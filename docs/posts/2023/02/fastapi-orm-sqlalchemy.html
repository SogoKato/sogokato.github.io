<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/favicon.ico"/><title>FastAPIとSQLAlchemy2.0ならもう型ヒントを諦めなくていい - Sogo.dev</title><meta name="description" content=" サチコ（Google Search Console）を眺めていたら `FastAPI MySQL` がそれなりに需要ありそうと思ったので、FastAPI と SQLAlchemy を組み合わせて ORM を使う方法を紹介したいと思います。最近の SQLAlchemy（1.4以降）ではマッピングされたオブジェクトに型を適用することもできるので、型ヒントを活かして型安全なコードを書くことも難しくなくなっています。

## 環境

* Python 3.10.6
* FastAPI 0.89.1
* SQLAl"/><meta http-equiv="content-language" content="ja"/><meta property="og:url" content="https://sogo.dev/posts/2023/02/fastapi-orm-sqlalchemy"/><meta property="og:type" content="article"/><meta property="og:title" content="FastAPIとSQLAlchemy2.0ならもう型ヒントを諦めなくていい - Sogo.dev"/><meta property="og:description" content=" サチコ（Google Search Console）を眺めていたら `FastAPI MySQL` がそれなりに需要ありそうと思ったので、FastAPI と SQLAlchemy を組み合わせて ORM を使う方法を紹介したいと思います。最近の SQLAlchemy（1.4以降）ではマッピングされたオブジェクトに型を適用することもできるので、型ヒントを活かして型安全なコードを書くことも難しくなくなっています。

## 環境

* Python 3.10.6
* FastAPI 0.89.1
* SQLAl"/><meta property="og:site_name" content="Sogo.dev"/><meta property="og:image" content="https://sogo.dev/images/ogp-image.jpg"/><meta name="twitter:card" content="summary"/><meta name="next-head-count" content="13"/><link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css"/><style>
        .py-overlay, .py-pop-up {display: none;}
        </style><link rel="alternate" href="/feed.xml" type="application/rss+xml" title="Sogo.dev"/><link rel="preconnect" href="https://use.typekit.net" crossorigin /><link rel="preload" href="/_next/static/css/ca5adee565d0260e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ca5adee565d0260e.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-2f406a55eb71bd78.js" defer=""></script><script src="/_next/static/chunks/framework-d507767242394e30.js" defer=""></script><script src="/_next/static/chunks/main-f4616c45ce8fd4b5.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2772d92391d417e1.js" defer=""></script><script src="/_next/static/chunks/541-77bbfd27f79d7fee.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5B...slug%5D-246dfa32aaaaa79c.js" defer=""></script><script src="/_next/static/iAOtCgGZVMAeNzyptNEld/_buildManifest.js" defer=""></script><script src="/_next/static/iAOtCgGZVMAeNzyptNEld/_ssgManifest.js" defer=""></script><style data-href="https://use.typekit.net/suf5fdm.css">@import url("https://p.typekit.net/p.css?s=1&k=suf5fdm&ht=tk&f=18518&a=11062204&app=typekit&e=css");@font-face{font-family:"rooney-sans";src:url("https://use.typekit.net/af/c27ef1/00000000000000007735a2d8/30/l?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n9&v=3") format("woff2"),url("https://use.typekit.net/af/c27ef1/00000000000000007735a2d8/30/d?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n9&v=3") format("woff"),url("https://use.typekit.net/af/c27ef1/00000000000000007735a2d8/30/a?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n9&v=3") format("opentype");font-display:auto;font-style:normal;font-weight:900;font-stretch:normal}.tk-rooney-sans{font-family:"rooney-sans",sans-serif}</style></head><body><div id="__next"><div class="bg-neutral-200 dark:bg-neutral-900 duration-400 min-h-screen text-neutral-900 dark:text-neutral-50 transition-all"><div class="grid grid-cols-10 justify-center max-w-7xl mx-auto"><header class="col-span-10"><div class="max-w-4xl mt-4 sm:mt-0 mx-auto flex justify-center sm:justify-between h-36 sm:h-48 items-center relative w-11/12"><div class="hidden sm:block"></div><a class="w-72 sm:w-auto" href="/"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27480%27%20height=%27160%27/%3e"/></span><img alt="logo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="logo" src="/images/logo.svg" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></a></div></header><main class="col-span-10 md:col-span-7"><article><div class="bg-white dark:bg-neutral-800 mx-auto mb-11 p-8 rounded-3xl shadow-lg w-11/12"><div><p>2023<!-- -->年<!-- -->2<!-- -->月<!-- -->8<!-- -->日</p><h1 class="mt-8 font-bold leading-tight mb-5 text-4xl">FastAPIとSQLAlchemy2.0ならもう型ヒントを諦めなくていい</h1><div class="flex justify-end"><a href="https://twitter.com/intent/tweet?text=FastAPI%E3%81%A8SQLAlchemy2.0%E3%81%AA%E3%82%89%E3%82%82%E3%81%86%E5%9E%8B%E3%83%92%E3%83%B3%E3%83%88%E3%82%92%E8%AB%A6%E3%82%81%E3%81%AA%E3%81%8F%E3%81%A6%E3%81%84%E3%81%84%0A&amp;url=https%3A%2F%2Fsogo.dev%2Fposts%2F2023%2F02%2Ffastapi-orm-sqlalchemy" target="_blank" rel="noopener noreferrer"><button class="bg-[#1da1f2] hover:bg-[#067acc] flex font-display items-center px-3.5 py-0.5 rounded-full text-duchs-900 hover:text-duchs-100 text-xs transition-all"><svg viewBox="0 0 20 20" style="fill:#fafafa;width:16px;height:16px"><path d="m6.29 18.12c7.53 0 11.65-6.25 11.65-11.65 0-.18 0-.35 0-.53.8-.58 1.49-1.3 2.04-2.12-.73.33-1.53.54-2.36.65.85-.5 1.49-1.31 1.81-2.27-.79.47-1.67.81-2.6.99-.75-.8-1.81-1.29-2.99-1.29-2.26 0-4.1 1.84-4.1 4.1 0 .32.04.63.1.93-3.4-.17-6.42-1.81-8.44-4.28-.35.61-.55 1.31-.55 2.06 0 1.42.73 2.68 1.82 3.41-.67-.02-1.3-.21-1.85-.51v.06c0 1.98 1.41 3.64 3.28 4.02-.34.1-.7.14-1.08.14-.26 0-.52-.02-.77-.07.52 1.63 2.04 2.81 3.83 2.84-1.41 1.1-3.17 1.76-5.09 1.76-.33 0-.65-.02-.97-.06 1.81 1.15 3.96 1.83 6.27 1.83"></path></svg><div class="ml-1 text-neutral-50">SHARE</div></button></a></div><div class="my-16 max-w-none prose dark:prose-invert prose-neutral"><p>サチコ（Google Search Console）を眺めていたら <code>FastAPI MySQL</code> がそれなりに需要ありそうと思ったので、FastAPI と SQLAlchemy を組み合わせて ORM を使う方法を紹介したいと思います。最近の SQLAlchemy（1.4以降）ではマッピングされたオブジェクトに型を適用することもできるので、型ヒントを活かして型安全なコードを書くことも難しくなくなっています。</p>
<h2>環境</h2>
<ul>
<li>Python 3.10.6</li>
<li>FastAPI 0.89.1</li>
<li>SQLAlchemy 2.0.1</li>
<li>Docker 20.10.13</li>
<li>Docker Compose v2.3.3</li>
</ul>
<h2>前提</h2>
<p>FastAPI 公式ドキュメントの <a href="https://fastapi.tiangolo.com/ja/tutorial/sql-databases/">SQL (Relational) Databases</a> のページを熟読しておいてください。</p>
<p>2023年1月にリリースされた SQLAlchemy 2.0を使用します。1系を使用している既存プロジェクトの場合は <a href="https://docs.sqlalchemy.org/en/20/changelog/migration_20.html">SQLAlchemy 2.0 - Major Migration Guide</a> を参考に2.0へ移行してください。1.4から2.0の移行はスムーズだと思います。</p>
<p>SQLAlchemy で利用できる ORM のモデルの書き方はいくつかあります。個人的には <a href="https://docs.sqlalchemy.org/en/20/orm/dataclasses.html">dataclass と統合した書き方</a>も好きですが、今回はシンプルにベーシックな実装を行います。</p>
<h2>成果物</h2>
<p><a href="https://github.com/SogoKato/fastapi-sqlalchemy2">https://github.com/SogoKato/fastapi-sqlalchemy2</a></p>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-py" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#cc99cd">from</span><span> fastapi </span><span class="token token" style="color:#cc99cd">import</span><span> Depends</span><span class="token token" style="color:#ccc">,</span><span> FastAPI</span><span class="token token" style="color:#ccc">,</span><span> HTTPException
</span><span></span><span class="token token" style="color:#cc99cd">from</span><span> pydantic </span><span class="token token" style="color:#cc99cd">import</span><span> BaseModel
</span><span></span><span class="token token" style="color:#cc99cd">from</span><span> sqlalchemy </span><span class="token token" style="color:#cc99cd">import</span><span> ForeignKey</span><span class="token token" style="color:#ccc">,</span><span> String</span><span class="token token" style="color:#ccc">,</span><span> create_engine</span><span class="token token" style="color:#ccc">,</span><span> select
</span><span></span><span class="token token" style="color:#cc99cd">from</span><span> sqlalchemy</span><span class="token token" style="color:#ccc">.</span><span>orm </span><span class="token token" style="color:#cc99cd">import</span><span> </span><span class="token token" style="color:#ccc">(</span><span>
</span><span>    DeclarativeBase</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>    Mapped</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>    Session</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>    mapped_column</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>    relationship</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>    sessionmaker</span><span class="token token" style="color:#ccc">,</span><span>
</span><span></span><span class="token token" style="color:#ccc">)</span><span>
</span>
<span></span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;
</span><span class="token token triple-quoted-string" style="color:#7ec699">SQLAlchemyのモデル.
</span><span class="token token triple-quoted-string" style="color:#7ec699">
</span><span class="token token triple-quoted-string" style="color:#7ec699">Based on:
</span><span class="token token triple-quoted-string" style="color:#7ec699">* https://docs.sqlalchemy.org/en/20/orm/quickstart.html#declare-models
</span><span class="token token triple-quoted-string" style="color:#7ec699">* https://fastapi.tiangolo.com/ja/tutorial/sql-databases/#create-the-database-models
</span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;</span><span>
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">class</span><span> </span><span class="token token" style="color:#f8c555">Base</span><span class="token token" style="color:#ccc">(</span><span>DeclarativeBase</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;各DBモデルの基底クラス.&quot;&quot;&quot;</span><span>
</span>
<span>    </span><span class="token token" style="color:#cc99cd">pass</span><span>
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">class</span><span> </span><span class="token token" style="color:#f8c555">User</span><span class="token token" style="color:#ccc">(</span><span>Base</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;usersテーブルのDBモデル.&quot;&quot;&quot;</span><span>
</span>
<span>    __tablename__ </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#7ec699">&quot;users&quot;</span><span>
</span>
<span>    </span><span class="token token" style="color:#cc99cd">id</span><span class="token token" style="color:#ccc">:</span><span> Mapped</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#cc99cd">int</span><span class="token token" style="color:#ccc">]</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> mapped_column</span><span class="token token" style="color:#ccc">(</span><span>primary_key</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">True</span><span class="token token" style="color:#ccc">,</span><span> index</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">True</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    email</span><span class="token token" style="color:#ccc">:</span><span> Mapped</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#cc99cd">str</span><span class="token token" style="color:#ccc">]</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> mapped_column</span><span class="token token" style="color:#ccc">(</span><span>String</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#f08d49">100</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">,</span><span> unique</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">True</span><span class="token token" style="color:#ccc">,</span><span> index</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">True</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    hashed_password</span><span class="token token" style="color:#ccc">:</span><span> Mapped</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#cc99cd">str</span><span class="token token" style="color:#ccc">]</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> mapped_column</span><span class="token token" style="color:#ccc">(</span><span>String</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#f08d49">100</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    is_active</span><span class="token token" style="color:#ccc">:</span><span> Mapped</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#cc99cd">bool</span><span class="token token" style="color:#ccc">]</span><span>
</span>
<span>    items</span><span class="token token" style="color:#ccc">:</span><span> Mapped</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#cc99cd">list</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#7ec699">&quot;Item&quot;</span><span class="token token" style="color:#ccc">]</span><span class="token token" style="color:#ccc">]</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> relationship</span><span class="token token" style="color:#ccc">(</span><span>back_populates</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#7ec699">&quot;owner&quot;</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">class</span><span> </span><span class="token token" style="color:#f8c555">Item</span><span class="token token" style="color:#ccc">(</span><span>Base</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;itemsテーブルのDBモデル.&quot;&quot;&quot;</span><span>
</span>
<span>    __tablename__ </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#7ec699">&quot;items&quot;</span><span>
</span>
<span>    </span><span class="token token" style="color:#cc99cd">id</span><span class="token token" style="color:#ccc">:</span><span> Mapped</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#cc99cd">int</span><span class="token token" style="color:#ccc">]</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> mapped_column</span><span class="token token" style="color:#ccc">(</span><span>primary_key</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">True</span><span class="token token" style="color:#ccc">,</span><span> index</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">True</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    title</span><span class="token token" style="color:#ccc">:</span><span> Mapped</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#cc99cd">str</span><span class="token token" style="color:#ccc">]</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> mapped_column</span><span class="token token" style="color:#ccc">(</span><span>String</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#f08d49">30</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">,</span><span> index</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">True</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    description</span><span class="token token" style="color:#ccc">:</span><span> Mapped</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#cc99cd">str</span><span class="token token" style="color:#ccc">]</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> mapped_column</span><span class="token token" style="color:#ccc">(</span><span>String</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#f08d49">30</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">,</span><span> index</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">True</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    owner_id</span><span class="token token" style="color:#ccc">:</span><span> Mapped</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#cc99cd">int</span><span class="token token" style="color:#ccc">]</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> mapped_column</span><span class="token token" style="color:#ccc">(</span><span>ForeignKey</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;users.id&quot;</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<span>    owner</span><span class="token token" style="color:#ccc">:</span><span> Mapped</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#7ec699">&quot;User&quot;</span><span class="token token" style="color:#ccc">]</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> relationship</span><span class="token token" style="color:#ccc">(</span><span>back_populates</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#7ec699">&quot;items&quot;</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<!-- -->
<span></span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;
</span><span class="token token triple-quoted-string" style="color:#7ec699">Pydanticのモデル.
</span><span class="token token triple-quoted-string" style="color:#7ec699">
</span><span class="token token triple-quoted-string" style="color:#7ec699">Based on:
</span><span class="token token triple-quoted-string" style="color:#7ec699">* https://fastapi.tiangolo.com/ja/tutorial/sql-databases/#create-the-pydantic-models
</span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;</span><span>
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">class</span><span> </span><span class="token token" style="color:#f8c555">ItemBase</span><span class="token token" style="color:#ccc">(</span><span>BaseModel</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;Itemの基底クラス.&quot;&quot;&quot;</span><span>
</span>
<span>    title</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">str</span><span>
</span><span>    description</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">str</span><span> </span><span class="token token" style="color:#67cdcc">|</span><span> </span><span class="token token" style="color:#f08d49">None</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#f08d49">None</span><span>
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">class</span><span> </span><span class="token token" style="color:#f8c555">ItemCreateRequest</span><span class="token token" style="color:#ccc">(</span><span>ItemBase</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;Item作成のリクエストを表現するクラス.&quot;&quot;&quot;</span><span>
</span>
<span>    </span><span class="token token" style="color:#cc99cd">pass</span><span>
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">class</span><span> </span><span class="token token" style="color:#f8c555">ItemResponse</span><span class="token token" style="color:#ccc">(</span><span>ItemBase</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;Itemのレスポンスを表現するクラス.&quot;&quot;&quot;</span><span>
</span>
<span>    </span><span class="token token" style="color:#cc99cd">id</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">int</span><span>
</span><span>    owner_id</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">int</span><span>
</span>
<span>    </span><span class="token token" style="color:#cc99cd">class</span><span> </span><span class="token token" style="color:#f8c555">Config</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        orm_mode </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#f08d49">True</span><span>
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">class</span><span> </span><span class="token token" style="color:#f8c555">UserBase</span><span class="token token" style="color:#ccc">(</span><span>BaseModel</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;Userの基底クラス.&quot;&quot;&quot;</span><span>
</span>
<span>    email</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">str</span><span>
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">class</span><span> </span><span class="token token" style="color:#f8c555">UserCreateRequest</span><span class="token token" style="color:#ccc">(</span><span>UserBase</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;User作成のリクエストを表現するクラス.&quot;&quot;&quot;</span><span>
</span>
<span>    password</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">str</span><span>
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">class</span><span> </span><span class="token token" style="color:#f8c555">UserResponse</span><span class="token token" style="color:#ccc">(</span><span>UserBase</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;Userのレスポンスを表現するクラス.&quot;&quot;&quot;</span><span>
</span>
<span>    </span><span class="token token" style="color:#cc99cd">id</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">int</span><span>
</span><span>    is_active</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">bool</span><span>
</span><span>    items</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">list</span><span class="token token" style="color:#ccc">[</span><span>ItemResponse</span><span class="token token" style="color:#ccc">]</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#ccc">]</span><span>
</span>
<span>    </span><span class="token token" style="color:#cc99cd">class</span><span> </span><span class="token token" style="color:#f8c555">Config</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        orm_mode </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#f08d49">True</span><span>
</span>
<!-- -->
<span></span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;
</span><span class="token token triple-quoted-string" style="color:#7ec699">DBのCRUD操作を行う関数.
</span><span class="token token triple-quoted-string" style="color:#7ec699">
</span><span class="token token triple-quoted-string" style="color:#7ec699">Based on:
</span><span class="token token triple-quoted-string" style="color:#7ec699">* https://docs.sqlalchemy.org/en/20/changelog/migration_20.html#migration-orm-usage
</span><span class="token token triple-quoted-string" style="color:#7ec699">* https://fastapi.tiangolo.com/ja/tutorial/sql-databases/#crud-utils
</span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;</span><span>
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">get_db_user</span><span class="token token" style="color:#ccc">(</span><span>db</span><span class="token token" style="color:#ccc">:</span><span> Session</span><span class="token token" style="color:#ccc">,</span><span> user_id</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">int</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;usersテーブルからuser_idに一致するUserを取得します.&quot;&quot;&quot;</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">return</span><span> db</span><span class="token token" style="color:#ccc">.</span><span>execute</span><span class="token token" style="color:#ccc">(</span><span>select</span><span class="token token" style="color:#ccc">(</span><span>User</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>where</span><span class="token token" style="color:#ccc">(</span><span>User</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#cc99cd">id</span><span> </span><span class="token token" style="color:#67cdcc">==</span><span> user_id</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>scalars</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>first</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">get_db_user_by_email</span><span class="token token" style="color:#ccc">(</span><span>db</span><span class="token token" style="color:#ccc">:</span><span> Session</span><span class="token token" style="color:#ccc">,</span><span> email</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">str</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;usersテーブルからemailに一致するUserを取得します.&quot;&quot;&quot;</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">return</span><span> db</span><span class="token token" style="color:#ccc">.</span><span>execute</span><span class="token token" style="color:#ccc">(</span><span>select</span><span class="token token" style="color:#ccc">(</span><span>User</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>where</span><span class="token token" style="color:#ccc">(</span><span>User</span><span class="token token" style="color:#ccc">.</span><span>email </span><span class="token token" style="color:#67cdcc">==</span><span> email</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>scalars</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>first</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">get_db_users</span><span class="token token" style="color:#ccc">(</span><span>db</span><span class="token token" style="color:#ccc">:</span><span> Session</span><span class="token token" style="color:#ccc">,</span><span> skip</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">int</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#f08d49">0</span><span class="token token" style="color:#ccc">,</span><span> limit</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">int</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#f08d49">100</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;usersテーブルからUserをすべて取得します.&quot;&quot;&quot;</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">return</span><span> db</span><span class="token token" style="color:#ccc">.</span><span>execute</span><span class="token token" style="color:#ccc">(</span><span>select</span><span class="token token" style="color:#ccc">(</span><span>User</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>offset</span><span class="token token" style="color:#ccc">(</span><span>skip</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>limit</span><span class="token token" style="color:#ccc">(</span><span>limit</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>scalars</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#cc99cd">all</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">create_db_user</span><span class="token token" style="color:#ccc">(</span><span>db</span><span class="token token" style="color:#ccc">:</span><span> Session</span><span class="token token" style="color:#ccc">,</span><span> user</span><span class="token token" style="color:#ccc">:</span><span> UserCreateRequest</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;usersテーブルにUserを追加します.&quot;&quot;&quot;</span><span>
</span><span>    fake_hashed_password </span><span class="token token" style="color:#67cdcc">=</span><span> user</span><span class="token token" style="color:#ccc">.</span><span>password </span><span class="token token" style="color:#67cdcc">+</span><span> </span><span class="token token" style="color:#7ec699">&quot;notreallyhashed&quot;</span><span>
</span><span>    db_user </span><span class="token token" style="color:#67cdcc">=</span><span> User</span><span class="token token" style="color:#ccc">(</span><span>
</span><span>        email</span><span class="token token" style="color:#67cdcc">=</span><span>user</span><span class="token token" style="color:#ccc">.</span><span>email</span><span class="token token" style="color:#ccc">,</span><span> hashed_password</span><span class="token token" style="color:#67cdcc">=</span><span>fake_hashed_password</span><span class="token token" style="color:#ccc">,</span><span> is_active</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">True</span><span>
</span><span>    </span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    db</span><span class="token token" style="color:#ccc">.</span><span>add</span><span class="token token" style="color:#ccc">(</span><span>db_user</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    db</span><span class="token token" style="color:#ccc">.</span><span>commit</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    db</span><span class="token token" style="color:#ccc">.</span><span>refresh</span><span class="token token" style="color:#ccc">(</span><span>db_user</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">return</span><span> db_user
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">get_db_items</span><span class="token token" style="color:#ccc">(</span><span>db</span><span class="token token" style="color:#ccc">:</span><span> Session</span><span class="token token" style="color:#ccc">,</span><span> skip</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">int</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#f08d49">0</span><span class="token token" style="color:#ccc">,</span><span> limit</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">int</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#f08d49">100</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;itemsテーブルからItemをすべて取得します.&quot;&quot;&quot;</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">return</span><span> db</span><span class="token token" style="color:#ccc">.</span><span>execute</span><span class="token token" style="color:#ccc">(</span><span>select</span><span class="token token" style="color:#ccc">(</span><span>Item</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>offset</span><span class="token token" style="color:#ccc">(</span><span>skip</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>limit</span><span class="token token" style="color:#ccc">(</span><span>limit</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>scalars</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#cc99cd">all</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">create_db_user_item</span><span class="token token" style="color:#ccc">(</span><span>db</span><span class="token token" style="color:#ccc">:</span><span> Session</span><span class="token token" style="color:#ccc">,</span><span> item</span><span class="token token" style="color:#ccc">:</span><span> ItemCreateRequest</span><span class="token token" style="color:#ccc">,</span><span> user_id</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">int</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;itemsテーブルにItemを追加します.&quot;&quot;&quot;</span><span>
</span><span>    db_item </span><span class="token token" style="color:#67cdcc">=</span><span> Item</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#67cdcc">**</span><span>item</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#cc99cd">dict</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">,</span><span> owner_id</span><span class="token token" style="color:#67cdcc">=</span><span>user_id</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    db</span><span class="token token" style="color:#ccc">.</span><span>add</span><span class="token token" style="color:#ccc">(</span><span>db_item</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    db</span><span class="token token" style="color:#ccc">.</span><span>commit</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    db</span><span class="token token" style="color:#ccc">.</span><span>refresh</span><span class="token token" style="color:#ccc">(</span><span>db_item</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">return</span><span> db_item
</span>
<!-- -->
<span></span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;
</span><span class="token token triple-quoted-string" style="color:#7ec699">FastAPIでSQLAlchemyを使うためのセットアップ.
</span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;</span><span>
</span><span></span><span class="token token" style="color:#999"># DBセッションを作成するクラスを作る.</span><span>
</span><span>SQLALCHEMY_DATABASE_URL </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#7ec699">&quot;mysql+mysqldb://user:password@db/test&quot;</span><span>
</span>
<span></span><span class="token token" style="color:#999"># デバッグ用にecho=Trueに設定.</span><span>
</span><span>engine </span><span class="token token" style="color:#67cdcc">=</span><span> create_engine</span><span class="token token" style="color:#ccc">(</span><span>SQLALCHEMY_DATABASE_URL</span><span class="token token" style="color:#ccc">,</span><span> echo</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">True</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>SessionLocal </span><span class="token token" style="color:#67cdcc">=</span><span> sessionmaker</span><span class="token token" style="color:#ccc">(</span><span>autocommit</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">False</span><span class="token token" style="color:#ccc">,</span><span> autoflush</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">False</span><span class="token token" style="color:#ccc">,</span><span> bind</span><span class="token token" style="color:#67cdcc">=</span><span>engine</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<span></span><span class="token token" style="color:#999"># DBマイグレーションを行う.</span><span>
</span><span>Base</span><span class="token token" style="color:#ccc">.</span><span>metadata</span><span class="token token" style="color:#ccc">.</span><span>create_all</span><span class="token token" style="color:#ccc">(</span><span>bind</span><span class="token token" style="color:#67cdcc">=</span><span>engine</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<span></span><span class="token token" style="color:#999"># FastAPIをインスタンス化.</span><span>
</span><span>app </span><span class="token token" style="color:#67cdcc">=</span><span> FastAPI</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">get_db</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;リクエストが来たらセッションを作成し、処理が完了したら閉じるためのDependency.&quot;&quot;&quot;</span><span>
</span><span>    db </span><span class="token token" style="color:#67cdcc">=</span><span> SessionLocal</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">try</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        </span><span class="token token" style="color:#cc99cd">yield</span><span> db
</span><span>    </span><span class="token token" style="color:#cc99cd">finally</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        db</span><span class="token token" style="color:#ccc">.</span><span>close</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<!-- -->
<span></span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;
</span><span class="token token triple-quoted-string" style="color:#7ec699">FastAPIのルーティング.
</span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;</span><span>
</span>
<!-- -->
<span></span><span class="token token decorator annotation" style="color:#ccc">@app</span><span class="token token decorator annotation" style="color:#ccc">.</span><span class="token token decorator annotation" style="color:#ccc">post</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;/users/&quot;</span><span class="token token" style="color:#ccc">,</span><span> response_model</span><span class="token token" style="color:#67cdcc">=</span><span>UserResponse</span><span class="token token" style="color:#ccc">)</span><span>
</span><span></span><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">create_user</span><span class="token token" style="color:#ccc">(</span><span>user</span><span class="token token" style="color:#ccc">:</span><span> UserCreateRequest</span><span class="token token" style="color:#ccc">,</span><span> db</span><span class="token token" style="color:#ccc">:</span><span> Session </span><span class="token token" style="color:#67cdcc">=</span><span> Depends</span><span class="token token" style="color:#ccc">(</span><span>get_db</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;ユーザーを作成します.&quot;&quot;&quot;</span><span>
</span><span>    db_user </span><span class="token token" style="color:#67cdcc">=</span><span> get_db_user_by_email</span><span class="token token" style="color:#ccc">(</span><span>db</span><span class="token token" style="color:#ccc">,</span><span> email</span><span class="token token" style="color:#67cdcc">=</span><span>user</span><span class="token token" style="color:#ccc">.</span><span>email</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">if</span><span> db_user</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        </span><span class="token token" style="color:#cc99cd">raise</span><span> HTTPException</span><span class="token token" style="color:#ccc">(</span><span>status_code</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">400</span><span class="token token" style="color:#ccc">,</span><span> detail</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#7ec699">&quot;Email already registered&quot;</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">return</span><span> create_db_user</span><span class="token token" style="color:#ccc">(</span><span>db</span><span class="token token" style="color:#67cdcc">=</span><span>db</span><span class="token token" style="color:#ccc">,</span><span> user</span><span class="token token" style="color:#67cdcc">=</span><span>user</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<!-- -->
<span></span><span class="token token decorator annotation" style="color:#ccc">@app</span><span class="token token decorator annotation" style="color:#ccc">.</span><span class="token token decorator annotation" style="color:#ccc">get</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;/users/&quot;</span><span class="token token" style="color:#ccc">,</span><span> response_model</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#cc99cd">list</span><span class="token token" style="color:#ccc">[</span><span>UserResponse</span><span class="token token" style="color:#ccc">]</span><span class="token token" style="color:#ccc">)</span><span>
</span><span></span><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">read_users</span><span class="token token" style="color:#ccc">(</span><span>skip</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">int</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#f08d49">0</span><span class="token token" style="color:#ccc">,</span><span> limit</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">int</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#f08d49">100</span><span class="token token" style="color:#ccc">,</span><span> db</span><span class="token token" style="color:#ccc">:</span><span> Session </span><span class="token token" style="color:#67cdcc">=</span><span> Depends</span><span class="token token" style="color:#ccc">(</span><span>get_db</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;ユーザーを一覧します.&quot;&quot;&quot;</span><span>
</span><span>    users </span><span class="token token" style="color:#67cdcc">=</span><span> get_db_users</span><span class="token token" style="color:#ccc">(</span><span>db</span><span class="token token" style="color:#ccc">,</span><span> skip</span><span class="token token" style="color:#67cdcc">=</span><span>skip</span><span class="token token" style="color:#ccc">,</span><span> limit</span><span class="token token" style="color:#67cdcc">=</span><span>limit</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">return</span><span> users
</span>
<!-- -->
<span></span><span class="token token decorator annotation" style="color:#ccc">@app</span><span class="token token decorator annotation" style="color:#ccc">.</span><span class="token token decorator annotation" style="color:#ccc">get</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;/users/{user_id}&quot;</span><span class="token token" style="color:#ccc">,</span><span> response_model</span><span class="token token" style="color:#67cdcc">=</span><span>UserResponse</span><span class="token token" style="color:#ccc">)</span><span>
</span><span></span><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">read_user</span><span class="token token" style="color:#ccc">(</span><span>user_id</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">int</span><span class="token token" style="color:#ccc">,</span><span> db</span><span class="token token" style="color:#ccc">:</span><span> Session </span><span class="token token" style="color:#67cdcc">=</span><span> Depends</span><span class="token token" style="color:#ccc">(</span><span>get_db</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;ユーザーを取得します.&quot;&quot;&quot;</span><span>
</span><span>    db_user </span><span class="token token" style="color:#67cdcc">=</span><span> get_db_user</span><span class="token token" style="color:#ccc">(</span><span>db</span><span class="token token" style="color:#ccc">,</span><span> user_id</span><span class="token token" style="color:#67cdcc">=</span><span>user_id</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">if</span><span> db_user </span><span class="token token" style="color:#cc99cd">is</span><span> </span><span class="token token" style="color:#f08d49">None</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        </span><span class="token token" style="color:#cc99cd">raise</span><span> HTTPException</span><span class="token token" style="color:#ccc">(</span><span>status_code</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">404</span><span class="token token" style="color:#ccc">,</span><span> detail</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#7ec699">&quot;User not found&quot;</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">return</span><span> db_user
</span>
<!-- -->
<span></span><span class="token token decorator annotation" style="color:#ccc">@app</span><span class="token token decorator annotation" style="color:#ccc">.</span><span class="token token decorator annotation" style="color:#ccc">post</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;/users/{user_id}/items/&quot;</span><span class="token token" style="color:#ccc">,</span><span> response_model</span><span class="token token" style="color:#67cdcc">=</span><span>ItemResponse</span><span class="token token" style="color:#ccc">)</span><span>
</span><span></span><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">create_item_for_user</span><span class="token token" style="color:#ccc">(</span><span>
</span><span>    user_id</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">int</span><span class="token token" style="color:#ccc">,</span><span> item</span><span class="token token" style="color:#ccc">:</span><span> ItemCreateRequest</span><span class="token token" style="color:#ccc">,</span><span> db</span><span class="token token" style="color:#ccc">:</span><span> Session </span><span class="token token" style="color:#67cdcc">=</span><span> Depends</span><span class="token token" style="color:#ccc">(</span><span>get_db</span><span class="token token" style="color:#ccc">)</span><span>
</span><span></span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;ユーザーのアイテムを作成します.&quot;&quot;&quot;</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">return</span><span> create_db_user_item</span><span class="token token" style="color:#ccc">(</span><span>db</span><span class="token token" style="color:#67cdcc">=</span><span>db</span><span class="token token" style="color:#ccc">,</span><span> item</span><span class="token token" style="color:#67cdcc">=</span><span>item</span><span class="token token" style="color:#ccc">,</span><span> user_id</span><span class="token token" style="color:#67cdcc">=</span><span>user_id</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<!-- -->
<span></span><span class="token token decorator annotation" style="color:#ccc">@app</span><span class="token token decorator annotation" style="color:#ccc">.</span><span class="token token decorator annotation" style="color:#ccc">get</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;/items/&quot;</span><span class="token token" style="color:#ccc">,</span><span> response_model</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#cc99cd">list</span><span class="token token" style="color:#ccc">[</span><span>ItemResponse</span><span class="token token" style="color:#ccc">]</span><span class="token token" style="color:#ccc">)</span><span>
</span><span></span><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">read_items</span><span class="token token" style="color:#ccc">(</span><span>skip</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">int</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#f08d49">0</span><span class="token token" style="color:#ccc">,</span><span> limit</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">int</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#f08d49">100</span><span class="token token" style="color:#ccc">,</span><span> db</span><span class="token token" style="color:#ccc">:</span><span> Session </span><span class="token token" style="color:#67cdcc">=</span><span> Depends</span><span class="token token" style="color:#ccc">(</span><span>get_db</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token triple-quoted-string" style="color:#7ec699">&quot;&quot;&quot;アイテムを一覧します.&quot;&quot;&quot;</span><span>
</span><span>    items </span><span class="token token" style="color:#67cdcc">=</span><span> get_db_items</span><span class="token token" style="color:#ccc">(</span><span>db</span><span class="token token" style="color:#ccc">,</span><span> skip</span><span class="token token" style="color:#67cdcc">=</span><span>skip</span><span class="token token" style="color:#ccc">,</span><span> limit</span><span class="token token" style="color:#67cdcc">=</span><span>limit</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">return</span><span> items</span></code></pre></pre>
<p>以上を <code>main.py</code> として保存して、下記の <code>Dockerfile</code> <code>docker-compose.yml</code> で <code>docker compose up --build</code> すれば動きます。</p>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-dockerfile" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token instruction" style="color:#cc99cd">FROM</span><span class="token token instruction"> python:3.10</span><span>
</span>
<span></span><span class="token token instruction" style="color:#cc99cd">WORKDIR</span><span class="token token instruction"> /app</span><span>
</span>
<span></span><span class="token token instruction" style="color:#cc99cd">ENV</span><span class="token token instruction"> PATH=</span><span class="token token instruction" style="color:#7ec699">$PATH</span><span class="token token instruction">:/root/.local/bin</span><span>
</span><span></span><span class="token token instruction" style="color:#cc99cd">COPY</span><span class="token token instruction"> pyproject.toml poetry.lock ./</span><span>
</span>
<span></span><span class="token token instruction" style="color:#cc99cd">RUN</span><span class="token token instruction"> curl -sSL https://install.python-poetry.org | python3 - </span><span class="token token instruction" style="color:#67cdcc">\</span><span class="token token instruction">
</span><span class="token token instruction">    &amp;&amp; poetry install</span><span>
</span>
<span></span><span class="token token instruction" style="color:#cc99cd">CMD</span><span class="token token instruction"> [</span><span class="token token instruction" style="color:#7ec699">&quot;poetry&quot;</span><span class="token token instruction">, </span><span class="token token instruction" style="color:#7ec699">&quot;run&quot;</span><span class="token token instruction">, </span><span class="token token instruction" style="color:#7ec699">&quot;uvicorn&quot;</span><span class="token token instruction">, </span><span class="token token instruction" style="color:#7ec699">&quot;main:app&quot;</span><span class="token token instruction">, </span><span class="token token instruction" style="color:#7ec699">&quot;--host&quot;</span><span class="token token instruction">, </span><span class="token token instruction" style="color:#7ec699">&quot;0.0.0.0&quot;</span><span class="token token instruction">, </span><span class="token token instruction" style="color:#7ec699">&quot;--reload&quot;</span><span class="token token instruction">]</span></code></pre></pre>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-yaml" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token key" style="color:#cc99cd">version</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#7ec699">&#x27;3&#x27;</span><span>
</span><span></span><span class="token token key" style="color:#cc99cd">services</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>  </span><span class="token token key" style="color:#cc99cd">app</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token key" style="color:#cc99cd">build</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>      </span><span class="token token key" style="color:#cc99cd">context</span><span class="token token" style="color:#ccc">:</span><span> ./
</span><span>      </span><span class="token token key" style="color:#cc99cd">dockerfile</span><span class="token token" style="color:#ccc">:</span><span> Dockerfile
</span><span>    </span><span class="token token key" style="color:#cc99cd">ports</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>      </span><span class="token token" style="color:#ccc">-</span><span> </span><span class="token token" style="color:#7ec699">&#x27;8000:8000&#x27;</span><span>
</span><span>    </span><span class="token token key" style="color:#cc99cd">volumes</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>      </span><span class="token token" style="color:#ccc">-</span><span> </span><span class="token token key" style="color:#cc99cd">type</span><span class="token token" style="color:#ccc">:</span><span> bind
</span><span>        </span><span class="token token key" style="color:#cc99cd">source</span><span class="token token" style="color:#ccc">:</span><span> ./
</span><span>        </span><span class="token token key" style="color:#cc99cd">target</span><span class="token token" style="color:#ccc">:</span><span> /app
</span><span>  </span><span class="token token key" style="color:#cc99cd">db</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token key" style="color:#cc99cd">image</span><span class="token token" style="color:#ccc">:</span><span> mysql</span><span class="token token" style="color:#ccc">:</span><span class="token token" style="color:#f08d49">8.0</span><span>
</span><span>    </span><span class="token token key" style="color:#cc99cd">environment</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>      </span><span class="token token key" style="color:#cc99cd">MYSQL_ROOT_PASSWORD</span><span class="token token" style="color:#ccc">:</span><span> password
</span><span>      </span><span class="token token key" style="color:#cc99cd">MYSQL_DATABASE</span><span class="token token" style="color:#ccc">:</span><span> test
</span><span>      </span><span class="token token key" style="color:#cc99cd">MYSQL_USER</span><span class="token token" style="color:#ccc">:</span><span> user
</span><span>      </span><span class="token token key" style="color:#cc99cd">MYSQL_PASSWORD</span><span class="token token" style="color:#ccc">:</span><span> password</span></code></pre></pre>
<h2>ちょこっと解説</h2>
<h3>SQL Alchemy 2.0 に対応させる</h3>
<p>コードを見ればそれがすべてなのであまり解説することはないのですが、FastAPI 公式ドキュメントの <a href="https://fastapi.tiangolo.com/ja/tutorial/sql-databases/">SQL (Relational) Databases</a> のページとの大きな違いは、SQLAlchemy 2.0風な書き方になっているかどうかです。</p>
<p>SQLAlchemy を使ったことのある方なら <code>session.query(User).filter(User.id == user_id).first()</code> のような書き方に慣れているかと思いますが、SQLAlchemy 2.0 ではこの書き方は<a href="https://docs.sqlalchemy.org/en/20/orm/queryguide/query.html#legacy-query-api">レガシーとされています</a>。</p>
<p>SQLAlchemy Core に統一された書き方が推奨されており、上記の例は以下のように書き換えられます。</p>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-py" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>session</span><span class="token token" style="color:#ccc">.</span><span>execute</span><span class="token token" style="color:#ccc">(</span><span>select</span><span class="token token" style="color:#ccc">(</span><span>User</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>where</span><span class="token token" style="color:#ccc">(</span><span>User</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#cc99cd">id</span><span> </span><span class="token token" style="color:#67cdcc">==</span><span> user_id</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>scalars</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>first</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span></code></pre></pre>
<p>特徴は</p>
<ul>
<li>ステートメント（SELECT ... WHERE ...）とその実行が明確に分離された</li>
<li><code>Query</code> クラスではなく <code>Result</code> クラスや <code>ScalarResult</code> で <code>.all()</code> や <code>.first()</code> を使う</li>
</ul>
<p>ことです。今までの API よりも分かりやすくなっていますし、型推論も効いているので使いやすいと思います。</p>
<p>モデルクラスの書き方も変わっています。</p>
<p>今までは以下のように定義していた部分が</p>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-py" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#cc99cd">id</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> Column</span><span class="token token" style="color:#ccc">(</span><span>Integer</span><span class="token token" style="color:#ccc">,</span><span> primary_key</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">True</span><span class="token token" style="color:#ccc">,</span><span> index</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">True</span><span class="token token" style="color:#ccc">)</span></code></pre></pre>
<p>このようになります。</p>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-py" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#cc99cd">id</span><span class="token token" style="color:#ccc">:</span><span> Mapped</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#cc99cd">int</span><span class="token token" style="color:#ccc">]</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> mapped_column</span><span class="token token" style="color:#ccc">(</span><span>primary_key</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">True</span><span class="token token" style="color:#ccc">,</span><span> index</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">True</span><span class="token token" style="color:#ccc">)</span></code></pre></pre>
<p>それっぽく移植していけば迷うことは少ないと思います。</p>
<h3>DB セッションの取得には dependency を使う</h3>
<p>FastAPI の主要な機能の一つともいえる dependency を使って、DB セッションの生成を行うのが定番となっています。ちなみに、<code>SessionLocal</code> の命名は、<code>sqlalchemy.orm.Session</code> と区別するためだそうです。</p>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-py" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">get_db</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    db </span><span class="token token" style="color:#67cdcc">=</span><span> SessionLocal</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">try</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        </span><span class="token token" style="color:#cc99cd">yield</span><span> db
</span><span>    </span><span class="token token" style="color:#cc99cd">finally</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        db</span><span class="token token" style="color:#ccc">.</span><span>close</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span></code></pre></pre>
<p>この <code>get_db</code> dependency を使うことで、リクエストの開始時に DB セッションを生成し（<code>yield</code> の段階で渡される）、リクエストの処理が完了したら（finally 節で）DB セッションが閉じられるようになります。Dependency での <code>yield</code> の使い方については <a href="https://fastapi.tiangolo.com/ja/tutorial/dependencies/dependencies-with-yield/">Dependencies with yield</a> をご参照ください。</p>
<p>Dependency は、別の dependency の中でも使うことができるので、リクエストの前処理（バリデーションなど）で引数に <code>db = Depends(get_db)</code> と指定することで、その中でも DB セッションを使うことができます。便利ですね。</p>
<h3>Pydantic の ORM mode</h3>
<p>私のユースケースでは普段使っていないのですが、マッチすれば便利だなと思うのが Pydantic の <code>orm_mode = True</code> です。</p>
<p>これが有効になっていると、Pydantic が値を取得するときに <code>data[&quot;id&quot;]</code> のように辞書のキーだけでなく、<code>data.id</code> のように属性でも値を取得しようと試みるようになるそうです。これだけ聞いてもあまりピンときませんが、この違いがあることによって ORM が張っている relationship（通常は lazy loading なので求められるまでは存在していない）の値をとってくることが可能になるようです（<code>@property</code> で呼び出して値をとってこられるというようなことかなと予想しています）。</p>
<h2>まとめ</h2>
<p><a href="https://prisma-client-py.readthedocs.io/en/stable/">Prisma Client Python</a> の型付けの開発者体験も結構好きでしたが、SQLAlchemy もまだまだ勢いがありますね。ぜひ活用してみてください。</p>
<p>関連記事もどうぞ。<br/>
<a href="/posts/2023/01/sqlalchemy-dealing-with-disconnects">SQLAlchemyで&#x27;MySQL server has gone away&#x27;が発生した時の対処法2つ</a></p>
<h2>おまけ：API をたたいてみる</h2>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>$ curl -s localhost:8000/users/ -XPOST \
</span>  -H &#x27;content-type: application/json&#x27; \
<!-- -->  -d &#x27;{&quot;email&quot;: &quot;me@example.com&quot;, &quot;password&quot;: &quot;mystrongpassword&quot;}&#x27; \
<!-- -->  | jq</code></pre></pre>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-json" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#ccc">{</span><span>
</span><span>  </span><span class="token token" style="color:#f8c555">&quot;email&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#7ec699">&quot;me@example.com&quot;</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>  </span><span class="token token" style="color:#f8c555">&quot;id&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#f08d49">1</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>  </span><span class="token token" style="color:#f8c555">&quot;is_active&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#f08d49">true</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>  </span><span class="token token" style="color:#f8c555">&quot;items&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#ccc">]</span><span>
</span><span></span><span class="token token" style="color:#ccc">}</span></code></pre></pre>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>$ curl -s localhost:8000/users/ | jq</span></code></pre></pre>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-json" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#ccc">[</span><span>
</span><span>  </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>    </span><span class="token token" style="color:#f8c555">&quot;email&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#7ec699">&quot;me@example.com&quot;</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>    </span><span class="token token" style="color:#f8c555">&quot;id&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#f08d49">1</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>    </span><span class="token token" style="color:#f8c555">&quot;is_active&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#f08d49">true</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>    </span><span class="token token" style="color:#f8c555">&quot;items&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#ccc">]</span><span>
</span><span>  </span><span class="token token" style="color:#ccc">}</span><span>
</span><span></span><span class="token token" style="color:#ccc">]</span></code></pre></pre>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>$ curl -s localhost:8000/users/?limit=0 | jq</span></code></pre></pre>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-json" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#ccc">]</span></code></pre></pre>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>$ curl -s localhost:8000/users/1 | jq</span></code></pre></pre>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-json" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#ccc">{</span><span>
</span><span>  </span><span class="token token" style="color:#f8c555">&quot;email&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#7ec699">&quot;me@example.com&quot;</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>  </span><span class="token token" style="color:#f8c555">&quot;id&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#f08d49">1</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>  </span><span class="token token" style="color:#f8c555">&quot;is_active&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#f08d49">true</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>  </span><span class="token token" style="color:#f8c555">&quot;items&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#ccc">]</span><span>
</span><span></span><span class="token token" style="color:#ccc">}</span></code></pre></pre>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>$ curl -s localhost:8000/users/1/items/ -XPOST \
</span>  -H &#x27;content-type: application/json&#x27; \
<!-- -->  -d &#x27;{&quot;title&quot;: &quot;LEVEL3&quot;, &quot;description&quot;: &quot;My favourite album&quot;}&#x27; \
<!-- -->  | jq</code></pre></pre>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-json" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#ccc">{</span><span>
</span><span>  </span><span class="token token" style="color:#f8c555">&quot;title&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#7ec699">&quot;LEVEL3&quot;</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>  </span><span class="token token" style="color:#f8c555">&quot;description&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#7ec699">&quot;My favourite album&quot;</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>  </span><span class="token token" style="color:#f8c555">&quot;id&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#f08d49">1</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>  </span><span class="token token" style="color:#f8c555">&quot;owner_id&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#f08d49">1</span><span>
</span><span></span><span class="token token" style="color:#ccc">}</span></code></pre></pre>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>$ curl -s localhost:8000/users/1 | jq</span></code></pre></pre>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-json" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#ccc">{</span><span>
</span><span>  </span><span class="token token" style="color:#f8c555">&quot;email&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#7ec699">&quot;me@example.com&quot;</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>  </span><span class="token token" style="color:#f8c555">&quot;id&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#f08d49">1</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>  </span><span class="token token" style="color:#f8c555">&quot;is_active&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#f08d49">true</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>  </span><span class="token token" style="color:#f8c555">&quot;items&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#ccc">[</span><span>
</span><span>    </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>      </span><span class="token token" style="color:#f8c555">&quot;title&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#7ec699">&quot;LEVEL3&quot;</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>      </span><span class="token token" style="color:#f8c555">&quot;description&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#7ec699">&quot;My favourite album&quot;</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>      </span><span class="token token" style="color:#f8c555">&quot;id&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#f08d49">1</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>      </span><span class="token token" style="color:#f8c555">&quot;owner_id&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#f08d49">1</span><span>
</span><span>    </span><span class="token token" style="color:#ccc">}</span><span>
</span><span>  </span><span class="token token" style="color:#ccc">]</span><span>
</span><span></span><span class="token token" style="color:#ccc">}</span></code></pre></pre>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>$ curl -s localhost:8000/items/ | jq</span></code></pre></pre>
<pre><div></div><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-json" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#ccc">[</span><span>
</span><span>  </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>    </span><span class="token token" style="color:#f8c555">&quot;title&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#7ec699">&quot;LEVEL3&quot;</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>    </span><span class="token token" style="color:#f8c555">&quot;description&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#7ec699">&quot;My favourite album&quot;</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>    </span><span class="token token" style="color:#f8c555">&quot;id&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#f08d49">1</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>    </span><span class="token token" style="color:#f8c555">&quot;owner_id&quot;</span><span class="token token" style="color:#67cdcc">:</span><span> </span><span class="token token" style="color:#f08d49">1</span><span>
</span><span>  </span><span class="token token" style="color:#ccc">}</span><span>
</span><span></span><span class="token token" style="color:#ccc">]</span></code></pre></pre>
<h2>参考文献</h2>
<ul>
<li><a href="https://fastapi.tiangolo.com/ja/tutorial/sql-databases/">SQL (Relational) Databases</a></li>
<li><a href="https://docs.sqlalchemy.org/en/20/orm/quickstart.html">ORM Quick Start</a></li>
</ul></div><ul class="flex flex-wrap mt-5"><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/python"># <!-- -->Python</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/fastapi"># <!-- -->FastAPI</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/sqlalchemy"># <!-- -->SQLAlchemy</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/orm"># <!-- -->ORM</a></ul></div></div><div class="flex flex-col sm:flex-row justify-between mx-auto w-11/12"><div class="w-full sm:w-1/2"><a class="dark:hover:bg-neutral-600 hover:bg-neutral-300 flex group items-center rounded-full transition-all pr-10" href="/posts/2023/02/unit-testing-principles-practices-and-patterns-part2-2"><div class="bg-duchs-200 group-hover:bg-duchs-800 flex items-center justify-center h-14 mx-5 first:ml-0 last:mr-0 px-3 rounded-full transition-all w-14"><svg class="fill-duchs-900 group-hover:fill-duchs-100" viewBox="0 0 10.19 8.33"><g><path d="M.31,4.9c-.11-.11-.19-.23-.24-.35s-.07-.25-.07-.37c0-.13,.02-.26,.07-.38s.13-.24,.24-.35L3.45,.32c.09-.09,.19-.17,.29-.23s.22-.09,.36-.09,.27,.03,.4,.09,.24,.14,.33,.24,.17,.21,.23,.33,.08,.25,.08,.38-.03,.25-.08,.35-.13,.21-.23,.3l-.87,.89c-.11,.11-.22,.22-.34,.32s-.24,.19-.36,.28h5.99c.15,0,.29,.03,.4,.08s.22,.12,.3,.21,.14,.2,.18,.32,.06,.25,.06,.39-.02,.26-.06,.38-.1,.22-.18,.31-.18,.16-.3,.21-.25,.08-.4,.08H3.42c.12,.09,.25,.18,.37,.28s.23,.2,.34,.32l.76,.79c.1,.1,.18,.2,.23,.31s.08,.22,.08,.34c0,.14-.03,.28-.1,.41s-.15,.25-.26,.36-.22,.19-.36,.25-.27,.09-.4,.09c-.12,0-.23-.03-.34-.08s-.21-.13-.31-.23L.31,4.9Z"></path></g></svg></div><div class=""><p class="line-clamp-1 mb-1">ビジネス・ロジックと連携の指揮を分離すれば良いテストが書ける：単体テストの考え方／使い方 第2部後半</p><p class="text-neutral-500">2023<!-- -->年<!-- -->2<!-- -->月<!-- -->19<!-- -->日</p></div></a></div><div class="w-full sm:w-1/2"><a class="dark:hover:bg-neutral-600 hover:bg-neutral-300 flex group items-center rounded-full transition-all pl-10 justify-end" href="/posts/2023/02/typeddict-is-not-subtype-of-dict"><div class="text-end"><p class="line-clamp-1 mb-1">TypedDictはdictのsubtypeではないので関数の引数にはMappingを使う</p><p class="text-neutral-500">2023<!-- -->年<!-- -->2<!-- -->月<!-- -->6<!-- -->日</p></div><div class="bg-duchs-200 group-hover:bg-duchs-800 flex items-center justify-center h-14 mx-5 first:ml-0 last:mr-0 px-3 rounded-full transition-all w-14"><svg class="fill-duchs-900 group-hover:fill-duchs-100" viewBox="0 0 10.19 8.33"><g><path d="M6.77,3.16c-.12-.09-.25-.18-.37-.28s-.23-.2-.34-.32l-.76-.79c-.1-.1-.18-.2-.23-.31s-.08-.22-.08-.34c0-.14,.03-.28,.1-.41s.15-.25,.26-.36,.22-.19,.36-.25,.27-.09,.4-.09c.12,0,.23,.03,.34,.08s.21,.13,.31,.23l3.12,3.12c.11,.11,.19,.23,.24,.35s.07,.25,.07,.37c0,.13-.02,.26-.07,.38s-.13,.24-.24,.35l-3.13,3.13c-.09,.09-.19,.17-.29,.23s-.22,.09-.36,.09-.27-.03-.4-.09-.24-.14-.33-.24-.17-.21-.23-.33-.08-.25-.08-.38,.03-.25,.08-.35,.13-.21,.23-.3l.87-.89c.11-.11,.22-.22,.34-.32s.24-.19,.36-.28H.95c-.15,0-.29-.03-.4-.08s-.22-.12-.3-.21-.14-.2-.18-.32-.06-.25-.06-.39,.02-.26,.06-.38,.1-.22,.18-.31,.18-.16,.3-.21,.25-.08,.4-.08H6.77Z"></path></g></svg></div></a></div></div></article></main><aside class="col-span-10 md:col-span-3"><div class="mx-auto w-11/12 mb-8"><h2 class="font-black font-display text-duchs-900 dark:text-duchs-100 text-xl">AUTHOR</h2><div class="flex items-center my-3.5"><div class="mr-2.5"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2780%27%20height=%2780%27/%3e"/></span><img alt="アイコン" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="rounded-full" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="アイコン" src="/images/icon.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="rounded-full" loading="lazy"/></noscript></span></div><div><p class="font-black font-display mb-2 text-duchs-900 dark:text-duchs-100 text-lg">Sogo Kato</p><div class="flex"><a class="mr-2 hover:opacity-75 transition-all" target="_blank" href="https://github.com/SogoKato"><div class="dark:hidden"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2720%27%20height=%2720%27/%3e"/></span><img alt="GitHubアイコン" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="GitHubアイコン" src="/images/github-light.svg" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><div class="hidden dark:block"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2720%27%20height=%2720%27/%3e"/></span><img alt="GitHubアイコン" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="GitHubアイコン" src="/images/github-dark.svg" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div></a></div></div></div><p class="mb-2.5 text-xs">クラウド業界に生息する駆け出しへっぽこエンジニア。ラズパイとダックスがすき。資格たくさんほしいので余ってる人はお裾分けください。</p><a href="/profile"><button class="bg-duchs-200 hover:bg-duchs-800 font-black font-display px-3.5 py-0.5 rounded-full text-duchs-900 hover:text-duchs-100 transition-all">MORE</button></a></div><div class="mx-auto w-11/12 mb-8"><h2 class="font-black font-display text-duchs-900 dark:text-duchs-100 text-xl">RECOMMENDED</h2><ul class="mt-3.5"><a class="block mb-3 hover:opacity-75 transition-all" href="/posts/2024/01/langchain-agent-tools-function-calling"><p class="mb-1 text-xs">LangChain agentで関数呼び出し</p><p class="text-neutral-500 text-xs">2024<!-- -->年<!-- -->1<!-- -->月<!-- -->24<!-- -->日</p></a><a class="block mb-3 hover:opacity-75 transition-all" href="/posts/2023/11/rye-with-docker"><p class="mb-1 text-xs">RyeをDockerで使う時のポイント</p><p class="text-neutral-500 text-xs">2023<!-- -->年<!-- -->11<!-- -->月<!-- -->18<!-- -->日</p></a><a class="block mb-3 hover:opacity-75 transition-all" href="/posts/2023/11/implementing-aws-sigv4-server"><p class="mb-1 text-xs">AWS SigV4リクエストの「検証する側」を実装する</p><p class="text-neutral-500 text-xs">2023<!-- -->年<!-- -->11<!-- -->月<!-- -->9<!-- -->日</p></a><a class="block mb-3 hover:opacity-75 transition-all" href="/posts/2023/05/celery-sqlalchemy"><p class="mb-1 text-xs">CeleryにおけるSQLAlchemyのセッション管理</p><p class="text-neutral-500 text-xs">2023<!-- -->年<!-- -->5<!-- -->月<!-- -->15<!-- -->日</p></a><a class="block mb-3 hover:opacity-75 transition-all" href="/posts/2023/05/sqlalchemy-sessions-and-transactions"><p class="mb-1 text-xs">SQLAlchemyのセッション・トランザクションを理解する</p><p class="text-neutral-500 text-xs">2023<!-- -->年<!-- -->5<!-- -->月<!-- -->14<!-- -->日</p></a></ul></div><div class="mx-auto w-11/12 mb-8"><h2 class="font-black font-display text-duchs-900 dark:text-duchs-100 text-xl">TAGS</h2><ul class="flex flex-wrap mt-3.5"><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/python"># <!-- -->Python</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/kubernetes"># <!-- -->Kubernetes</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/docker"># <!-- -->Docker</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/aws"># <!-- -->AWS</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/単体テスト"># <!-- -->単体テスト</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/認証-認可"># <!-- -->認証/認可</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/raspberry-pi"># <!-- -->Raspberry Pi</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/sqlalchemy"># <!-- -->SQLAlchemy</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/読書"># <!-- -->読書</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/fluentd"># <!-- -->Fluentd</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/fastapi"># <!-- -->FastAPI</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/gitlab"># <!-- -->GitLab</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/ci-cd"># <!-- -->CI/CD</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/資格"># <!-- -->資格</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/データベース"># <!-- -->データベース</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/react"># <!-- -->React</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/コンテナ"># <!-- -->コンテナ</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/開発環境"># <!-- -->開発環境</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/go"># <!-- -->Go</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/ニフクラ"># <!-- -->ニフクラ</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/personal"># <!-- -->Personal</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/javascript"># <!-- -->JavaScript</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/next.js"># <!-- -->Next.js</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/terraform"># <!-- -->Terraform</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/squid"># <!-- -->Squid</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/chatgpt"># <!-- -->ChatGPT</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/langchain"># <!-- -->LangChain</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/git"># <!-- -->git</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/cedar"># <!-- -->Cedar</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/rust"># <!-- -->Rust</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/rye"># <!-- -->Rye</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/passkey"># <!-- -->Passkey</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/bitwarden"># <!-- -->Bitwarden</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/github"># <!-- -->GitHub</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/volumio"># <!-- -->Volumio</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/synology"># <!-- -->Synology</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/nas"># <!-- -->NAS</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/rsync"># <!-- -->rsync</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/ログ"># <!-- -->ログ</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/ubuntu"># <!-- -->Ubuntu</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/k3s"># <!-- -->K3s</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/celery"># <!-- -->Celery</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/joy-ui"># <!-- -->Joy-UI</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/kaniko"># <!-- -->Kaniko</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/自宅サーバー"># <!-- -->自宅サーバー</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/ネットワーク"># <!-- -->ネットワーク</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/vpn"># <!-- -->VPN</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/wireguard"># <!-- -->WireGuard</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/haproxy"># <!-- -->HAProxy</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/webassembly"># <!-- -->WebAssembly</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/pyscript"># <!-- -->PyScript</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/ansible"># <!-- -->Ansible</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/apt"># <!-- -->APT</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/api-gateway"># <!-- -->API Gateway</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/orm"># <!-- -->ORM</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/mysql"># <!-- -->MySQL</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/キーボード"># <!-- -->キーボード</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/vs-code"># <!-- -->VS Code</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/openid-connect"># <!-- -->OpenID Connect</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/spa"># <!-- -->SPA</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/tailwind-css"># <!-- -->Tailwind CSS</a></ul></div><div class="mx-auto w-11/12 "><h2 class="font-black font-display text-duchs-900 dark:text-duchs-100 text-xl">LINKS</h2><a class="block mb-1 mt-3.5 hover:opacity-75 transition-all" href="/feed.xml"><p>RSS</p></a><a class="block mb-1 hover:opacity-75 transition-all" target="_blank" href="https://github.com/SogoKato/sogokato.github.io"><p class="flex items-center">GitHub <svg class="fill-neutral-900 dark:fill-neutral-100 h-3 ml-2" viewBox="0 0 7.82 7.82"><g><path d="M4.41,2.01c-.15,.02-.3,.04-.46,.06s-.31,.02-.46,.01l-1.1-.02c-.14,0-.27-.02-.38-.06s-.21-.1-.3-.19c-.1-.1-.17-.22-.22-.36s-.07-.29-.07-.44c0-.15,.02-.29,.07-.43s.12-.26,.22-.35c.09-.09,.18-.15,.29-.18S2.24,0,2.39,0H6.8c.15,0,.29,.03,.41,.08s.23,.12,.31,.21c.09,.09,.17,.2,.22,.32s.08,.26,.08,.41V5.46c0,.13-.02,.26-.05,.37s-.09,.22-.19,.31-.21,.17-.35,.22-.27,.07-.4,.07-.27-.03-.4-.07-.24-.12-.33-.21-.15-.19-.19-.31-.05-.24-.05-.38l-.02-1.24c0-.16,0-.31,.02-.46s.03-.3,.06-.46L1.7,7.53c-.11,.11-.22,.18-.34,.23s-.24,.07-.36,.06-.24-.04-.35-.09-.22-.13-.32-.23-.17-.2-.23-.31S0,6.95,0,6.83s.01-.24,.06-.36,.12-.23,.23-.34L4.41,2.01Z"></path></g></svg></p></a></div></aside><footer class="col-span-10"><div class="flex flex-col items-center py-10"><a class="mb-2 text-xs" href="/privacy">プライバシーポリシー</a><small>Copyright © <!-- -->2024<!-- --> Sogo Kato All rights reserved.</small></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"posts":[{"title":"SquidをDockerで動かす","date":"2024-02-06T00:00:00.000Z","ref":"/posts/2024/02/squid-in-docker","desc":" Squid を Docker コンテナで実行したかったのですが、2024年2月現在で最新の v6 で起動するものがなさそうだったので作りました。apt リポジトリにはビルド済みの squid がないのですが、alpine にはあったので alpine を使うと楽です。また、シャットダウン時の挙動に要注意。\n\n## できたもの\n\n* SogoKato/docker-squid\n* noroch/squid - Docker Image | Docker Hub\n\nsameersbn/docker-squid","draft":false,"tags":[{"name":"Squid","ref":"/tags/squid"},{"name":"Docker","ref":"/tags/docker"}],"showTerminalAside":false},{"title":"LangChain agentで関数呼び出し","date":"2024-01-24T00:00:00.000Z","ref":"/posts/2024/01/langchain-agent-tools-function-calling","desc":" 個人で使っている LINE bot を賢くしたくて、ChatGPT を組み込んでみました。ChatGPT を自分のアプリに組み込むのは初めてなのですが、LangChain の機能の豊富さに驚かされました。\n\n## 対象読者\n\n* 人間のあいまいな指示を機械が実行できるアクションに落とし込ませたい人\n\n## 検証環境\n\n* Python 3.11.6\n* LangChain 0.1.1\n* langchain-openai 0.0.2.post1\n\n## できたもの\n\n```python\nfrom data","draft":false,"tags":[{"name":"ChatGPT","ref":"/tags/chatgpt"},{"name":"LangChain","ref":"/tags/langchain"},{"name":"Python","ref":"/tags/python"}],"showTerminalAside":false},{"title":"Dockerが16KiB以上のログを分割する問題にFluentd側で対処する","date":"2024-01-15T00:00:00.000Z","ref":"/posts/2024/01/fluentd-docker-split-logs","desc":" Docker のログドライバーは 16KiB (16384 バイト) 以上のメッセージの場合、ログを分割してしまいます。\n\nfluent-plugins-nursery/fluent-plugin-concat を使うことで分割されてしまったログを連結して1つにまとめられるようなので検証してみました。\n\n## 試してみる\n\n用意したファイルは以下です。16383バイトのログと16384バイトのログを20秒間隔で出力するアプリを用意して docker の fluentd ログドライバーで fluentd コ","draft":false,"tags":[{"name":"Fluentd","ref":"/tags/fluentd"},{"name":"Docker","ref":"/tags/docker"}],"showTerminalAside":false},{"title":"git-credential-cacheをコンテナから使いたかった","date":"2024-01-11T00:00:00.000Z","ref":"/posts/2024/01/git-credential-cache-in-container","desc":" git でリモートサーバーに HTTPS で接続する時、ユーザー名やパスワードを入力する必要がありますが、push や pull のたびに入力するのは面倒ですよね。git には標準で認証情報を管理してくれる仕組みがあり、毎回の入力を省略することができます。\n\nWindows や Mac の場合は OS の認証情報管理の仕組みと連携することができますが、Linux では `store` モードか `cache` モードしかありません。`store` モードでは平文でパスワードが書き込まれてしまい安全ではない","draft":false,"tags":[{"name":"Docker","ref":"/tags/docker"},{"name":"コンテナ","ref":"/tags/コンテナ"},{"name":"git","ref":"/tags/git"}],"showTerminalAside":false},{"title":"Cedarで（超最小限な）RBAC認可を実装してみる","date":"2023-12-07T00:00:00.000Z","ref":"/posts/2023/12/cedar-rbac","desc":" この記事はニフクラ等を提供している、富士通クラウドテクノロジーズ Advent Calendar 2023の7日目の記事です。\n\n昨日は @George22e さんの ヴァイオリンの音色のよさはスペクトラムアナライザーで分かるか試してみた でした。  \n自らの演奏とプロの演奏を可視化して分析する姿勢にエンジニアリングの精神と通じるものを感じました。私も仕事でも趣味でも本気でエンジニアリングしていきたいです。\n\n今日は AWS が公開しているアクセス制御用のオープンソース言語 Cedar とその認可エンジン","draft":false,"tags":[{"name":"Cedar","ref":"/tags/cedar"},{"name":"AWS","ref":"/tags/aws"},{"name":"認証/認可","ref":"/tags/認証-認可"},{"name":"Rust","ref":"/tags/rust"}],"showTerminalAside":false},{"title":"RyeをDockerで使う時のポイント","date":"2023-11-18T00:00:00.000Z","ref":"/posts/2023/11/rye-with-docker","desc":" Rye は Rust 製の Python パッケージマネージャです。まだ「実験的」なステータスなので全ての方にお勧めできる段階ではないかもしれないですが、十分に実用的で安定していると思います。Pipenv や Poetry との違いは、パッケージ管理だけでなく、Python バージョンの管理までやってくれるところが特徴で、Pipenv/Poetry + pyenv が1つのツールにまとまっているイメージです。\n\nさて、今回は Rye を Docker コンテナで使う時のポイントをまとめてみました。Rye ","draft":false,"tags":[{"name":"Python","ref":"/tags/python"},{"name":"Rye","ref":"/tags/rye"},{"name":"Docker","ref":"/tags/docker"}],"showTerminalAside":false},{"title":"AWS SigV4リクエストの「検証する側」を実装する","date":"2023-11-09T00:00:00.000Z","ref":"/posts/2023/11/implementing-aws-sigv4-server","desc":" 世の中には AWS Signature V4 署名の実装方法についての記事はたくさんありますが、その署名を付与して検証する側（サーバー）の実装方法について見つけるのは難しいです。AWS API Gateway を使えば簡単に自分で書かなくても良いのでそれはそうなのですが、AWS SigV4 は curl のオプションとしても使える くらいの地位を獲得しているので、AWS SigV4 を利用した認証機能の実装方法についての記事があってもいいでしょう。\n\nということで、今回は Python と FastAPI","draft":false,"tags":[{"name":"認証/認可","ref":"/tags/認証-認可"},{"name":"AWS","ref":"/tags/aws"},{"name":"Python","ref":"/tags/python"},{"name":"FastAPI","ref":"/tags/fastapi"}],"showTerminalAside":false},{"title":"Bitwardenブラウザ拡張がPasskeyに対応したので試してみた","date":"2023-11-08T00:00:00.000Z","ref":"/posts/2023/11/bitwarden-passkey","desc":" パスワードマネージャによる Passkey のサポートが進んでいます。\n\n私は Bitwarden を使ってパスワードなどの機密情報を保存しているのですが、ついに Bitwarden による Passkey 対応が始まりました。公式ブログでも11月7日に投稿されています。\n\n## 環境\n\n* Bitwarden Firefox アドオン 2023.10.1\n* Firefox 118.0.2\n\n## 試してみる\n\n既にいくつものサービスが Passkey 対応していますが、今回は Google アカウント","draft":false,"tags":[{"name":"Passkey","ref":"/tags/passkey"},{"name":"Bitwarden","ref":"/tags/bitwarden"},{"name":"認証/認可","ref":"/tags/認証-認可"}],"showTerminalAside":false},{"title":"GitLabのRemote developmentを試してみる","date":"2023-10-24T00:00:00.000Z","ref":"/posts/2023/10/gitlab-remote-development","desc":" VS Code Serverでリモートホストのコンテナ上開発環境に直接アクセスするの記事にて GitHub でやっている「ぼくのかんがえたさいきょうのかいはつかんきょう」第2弾です。今回は GitLab を使ってリモート開発環境を構築してみたいと思います。  \nなお、GitLab には Premium 以上のライセンスで使える Workspaces という機能が 16.0 で登場しましたが、今回はそれではなく、自分でコンテナを立ててそこにアクセスする形になります。こちらは無料ライセンスで使えます。ただし執","draft":false,"tags":[{"name":"GitLab","ref":"/tags/gitlab"},{"name":"開発環境","ref":"/tags/開発環境"}],"showTerminalAside":false},{"title":"GitHub ActionsでGo製ツールをビルド\u0026リリース【GoReleaser】","date":"2023-09-26T00:00:00.000Z","ref":"/posts/2023/09/github-actions-goreleaser","desc":" 前回の記事で紹介した nifdiff をリリースする際に、簡単に GitHub actions を使って Go 製ツールをビルドしてリリースする方法を見つけたのでメモです。\n\n## ポイント\n\n* GoReleaser を使うと Go で作ったソフトウェアを素早く出荷できる\n* kyoh86/git-vertag-action を使うと最新のバージョンから +1 メジャー・マイナー・パッチバージョンアップしたバージョンのタグを作成できる\n\n## 今回やったこと\n\n* Go 製ツールをクロスコンパイルして、","draft":false,"tags":[{"name":"Go","ref":"/tags/go"},{"name":"GitHub","ref":"/tags/github"},{"name":"CI/CD","ref":"/tags/ci-cd"}],"showTerminalAside":false},{"title":"ニフクラのリソースを比較できるツールnifdiffを作った","date":"2023-09-25T00:00:00.000Z","ref":"/posts/2023/09/nifdiff","desc":" 2つのファイアウォールグループのルールの差分を見たいことがあって、ちょっとしたツールを作ってみました。\n\n## nifdiff とは\n\n* 2つのニフクラリソースの差分を見ることができるツール\n* 同一アカウント内であれば、リージョンまたぎで比較できる\n* 現状対応しているのはファイアウォールグループのみ\n\nhttps://github.com/SogoKato/nifdiff\n\nこんな感じのコマンドを投げると\n\n```\nnifdiff nrn:nifcloud:computing:jp-east-1::","draft":false,"tags":[{"name":"ニフクラ","ref":"/tags/ニフクラ"},{"name":"Go","ref":"/tags/go"}],"showTerminalAside":false},{"title":"AWS Certified Solutions Architect - Professionalを取得した","date":"2023-09-21T00:00:00.000Z","ref":"/posts/2023/09/aws-solutions-architect-professional","desc":" AWS 認定ソリューションアーキテクト - Professional (SAP-C02) の資格を取得したので学習メモです。\n\n過去の資格に関する記事はこちら\n* AWS Certified Solutions Architect - Associateを取得した\n* CKAD受検記録【2023年版】\n* GCP未経験の新卒2年目がAssociate Cloud EngineerとProfessional Cloud Architectを連続で受検したときの記録\n* 新卒エンジニアがCKA取得を目指してK","draft":false,"tags":[{"name":"AWS","ref":"/tags/aws"},{"name":"資格","ref":"/tags/資格"}],"showTerminalAside":false},{"title":"FluentdをDocker SwarmにDaemonSet的に配置してログを収集する","date":"2023-09-15T00:00:00.000Z","ref":"/posts/2023/09/fluentd-docker-swarm","desc":" Docker Swarm 上のサービスのログを fluentd を使って送信するためのメモです。\n\nKubernetes で同様のことを実現する場合、Forwarder として使う fluentd を DaemonSet として起動してノード上のログを集めさせることが一般的です。今回は Swarm クラスター内の各ノードに1つずつ fluentd を起動して、あるノード上で動くコンテナのログはそのノード上の fluentd に集まるように設定していきます。\n\n## ポイント\n\n* 各ノードに配置するには ","draft":false,"tags":[{"name":"Fluentd","ref":"/tags/fluentd"},{"name":"Docker","ref":"/tags/docker"}],"showTerminalAside":false},{"title":"Raspberry Pi Zero WHにVolumio 3を入れる場合は2系からアップグレードする","date":"2023-09-09T00:00:00.000Z","ref":"/posts/2023/09/volumio-raspberrypi-zero","desc":" 掲題の通りです。今更ながら、その辺に転がっているラズパイゼロ（初代、Wi-Fi 付）とその辺に転がっている中華 USB-DAC を使って Spotify Connect 用の環境を整えようと Volumio を入れてみました。\n\n## 使ったもの\n\n* Raspberry Pi Zero WH\n* Micro SD\n* 電源（Apple の 5W 1A のやつで十分）\n* Micro USB ケーブル\n* USB OTG ケーブル（Micro USB オスから USB A メスに変換するやつ）\n* Min","draft":false,"tags":[{"name":"Volumio","ref":"/tags/volumio"},{"name":"Raspberry Pi","ref":"/tags/raspberry-pi"}],"showTerminalAside":false},{"title":"AWS Certified Solutions Architect - Associateを取得した","date":"2023-08-13T00:00:00.000Z","ref":"/posts/2023/08/aws-solutions-architect-associate","desc":" AWS 認定ソリューションアーキテクト - Associate (SAA-C03) の資格を取得したので学習メモです。\n\n過去の資格に関する記事はこちら\n* CKAD受検記録【2023年版】\n* GCP未経験の新卒2年目がAssociate Cloud EngineerとProfessional Cloud Architectを連続で受検したときの記録\n* 新卒エンジニアがCKA取得を目指してKubernetesを勉強したときの記録\n\n続きの記事 → AWS Certified Solutions Arc","draft":false,"tags":[{"name":"AWS","ref":"/tags/aws"},{"name":"資格","ref":"/tags/資格"}],"showTerminalAside":false},{"title":"SynologyのHyper Backupを使って自分のサーバーへバックアップ（rsync over SSH）","date":"2023-07-22T00:00:00.000Z","ref":"/posts/2023/07/synology-hyper-backup-rsync-over-ssh","desc":" 先日 Synology の NAS を導入したのですが、耐障害性を考慮すると別の拠点とのバックアップが欲しくなってきます。Synology の NAS は QuickConnect を利用することで Synology 社のサーバーを経由することで、自宅のポートを開放せずに構築することができるのがメリットです。バックアップ用途のためだけでにポートを開放するのはアレなので、自宅からのアウトバウンドの通信で定期的にバックアップを行う方法を検討しました。\n\n## 構成\n\n超シンプル構成です。\n\n!構成図\n\nNAS","draft":false,"tags":[{"name":"Synology","ref":"/tags/synology"},{"name":"NAS","ref":"/tags/nas"},{"name":"rsync","ref":"/tags/rsync"}],"showTerminalAside":false},{"title":"Fluentdでニフクラのオブジェクトストレージサービスにログを送る","date":"2023-07-05T00:00:00.000Z","ref":"/posts/2023/07/fluentd-nifcloud-object-storage-service","desc":" Fluentd の fluent-plugin-s3 を使ってニフクラのオブジェクトストレージサービスにログをアップロードする時のメモです。\n\n## ポイント\n\n* `s3_endpoint` を指定する\n  * https://jp-east-1.storage.api.nifcloud.com または https://jp-west-2.storage.api.nifcloud.com\n  * 参照: エンドポイント\n* `force_path_style` を true にする\n  * オブジェクト","draft":false,"tags":[{"name":"Fluentd","ref":"/tags/fluentd"},{"name":"ニフクラ","ref":"/tags/ニフクラ"},{"name":"ログ","ref":"/tags/ログ"}],"showTerminalAside":false},{"title":"シンプル思考を徹底しよう：この半年の振り返り","date":"2023-06-25T00:00:00.000Z","ref":"/posts/2023/06/reflection","desc":" 先日、この半年くらい担当させてもらった仕事が一区切りついたので振り返りをしておこうかなと思います。\n\n全部よくある話だと思いますが、「経験しないとわからないこともあるものだ」ということで、今回は思考垂れ流し回です。\n\n## とにかく余裕を\n\n取り掛かり始めたころ、諸先輩方にファーストリリースではとにかく最低限のものを作るように言われたが、今ならそれが身に沁みてわかる。スケジュール的に余裕を持たせる効果のほか、エンハンスの伸びしろも大きくなるので、リリース後に機能拡充していくことで対外的な見た目が良くなる効","draft":false,"tags":[{"name":"Personal","ref":"/tags/personal"}],"showTerminalAside":false},{"title":"KubernetesのPodからラズパイのGPIOを操作する","date":"2023-06-24T00:00:00.000Z","ref":"/posts/2023/06/k8s-raspi-gpio","desc":" 今まで Docker Compose で動かしてたアプリを Kubernetes に移植したときのメモです。\n\n## Docker Compose では\n\nDocker の `--device` オプションと同じ記法で指定できていました。\n\n```yaml\nservices:\n  app:\n    image: hoge\n    devices:\n      - /dev/gpiomem\n```\n\n## Kubernetes では\n\nデバイスプラグインを使用して Kubelet にハードウェアリソースを知","draft":false,"tags":[{"name":"Kubernetes","ref":"/tags/kubernetes"},{"name":"Raspberry Pi","ref":"/tags/raspberry-pi"}],"showTerminalAside":false},{"title":"Ubuntu 22.04ではusercfg.txtがデフォルトでincludeされていないので注意","date":"2023-06-14T00:00:00.000Z","ref":"/posts/2023/06/ubuntu-22.04-raspi-config.txt","desc":" タイトルの通りです。これにしばらくハマってしまったので戒めのために書いておきます。\n\n## tl;dr\n\nUbuntu 20.04 の時と同じ設定ファイルをラズパイの /boot/firmware に入れていたけど反映されていなかった。調べてみたらそのファイルを include する文が Ubuntu 22.04 では消されていた。\n\n## そもそも config.txt とは？\n\n\u003e The Raspberry Pi uses a configuration file instead of the BI","draft":false,"tags":[{"name":"Ubuntu","ref":"/tags/ubuntu"},{"name":"Raspberry Pi","ref":"/tags/raspberry-pi"}],"showTerminalAside":false},{"title":"ラズパイでK3sクラスター構築","date":"2023-06-13T00:00:00.000Z","ref":"/posts/2023/06/k3s-setup","desc":" 今まで kubeadm でクラスター運用をしていたのですが、ラズパイくんたちのお引越しの関係で再構築することにしました。Raspberry Pi 4B 2GB や 3A+（RAM 512MB）も join させたかったこともあり、エッジ環境での動作も想定されている K3s を選びました。\n\n## 環境\n\n* Raspberry Pi 4B 8GB x 2, Raspberry Pi 4B 4GB x 1, Raspberry Pi 4B 2GB x 1\n  * SSD ブート\n  * PoE+ 電源\n  ","draft":false,"tags":[{"name":"Kubernetes","ref":"/tags/kubernetes"},{"name":"K3s","ref":"/tags/k3s"},{"name":"Raspberry Pi","ref":"/tags/raspberry-pi"}],"showTerminalAside":false},{"title":"CeleryにおけるSQLAlchemyのセッション管理","date":"2023-05-15T00:00:00.000Z","ref":"/posts/2023/05/celery-sqlalchemy","desc":" 前回の記事では SQLAlchemy の Session について解説しました。今回はその応用として、Celery においてどのように Session を管理するかを考えたいと思います。\n\n関連記事：\n* SQLAlchemyのセッション・トランザクションを理解する\n* SQLAlchemyで'MySQL server has gone away'が発生した時の対処法2つ\n\n## 結論\n\n以下のように DB 操作を行うタスクのためのクラスを作ります。\n\n```python\nfrom typing impo","draft":false,"tags":[{"name":"Python","ref":"/tags/python"},{"name":"SQLAlchemy","ref":"/tags/sqlalchemy"},{"name":"データベース","ref":"/tags/データベース"},{"name":"Celery","ref":"/tags/celery"}],"showTerminalAside":false},{"title":"SQLAlchemyのセッション・トランザクションを理解する","date":"2023-05-14T00:00:00.000Z","ref":"/posts/2023/05/sqlalchemy-sessions-and-transactions","desc":" SQLAlchemy の Session や scoped_session、トランザクションに関して理解していきます。\n\n## 用語おさらい\n\n### セッション（Session）\n\nSQLAlchemy の Session オブジェクトは、ORM マッピングされたオブジェクトの永続化に関する操作を管理するオブジェクトです。\n\n`sqlalchemy.orm.Session` を直接インスタンス化しても良いですが、実環境では sessionmaker を使うことが一般的です。sessionmaker は ","draft":false,"tags":[{"name":"Python","ref":"/tags/python"},{"name":"SQLAlchemy","ref":"/tags/sqlalchemy"},{"name":"データベース","ref":"/tags/データベース"}],"showTerminalAside":true},{"title":"Reactで検索・ソート可能なDataTableを自作する","date":"2023-04-22T00:00:00.000Z","ref":"/posts/2023/04/datatable-react","desc":" 最近、MUI の妹分の UI ライブラリである Joy-UI を使ってます。現在進行形で活発に開発が進んでいて、設計（デザイン）も今時な感じで好感触です。ところどころまだ開発されていないコンポーネントもちらほらあるものの、ドキュメントには代替策がコード付きで載っていてとても親切です。\n\nMUI X というより発展的なコンポーネントをもつ UI ライブラリもあるのですが、そこに今回のテーマである「データテーブル」に該当する Data Grid というものがあります。これは超すごくて、雑に言うと Excel ","draft":false,"tags":[{"name":"React","ref":"/tags/react"},{"name":"Joy-UI","ref":"/tags/joy-ui"}],"showTerminalAside":false},{"title":"Kanikoでコンテナイメージつくるならcache=trueは有効にしておこう","date":"2023-04-18T00:00:00.000Z","ref":"/posts/2023/04/kaniko-cache","desc":" !ぜんぜんわからない　俺たちは雰囲気でカニコをやっている\n\n恥ずかしながら、わたしは雰囲気で kaniko にコンテナイメージのビルドをしてもらっていることに気づきました。1年以上 GitLab CI で kaniko を使っておきながら、ただ「特権コンテナを使わずにイメージつくれるやつ」くらいの認識しかしていなかったです。\n\n## kaniko の cache=true オプション\n\nkaniko には `--cache` というフラグがあり、これを true にすることでコンテナのビルド時にキャッシュ","draft":false,"tags":[{"name":"Kaniko","ref":"/tags/kaniko"},{"name":"CI/CD","ref":"/tags/ci-cd"},{"name":"コンテナ","ref":"/tags/コンテナ"},{"name":"GitLab","ref":"/tags/gitlab"}],"showTerminalAside":false},{"title":"IPoE回線の自宅のWebサービスをVPN経由で固定IPのクラウドから公開する","date":"2023-04-15T00:00:00.000Z","ref":"/posts/2023/04/reverse-proxy-to-home-ipoe-network","desc":" PPPoE 回線が遅いので IPoE（IPv4 over IPv6）へ移行しようと思いました。以前は2つのルーターを使って、PPPoE と IPoE の2セッションを張ることができたのですが、ある時からできなくなり、しばらく PPPoE だけで生活していました。とはいえやはり遅い、遅すぎる……ということで、今回の記事に至ります。\n\nIPoE に移行するにあたっての課題は**任意のポートを開放できないこと**です。\n\n代わりの方法を考えていたところ、ちょうど手元に1台 AWS Lightsail のサーバー","draft":false,"tags":[{"name":"自宅サーバー","ref":"/tags/自宅サーバー"},{"name":"ネットワーク","ref":"/tags/ネットワーク"},{"name":"VPN","ref":"/tags/vpn"},{"name":"WireGuard","ref":"/tags/wireguard"},{"name":"HAProxy","ref":"/tags/haproxy"}],"showTerminalAside":false},{"title":"CKAD受検記録【2023年版】","date":"2023-03-30T00:00:00.000Z","ref":"/posts/2023/03/certified-kubernetes-application-developer","desc":" 2023年3月30日に Certified Kubernetes Application Developer (CKAD) を受験し、合格しましたのでその受検記録記事です。ちょうど1年前に Certified Kuberenetes Administrator (CKA) を取っていたので、その続きとなります。\n\n前回の記事：新卒エンジニアがCKA取得を目指してKubernetesを勉強したときの記録\n\n## 対象読者\n\n* Kubernetes を使っているが、資格はまだ取ってない人\n* CKA を取っ","draft":false,"tags":[{"name":"Kubernetes","ref":"/tags/kubernetes"},{"name":"資格","ref":"/tags/資格"}],"showTerminalAside":false},{"title":"PyScriptを使ってブログのサンプルコードを実行させる","date":"2023-03-06T00:00:00.000Z","ref":"/posts/2023/03/pyscript-codeblock","desc":" 前回の記事を書くときに WebAssembly でブログのコードブロックのコードを実行させられたら面白いかも、ということで PyScript を使って実装してみました。React \u0026 Next.js で使う際の注意点についても書こうと思います。\n\n以下については前提知識としてこの記事では解説しません。\n\n* PyScript\n* Pyodide\n* WebAssembly\n* react-markdown のコードブロック（バッククォート3つ \\```）をカスタマイズする方法\n\n## やったこと\n\n* r","draft":false,"tags":[{"name":"Python","ref":"/tags/python"},{"name":"WebAssembly","ref":"/tags/webassembly"},{"name":"PyScript","ref":"/tags/pyscript"},{"name":"JavaScript","ref":"/tags/javascript"},{"name":"React","ref":"/tags/react"},{"name":"Next.js","ref":"/tags/next.js"}],"showTerminalAside":true},{"title":"Pythonのunittest.mock.patchではどこにパッチするかが重要","date":"2023-03-04T00:00:00.000Z","ref":"/posts/2023/03/python-unittest-mock-where-to-patch","desc":" Python 公式ドキュメントの unittest.mock のページにドンピシャの内容が書いてありますが、なかなか気づけずにハマってしまっていたのでメモです。\n\n`unittest.mock.patch` でパッチしたけど当たってない気がする人は参考にしてみてください。\n\n下記の引用に要点が凝縮されています。\n\n\u003e ### どこにパッチするか\n\u003e\n\u003e `patch()` は (一時的に) ある 名前 が参照しているオブジェクトを別のものに変更することで適用されます。任意のオブジェクトには、それを参照する","draft":false,"tags":[{"name":"Python","ref":"/tags/python"},{"name":"単体テスト","ref":"/tags/単体テスト"}],"showTerminalAside":true},{"title":"Ansibleでgpg公開鍵とaptのサードパーティリポジトリを追加する ～Terraformをインストールしたい～","date":"2023-03-01T00:00:00.000Z","ref":"/posts/2023/03/ansible-apt-repo-signed-by-gpg-key","desc":" apt を使って docker や terraform をインストールする時など、提供元のサードパーティ apt リポジトリを追加する場合が結構ありますよね。その際に、今までは `apt-key` を使って OpenPGP 公開鍵をインポートしていたのですが、`apt-key` は Debian 11 と Ubuntu 22.04 を最後に使えなくなる ので、今後は `gnupg` を使った方法が主流になっていきます。\n\nAnsible にも ansible.builtin.apt_key module ","draft":false,"tags":[{"name":"Ansible","ref":"/tags/ansible"},{"name":"Terraform","ref":"/tags/terraform"},{"name":"APT","ref":"/tags/apt"}],"showTerminalAside":false},{"title":"TerraformでAPI Gatewayのスロットリングを設定する","date":"2023-02-23T00:00:00.000Z","ref":"/posts/2023/02/aws-api-gateway-terraform-throttling-settings","desc":" AWS API Gateway のスロットリングを Terraform を使って設定する方法を見つけるまでに少し手間取ったのでメモ。\n\n## AWS マネジメントコンソールでの場所\n\n今回 Terraform で設定するのは、マネジメントコンソールの各ステージの設定画面内の「デフォルトのメソッドスロットリング」に該当する箇所です。\n\n!management console\n\n## そもそも API Gateway のスロットリングとは\n\nAPI Gateway では API が1秒あたりに処理できるリクエ","draft":false,"tags":[{"name":"AWS","ref":"/tags/aws"},{"name":"API Gateway","ref":"/tags/api-gateway"},{"name":"Terraform","ref":"/tags/terraform"}],"showTerminalAside":false},{"title":"プロセス外依存は統合テストで確認しよう：単体テストの考え方／使い方 第3部","date":"2023-02-22T00:00:00.000Z","ref":"/posts/2023/02/unit-testing-principles-practices-and-patterns-part3","desc":" 『単体テストの考え方／使い方』（Vladimir Khorikov 著、須田智之訳）を読んだので、そのまとめを部ごとに書いていこうと思います。\n\n1. 単体テストの目的・定義・学派・命名について：単体テストの考え方／使い方 第1部\n1. リファクタリングしやすいテストを書こう：単体テストの考え方／使い方 第2部前半\n1. ビジネス・ロジックと連携の指揮を分離すれば良いテストが書ける：単体テストの考え方／使い方 第2部後半\n1. プロセス外依存は統合テストで確認しよう：単体テストの考え方／使い方 第3部（こ","draft":false,"tags":[{"name":"単体テスト","ref":"/tags/単体テスト"},{"name":"読書","ref":"/tags/読書"}],"showTerminalAside":false},{"title":"ビジネス・ロジックと連携の指揮を分離すれば良いテストが書ける：単体テストの考え方／使い方 第2部後半","date":"2023-02-19T00:00:00.000Z","ref":"/posts/2023/02/unit-testing-principles-practices-and-patterns-part2-2","desc":" 『単体テストの考え方／使い方』（Vladimir Khorikov 著、須田智之訳）を読んでいるので、そのまとめを部ごとに書いていこうと思います。\n\n1. 単体テストの目的・定義・学派・命名について：単体テストの考え方／使い方 第1部\n1. リファクタリングしやすいテストを書こう：単体テストの考え方／使い方 第2部前半\n1. ビジネス・ロジックと連携の指揮を分離すれば良いテストが書ける：単体テストの考え方／使い方 第2部後半（この記事）\n1. プロセス外依存は統合テストで確認しよう：単体テストの考え方／使","draft":false,"tags":[{"name":"単体テスト","ref":"/tags/単体テスト"},{"name":"読書","ref":"/tags/読書"}],"showTerminalAside":false},{"title":"FastAPIとSQLAlchemy2.0ならもう型ヒントを諦めなくていい","date":"2023-02-08T00:00:00.000Z","ref":"/posts/2023/02/fastapi-orm-sqlalchemy","desc":" サチコ（Google Search Console）を眺めていたら `FastAPI MySQL` がそれなりに需要ありそうと思ったので、FastAPI と SQLAlchemy を組み合わせて ORM を使う方法を紹介したいと思います。最近の SQLAlchemy（1.4以降）ではマッピングされたオブジェクトに型を適用することもできるので、型ヒントを活かして型安全なコードを書くことも難しくなくなっています。\n\n## 環境\n\n* Python 3.10.6\n* FastAPI 0.89.1\n* SQLAl","draft":false,"tags":[{"name":"Python","ref":"/tags/python"},{"name":"FastAPI","ref":"/tags/fastapi"},{"name":"SQLAlchemy","ref":"/tags/sqlalchemy"},{"name":"ORM","ref":"/tags/orm"}],"showTerminalAside":false},{"title":"TypedDictはdictのsubtypeではないので関数の引数にはMappingを使う","date":"2023-02-06T00:00:00.000Z","ref":"/posts/2023/02/typeddict-is-not-subtype-of-dict","desc":" Python の dict（辞書）を TypeScript の interface のように扱えて便利な TypedDict ですが、**dict のサブクラスではない**というのが少し落とし穴だなと思ったのでメモ。\n\n## まずは PEP を見よう\n\n大抵のことは公式ドキュメントを見れば書いてあります。今回も例外なくそうでした。\n\n\u003e First, any TypedDict type is consistent with `Mapping[str, object]`.\n\nhttps://peps.py","draft":false,"tags":[{"name":"Python","ref":"/tags/python"}],"showTerminalAside":false},{"title":"リファクタリングしやすいテストを書こう：単体テストの考え方／使い方 第2部前半","date":"2023-02-04T00:00:00.000Z","ref":"/posts/2023/02/unit-testing-principles-practices-and-patterns-part2-1","desc":" 『単体テストの考え方／使い方』（Vladimir Khorikov 著、須田智之訳）を読んでいるので、そのまとめを部ごとに書いていこうと思います。\n\n1. 単体テストの目的・定義・学派・命名について：単体テストの考え方／使い方 第1部\n1. リファクタリングしやすいテストを書こう：単体テストの考え方／使い方 第2部前半（この記事）\n1. ビジネス・ロジックと連携の指揮を分離すれば良いテストが書ける：単体テストの考え方／使い方 第2部後半\n1. プロセス外依存は統合テストで確認しよう：単体テストの考え方／使","draft":false,"tags":[{"name":"単体テスト","ref":"/tags/単体テスト"},{"name":"読書","ref":"/tags/読書"}],"showTerminalAside":false},{"title":"単体テストの目的・定義・学派・命名について：単体テストの考え方／使い方 第1部","date":"2023-01-17T00:00:00.000Z","ref":"/posts/2023/01/unit-testing-principles-practices-and-patterns-part1","desc":" 『単体テストの考え方／使い方』（Vladimir Khorikov 著、須田智之訳）を読んでいるので、そのまとめを部ごとに書いていこうと思います。\n\n1. 単体テストの目的・定義・学派・命名について：単体テストの考え方／使い方 第1部（この記事）\n1. リファクタリングしやすいテストを書こう：単体テストの考え方／使い方 第2部前半\n1. ビジネス・ロジックと連携の指揮を分離すれば良いテストが書ける：単体テストの考え方／使い方 第2部後半\n1. プロセス外依存は統合テストで確認しよう：単体テストの考え方／使","draft":false,"tags":[{"name":"単体テスト","ref":"/tags/単体テスト"},{"name":"読書","ref":"/tags/読書"}],"showTerminalAside":false},{"title":"SQLAlchemyで'MySQL server has gone away'が発生した時の対処法2つ","date":"2023-01-12T00:00:00.000Z","ref":"/posts/2023/01/sqlalchemy-dealing-with-disconnects","desc":" FastAPI で SQLAlchemy を使っている時に、コンテナを立てた直後は問題ないけど一定時間経過後に DB 接続が切れてしまう問題に遭遇したのでその時に調べたことのメモ。\n\n## 環境\n\n* mysql 5.7.15\n* SQLAlchemy 1.4.45\n* mysqlclient 2.1.1\n\n## 問題\n\n```\nMySQLdb.OperationalError: (2006, 'MySQL server has gone away')\n```\n\n最後に MySQL サーバーに接続してから","draft":false,"tags":[{"name":"Python","ref":"/tags/python"},{"name":"SQLAlchemy","ref":"/tags/sqlalchemy"},{"name":"MySQL","ref":"/tags/mysql"},{"name":"データベース","ref":"/tags/データベース"}],"showTerminalAside":false},{"title":"2023年版 キーボードマッピングの個人的メモ","date":"2023-01-08T00:00:00.000Z","ref":"/posts/2023/01/keyboard-remap","desc":" 不定期的に「あーでもない、こーでもない」と言ってキーボードのマッピングをいじりだしてしまうことってありますよね。私はあります。限りあるキーの中から自分にとっての最適解を見つける作業はなんだかんだ楽しいです。\n\n今回は 2023 年版、私のキーボードのマッピングを書きとめておこうと思います。\n\n過去の記事: Windows10 と PowerToys で US キーボードでも無変換・変換キーを使って IME を一発で切り替える\n\n## 環境\n\n* 使うパソコン\n  * Windows デスクトップ\n  * ","draft":false,"tags":[{"name":"キーボード","ref":"/tags/キーボード"}],"showTerminalAside":false},{"title":"プロキシ環境でKubernetes構築（Containerd+Calico）","date":"2022-12-27T00:00:00.000Z","ref":"/posts/2022/12/kubernetes-behind-proxy","desc":" 同期と一緒にトラシュしたので、プロキシ環境下で kubeadm + Containerd + Calico の Kubernetes クラスターを構築する方法について記録を残します。\n\n## 環境\n\n* Ubuntu 22.04\n  * サーバーはニフクラを利用（e-medium4 2vCPU/4GB）\n* Kubernetes v1.26.0\n* kubeadm v1.26.0\n* Containerd v1.6.14\n* Calico v3.24.5\n\nコントロールプレーン、ノード1台ずつの構成としま","draft":false,"tags":[{"name":"Kubernetes","ref":"/tags/kubernetes"}],"showTerminalAside":false},{"title":"Ubuntu 22.04でのKubernetesクラスター構築（ContainerdとSystemdCgroup）","date":"2022-12-26T00:00:00.000Z","ref":"/posts/2022/12/kubernetes-ubuntu22.04-cgroup-systemd","desc":" 公式ドキュメントのコマンドを手順通り流し込めば割と簡単に構築できる Kubernetes クラスターですが、Ubuntu 22.04 になってから少し手を入れる必要が出てきたので差分を紹介しておきます。\n\n**2022-02-16 更新：Kubernetes ドキュメントの日本語版が更新されていたのでリライトしました。**\n\n## 環境\n\n* Ubuntu 22.04\n* Kubernetes v1.26.0\n* kubeadm v1.26.0\n* Containerd v1.6.16\n\n## 何が変わっ","draft":false,"tags":[{"name":"Kubernetes","ref":"/tags/kubernetes"}],"showTerminalAside":false},{"title":"KubernetesでCoreDNSがループしてしまう問題への対処","date":"2022-12-24T00:00:00.000Z","ref":"/posts/2022/12/kubernetes-coredns-loop","desc":" 1年前にも Kubernetes クラスターを自力で組んでトラブルシューティングしてみる【The Hard Way】の記事の中で軽く解説したネタです。\n\n## 環境\n\n* Ubuntu 22.04\n* Kubernetes v1.26.0\n* kubeadm v1.26.0\n\n## 問題\n\nKubernetes クラスター内で名前解決に使われる CoreDNS の Pod が `CrashLoopBackOff` になってしまい再起動を繰り返す問題が発生することがあります。\n\n```\n# kubectl ","draft":false,"tags":[{"name":"Kubernetes","ref":"/tags/kubernetes"}],"showTerminalAside":false},{"title":"VS Code Serverでリモートホストのコンテナ上開発環境に直接アクセスする","date":"2022-12-17T00:00:00.000Z","ref":"/posts/2022/12/vscode-server-devcontainer","desc":" 今回は「ぼくのかんがえたさいきょうのかいはつかんきょう」を紹介したいと思います。\n\nVS Code Server を使い、リモートサーバー上でコンテナとして動かしている開発環境に直接乗り込んでみよう、というアイデアです。\n\nSSH もポート開放も不要なのでとてもお手軽です。\n\n## 2023/10/24 追記\n\nGitLab のリモート開発環境も試してみました。\n\nGitLabのRemote developmentを試してみる\n\n## 2023/06/14 追記\n\n以下で紹介する方法が最近は使えなくなって","draft":false,"tags":[{"name":"VS Code","ref":"/tags/vs-code"},{"name":"開発環境","ref":"/tags/開発環境"}],"showTerminalAside":false},{"title":"よくあるSPA+API構成でのOpenID Connectクライアント実装","date":"2022-12-02T00:00:00.000Z","ref":"/posts/2022/12/openid-connect-fastapi","desc":" この記事はニフクラ等を提供している、富士通クラウドテクノロジーズ Advent Calendar 2022の2日目の記事です。\n\n昨日は @ntoofu さんの パケットキャプチャからKubernetes APIのTLS通信を解析する でした。  \n私は TLS な時点でパケットキャプチャを諦めてしまいそうですが Linux の便利な仕組みと気合があれば TLS 1.3 のパケットキャプチャも可能だとわかり、とても有益でした。私もギークなエンジニア目指して頑張ります。\n\n今日は OpenID Connec","draft":false,"tags":[{"name":"OpenID Connect","ref":"/tags/openid-connect"},{"name":"認証/認可","ref":"/tags/認証-認可"},{"name":"SPA","ref":"/tags/spa"},{"name":"Python","ref":"/tags/python"},{"name":"FastAPI","ref":"/tags/fastapi"}],"showTerminalAside":false},{"title":"GitLab CIのrulesとworkflowを理解する","date":"2022-11-17T00:00:00.000Z","ref":"/posts/2022/11/gitlab-rules-workflow","desc":" GitLab CI の rules を使って Dockerfile などの特定のファイルの変更時のみ Docker イメージを作成するパイプラインを回して、それ以外の時には既存の Docker イメージを使用して CI を実行する、という組み方をしたかったのですが、書き方に結構手間取ったのでメモ。\n\n環境: GitLab.com 15.6.0-pre\n\n## rules とは\n\nhttps://docs.gitlab.com/ee/ci/yaml/#rules\n\nそれぞれのジョブについて、パイプラインに追","draft":false,"tags":[{"name":"GitLab","ref":"/tags/gitlab"},{"name":"CI/CD","ref":"/tags/ci-cd"}],"showTerminalAside":false},{"title":"Next.jsとTailwind CSSでブログを作るときに考えたこと","date":"2022-11-13T00:00:00.000Z","ref":"/posts/2022/11/blog-with-nextjs-and-tailwindcss","desc":" このブログは Next.js の SSG（Static Site Generation; 静的サイト生成）機能を使いながら、デザインの大半は Tailwind CSS を使用して整えています。そして生成された HTML, CSS, JS は GitHub Pages でホストさせてもらっています。\n\nそこそこの出来栄えになったので、今回はこのブログができるまでのお話をしたいなと思ったのですが、正直なところ、以下のリンク先のページを~~まるパク~~参考にさせてもらいながら作成したので、具体的な構築方法につい","draft":false,"tags":[{"name":"JavaScript","ref":"/tags/javascript"},{"name":"React","ref":"/tags/react"},{"name":"Next.js","ref":"/tags/next.js"},{"name":"Tailwind CSS","ref":"/tags/tailwind-css"}],"showTerminalAside":false},{"title":"Hello World!","date":"2022-10-11T00:00:00.000Z","ref":"/posts/2022/10/hello-world","desc":" はじめまして。  \nこれは初めての投稿です。\n\n今までブログが長く続いたことがないのですが、n度目の正直ということで今回こそは長く続くように頑張りたいと思います（とても固い決意）。\n\n@SogoKato といいます。どんな人か気になってくれた方は 自己紹介ページ をご覧いただければと思います。\n\nこのブログの制作にあたっては、初めて React + Next.js + Tailwind CSS を触って作ってみましたが、結構いい開発者体験だったのでこれについてもまた記事に起こしていきたいな〜と思っています","draft":false,"tags":[{"name":"Personal","ref":"/tags/personal"}],"showTerminalAside":false}],"post":{"title":"FastAPIとSQLAlchemy2.0ならもう型ヒントを諦めなくていい","date":"2023-02-08T00:00:00.000Z","ref":"/posts/2023/02/fastapi-orm-sqlalchemy","desc":" サチコ（Google Search Console）を眺めていたら `FastAPI MySQL` がそれなりに需要ありそうと思ったので、FastAPI と SQLAlchemy を組み合わせて ORM を使う方法を紹介したいと思います。最近の SQLAlchemy（1.4以降）ではマッピングされたオブジェクトに型を適用することもできるので、型ヒントを活かして型安全なコードを書くことも難しくなくなっています。\n\n## 環境\n\n* Python 3.10.6\n* FastAPI 0.89.1\n* SQLAl","draft":false,"tags":[{"name":"Python","ref":"/tags/python"},{"name":"FastAPI","ref":"/tags/fastapi"},{"name":"SQLAlchemy","ref":"/tags/sqlalchemy"},{"name":"ORM","ref":"/tags/orm"}],"showTerminalAside":false,"content":"\nサチコ（Google Search Console）を眺めていたら `FastAPI MySQL` がそれなりに需要ありそうと思ったので、FastAPI と SQLAlchemy を組み合わせて ORM を使う方法を紹介したいと思います。最近の SQLAlchemy（1.4以降）ではマッピングされたオブジェクトに型を適用することもできるので、型ヒントを活かして型安全なコードを書くことも難しくなくなっています。\n\n## 環境\n\n* Python 3.10.6\n* FastAPI 0.89.1\n* SQLAlchemy 2.0.1\n* Docker 20.10.13\n* Docker Compose v2.3.3\n\n## 前提\n\nFastAPI 公式ドキュメントの [SQL (Relational) Databases](https://fastapi.tiangolo.com/ja/tutorial/sql-databases/) のページを熟読しておいてください。\n\n2023年1月にリリースされた SQLAlchemy 2.0を使用します。1系を使用している既存プロジェクトの場合は [SQLAlchemy 2.0 - Major Migration Guide](https://docs.sqlalchemy.org/en/20/changelog/migration_20.html) を参考に2.0へ移行してください。1.4から2.0の移行はスムーズだと思います。\n\nSQLAlchemy で利用できる ORM のモデルの書き方はいくつかあります。個人的には [dataclass と統合した書き方](https://docs.sqlalchemy.org/en/20/orm/dataclasses.html)も好きですが、今回はシンプルにベーシックな実装を行います。\n\n## 成果物\n\nhttps://github.com/SogoKato/fastapi-sqlalchemy2\n\n```py\nfrom fastapi import Depends, FastAPI, HTTPException\nfrom pydantic import BaseModel\nfrom sqlalchemy import ForeignKey, String, create_engine, select\nfrom sqlalchemy.orm import (\n    DeclarativeBase,\n    Mapped,\n    Session,\n    mapped_column,\n    relationship,\n    sessionmaker,\n)\n\n\"\"\"\nSQLAlchemyのモデル.\n\nBased on:\n* https://docs.sqlalchemy.org/en/20/orm/quickstart.html#declare-models\n* https://fastapi.tiangolo.com/ja/tutorial/sql-databases/#create-the-database-models\n\"\"\"\n\n\nclass Base(DeclarativeBase):\n    \"\"\"各DBモデルの基底クラス.\"\"\"\n\n    pass\n\n\nclass User(Base):\n    \"\"\"usersテーブルのDBモデル.\"\"\"\n\n    __tablename__ = \"users\"\n\n    id: Mapped[int] = mapped_column(primary_key=True, index=True)\n    email: Mapped[str] = mapped_column(String(100), unique=True, index=True)\n    hashed_password: Mapped[str] = mapped_column(String(100))\n    is_active: Mapped[bool]\n\n    items: Mapped[list[\"Item\"]] = relationship(back_populates=\"owner\")\n\n\nclass Item(Base):\n    \"\"\"itemsテーブルのDBモデル.\"\"\"\n\n    __tablename__ = \"items\"\n\n    id: Mapped[int] = mapped_column(primary_key=True, index=True)\n    title: Mapped[str] = mapped_column(String(30), index=True)\n    description: Mapped[str] = mapped_column(String(30), index=True)\n    owner_id: Mapped[int] = mapped_column(ForeignKey(\"users.id\"))\n\n    owner: Mapped[\"User\"] = relationship(back_populates=\"items\")\n\n\n\"\"\"\nPydanticのモデル.\n\nBased on:\n* https://fastapi.tiangolo.com/ja/tutorial/sql-databases/#create-the-pydantic-models\n\"\"\"\n\n\nclass ItemBase(BaseModel):\n    \"\"\"Itemの基底クラス.\"\"\"\n\n    title: str\n    description: str | None = None\n\n\nclass ItemCreateRequest(ItemBase):\n    \"\"\"Item作成のリクエストを表現するクラス.\"\"\"\n\n    pass\n\n\nclass ItemResponse(ItemBase):\n    \"\"\"Itemのレスポンスを表現するクラス.\"\"\"\n\n    id: int\n    owner_id: int\n\n    class Config:\n        orm_mode = True\n\n\nclass UserBase(BaseModel):\n    \"\"\"Userの基底クラス.\"\"\"\n\n    email: str\n\n\nclass UserCreateRequest(UserBase):\n    \"\"\"User作成のリクエストを表現するクラス.\"\"\"\n\n    password: str\n\n\nclass UserResponse(UserBase):\n    \"\"\"Userのレスポンスを表現するクラス.\"\"\"\n\n    id: int\n    is_active: bool\n    items: list[ItemResponse] = []\n\n    class Config:\n        orm_mode = True\n\n\n\"\"\"\nDBのCRUD操作を行う関数.\n\nBased on:\n* https://docs.sqlalchemy.org/en/20/changelog/migration_20.html#migration-orm-usage\n* https://fastapi.tiangolo.com/ja/tutorial/sql-databases/#crud-utils\n\"\"\"\n\n\ndef get_db_user(db: Session, user_id: int):\n    \"\"\"usersテーブルからuser_idに一致するUserを取得します.\"\"\"\n    return db.execute(select(User).where(User.id == user_id)).scalars().first()\n\n\ndef get_db_user_by_email(db: Session, email: str):\n    \"\"\"usersテーブルからemailに一致するUserを取得します.\"\"\"\n    return db.execute(select(User).where(User.email == email)).scalars().first()\n\n\ndef get_db_users(db: Session, skip: int = 0, limit: int = 100):\n    \"\"\"usersテーブルからUserをすべて取得します.\"\"\"\n    return db.execute(select(User).offset(skip).limit(limit)).scalars().all()\n\n\ndef create_db_user(db: Session, user: UserCreateRequest):\n    \"\"\"usersテーブルにUserを追加します.\"\"\"\n    fake_hashed_password = user.password + \"notreallyhashed\"\n    db_user = User(\n        email=user.email, hashed_password=fake_hashed_password, is_active=True\n    )\n    db.add(db_user)\n    db.commit()\n    db.refresh(db_user)\n    return db_user\n\n\ndef get_db_items(db: Session, skip: int = 0, limit: int = 100):\n    \"\"\"itemsテーブルからItemをすべて取得します.\"\"\"\n    return db.execute(select(Item).offset(skip).limit(limit)).scalars().all()\n\n\ndef create_db_user_item(db: Session, item: ItemCreateRequest, user_id: int):\n    \"\"\"itemsテーブルにItemを追加します.\"\"\"\n    db_item = Item(**item.dict(), owner_id=user_id)\n    db.add(db_item)\n    db.commit()\n    db.refresh(db_item)\n    return db_item\n\n\n\"\"\"\nFastAPIでSQLAlchemyを使うためのセットアップ.\n\"\"\"\n# DBセッションを作成するクラスを作る.\nSQLALCHEMY_DATABASE_URL = \"mysql+mysqldb://user:password@db/test\"\n\n# デバッグ用にecho=Trueに設定.\nengine = create_engine(SQLALCHEMY_DATABASE_URL, echo=True)\nSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)\n\n# DBマイグレーションを行う.\nBase.metadata.create_all(bind=engine)\n\n# FastAPIをインスタンス化.\napp = FastAPI()\n\n\ndef get_db():\n    \"\"\"リクエストが来たらセッションを作成し、処理が完了したら閉じるためのDependency.\"\"\"\n    db = SessionLocal()\n    try:\n        yield db\n    finally:\n        db.close()\n\n\n\"\"\"\nFastAPIのルーティング.\n\"\"\"\n\n\n@app.post(\"/users/\", response_model=UserResponse)\ndef create_user(user: UserCreateRequest, db: Session = Depends(get_db)):\n    \"\"\"ユーザーを作成します.\"\"\"\n    db_user = get_db_user_by_email(db, email=user.email)\n    if db_user:\n        raise HTTPException(status_code=400, detail=\"Email already registered\")\n    return create_db_user(db=db, user=user)\n\n\n@app.get(\"/users/\", response_model=list[UserResponse])\ndef read_users(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):\n    \"\"\"ユーザーを一覧します.\"\"\"\n    users = get_db_users(db, skip=skip, limit=limit)\n    return users\n\n\n@app.get(\"/users/{user_id}\", response_model=UserResponse)\ndef read_user(user_id: int, db: Session = Depends(get_db)):\n    \"\"\"ユーザーを取得します.\"\"\"\n    db_user = get_db_user(db, user_id=user_id)\n    if db_user is None:\n        raise HTTPException(status_code=404, detail=\"User not found\")\n    return db_user\n\n\n@app.post(\"/users/{user_id}/items/\", response_model=ItemResponse)\ndef create_item_for_user(\n    user_id: int, item: ItemCreateRequest, db: Session = Depends(get_db)\n):\n    \"\"\"ユーザーのアイテムを作成します.\"\"\"\n    return create_db_user_item(db=db, item=item, user_id=user_id)\n\n\n@app.get(\"/items/\", response_model=list[ItemResponse])\ndef read_items(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):\n    \"\"\"アイテムを一覧します.\"\"\"\n    items = get_db_items(db, skip=skip, limit=limit)\n    return items\n```\n\n以上を `main.py` として保存して、下記の `Dockerfile` `docker-compose.yml` で `docker compose up --build` すれば動きます。\n\n```dockerfile\nFROM python:3.10\n\nWORKDIR /app\n\nENV PATH=$PATH:/root/.local/bin\nCOPY pyproject.toml poetry.lock ./\n\nRUN curl -sSL https://install.python-poetry.org | python3 - \\\n    \u0026\u0026 poetry install\n\nCMD [\"poetry\", \"run\", \"uvicorn\", \"main:app\", \"--host\", \"0.0.0.0\", \"--reload\"]\n```\n\n```yaml\nversion: '3'\nservices:\n  app:\n    build:\n      context: ./\n      dockerfile: Dockerfile\n    ports:\n      - '8000:8000'\n    volumes:\n      - type: bind\n        source: ./\n        target: /app\n  db:\n    image: mysql:8.0\n    environment:\n      MYSQL_ROOT_PASSWORD: password\n      MYSQL_DATABASE: test\n      MYSQL_USER: user\n      MYSQL_PASSWORD: password\n```\n\n## ちょこっと解説\n\n### SQL Alchemy 2.0 に対応させる\n\nコードを見ればそれがすべてなのであまり解説することはないのですが、FastAPI 公式ドキュメントの [SQL (Relational) Databases](https://fastapi.tiangolo.com/ja/tutorial/sql-databases/) のページとの大きな違いは、SQLAlchemy 2.0風な書き方になっているかどうかです。\n\nSQLAlchemy を使ったことのある方なら `session.query(User).filter(User.id == user_id).first()` のような書き方に慣れているかと思いますが、SQLAlchemy 2.0 ではこの書き方は[レガシーとされています](https://docs.sqlalchemy.org/en/20/orm/queryguide/query.html#legacy-query-api)。\n\nSQLAlchemy Core に統一された書き方が推奨されており、上記の例は以下のように書き換えられます。\n\n```py\nsession.execute(select(User).where(User.id == user_id)).scalars().first()\n```\n\n特徴は\n\n* ステートメント（SELECT ... WHERE ...）とその実行が明確に分離された\n* `Query` クラスではなく `Result` クラスや `ScalarResult` で `.all()` や `.first()` を使う\n\nことです。今までの API よりも分かりやすくなっていますし、型推論も効いているので使いやすいと思います。\n\nモデルクラスの書き方も変わっています。\n\n今までは以下のように定義していた部分が\n\n```py\nid = Column(Integer, primary_key=True, index=True)\n```\n\nこのようになります。\n\n```py\nid: Mapped[int] = mapped_column(primary_key=True, index=True)\n```\n\nそれっぽく移植していけば迷うことは少ないと思います。\n\n### DB セッションの取得には dependency を使う\n\nFastAPI の主要な機能の一つともいえる dependency を使って、DB セッションの生成を行うのが定番となっています。ちなみに、`SessionLocal` の命名は、`sqlalchemy.orm.Session` と区別するためだそうです。\n\n```py\ndef get_db():\n    db = SessionLocal()\n    try:\n        yield db\n    finally:\n        db.close()\n```\n\nこの `get_db` dependency を使うことで、リクエストの開始時に DB セッションを生成し（`yield` の段階で渡される）、リクエストの処理が完了したら（finally 節で）DB セッションが閉じられるようになります。Dependency での `yield` の使い方については [Dependencies with yield](https://fastapi.tiangolo.com/ja/tutorial/dependencies/dependencies-with-yield/) をご参照ください。\n\nDependency は、別の dependency の中でも使うことができるので、リクエストの前処理（バリデーションなど）で引数に `db = Depends(get_db)` と指定することで、その中でも DB セッションを使うことができます。便利ですね。\n\n### Pydantic の ORM mode\n\n私のユースケースでは普段使っていないのですが、マッチすれば便利だなと思うのが Pydantic の `orm_mode = True` です。\n\nこれが有効になっていると、Pydantic が値を取得するときに `data[\"id\"]` のように辞書のキーだけでなく、`data.id` のように属性でも値を取得しようと試みるようになるそうです。これだけ聞いてもあまりピンときませんが、この違いがあることによって ORM が張っている relationship（通常は lazy loading なので求められるまでは存在していない）の値をとってくることが可能になるようです（`@property` で呼び出して値をとってこられるというようなことかなと予想しています）。\n\n## まとめ\n\n[Prisma Client Python](https://prisma-client-py.readthedocs.io/en/stable/) の型付けの開発者体験も結構好きでしたが、SQLAlchemy もまだまだ勢いがありますね。ぜひ活用してみてください。\n\n関連記事もどうぞ。  \n[SQLAlchemyで'MySQL server has gone away'が発生した時の対処法2つ](/posts/2023/01/sqlalchemy-dealing-with-disconnects)\n\n## おまけ：API をたたいてみる\n\n```\n$ curl -s localhost:8000/users/ -XPOST \\\n  -H 'content-type: application/json' \\\n  -d '{\"email\": \"me@example.com\", \"password\": \"mystrongpassword\"}' \\\n  | jq\n```\n\n```json\n{\n  \"email\": \"me@example.com\",\n  \"id\": 1,\n  \"is_active\": true,\n  \"items\": []\n}\n```\n\n```\n$ curl -s localhost:8000/users/ | jq\n```\n\n```json\n[\n  {\n    \"email\": \"me@example.com\",\n    \"id\": 1,\n    \"is_active\": true,\n    \"items\": []\n  }\n]\n```\n\n```\n$ curl -s localhost:8000/users/?limit=0 | jq\n```\n\n```json\n[]\n```\n\n```\n$ curl -s localhost:8000/users/1 | jq\n```\n\n```json\n{\n  \"email\": \"me@example.com\",\n  \"id\": 1,\n  \"is_active\": true,\n  \"items\": []\n}\n```\n\n```\n$ curl -s localhost:8000/users/1/items/ -XPOST \\\n  -H 'content-type: application/json' \\\n  -d '{\"title\": \"LEVEL3\", \"description\": \"My favourite album\"}' \\\n  | jq\n```\n\n```json\n{\n  \"title\": \"LEVEL3\",\n  \"description\": \"My favourite album\",\n  \"id\": 1,\n  \"owner_id\": 1\n}\n```\n\n```\n$ curl -s localhost:8000/users/1 | jq\n```\n\n```json\n{\n  \"email\": \"me@example.com\",\n  \"id\": 1,\n  \"is_active\": true,\n  \"items\": [\n    {\n      \"title\": \"LEVEL3\",\n      \"description\": \"My favourite album\",\n      \"id\": 1,\n      \"owner_id\": 1\n    }\n  ]\n}\n```\n\n```\n$ curl -s localhost:8000/items/ | jq\n```\n\n```json\n[\n  {\n    \"title\": \"LEVEL3\",\n    \"description\": \"My favourite album\",\n    \"id\": 1,\n    \"owner_id\": 1\n  }\n]\n```\n\n## 参考文献\n\n* [SQL (Relational) Databases](https://fastapi.tiangolo.com/ja/tutorial/sql-databases/)\n* [ORM Quick Start](https://docs.sqlalchemy.org/en/20/orm/quickstart.html)\n"}},"__N_SSG":true},"page":"/posts/[...slug]","query":{"slug":["2023","02","fastapi-orm-sqlalchemy"]},"buildId":"iAOtCgGZVMAeNzyptNEld","isFallback":false,"gsp":true,"scriptLoader":[{"async":true,"src":"https://www.googletagmanager.com/gtag/js?id=G-RE7Q7WBFDJ","strategy":"afterInteractive"},{"id":"_gtag","defer":true,"dangerouslySetInnerHTML":{"__html":"\n              if (window.location.hostname === \"sogo.dev\") {\n                window.dataLayer = window.dataLayer || [];\n                function gtag(){dataLayer.push(arguments);}\n                gtag(\"js\", new Date());\n                gtag(\"config\", \"G-RE7Q7WBFDJ\");\n              }"},"strategy":"afterInteractive"}]}</script></body></html>