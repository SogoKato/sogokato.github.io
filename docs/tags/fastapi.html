<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/favicon.ico"/><title>FastAPI - Sogo.dev</title><meta name="description" content="@SogoKatoã®ãƒ–ãƒ­ã‚°ã€‚æŠ€è¡“ç³»ã®è¨˜äº‹ã‚’æ›¸ãã¾ã™ã€‚FastAPIã«ã¤ã„ã¦ã®è¨˜äº‹ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚"/><meta http-equiv="content-language" content="ja"/><meta property="og:url" content="https://sogo.dev/tags/fastapi"/><meta property="og:type" content="website"/><meta property="og:title" content="FastAPI - Sogo.dev"/><meta property="og:description" content="@SogoKatoã®ãƒ–ãƒ­ã‚°ã€‚æŠ€è¡“ç³»ã®è¨˜äº‹ã‚’æ›¸ãã¾ã™ã€‚FastAPIã«ã¤ã„ã¦ã®è¨˜äº‹ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚"/><meta property="og:site_name" content="Sogo.dev"/><meta property="og:image" content="https://sogo.dev/images/ogp-image.jpg"/><meta name="twitter:card" content="summary"/><meta name="next-head-count" content="13"/><link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css"/><link rel="alternate" href="/feed.xml" type="application/rss+xml" title="Sogo.dev"/><link rel="preconnect" href="https://use.typekit.net" crossorigin /><link rel="preload" href="/_next/static/css/80c8e95b286f26bf.css" as="style"/><link rel="stylesheet" href="/_next/static/css/80c8e95b286f26bf.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-b550e75f0c7dab9d.js" defer=""></script><script src="/_next/static/chunks/framework-d507767242394e30.js" defer=""></script><script src="/_next/static/chunks/main-f4616c45ce8fd4b5.js" defer=""></script><script src="/_next/static/chunks/pages/_app-544ebbd85389bdbb.js" defer=""></script><script src="/_next/static/chunks/518-ef57921eaa056e5d.js" defer=""></script><script src="/_next/static/chunks/pages/tags/%5Btag%5D-8d18ff04396c8051.js" defer=""></script><script src="/_next/static/myGytjg_O6H0FTkSaqhtQ/_buildManifest.js" defer=""></script><script src="/_next/static/myGytjg_O6H0FTkSaqhtQ/_ssgManifest.js" defer=""></script><style data-href="https://use.typekit.net/suf5fdm.css">@import url("https://p.typekit.net/p.css?s=1&k=suf5fdm&ht=tk&f=18518&a=11062204&app=typekit&e=css");@font-face{font-family:"rooney-sans";src:url("https://use.typekit.net/af/c27ef1/00000000000000007735a2d8/30/l?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n9&v=3") format("woff2"),url("https://use.typekit.net/af/c27ef1/00000000000000007735a2d8/30/d?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n9&v=3") format("woff"),url("https://use.typekit.net/af/c27ef1/00000000000000007735a2d8/30/a?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n9&v=3") format("opentype");font-display:auto;font-style:normal;font-weight:900;font-stretch:normal}.tk-rooney-sans{font-family:"rooney-sans",sans-serif}</style></head><body><div id="__next"><div class="bg-neutral-200 dark:bg-neutral-900 duration-400 min-h-screen text-neutral-900 dark:text-neutral-50 transition-all"><div class="grid grid-cols-10 justify-center max-w-7xl mx-auto"><header class="col-span-10"><div class="max-w-4xl mt-4 sm:mt-0 mx-auto flex justify-center sm:justify-between h-36 sm:h-48 items-center relative w-11/12"><div class="hidden sm:block"></div><a class="w-72 sm:w-auto" href="/"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27480%27%20height=%27160%27/%3e"/></span><img alt="logo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="logo" src="/images/logo.svg" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></a></div></header><main class="col-span-10 md:col-span-7"><div><div class="bg-white dark:bg-neutral-800 mx-auto mb-11 p-8 rounded-3xl shadow-lg w-11/12"><div><a class="block" href="/posts/2023/02/fastapi-orm-sqlalchemy"><p>2023<!-- -->å¹´<!-- -->2<!-- -->æœˆ<!-- -->8<!-- -->æ—¥</p><h2 class="mt-5 font-bold leading-tight mb-5 text-4xl">FastAPIã¨SQLAlchemy2.0ãªã‚‰ã‚‚ã†å‹ãƒ’ãƒ³ãƒˆã‚’è«¦ã‚ãªãã¦ã„ã„</h2><p class="line-clamp-3 my-5 text-neutral-600 dark:text-neutral-300"> ã‚µãƒã‚³ï¼ˆGoogle Search Consoleï¼‰ã‚’çœºã‚ã¦ã„ãŸã‚‰ `FastAPI MySQL` ãŒãã‚Œãªã‚Šã«éœ€è¦ã‚ã‚Šãã†ã¨æ€ã£ãŸã®ã§ã€FastAPI ã¨ SQLAlchemy ã‚’çµ„ã¿åˆã‚ã›ã¦ ORM ã‚’ä½¿ã†æ–¹æ³•ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚æœ€è¿‘ã® SQLAlchemyï¼ˆ1.4ä»¥é™ï¼‰ã§ã¯ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œ</p></a><ul class="flex flex-wrap mt-5"><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/python"># <!-- -->Python</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/fastapi"># <!-- -->FastAPI</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/sqlalchemy"># <!-- -->SQLAlchemy</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/orm"># <!-- -->ORM</a></ul></div></div><div class="bg-white dark:bg-neutral-800 mx-auto mb-11 p-8 rounded-3xl shadow-lg w-11/12"><div><a class="block" href="/posts/2022/12/openid-connect-fastapi"><p>2022<!-- -->å¹´<!-- -->12<!-- -->æœˆ<!-- -->2<!-- -->æ—¥</p><h2 class="mt-5 font-bold leading-tight mb-5 text-4xl">ã‚ˆãã‚ã‚‹SPA+APIæ§‹æˆã§ã®OpenID Connectã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…</h2><p class="line-clamp-3 my-5 text-neutral-600 dark:text-neutral-300"> ã“ã®è¨˜äº‹ã¯ãƒ‹ãƒ•ã‚¯ãƒ©ç­‰ã‚’æä¾›ã—ã¦ã„ã‚‹ã€å¯Œå£«é€šã‚¯ãƒ©ã‚¦ãƒ‰ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º Advent Calendar 2022ã®2æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

æ˜¨æ—¥ã¯ [@nt</p></a><ul class="flex flex-wrap mt-5"><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/openid-connect"># <!-- -->OpenID Connect</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/èªè¨¼-èªå¯"># <!-- -->èªè¨¼/èªå¯</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/spa"># <!-- -->SPA</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/python"># <!-- -->Python</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/fastapi"># <!-- -->FastAPI</a></ul></div></div><div class="flex justify-center"><div class="bg-neutral-300 dark:bg-neutral-600 w-14 font-display h-14 mr-5 last:mr-0 px-4 py-2 rounded-full text-4xl text-center transition-all">1</div></div></div></main><aside class="col-span-10 md:col-span-3"><div class="mx-auto w-11/12 mb-8"><h2 class="font-black font-display text-duchs-900 dark:text-duchs-100 text-xl">AUTHOR</h2><div class="flex items-center my-3.5"><div class="mr-2.5"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2780%27%20height=%2780%27/%3e"/></span><img alt="ã‚¢ã‚¤ã‚³ãƒ³" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="rounded-full" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="ã‚¢ã‚¤ã‚³ãƒ³" src="/images/icon.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="rounded-full" loading="lazy"/></noscript></span></div><div><p class="font-black font-display mb-2 text-duchs-900 dark:text-duchs-100 text-lg">Sogo Kato</p><div class="flex"><a class="mr-2 hover:opacity-75 transition-all" target="_blank" href="https://github.com/SogoKato"><div class="dark:hidden"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2720%27%20height=%2720%27/%3e"/></span><img alt="GitHubã‚¢ã‚¤ã‚³ãƒ³" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="GitHubã‚¢ã‚¤ã‚³ãƒ³" src="/images/github-light.svg" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><div class="hidden dark:block"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2720%27%20height=%2720%27/%3e"/></span><img alt="GitHubã‚¢ã‚¤ã‚³ãƒ³" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="GitHubã‚¢ã‚¤ã‚³ãƒ³" src="/images/github-dark.svg" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div></a></div></div></div><p class="mb-2.5 text-xs">ã‚¯ãƒ©ã‚¦ãƒ‰æ¥­ç•Œã«ç”Ÿæ¯ã™ã‚‹é§†ã‘å‡ºã—ã¸ã£ã½ã“ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã€‚ãƒ©ã‚ºãƒ‘ã‚¤ã¨ãƒ€ãƒƒã‚¯ã‚¹ãŒã™ãã€‚è³‡æ ¼ãŸãã•ã‚“ã»ã—ã„ã®ã§ä½™ã£ã¦ã‚‹äººã¯ãŠè£¾åˆ†ã‘ãã ã•ã„ã€‚</p><a href="/profile"><button class="bg-duchs-200 hover:bg-duchs-800 font-black font-display px-3.5 py-0.5 rounded-full text-duchs-900 hover:text-duchs-100 transition-all">MORE</button></a></div><div class="mx-auto w-11/12 mb-8"><h2 class="font-black font-display text-duchs-900 dark:text-duchs-100 text-xl">RECOMMENDED</h2><ul class="mt-3.5"><a class="block mb-3 hover:opacity-75 transition-all" href="/posts/2023/03/pyscript-codeblock"><p class="mb-1 text-xs">PyScriptã‚’ä½¿ã£ã¦ãƒ–ãƒ­ã‚°ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã•ã›ã‚‹</p><p class="text-neutral-500 text-xs">2023<!-- -->å¹´<!-- -->3<!-- -->æœˆ<!-- -->6<!-- -->æ—¥</p></a><a class="block mb-3 hover:opacity-75 transition-all" href="/posts/2023/03/python-unittest-mock-where-to-patch"><p class="mb-1 text-xs">Pythonã®unittest.mock.patchã§ã¯ã©ã“ã«ãƒ‘ãƒƒãƒã™ã‚‹ã‹ãŒé‡è¦</p><p class="text-neutral-500 text-xs">2023<!-- -->å¹´<!-- -->3<!-- -->æœˆ<!-- -->4<!-- -->æ—¥</p></a><a class="block mb-3 hover:opacity-75 transition-all" href="/posts/2023/03/ansible-apt-repo-signed-by-gpg-key"><p class="mb-1 text-xs">Ansibleã§gpgå…¬é–‹éµã¨aptã®ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒªãƒã‚¸ãƒˆãƒªã‚’è¿½åŠ ã™ã‚‹ ï½Terraformã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã„ï½</p><p class="text-neutral-500 text-xs">2023<!-- -->å¹´<!-- -->3<!-- -->æœˆ<!-- -->1<!-- -->æ—¥</p></a><a class="block mb-3 hover:opacity-75 transition-all" href="/posts/2023/02/aws-api-gateway-terraform-throttling-settings"><p class="mb-1 text-xs">Terraformã§API Gatewayã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ã‚’è¨­å®šã™ã‚‹</p><p class="text-neutral-500 text-xs">2023<!-- -->å¹´<!-- -->2<!-- -->æœˆ<!-- -->23<!-- -->æ—¥</p></a><a class="block mb-3 hover:opacity-75 transition-all" href="/posts/2023/02/unit-testing-principles-practices-and-patterns-part3"><p class="mb-1 text-xs">ãƒ—ãƒ­ã‚»ã‚¹å¤–ä¾å­˜ã¯çµ±åˆãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ã‚ˆã†ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬3éƒ¨</p><p class="text-neutral-500 text-xs">2023<!-- -->å¹´<!-- -->2<!-- -->æœˆ<!-- -->22<!-- -->æ—¥</p></a></ul></div><div class="mx-auto w-11/12 mb-8"><h2 class="font-black font-display text-duchs-900 dark:text-duchs-100 text-xl">TAGS</h2><ul class="flex flex-wrap mt-3.5"><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/python"># <!-- -->Python</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/å˜ä½“ãƒ†ã‚¹ãƒˆ"># <!-- -->å˜ä½“ãƒ†ã‚¹ãƒˆ</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/èª­æ›¸"># <!-- -->èª­æ›¸</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/kubernetes"># <!-- -->Kubernetes</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/javascript"># <!-- -->JavaScript</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/react"># <!-- -->React</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/next.js"># <!-- -->Next.js</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/terraform"># <!-- -->Terraform</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/fastapi"># <!-- -->FastAPI</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/sqlalchemy"># <!-- -->SQLAlchemy</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/webassembly"># <!-- -->WebAssembly</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/pyscript"># <!-- -->PyScript</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/ansible"># <!-- -->Ansible</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/apt"># <!-- -->APT</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/aws"># <!-- -->AWS</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/api-gateway"># <!-- -->API Gateway</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/orm"># <!-- -->ORM</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰"># <!-- -->ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/vs-code"># <!-- -->VS Code</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/é–‹ç™ºç’°å¢ƒ"># <!-- -->é–‹ç™ºç’°å¢ƒ</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/openid-connect"># <!-- -->OpenID Connect</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/èªè¨¼-èªå¯"># <!-- -->èªè¨¼/èªå¯</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/spa"># <!-- -->SPA</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/gitlab"># <!-- -->Gitlab</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/ci-cd"># <!-- -->CI/CD</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/tailwind-css"># <!-- -->Tailwind CSS</a><a class="bg-duchs-100 hover:bg-duchs-500 font-bold mb-2 mr-3 px-5 py-1 rounded-full dark:text-neutral-900 hover:text-neutral-50 hover:dark:text-neutral-50 text-xs transition-all" href="/tags/personal"># <!-- -->Personal</a></ul></div><div class="mx-auto w-11/12 "><h2 class="font-black font-display text-duchs-900 dark:text-duchs-100 text-xl">LINKS</h2><a class="block mb-1 mt-3.5 hover:opacity-75 transition-all" href="/feed.xml"><p>RSS</p></a><a class="block mb-1 hover:opacity-75 transition-all" target="_blank" href="https://github.com/SogoKato/sogokato.github.io"><p class="flex items-center">GitHub <svg class="fill-neutral-900 dark:fill-neutral-100 h-3 ml-2" viewBox="0 0 7.82 7.82"><g><path d="M4.41,2.01c-.15,.02-.3,.04-.46,.06s-.31,.02-.46,.01l-1.1-.02c-.14,0-.27-.02-.38-.06s-.21-.1-.3-.19c-.1-.1-.17-.22-.22-.36s-.07-.29-.07-.44c0-.15,.02-.29,.07-.43s.12-.26,.22-.35c.09-.09,.18-.15,.29-.18S2.24,0,2.39,0H6.8c.15,0,.29,.03,.41,.08s.23,.12,.31,.21c.09,.09,.17,.2,.22,.32s.08,.26,.08,.41V5.46c0,.13-.02,.26-.05,.37s-.09,.22-.19,.31-.21,.17-.35,.22-.27,.07-.4,.07-.27-.03-.4-.07-.24-.12-.33-.21-.15-.19-.19-.31-.05-.24-.05-.38l-.02-1.24c0-.16,0-.31,.02-.46s.03-.3,.06-.46L1.7,7.53c-.11,.11-.22,.18-.34,.23s-.24,.07-.36,.06-.24-.04-.35-.09-.22-.13-.32-.23-.17-.2-.23-.31S0,6.95,0,6.83s.01-.24,.06-.36,.12-.23,.23-.34L4.41,2.01Z"></path></g></svg></p></a></div></aside><footer class="col-span-10"><div class="flex flex-col items-center py-10"><a class="mb-2 text-xs" href="/privacy">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a><small>Copyright Â© <!-- -->2023<!-- --> Sogo Kato All rights reserved.</small></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"posts":[{"title":"PyScriptã‚’ä½¿ã£ã¦ãƒ–ãƒ­ã‚°ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã•ã›ã‚‹","date":"2023-03-06T00:00:00.000Z","ref":"/posts/2023/03/pyscript-codeblock","desc":" å‰å›ã®è¨˜äº‹ã‚’æ›¸ãã¨ãã« WebAssembly ã§ãƒ–ãƒ­ã‚°ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã•ã›ã‚‰ã‚ŒãŸã‚‰é¢ç™½ã„ã‹ã‚‚ã€ã¨ã„ã†ã“ã¨ã§ PyScript ã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚React \u0026 Next.js ã§ä½¿ã†éš›ã®æ³¨æ„ç‚¹ã«ã¤ã„ã¦","draft":false,"content":"\n[å‰å›ã®è¨˜äº‹](/posts/2023/03/pyscript-codeblock)ã‚’æ›¸ãã¨ãã« WebAssembly ã§ãƒ–ãƒ­ã‚°ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã•ã›ã‚‰ã‚ŒãŸã‚‰é¢ç™½ã„ã‹ã‚‚ã€ã¨ã„ã†ã“ã¨ã§ PyScript ã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚React \u0026 Next.js ã§ä½¿ã†éš›ã®æ³¨æ„ç‚¹ã«ã¤ã„ã¦ã‚‚æ›¸ã“ã†ã¨æ€ã„ã¾ã™ã€‚\n\nä»¥ä¸‹ã«ã¤ã„ã¦ã¯å‰æçŸ¥è­˜ã¨ã—ã¦ã“ã®è¨˜äº‹ã§ã¯è§£èª¬ã—ã¾ã›ã‚“ã€‚\n\n* [PyScript](https://pyscript.net/)\n* [Pyodide](https://pyodide.org/en/stable/)\n* [WebAssembly](https://webassembly.org/)\n* [react-markdown](https://github.com/remarkjs/react-markdown) ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆ3ã¤ \\```ï¼‰ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹æ–¹æ³•\n\n## ã‚„ã£ãŸã“ã¨\n\n* react-markdown ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§ã®ã‚ªãƒ¬ã‚ªãƒ¬æ–‡æ³•ã§ PyScript ã‚’å°å…¥\n* PyScript ã®ã‚«ã‚¹ã‚¿ãƒ è¦ç´ ï¼ˆä»¥ä¸‹ï¼‰ã«å¯¾å¿œã™ã‚‹ React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ\n  * `\u003cpy-script\u003e`, `\u003cpy-repl\u003e`, `\u003cpy-terminal\u003e`, `\u003cpy-config\u003e`\n* React ã®ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹ãŸã‚ã« Next.js ã® [Dynamic Import](https://nextjs.org/docs/advanced-features/dynamic-import) ã‚’ä½¿ç”¨\n* PyScript ã®åˆæœŸåŒ–ã®ä»•æ§˜ã«åˆã‚ã›ãŸæœ€é©åŒ–\n\n## ã¾ãšã¯éŠã‚“ã§ã¿ã‚ˆã†\n\nã“ã¡ã‚‰ãŒæˆæœç‰©ã«ãªã‚Šã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯é–‹å§‹ã® \\`\\`\\` ã®æ¨ªã«æ›¸ã„ãŸæ–‡å­—åˆ—ãŒã€ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹é–¢æ•°ã®å¼•æ•°ã«æ¸¡ã•ã‚Œã‚‹ã®ã§ã€ã“ã“ã§ã‚ªãƒ¬ã‚ªãƒ¬æ–‡æ³•ã‚’åˆ¶å®šã—ã¾ã™ã€‚\n\n### py-terminal ã‚¿ã‚°\n\nã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã®å‡ºåŠ›ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚¿ã‚°ã§ã™ã€‚å¾Œè¿°ã® `\u003cpy-script\u003e` ã‚„ `\u003cpy-repl\u003e` ã§ã®æ¨™æº–å‡ºåŠ›ã‚„æ¨™æº–ã‚¨ãƒ©ãƒ¼ã¯ã“ã“ã«å‡ºã¦ãã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã«è¤‡æ•°é…ç½®ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€è¡¨ç¤ºã•ã‚Œã‚‹å†…å®¹ã¯åŒã˜ã«ãªã‚Šã¾ã™ã€‚\n\nMarkdown ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¦ã„ã¾ã™ã€‚\n\n\\`\\`\\`pyterminal  \n\\`\\`\\`\n\n```pyterminal\n```\n\n### py-script ã‚¿ã‚°\n\næœ€ã‚‚åŸºæœ¬çš„ãªã‚¿ã‚°ã§ã™ã€‚\n\n\\`\\`\\`python:pyscript  \nprint(\"Hello world!\")  \n\\`\\`\\`\n\nãã‚Œã‚’ `\u003cpy-script\u003e` ã‚¿ã‚°ã«å¤‰æ›ã™ã‚‹ã“ã¨ã§ã€PyScript åˆæœŸåŒ–æ™‚ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚\n\n```python:pyscript\nprint(\"Hello world!\")\n```\n\n### py-repl ã‚¿ã‚°\n\nJupyter Notebook ã®ã‚ˆã†ãªæ„Ÿã˜ã§é€æ¬¡å®Ÿè¡ŒãŒã§ãã¾ã™ã€‚\n\n```pyrepl\nprint(\"ã“ã‚“ã«ã¡ã¯ä¸–ç•Œ!\")\nx = 1\nx\n```\n\n```pyrepl\nraise ValueError()\n```\n\n### py-config ã‚¿ã‚°\n\n[å„ç¨®è¨­å®šå€¤](https://docs.pyscript.net/latest/reference/elements/py-config.html)ã‚’å…¥ã‚Œã‚‹ãŸã‚ã®ã‚¿ã‚°ã§ã™ã€‚\n\nãƒšãƒ¼ã‚¸å†…ã«é…ç½®ã§ãã‚‹ `\u003cpy-config\u003e` ã¯ä¸€ã¤ã ã‘ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚\n\nä»Šå›ã®å®Ÿè£…æ™‚ã«ã¯ PyScript ã® fetch æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ã‚’è¡Œã†ã¨ã„ã†è¦ä»¶ãŒã‚ã£ãŸã®ã§ã€`pyconfig` ã® markdown ã®è¨˜è¿°ã¯ã€è¨˜äº‹ã§ã¯ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã¨ã—ã¦è¦‹ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚\n\n\\`\\`\\`pyconfig  \nterminal = false  \n\n\\[\\[fetch\\]\\]  \nfrom = \"../../../assets/posts/2023/03/dog.py\"  \nto_file = \"./dog.py\"  \n\\`\\`\\`\n\n```pyconfig\nterminal = false\n\n[[fetch]]\nfrom = \"../../../assets/posts/2023/03/dog.py\"\nto_file = \"./dog.py\"\n```\n\nã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ PyScript ã«èª­ã¿è¾¼ã‚€ã“ã¨ã§ã€è‡ªä½œã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚\n\n`dog.py` ã®ä¸­èº«ã¯ã“ã†ãªã£ã¦ã„ã¾ã™ã€‚\n\n```python:dog.py\nclass Dog:\n    def bark(self):\n        print(\"Bow-wow!\")\n```\n\n`\u003cpy-script\u003e` ã§å®Ÿè¡Œã™ã‚‹ã¨ print ã—ãŸã‚‚ã®ãŒã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«å‡ºã¦ãã¾ã™ã€‚\n\n```python:pyscript\nfrom dog import Dog\n\nwanchan = Dog()\nwanchan.bark()\n```\n\n## react-markdown ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§ã®ã‚ªãƒ¬ã‚ªãƒ¬æ–‡æ³•ã§ PyScript ã‚’å°å…¥\n\nã™ã§ã«è¦‹ã¦ã„ãŸã ã„ãŸã‚ˆã†ã«ã€ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®è¨€èªã‚’è¨˜è¼‰ã™ã‚‹éƒ¨åˆ†ã‚’æ‹¡å¼µã—ãŸã‚ªãƒ¬ã‚ªãƒ¬æ–‡æ³•ã§å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚\n\nã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯é–‹å§‹ã® \\`\\`\\` ã®æ¨ªã«æ›¸ã„ãŸæ–‡å­—åˆ—ãŒ [`CodeBlock`](https://github.com/SogoKato/sogokato.github.io/blob/8769da4e6bb4bdecf4a0c59d274d4a439b66535b/components/CodeBlock.tsx) ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã® `className` å¼•æ•°ã«æ¸¡ã•ã‚Œã‚‹ã®ã§ã€ãã‚Œã‚’ `split` ã—ã¦æ¡ä»¶åˆ†å²ã‚’ä½œã‚Šã¾ã™ã€‚\n\né–¢é€£ã™ã‚‹ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆåŸ·ç­†æ™‚ç‚¹ï¼‰\n* [components/CodeBlock.tsx](https://github.com/SogoKato/sogokato.github.io/blob/cb55f79c362d9aa6578ea5c68a703b69f3c2c238/components/CodeBlock.tsx)\n\n## PyScript ã®ã‚«ã‚¹ã‚¿ãƒ è¦ç´ ã«å¯¾å¿œã™ã‚‹ React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ\n\nä¸Šè¨˜ã® CodeBlock ã‚„ãã®ä»–ã®å ´æ‰€ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ PyScript ã®ã‚«ã‚¹ã‚¿ãƒ è¦ç´ ã‚’è¡¨ã™ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚æ±ç”¨çš„ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç›®æŒ‡ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã€ã™ã¹ã¦ã®å¼•æ•°ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã¯ã—ã¦ã„ã¾ã›ã‚“ã€‚\n\né–¢é€£ã™ã‚‹ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆåŸ·ç­†æ™‚ç‚¹ï¼‰\n* `\u003cpy-script\u003e`\n  * [components/PyScript.tsx](https://github.com/SogoKato/sogokato.github.io/blob/cb55f79c362d9aa6578ea5c68a703b69f3c2c238/components/PyScript.tsx)\n* `\u003cpy-repl\u003e`\n  * [components/PyRepl.tsx](https://github.com/SogoKato/sogokato.github.io/blob/cb55f79c362d9aa6578ea5c68a703b69f3c2c238/components/PyRepl.tsx)\n* `\u003cpy-terminal\u003e`\n  * [components/PyTerminal.tsx](https://github.com/SogoKato/sogokato.github.io/blob/cb55f79c362d9aa6578ea5c68a703b69f3c2c238/components/PyTerminal.tsx)\n* `\u003cpy-config\u003e`\n  * [components/PyConfig.tsx](https://github.com/SogoKato/sogokato.github.io/blob/cb55f79c362d9aa6578ea5c68a703b69f3c2c238/components/PyConfig.tsx)\n\n## React ã®ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹ãŸã‚ã« Next.js ã® Dynamic Import ã‚’ä½¿ç”¨\n\nPyScript ãŒ DOM ã®æ›¸ãæ›ãˆã‚’è¡Œã†ã®ã§ã€ã‚µãƒ¼ãƒãƒ¼å´ã§ SSR ã—ãŸçµæœã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã® DOM ã¨ã®ä¸æ•´åˆãŒç™ºç”Ÿã—ã€ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã—ã¾ã„ã¾ã™ã€‚\n\n[Next.jsã¨Tailwind CSSã§ãƒ–ãƒ­ã‚°ã‚’ä½œã‚‹ã¨ãã«è€ƒãˆãŸã“ã¨](/posts/2022/11/blog-with-nextjs-and-tailwindcss)ã®è¨˜äº‹ã§ã‚‚ç´¹ä»‹ã—ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ãŒ Next.js ã«ã¯ [Dynamic Import](https://nextjs.org/docs/advanced-features/dynamic-import) ã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚Šã€ã“ã‚Œã‚’ä½¿ã†ã“ã¨ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã¿ã§å®Ÿè¡Œã—ãŸã„å‡¦ç†ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚\n\nä¸Šã§ä½œæˆã—ãŸ PyScript ã®ã‚«ã‚¹ã‚¿ãƒ è¦ç´ ã«å¯¾å¿œã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆ`PyConfig` ä»¥å¤–ï¼‰ã‚’ä½¿ã†éš›ã¯ Dynamic Import ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚`PyConfig` ã«ã¤ã„ã¦ã¯ DOM ãŒå¤‰æ›´ã•ã‚Œã‚‹ã“ã¨ãŒãªã„ã®ã§ Dynamic Import ã«ã™ã‚‹å¿…è¦ãŒãªã„ã§ã™ï¼ˆã¾ãŸã€ã“ã‚Œã‚’ Dynamic Import ã«ã—ãŸã‚‰ã†ã¾ãå‹•ä½œã—ã¾ã›ã‚“ã§ã—ãŸï¼‰ã€‚\n\né–¢é€£ã™ã‚‹ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆåŸ·ç­†æ™‚ç‚¹ï¼‰\n* [components/CodeBlock.tsx](https://github.com/SogoKato/sogokato.github.io/blob/cb55f79c362d9aa6578ea5c68a703b69f3c2c238/components/CodeBlock.tsx)\n\n## PyScript ã®åˆæœŸåŒ–ã®ä»•æ§˜ã«åˆã‚ã›ãŸæœ€é©åŒ–\n\nPyScript ã§ã¯ script ã‚¿ã‚°ã§èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€åˆæœŸåŒ–ã®å‡¦ç†ãŒè¡Œã‚ã‚Œã€ç¾çŠ¶ã§ã¯åˆæœŸåŒ–å¾Œã«è¨­å®šã®å¤‰æ›´ç­‰ã¯è¡Œãˆã¾ã›ã‚“ã€‚ã¤ã¾ã‚Šã€script ã‚¿ã‚°ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹æ™‚ã«ã¯ `\u003cpy-config\u003e` ã‚’ã¯ã˜ã‚ã¨ã™ã‚‹å„è¦ç´ ãŒå®£è¨€ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆè©³ã—ãã¯è¦æ¤œè¨¼ã§ã™ãŒï¼‰ã€‚\n\nã“ã®ä»•æ§˜ã¯ã€å‹•çš„ã«è¦ç´ ã‚’ç®¡ç†ã™ã‚‹ React ã¨ç›¸æ€§ãŒè‰¯ããªã„ã§ã™ã€‚ã¨ã‚Šã‚ãˆãšã€`\u003cReactMarkdown\u003e` ã®å‘¼ã³å‡ºã—å´ã§ã€PyScript ã®å„è¦ç´ ã‚ˆã‚Šã‚‚å¾Œã‚ã«é…ç½®ã— `lazyOnload` strategy ã§èª­ã¿è¾¼ã‚€ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚\n\nã¾ãŸã€SPA ã®ã‚ˆã†ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¡Œãªã£ã¦ã„ã‚‹ã®ã§ã€åˆ¥ã®è¨˜äº‹ã«ç§»å‹•ã—ã¦ã‚‚å‰ã®ãƒšãƒ¼ã‚¸ã®å®Ÿè¡ŒçµæœãŒã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«æ®‹ã£ã¦ã—ã¾ã„ã¾ã™ã€‚ç¾çŠ¶ã§ã¯ PyScript å´ã« destroy ç³»ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒç”¨æ„ã•ã‚Œã¦ã„ãªã„ã®ã§ã€ã“ã¡ã‚‰ã‚‚ã¨ã‚Šã‚ãˆãšã®å¯¾å¿œã¨ã—ã¦é–²è¦§è€…ã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚ˆã†ã«ä¿ƒã™ä»•çµ„ã¿ã‚’å…¥ã‚Œã¦ã„ã¾ã™ãƒ»ãƒ»ãƒ»ã€‚ğŸ™‡\n\né–¢é€£ã™ã‚‹ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆåŸ·ç­†æ™‚ç‚¹ï¼‰\n* [components/PostCard.tsx](https://github.com/SogoKato/sogokato.github.io/blob/cb55f79c362d9aa6578ea5c68a703b69f3c2c238/components/PostCard.tsx)\n* [components/PyTerminal.tsx](https://github.com/SogoKato/sogokato.github.io/blob/cb55f79c362d9aa6578ea5c68a703b69f3c2c238/components/PyTerminal.tsx)\n\n## ãŠã‚ã‚Šã«\n\nPyScript ã¯ã¾ã ã¾ã ç™ºå±•é€”ä¸Šæ„ŸãŒã‚ã‚Šã€å‘¨è¾ºã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã‚‚æ•´å‚™ã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€ä»Šå›ã¯æ°—åˆã§ãƒ–ãƒ­ã‚°ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã« WASM ã‚’å°å…¥ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚èª­ã¿è¾¼ã‚ãŸã‚Šã™ã‚‹ã®ã§ã€ã¡ã‚‡ã£ã¨ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’è¼‰ã›ã¦å‹•ã‹ã™ã«ã¯ååˆ†ã ã¨æ€ã„ã¾ã™ã€‚\n\nã“ã®è¨˜äº‹ãŒè‰¯ã‘ã‚Œã° RSS ç™»éŒ²ã¨ã€Œã„ã„ã­ã€ã€Œå½¹ã«ç«‹ã£ãŸã€ãƒœã‚¿ãƒ³ã‚’ãƒãƒãƒƒã¨ãŠé¡˜ã„ã—ã¾ã™ï¼ï¼ˆYouTuber é¢¨ï¼‰  \nãã—ã¦ã€åŒã˜ã‚ˆã†ãªã“ã¨ã‚’æ€ã„ã¤ã„ãŸèª°ã‹ã®åŠ©ã‘ã«ãªã‚Œã°å¹¸ã„ã§ã™ï¼\n\n## å‚è€ƒæ–‡çŒ®\n\n* [PyScript](https://pyscript.net/)\n* [Pyodide](https://pyodide.org/en/stable/)\n* [pyscript-react](https://github.com/Py4Js/pyscript-react)\n* [ã‚ªãƒ¬ã‚ªãƒ¬è¨˜æ³•ã®Markdownã‚’ä»»æ„ã®ReactElementã¨ã—ã¦å¤‰æ›ã™ã‚‹](https://qiita.com/bigmon/items/de62335fbf8388192499)\n","tags":[{"name":"Python","ref":"/tags/python"},{"name":"WebAssembly","ref":"/tags/webassembly"},{"name":"PyScript","ref":"/tags/pyscript"},{"name":"JavaScript","ref":"/tags/javascript"},{"name":"React","ref":"/tags/react"},{"name":"Next.js","ref":"/tags/next.js"}],"showTerminalAside":true},{"title":"Pythonã®unittest.mock.patchã§ã¯ã©ã“ã«ãƒ‘ãƒƒãƒã™ã‚‹ã‹ãŒé‡è¦","date":"2023-03-04T00:00:00.000Z","ref":"/posts/2023/03/python-unittest-mock-where-to-patch","desc":" Python å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® unittest.mock ã®ãƒšãƒ¼ã‚¸ã«ãƒ‰ãƒ³ãƒ”ã‚·ãƒ£ã®å†…å®¹ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã™ãŒã€ãªã‹ãªã‹æ°—ã¥ã‘ãšã«ãƒãƒã£ã¦ã—ã¾ã£ã¦ã„ãŸã®ã§","draft":false,"content":"\n[Python å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® unittest.mock ã®ãƒšãƒ¼ã‚¸](https://docs.python.org/ja/3/library/unittest.mock.html#where-to-patch)ã«ãƒ‰ãƒ³ãƒ”ã‚·ãƒ£ã®å†…å®¹ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã™ãŒã€ãªã‹ãªã‹æ°—ã¥ã‘ãšã«ãƒãƒã£ã¦ã—ã¾ã£ã¦ã„ãŸã®ã§ãƒ¡ãƒ¢ã§ã™ã€‚\n\n`unittest.mock.patch` ã§ãƒ‘ãƒƒãƒã—ãŸã‘ã©å½“ãŸã£ã¦ãªã„æ°—ãŒã™ã‚‹äººã¯å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚\n\nä¸‹è¨˜ã®å¼•ç”¨ã«è¦ç‚¹ãŒå‡ç¸®ã•ã‚Œã¦ã„ã¾ã™ã€‚\n\n\u003e ### ã©ã“ã«ãƒ‘ãƒƒãƒã™ã‚‹ã‹\n\u003e\n\u003e `patch()` ã¯ (ä¸€æ™‚çš„ã«) ã‚ã‚‹ åå‰ ãŒå‚ç…§ã—ã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ¥ã®ã‚‚ã®ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã§é©ç”¨ã•ã‚Œã¾ã™ã€‚ä»»æ„ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ã€ãã‚Œã‚’å‚ç…§ã™ã‚‹ãŸãã•ã‚“ã®åå‰ãŒå­˜åœ¨ã—ãˆã¾ã™ã€‚ãªã®ã§ã€å¿…ãšãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚·ã‚¹ãƒ†ãƒ ãŒä½¿ã£ã¦ã„ã‚‹åå‰ã«å¯¾ã—ã¦ patch ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚\n\u003e\n\u003e åŸºæœ¬çš„ãªåŸå‰‡ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒ _ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—_ ã•ã‚Œã‚‹ã¨ã“ã‚ã«ãƒ‘ãƒƒãƒã™ã‚‹ã“ã¨ã§ã™ã€‚ãã®å ´æ‰€ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå®šç¾©ã•ã‚ŒãŸã¨ã“ã‚ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚\n\nã¤ã¾ã‚Šã€å®£è¨€ã—ãŸå ´æ‰€ã§ã¯ãªã import ã—ã¦ã„ã‚‹å´ã‹ã‚‰è¦‹ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½ç½®ã‚’æŒ‡å®šã—ãªã•ã„ã€ã¨ã„ã†ã“ã¨ã§ã™ã€‚ãŸã ã€`from a import SomeClass` ã¨ã™ã‚‹ã‹ã€`import a` ã—ã¦ `a.SomeClass` ã¨ã™ã‚‹ã‹ã§ãƒ‘ãƒƒãƒã®å½“ã¦æ–¹ãŒå¤‰ã‚ã£ã¦ãã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚\n\nä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹æƒ³å®šã§å®Ÿé¨“ã—ã¦ã¿ã¾ã™ã€‚\n\n```pyconfig\nterminal = false\n\n[[fetch]]\nfrom = \"../../../assets/posts/2023/03/a.py\"\nto_file = \"./a.py\"\n\n[[fetch]]\nfrom = \"../../../assets/posts/2023/03/b.py\"\nto_file = \"./b.py\"\n\n[[fetch]]\nfrom = \"../../../assets/posts/2023/03/c.py\"\nto_file = \"./c.py\"\n\n[[fetch]]\nfrom = \"../../../assets/posts/2023/03/test_b.py\"\nto_file = \"./test_b.py\"\n\n[[fetch]]\nfrom = \"../../../assets/posts/2023/03/test_c.py\"\nto_file = \"./test_c.py\"\n```\n\n`a.py` ã® `SomeClass` ã¯ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ãŒä¾å­˜ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ã§ã™ã€‚ã“ã‚ŒãŒãƒ¢ãƒƒã‚¯ã®å¯¾è±¡ã¨ãªã‚‹ã‚¯ãƒ©ã‚¹ã§ã™ã€‚\n\n```python:a.py\nclass SomeClass:\n    def some_method(self):\n        raise NotImplementedError()\n```\n\n`b.py` ã® `SystemUnderTest` ã¯ãã®åã®é€šã‚Šãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚`b.py` ã§ã¯ `from a import SomeClass` ã§ import ã—ã¦ã‹ã‚‰ `SomeClass()` ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¦ã„ã¾ã™ã€‚\n\n\u003e ã“ã®çŠ¶æ…‹ã§ `a.SomeClass` ã‚’ patch() ã‚’ä½¿ã£ã¦ mock out ã—ã¦ã‚‚ãƒ†ã‚¹ãƒˆã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« b ã¯ã™ã§ã« æœ¬ç‰©ã® `SomeClass` ã¸ã®å‚ç…§ã‚’æŒã£ã¦ã„ã¦ã€ãƒ‘ãƒƒãƒã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‹ã‚‰ã§ã™ã€‚\n\u003e\n\u003e é‡è¦ãªã®ã¯ã€ SomeClass ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ (ã‚‚ã—ãã¯ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹) å ´æ‰€ã«ãƒ‘ãƒƒãƒã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã®å ´åˆã€ `some_function` ã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« b ã®ä¸­ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸ `SomeClass` ã‚’ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã™ã€‚\n\nãªã®ã§ãƒ‘ãƒƒãƒã™ã‚‹æ™‚ã¯ `@patch(\"b.SomeClass\")` ã¨ã—ã¾ã™ã€‚\n\n```python:b.py\nfrom a import SomeClass\n\n\nclass SystemUnderTest:\n    def some_function(self):\n        sc = SomeClass()\n        return sc.some_method()\n```\n\n`c.py` ã® `SystemUnderTest` ã‚‚ãã®åã®é€šã‚Šãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚`ï½ƒ.py` ã§ã¯ `import a` ã§ import ã—ã¦ã‹ã‚‰ `a.SomeClass()` ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¦ã„ã¾ã™ã€‚\n\n\u003e ã“ã®å ´åˆã€ãƒ‘ãƒƒãƒã—ãŸã„ã‚¯ãƒ©ã‚¹ã¯ãã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ `a.SomeClass` ã‚’ãƒ‘ãƒƒãƒã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™\n\nãªã®ã§ `@patch(\"a.SomeClass\")` ã¨æ›¸ã„ã¦ãƒ‘ãƒƒãƒã‚’å½“ã¦ã¾ã™ã€‚\n\n```python:c.py\nimport a\n\n\nclass SystemUnderTest:\n    def some_function(self):\n        sc = a.SomeClass()\n        return sc.some_method()\n```\n\nãã‚Œãã‚Œã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ç¢ºã‹ã‚ã¦ã¿ã¾ã™ã€‚`TestB` ã® `test_patching_a` ã¯ãƒ‘ãƒƒãƒãŒå½“ãŸã‚‰ãªã„ã®ã§å¤±æ•—ã™ã‚‹ã¯ãšã§ã™ã€‚\n\n```python:test_b.py\nimport unittest\nfrom unittest.mock import patch\n\nfrom b import SystemUnderTest\n\n\nclass TestB(unittest.TestCase):\n    @patch(\"a.SomeClass\")\n    def test_patching_a(self, some_class_mock):\n        some_class_mock_instance = some_class_mock.return_value\n        some_class_mock_instance.some_method.return_value = \"mock\"\n        sut = SystemUnderTest()\n        # Call below will raise NotImplementedError since it is not patched\n        actual = sut.some_function()\n        assert actual == \"mock\"\n\n    @patch(\"b.SomeClass\")\n    def test_patching_b(self, some_class_mock):\n        some_class_mock_instance = some_class_mock.return_value\n        some_class_mock_instance.some_method.return_value = \"mock\"\n        sut = SystemUnderTest()\n        actual = sut.some_function()\n        assert actual == \"mock\"\n```\n\n`TestC` ã® `test_patching_c` ã§ã¯ãƒ‘ãƒƒãƒã‚’å½“ã¦ã‚‹ã“ã¨ã«å¤±æ•—ã—ã¾ã™ã€‚\n\n```python:test_c.py\nimport unittest\nfrom unittest.mock import patch\n\nfrom c import SystemUnderTest\n\n\nclass TestC(unittest.TestCase):\n    @patch(\"a.SomeClass\")\n    def test_patching_a(self, some_class_mock):\n        some_class_mock_instance = some_class_mock.return_value\n        some_class_mock_instance.some_method.return_value = \"mock\"\n        sut = SystemUnderTest()\n        actual = sut.some_function()\n        assert actual == \"mock\"\n\n    @patch(\"c.SomeClass\")  # will raise AttributeError\n    def test_patching_c(self, some_class_mock):\n        some_class_mock_instance = some_class_mock.return_value\n        some_class_mock_instance.some_method.return_value = \"mock\"\n        sut = SystemUnderTest()\n        actual = sut.some_function()\n        assert actual == \"mock\"\n```\n\nå®Ÿè¡Œã—ã¾ã™ã€‚\n\n```python:main.py:pyscript\nfrom unittest import TestLoader\nfrom unittest import TextTestRunner\n\n\nloader = TestLoader()\ntest = loader.discover(\".\")\nrunner = TextTestRunner()\nrunner.run(test)\n```\n\n```pyterminal\n```\n\næœŸå¾…é€šã‚Šã®çµæœãŒå¾—ã‚‰ã‚Œã¦ã„ã¾ã™ã­ã€‚Python ã® import ã¾ã‚ã‚Šã¯ã‚„ã£ã±ã‚Šãªã‚“ã‹é¢å€’ãã•ã„ãƒ»ãƒ»ãƒ»ã€‚\n\n## å‚è€ƒæ–‡çŒ®\n\n* [unittest.mock --- ãƒ¢ãƒƒã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª](https://docs.python.org/ja/3/library/unittest.mock.html)\n","tags":[{"name":"Python","ref":"/tags/python"},{"name":"å˜ä½“ãƒ†ã‚¹ãƒˆ","ref":"/tags/å˜ä½“ãƒ†ã‚¹ãƒˆ"}],"showTerminalAside":true},{"title":"Ansibleã§gpgå…¬é–‹éµã¨aptã®ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒªãƒã‚¸ãƒˆãƒªã‚’è¿½åŠ ã™ã‚‹ ï½Terraformã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã„ï½","date":"2023-03-01T00:00:00.000Z","ref":"/posts/2023/03/ansible-apt-repo-signed-by-gpg-key","desc":" apt ã‚’ä½¿ã£ã¦ docker ã‚„ terraform ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ™‚ãªã©ã€æä¾›å…ƒã®ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ apt ãƒªãƒã‚¸ãƒˆãƒªã‚’è¿½åŠ ã™ã‚‹å ´åˆãŒçµæ§‹ã‚ã‚Šã¾ã™ã‚ˆã­ã€‚ãã®éš›ã«ã€ä»Šã¾ã§ã¯ `apt-key` ã‚’ä½¿ã£ã¦ OpenPGP å…¬é–‹éµã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ãŸã®ã§ã™ãŒã€`apt-key` ã¯ [Debian","draft":false,"content":"\napt ã‚’ä½¿ã£ã¦ docker ã‚„ terraform ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ™‚ãªã©ã€æä¾›å…ƒã®ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ apt ãƒªãƒã‚¸ãƒˆãƒªã‚’è¿½åŠ ã™ã‚‹å ´åˆãŒçµæ§‹ã‚ã‚Šã¾ã™ã‚ˆã­ã€‚ãã®éš›ã«ã€ä»Šã¾ã§ã¯ `apt-key` ã‚’ä½¿ã£ã¦ OpenPGP å…¬é–‹éµã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ãŸã®ã§ã™ãŒã€`apt-key` ã¯ [Debian 11 ã¨ Ubuntu 22.04 ã‚’æœ€å¾Œã«ä½¿ãˆãªããªã‚‹](https://manpages.debian.org/unstable/apt/apt-key.8.ja.html) ã®ã§ã€ä»Šå¾Œã¯ `gnupg` ã‚’ä½¿ã£ãŸæ–¹æ³•ãŒä¸»æµã«ãªã£ã¦ã„ãã¾ã™ã€‚\n\nAnsible ã«ã‚‚ [ansible.builtin.apt_key module](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_key_module.html) ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã¯å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã•ã‚Œã‚‹ã‚‚ã®ã®ã€ä»Šå¾Œæ–°ãŸã«ä½¿ã†ã®ã¯é¿ã‘ãŸã»ã†ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚\n\nå¹¸ã„ã€ã“ã‚Œã‹ã‚‰ã®å…¬é–‹éµã¨ apt ãƒªãƒã‚¸ãƒˆãƒªã®ç´ã¥ã‘ã®æ–¹æ³•ã¯ã¨ã¦ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚\n\n* å…¬é–‹éµã¯ã©ã“ã«ãŠã„ã¦ã‚‚ OK\n  * `/usr/share/keyrings/` ã«ç½®ãã“ã¨ãŒå¤šãã†\n* `deb [signed-by=/path/to/key] ...` ã¨æ›¸ã„ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ `/etc/apt/sources.list.d` ã«è¿½åŠ ã™ã‚‹\n  * `add-apt-repository` ã§ã‚‚åŒæ§˜\n* å…¬é–‹éµã®å½¢å¼ã¯ `.asc` ã§ã‚‚ `.gpg` ã§ã‚‚ OK\n  * [apt-key ãŒéæ¨å¥¨ã«ãªã£ãŸã®ã§](https://zenn.dev/spiegel/articles/20220508-apt-key-is-deprecated) ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™\n\n3ç‚¹ç›®ã®å…¬é–‹éµã®å½¢å¼ã«ã¤ã„ã¦ã¯ã€ç§ã¯ãã‚‚ãã‚‚2ç¨®é¡ã‚ã‚‹ã“ã¨ã‚’ä»Šå›åˆã‚ã¦çŸ¥ã‚Šã¾ã—ãŸã€‚\n\n* ãƒã‚¤ãƒŠãƒªå½¢å¼\n  * `.gpg` æ‹¡å¼µå­\n* ASCII å½¢å¼ï¼ˆarmoredï¼‰\n  * `.asc` æ‹¡å¼µå­\n\nã¾ããƒã‚¤ãƒŠãƒªã‹ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ã¨ã„ã†é•ã„ã ã‘ã§ã™ã­ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã‚‹ã¨ãã¯ asc ã«ãªã£ã¦ã„ã¦ã€ãã®ã‚ã¨ dearmor ã—ã¦æ ¼ç´ã™ã‚‹ã¨ã„ã†æ‰‹é †ã‚’ [Docker](https://docs.docker.com/engine/install/ubuntu/) ãŠã‚ˆã³ [Hashicorp](https://www.hashicorp.com/official-packaging-guide) ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸï¼ˆã„ã¤ã‚‚æ„å‘³ã‚’ç†è§£ã›ãšã«ã‚³ãƒãƒ³ãƒ‰ã‚’æµã—è¾¼ã‚“ã§ã„ãŸã“ã¨ã‚’åçœï¼‰ã€‚\n\n## æˆæœç‰©\n\nå‰æ®µãŒé•·ããªã‚Šã¾ã—ãŸãŒã€ä»Šå›ä½œã£ã¦ã„ã Ansible ã® task ã¯ä»¥ä¸‹ã®æµã‚Œã«ãªã‚Šã¾ã™ã€‚\n\n1. `apt update` \u0026\u0026 ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«\n1. å…¬é–‹éµï¼ˆ`.asc` å½¢å¼ï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰\n1. å…¬é–‹éµã®ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆã‚’æ¤œè¨¼\n1. ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ apt ãƒªãƒã‚¸ãƒˆãƒªã®è¿½åŠ  \u0026\u0026 `apt update`\n1. ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ apt ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«\n\nHashicorp ã®å…¬é–‹éµã¨ apt ãƒªãƒã‚¸ãƒˆãƒªã‚’è¿½åŠ ã—ã¦ã€terraform ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã®ã‚µãƒ³ãƒ—ãƒ«ãŒä¸‹è¨˜ã«ãªã‚Šã¾ã™ã€‚ä»–ã®ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ apt ãƒªãƒã‚¸ãƒˆãƒªã‚’è¿½åŠ ã™ã‚‹å ´åˆã«ã‚‚å¿œç”¨ãŒåˆ©ãã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚\n\n```yaml\n- name: apt cache is updated\n  apt:\n    update_cache: yes\n    cache_valid_time: 3600\n  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'\n\n- name: prerequisites are installed\n  package:\n    name: \"{{ item }}\"\n    state: present\n  with_items:\n    - gnupg\n    - software-properties-common\n\n- name: hashicorp gpg key is installed\n  ansible.builtin.get_url:\n    url: https://apt.releases.hashicorp.com/gpg\n    dest: /usr/share/keyrings/hashicorp-archive-keyring.asc\n\n- name: hashicorp gpg key is verified\n  command: gpg --dry-run -q --import --import-options import-show /usr/share/keyrings/hashicorp-archive-keyring.asc\n  register: hashicorp_gpg_show_result\n  changed_when: no\n  # MEMO: Check the URL below for the latest fingerprint.\n  #       https://www.hashicorp.com/official-packaging-guide\n  failed_when: \"'798AEC654E5C15428C8E42EEAA16FCBCA621E701' not in hashicorp_gpg_show_result.stdout\"\n\n- name: hashicorp repository is added\n  ansible.builtin.apt_repository:\n    repo: deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.asc] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main\n    filename: hashicorp\n    state: present\n\n- name: terraform is installed\n  package:\n    name: terraform\n    state: present\n```\n\n## ã™ã“ã—è§£èª¬\n\n`hashicorp gpg key is verified` ã§ã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸå…¬é–‹éµãŒå…¬å¼ã®ã‚‚ã®ã‹ã©ã†ã‹ã‚’ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆã‚’æ¯”è¼ƒã—ã¦æ¤œè¨¼ã—ã¦ã„ã¾ã™ã€‚ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆã¯åŸ·ç­†æ™‚ç‚¹ï¼ˆ2023/3/1ï¼‰ã®ã‚‚ã®ã§ã™ã€‚\n\nè‹¥å¹²æ°—æŒã¡æ‚ªã„å®Ÿè£…ãªæ°—ã‚‚ã™ã‚‹ã®ã§ï¼ˆã¨ã¯ã„ãˆç›®è¦–ã§ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¨åŒã˜ã ã‘ã©ã‚‚ï¼‰ã€ã‚‚ã£ã¨è‰¯ã„å®Ÿè£…ã‚’çŸ¥ã£ã¦ã„ã‚‹äººã¯ãœã²æ•™ãˆã¦ãã ã•ã„ã€‚ã€‚\n\nå‚è€ƒã¾ã§ã« `gpg --dry-run -q --import --import-options import-show /usr/share/keyrings/hashicorp-archive-keyring.asc` ã®å‡ºåŠ›ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\n\n```\npub   rsa4096 2023-01-10 [SC] [expires: 2028-01-09]\n      798AEC654E5C15428C8E42EEAA16FCBCA621E701\nuid                      HashiCorp Security (HashiCorp Package Signing) \u003csecurity+packaging@hashicorp.com\u003e\nsub   rsa4096 2023-01-10 [S] [expires: 2028-01-09]\n```\n\n`hashicorp repository is added` ã§ã¯ `signed-by=` ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸå…¬é–‹éµã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§å…¬é–‹éµã¨ apt ãƒªãƒã‚¸ãƒˆãƒªã‚’ç´ã¥ã‘ã¦ã„ã¾ã™ã€‚Ansible ã® `ansible_distribution_release` å¤‰æ•°ã‚’ä½¿ã†ã“ã¨ã§ã€ã‚³ãƒ¼ãƒ‰ãƒãƒ¼ãƒ ï¼ˆjammy ã¨ã‹ focal ã¨ã‹ bionic ã¨ã‹ï¼‰ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆ`lsb_release -cs` ã¨åŒç­‰ï¼‰ã€‚\n\n`ansible.builtin.apt_repository module` ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ changed ã®æ™‚ã«è‡ªå‹•ã§ `apt update` ã‚‚ã—ã¦ãã‚Œã‚‹ã®ã§æ˜ç¤ºçš„ã«æ›¸ãå¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\n\n## å®Ÿè¡Œçµæœ\n\n```\nPLAY [localhost] **********************************************************************************************************\n\nTASK [Gathering Facts] ****************************************************************************************************\nok: [localhost]\n\nTASK [apt cache is updated] ***********************************************************************************************\nok: [localhost]\n\nTASK [prerequisites are installed] ****************************************************************************************\nok: [localhost] =\u003e (item=gnupg)\nok: [localhost] =\u003e (item=software-properties-common)\n\nTASK [hashicorp gpg key is installed] *************************************************************************************\nchanged: [localhost]\n\nTASK [hashicorp gpg key is verified] **************************************************************************************\nok: [localhost]\n\nTASK [hashicorp repository is added] **************************************************************************************\nchanged: [localhost]\n\nTASK [terraform is installed] *********************************************************************************************\nchanged: [localhost]\n\nPLAY RECAP ****************************************************************************************************************\nlocalhost                  : ok=7    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n```\n\n## å‚è€ƒæ–‡çŒ®\n\n* [APT-KEY(8)](https://manpages.debian.org/unstable/apt/apt-key.8.ja.html)\n* [ansible.builtin.apt_key module â€“ Add or remove an apt key](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_key_module.html)\n* [ansible.builtin.apt_repository module â€“ Add and remove APT repositories](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_repository_module.html)\n* [Official Packaging Guide](https://www.hashicorp.com/official-packaging-guide)\n* [Install Terraform](https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli)\n* [Install Docker Engine on Ubuntu](https://docs.docker.com/engine/install/ubuntu/)\n* [apt-key ãŒéæ¨å¥¨ã«ãªã£ãŸã®ã§](https://zenn.dev/spiegel/articles/20220508-apt-key-is-deprecated)\n* [éæ¨å¥¨ã¨ãªã£ãŸapt-keyã®ä»£ã‚ã‚Šã«signed-byã¨gnupgã‚’ä½¿ã†æ–¹æ³•](https://www.clear-code.com/blog/2021/5/5.html)\n* [GnuPG ã®ä½¿ç”¨æ³•](https://www.math.s.chiba-u.ac.jp/~matsu/gpg/gpg-3.html)\n* [How do I verify an asc key fingerprint?](https://askubuntu.com/questions/48508/how-do-i-verify-an-asc-key-fingerprint)\n","tags":[{"name":"Ansible","ref":"/tags/ansible"},{"name":"Terraform","ref":"/tags/terraform"},{"name":"APT","ref":"/tags/apt"}],"showTerminalAside":false},{"title":"Terraformã§API Gatewayã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ã‚’è¨­å®šã™ã‚‹","date":"2023-02-23T00:00:00.000Z","ref":"/posts/2023/02/aws-api-gateway-terraform-throttling-settings","desc":" AWS API Gateway ã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ã‚’ Terraform ã‚’ä½¿ã£ã¦è¨­å®šã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¤ã‘ã‚‹ã¾ã§ã«å°‘ã—æ‰‹é–“å–ã£ãŸã®ã§ãƒ¡ãƒ¢ã€‚\n\n## AWS ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã®å ´æ‰€\n\nä»Šå› Terraform ã§è¨­å®šã™ã‚‹ã®ã¯ã€ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®å„ã‚¹ãƒ†ãƒ¼ã‚¸ã®è¨­å®šç”»é¢å†…ã®ã€Œãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚¹","draft":false,"content":"\nAWS API Gateway ã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ã‚’ Terraform ã‚’ä½¿ã£ã¦è¨­å®šã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¤ã‘ã‚‹ã¾ã§ã«å°‘ã—æ‰‹é–“å–ã£ãŸã®ã§ãƒ¡ãƒ¢ã€‚\n\n## AWS ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã®å ´æ‰€\n\nä»Šå› Terraform ã§è¨­å®šã™ã‚‹ã®ã¯ã€ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®å„ã‚¹ãƒ†ãƒ¼ã‚¸ã®è¨­å®šç”»é¢å†…ã®ã€Œãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ã€ã«è©²å½“ã™ã‚‹ç®‡æ‰€ã§ã™ã€‚\n\n![management console](/images/posts/2023/02/aws_apigw_console.png)\n\n## ãã‚‚ãã‚‚ API Gateway ã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ã¨ã¯\n\nAPI Gateway ã§ã¯ API ãŒ1ç§’ã‚ãŸã‚Šã«å‡¦ç†ã§ãã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚„åŒæ™‚ã«å‡¦ç†ã§ãã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’åˆ¶é™ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦è² è·ãŒé«˜ããªã‚Šã™ããŸã‚Šã€æ”»æ’ƒã«ã‚ˆã£ã¦æ„å›³ã—ãªã„é«˜é¡è«‹æ±‚ã‚’å—ã‘ã¦ã—ã¾ã£ãŸã‚Šã™ã‚‹ãƒªã‚¹ã‚¯ã‚’æ¸›ã‚‰ã™ã“ã¨ãŒã§ãã¾ã™ã€‚\n\nãŸã ã—ã€ã“ã®è¨­å®šã¯ãƒ™ã‚¹ãƒˆã‚¨ãƒ•ã‚©ãƒ¼ãƒˆã§æä¾›ã•ã‚Œã‚‹ãŸã‚ã€**ã“ã®è¨­å®šå€¤ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸Šé™ã«ãªã‚‹ã‚ã‘ã§ã¯ãªã„**ã¨ã„ã†ç‚¹ã«æ³¨æ„ã¯å¿…è¦ã§ã™ã€‚\n\n\u003e API ã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ãŠã‚ˆã³ã‚¯ã‚©ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¦ã€å¤šã™ãã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ API ã®è² è·ãŒé«˜ããªã‚Šã™ããªã„ã‚ˆã†ã«ä¿è­·ã§ãã¾ã™ã€‚ã‚¹ãƒ­ãƒƒãƒˆãƒ«ã¨ã‚¯ã‚©ãƒ¼ã‚¿ã®ä¸¡æ–¹ã¯ãƒ™ã‚¹ãƒˆã‚¨ãƒ•ã‚©ãƒ¼ãƒˆãƒ™ãƒ¼ã‚¹ã§é©ç”¨ã•ã‚Œã‚‹ãŸã‚ã€ã“ã‚Œã‚‰ã¯ä¿è¨¼ã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸Šé™ã§ã¯ãªãã€ç›®æ¨™ã¨ã—ã¦è€ƒãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\n\n_[AWS ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ã‚¬ã‚¤ãƒ‰](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-request-throttling.html)ã‚ˆã‚Šå¼•ç”¨ã€‚_\n\n### è¨­å®šã§ãã‚‹å€¤\n\nä»¥ä¸‹ã®2ã¤ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã®åˆ¶é™ã‚’ä¸Šå›ã£ãŸæ™‚ã€`429 Too Many Requests` ãŒè¿”ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\n\n* **ãƒ¬ãƒ¼ãƒˆï¼š1ç§’ã‚ãŸã‚Šã«å‡¦ç†ã§ãã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°**\n* **ãƒãƒ¼ã‚¹ãƒˆï¼šåŒæ™‚ã«å‡¦ç†ã§ãã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°**\n\n### ã‚¹ã‚³ãƒ¼ãƒ—\n\næ¬¡ã®ã‚¹ã‚³ãƒ¼ãƒ—ã®é †åºã§é©ç”¨ã•ã‚Œã¾ã™ï¼ˆï¼‘ãŒæœ€ã‚‚å„ªå…ˆã•ã‚Œã‚‹ï¼‰ã€‚\n\n\u003e 1. ä½¿ç”¨é‡ãƒ—ãƒ©ãƒ³ã§ API ã‚¹ãƒ†ãƒ¼ã‚¸ã«è¨­å®šã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚ãŸã‚Šã€ã¾ãŸã¯ãƒ¡ã‚½ãƒƒãƒ‰ã‚ãŸã‚Šã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°åˆ¶é™\n\u003e 2. API ã‚¹ãƒ†ãƒ¼ã‚¸ã«è¨­å®šã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ã‚ãŸã‚Šã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°åˆ¶é™\n\u003e 3. ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã”ã¨ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°\n\u003e 4. AWS ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°\n\n_[AWS ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ã‚¬ã‚¤ãƒ‰](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-request-throttling.html)ã‚ˆã‚Šå¼•ç”¨ã€‚_\n\n1ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆAPI ã‚­ãƒ¼ï¼‰å˜ä½ã®è¨­å®šã§ã™ã€‚ã“ã‚Œã«é–¢ã—ã¦ã¯ä»Šå›ã®è¨˜äº‹ã®ã‚¹ã‚³ãƒ¼ãƒ—å¤–ã§ã™ã®ã§ã€è©¦ã—ã¦ã¿ãŸã„æ–¹ã¯ AWS ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ã‚¬ã‚¤ãƒ‰ [API ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ãŸä½¿ç”¨é‡ãƒ—ãƒ©ãƒ³ã®ä½œæˆã¨ä½¿ç”¨](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-api-usage-plans.html)ã®ãƒšãƒ¼ã‚¸ã‚’ã”è¦§ãã ã•ã„ã€‚\n\n2ãŒä»Šå›è¨­å®šã™ã‚‹é …ç›®ã«ãªã‚Šã¾ã™ã€‚ä»Šå›ã¯ã‚ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¸ã«ãŠã‘ã‚‹ã™ã¹ã¦ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å¯¾è±¡ã«ã—ãŸè¨­å®šã‚’è¡Œã„ã¾ã™ãŒã€**ãƒ‘ã‚¹ã”ã¨ãƒ¡ã‚½ãƒƒãƒ‰ã”ã¨ã®è¨­å®šã‚’è¡Œã†ã“ã¨ã‚‚å¯èƒ½**ã§ã™ã€‚\n\n3ã¯ AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå˜ä½ã®è¨­å®šã«ãªã‚Šã¾ã™ã€‚ä»Šå›ã®è¨˜äº‹ã®ã‚¹ã‚³ãƒ¼ãƒ—å¤–ã§ã™ã€‚\n\n4ã¯ AWS ãŒè¨­å®šã—ã¦ã„ã‚‹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã”ã¨ã®è¨­å®šã«ãªã‚Šã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚ã¾ãŸã€1ã€œ3ã®è¨­å®šå€¤ã¯4ã®å€¤ã‚ˆã‚Šã‚‚é«˜ãã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚\n\n## Terraform ã§ã®è¨­å®šæ–¹æ³•\n\nTerraform ã§ API Gateway ã®ã‚ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¸ã«ãŠã‘ã‚‹ã™ã¹ã¦ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å¯¾è±¡ã«ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ã®è¨­å®šã‚’è¡Œã†ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã‘ã° OK ã§ã™ã€‚\n\n```tf\nresource \"aws_api_gateway_method_settings\" \"example\" {\n  rest_api_id = aws_api_gateway_rest_api.example.id\n  stage_name  = aws_api_gateway_stage.example.stage_name\n  method_path = \"*/*\"\n\n  settings {\n    throttling_rate_limit  = 2\n    throttling_burst_limit = 1\n  }\n}\n```\n\nã“ã® `settings` ã«ã¯ä¸Šè¨˜2ã¤ä»¥å¤–ã«ã‚‚ API Gateway é–¢é€£ã®è¨­å®šãŒã§ãã¾ã™ã®ã§æ°—ã«ãªã‚‹æ–¹ã¯ Terraform ç¤¾ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ [Resource: aws_api_gateway_method_settings](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_method_settings) ã‚’ã”è¦§ãã ã•ã„ã€‚\n\n## ã‚µãƒ³ãƒ—ãƒ«\n\nä¸‹è¨˜ã‚µãƒ³ãƒ—ãƒ«ã¯ [API Gateway REST API OpenAPI Example](https://github.com/hashicorp/terraform-provider-aws/tree/main/examples/api-gateway-rest-api-openapi) ã‚’åŸºã«ä½œæˆã—ã¦ã„ã¾ã™ã€‚\n\næ³¨æ„ç‚¹ã¨ã—ã¦ã€Terraform ç¤¾ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ¬¡ã®è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ã€‚\n\n\u003e We recommend using this resource in conjunction with the `aws_api_gateway_stage` resource instead of a stage managed by the `aws_api_gateway_deployment` resource optional `stage_name` argument. Stages managed by the `aws_api_gateway_deployment` resource are recreated on redeployment and this resource will require a second apply to recreate the method settings.  \n\u003e è¨³ï¼šã“ã®ãƒªã‚½ãƒ¼ã‚¹ï¼ˆè¨³è¨»ï¼š`aws_api_gateway_method_settings`ï¼‰ã‚’ã€€`aws_api_gateway_stage` ãƒªã‚½ãƒ¼ã‚¹ã¨ã‚ã‚ã›ã¦ä½¿ã†ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚`aws_api_gateway_deployment` ãƒªã‚½ãƒ¼ã‚¹ã®ä»»æ„ã®å¼•æ•° `stage_name` ã§ç®¡ç†ã•ã‚Œã‚‹ã‚¹ãƒ†ãƒ¼ã‚¸ã¨ä¸€ç·’ã«ä½¿ã†ã“ã¨ã¯ãŠã™ã™ã‚ã—ã¾ã›ã‚“ã€‚`aws_api_gateway_deployment` ã§ç®¡ç†ã•ã‚Œã‚‹ã‚¹ãƒ†ãƒ¼ã‚¸ã¯å†ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«å†ä½œæˆã•ã‚Œã€ãƒ¡ã‚½ãƒƒãƒ‰ã®è¨­å®šã‚’å†ä½œæˆã™ã‚‹ãŸã‚ã«å†åº¦ apply ã™ã‚‹å¿…è¦ãŒå‡ºã¦ãã¾ã™ã€‚\n\n_[Terraform ç¤¾ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_method_settings) ã‚ˆã‚Šå¼•ç”¨ã€‚_\n\nã‚‚ã—ã™ã§ã« API Gateway ã«é–¢ã™ã‚‹ Terraform è¨­å®šãŒã‚ã‚Šã€`aws_api_gateway_deployment` ã® `stage_name` å¼•æ•°ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯ã€`aws_api_gateway_stage` ã‚’ä½¿ã£ã¦æ›¸ãã‚ˆã†ã«ä¿®æ­£ã—ãŸã»ã†ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚\n\nãã®éš›ã€\n\n```tf\ntriggers = {\n  redeployment = sha1(jsonencode(aws_api_gateway_rest_api.example.body))\n}\n\nlifecycle {\n  create_before_destroy = true\n}\n```\n\nã‚ãŸã‚ŠãŒé–¢é€£ã™ã‚‹è¨­å®šã«ãªã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚ç§ã®å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã¨ç•°ãªã‚Šã€Lambda ã¨ã®çµ±åˆã‚’è¡Œã£ã¦ã„ãŸã®ã§ã€`sha1(jsonencode(aws_api_gateway_rest_api.example.body))` ã«ç›¸å½“ã™ã‚‹æ›¸ãæ–¹ãŒã‚ã‹ã‚‰ãšã€`triggers` `lifecycle` ã¯æ¶ˆã—ã¡ã‚ƒã„ã¾ã—ãŸã€‚ã€‚ï¼ˆä»Šã®ã¨ã“ã‚ã¯å¤§ä¸ˆå¤«ãã†ã§ã™ãŒã€ã‚‚ã—æ›´æ–°ãŒã‚ã‚Šã¾ã—ãŸã‚‰è¿½è¨˜ã—ã¾ã™ï¼‰\n\n```tf\n#\n# Variables\n#\n\nvariable \"aws_region\" {\n  default     = \"ap-northeast-1\"\n  description = \"AWS Region to deploy example API Gateway REST API\"\n  type        = string\n}\n\nvariable \"rest_api_name\" {\n  default     = \"api-gateway-rest-api-openapi-example\"\n  description = \"Name of the API Gateway REST API (can be used to trigger redeployments)\"\n  type        = string\n}\n\nvariable \"rest_api_path\" {\n  default     = \"/path1\"\n  description = \"Path to create in the API Gateway REST API (can be used to trigger redeployments)\"\n  type        = string\n}\n\n#\n# Provider\n#\n\nprovider \"aws\" {\n  region = var.aws_region\n}\n\n#\n# API Gateway\n#\n\nresource \"aws_api_gateway_rest_api\" \"example\" {\n  body = jsonencode({\n    openapi = \"3.0.1\"\n    info = {\n      title   = var.rest_api_name\n      version = \"1.0\"\n    }\n    paths = {\n      (var.rest_api_path) = {\n        get = {\n          x-amazon-apigateway-integration = {\n            httpMethod           = \"GET\"\n            payloadFormatVersion = \"1.0\"\n            type                 = \"HTTP_PROXY\"\n            uri                  = \"https://ip-ranges.amazonaws.com/ip-ranges.json\"\n          }\n        }\n      }\n    }\n  })\n\n  name = var.rest_api_name\n\n  endpoint_configuration {\n    types = [\"REGIONAL\"]\n  }\n}\n\nresource \"aws_api_gateway_deployment\" \"example\" {\n  rest_api_id = aws_api_gateway_rest_api.example.id\n\n  triggers = {\n    redeployment = sha1(jsonencode(aws_api_gateway_rest_api.example.body))\n  }\n\n  lifecycle {\n    create_before_destroy = true\n  }\n}\n\n#\n# Stage and Stage Settings\n#\n\nresource \"aws_api_gateway_stage\" \"example\" {\n  deployment_id = aws_api_gateway_deployment.example.id\n  rest_api_id   = aws_api_gateway_rest_api.example.id\n  stage_name    = \"example\"\n}\n\nresource \"aws_api_gateway_method_settings\" \"example\" {\n  rest_api_id = aws_api_gateway_rest_api.example.id\n  stage_name  = aws_api_gateway_stage.example.stage_name\n  method_path = \"*/*\"\n\n  settings {\n    throttling_rate_limit  = 2\n    throttling_burst_limit = 1\n  }\n}\n```\n\n```shell\nexport AWS_ACCESS_KEY_ID=\nexport AWS_SECRET_ACCESS_KEY=\n```\n\n```shell\nterraform init\nterraform plan\nterraform apply\n```\n\ncurl ã§åŒæ™‚ã«è¤‡æ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã¦429ãŒè¿”ã£ã¦ãã‚‹ã‹ã‚’ç¢ºã‹ã‚ã¾ã™ã€‚curl ã® `--parallel` ã‚’ä½¿ã†ãŸã‚ã«ã€åŒã˜å†…å®¹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’12å€‹ä½œæˆã—ã¾ã™ã€‚\n\n```shell\nfor i in 0 1 2 3 4 5 6 7 8 9 10 11;\ndo echo 'url = \"https://xxxxxxxxxx.execute-api.ap-northeast-1.amazonaws.com/example/path1\"' \u003e\u003e data.txt;\necho 'output = \"/dev/null\"' \u003e\u003e data.txt;\necho 'write-out = \"%{http_code}\\n\"' \u003e\u003e data.txt;\necho 'silent' \u003e\u003e data.txt;\ndone\n```\n\n```shell\ntime curl --parallel --parallel-immediate --parallel-max 4 --config data.txt\n```\n\nå®Ÿè¡Œçµæœã¯æ¯å›å¤‰ã‚ã‚Šã¾ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœã«ãªã‚Šã¾ã™ã€‚ãã£ã‹ã‚Šãƒ¬ãƒ¼ãƒˆ2ãƒ»ãƒãƒ¼ã‚¹ãƒˆ1ã«ãªã£ã¦ã„ãªã•ãã†ãªã®ã§ã€ã‚„ã¯ã‚Šãƒ™ã‚¹ãƒˆã‚¨ãƒ•ã‚©ãƒ¼ãƒˆãªã®ã ãªã¨ã„ã†ã“ã¨ãŒä¼ºãˆã¾ã™ã€‚\n\n```\n200\n200\n200\n200\n429\n429\n200\n200\n429\n200\n200\n200\n\nreal    0m1.527s\nuser    0m0.114s\nsys     0m0.151s\n```\n\n## å‚è€ƒæ–‡çŒ®\n\n* [API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’èª¿æ•´ã—ã¦ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã‚’å‘ä¸Šã•ã›ã‚‹](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-request-throttling.html)\n* [Resource: aws_api_gateway_method_settings](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_method_settings)\n* [API Gateway REST API OpenAPI Example](https://github.com/hashicorp/terraform-provider-aws/tree/main/examples/api-gateway-rest-api-openapi)\n* [Burst Throttling on AWS API Gateway Explained](https://www.petefreitag.com/item/853.cfm)\n","tags":[{"name":"AWS","ref":"/tags/aws"},{"name":"API Gateway","ref":"/tags/api-gateway"},{"name":"Terraform","ref":"/tags/terraform"}],"showTerminalAside":false},{"title":"ãƒ—ãƒ­ã‚»ã‚¹å¤–ä¾å­˜ã¯çµ±åˆãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ã‚ˆã†ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬3éƒ¨","date":"2023-02-22T00:00:00.000Z","ref":"/posts/2023/02/unit-testing-principles-practices-and-patterns-part3","desc":" ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰ã‚’èª­ã‚“ã ã®ã§ã€ãã®ã¾ã¨ã‚ã‚’éƒ¨ã”ã¨ã«æ›¸ã„ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚\n\n1. [å˜ä½“ãƒ†ã‚¹ãƒˆã®ç›®çš„ãƒ»å®šç¾©ãƒ»å­¦æ´¾ãƒ»å‘½å","draft":false,"content":"\n[ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰](https://book.mynavi.jp/ec/products/detail/id=134252)ã‚’èª­ã‚“ã ã®ã§ã€ãã®ã¾ã¨ã‚ã‚’éƒ¨ã”ã¨ã«æ›¸ã„ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚\n\n1. [å˜ä½“ãƒ†ã‚¹ãƒˆã®ç›®çš„ãƒ»å®šç¾©ãƒ»å­¦æ´¾ãƒ»å‘½åã«ã¤ã„ã¦ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬1éƒ¨](/posts/2023/01/unit-testing-principles-practices-and-patterns-part1)\n1. [ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã‚„ã™ã„ãƒ†ã‚¹ãƒˆã‚’æ›¸ã“ã†ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬2éƒ¨å‰åŠ](/posts/2023/02/unit-testing-principles-practices-and-patterns-part2-1)\n1. [ãƒ“ã‚¸ãƒã‚¹ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ã¨é€£æºã®æŒ‡æ®ã‚’åˆ†é›¢ã™ã‚Œã°è‰¯ã„ãƒ†ã‚¹ãƒˆãŒæ›¸ã‘ã‚‹ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬2éƒ¨å¾ŒåŠ](/posts/2023/02/unit-testing-principles-practices-and-patterns-part2-2)\n1. ãƒ—ãƒ­ã‚»ã‚¹å¤–ä¾å­˜ã¯çµ±åˆãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ã‚ˆã†ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬3éƒ¨ï¼ˆã“ã®è¨˜äº‹ï¼‰\n\nä»Šå›ã¯ç¬¬3éƒ¨ã€Œçµ±åˆï¼ˆintegrationï¼‰ãƒ†ã‚¹ãƒˆã€ã«ã¤ã„ã¦ã®æ„Ÿæƒ³ã¨è€ƒå¯Ÿã«ãªã‚Šã¾ã™ã€‚ç¬¬3éƒ¨ã¯ä»¥ä¸‹ã®3ç« ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚ç¬¬4éƒ¨ã€Œå˜ä½“ãƒ†ã‚¹ãƒˆã®ã‚¢ãƒ³ãƒãƒ»ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã«ã¤ã„ã¦ã¯å‰²æ„›ã—ã¾ã™ãŒã€ã“ã“ã«ã‚‚ã¾ãŸé‡è¦ã‹ã¤æ°—ã«ãªã‚‹ãƒˆãƒ”ãƒƒã‚¯ã®å†…å®¹ãŒæ›¸ã‹ã‚Œã¦ã„ãŸã®ã§ã€èˆˆå‘³ã®ã‚ã‚‹æ–¹ã¯ãœã²æ‰‹ã«å–ã£ã¦èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚\n\n* ç¬¬8ç« ï¼šãªãœã€çµ±åˆï¼ˆintegrationï¼‰ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã®ã‹ï¼Ÿ\n* ç¬¬9ç« ï¼šãƒ¢ãƒƒã‚¯ã®ãƒ™ã‚¹ãƒˆãƒ»ãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹\n* ç¬¬10ç« ï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆ\n\nã“ã‚Œã‚‰ã®ç« ã§ã¯ã€ç§ãŒã“ã®æœ¬ã‚’èª­ã¿ãªãŒã‚‰å®Ÿéš›ã«ã©ã®ã‚ˆã†ã«è‡ªåˆ†ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã„ãã‹ã‚’è€ƒãˆã¦ã„ã‚‹ã¨ãã«æµ®ã‹ã‚“ã§ã„ãŸç–‘å•ç‚¹ã‚’ã»ã¼ã™ã¹ã¦è§£æ¶ˆã—ã¦ãã‚Œã¾ã—ãŸã€‚\n\nç‰¹ã«å°è±¡ã«æ®‹ã£ãŸã¨ã“ã‚ã‚’ã¾ã¨ã‚ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚\n\n## ãƒ¢ãƒƒã‚¯ã‚’ä½¿ã†ã¹ãã‚¿ã‚¤ãƒŸãƒ³ã‚°\n\n\u003e ç®¡ç†ä¸‹ã«ã‚ã‚‹ä¾å­˜ã«å¯¾ã—ã¦ã¯å®Ÿéš›ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã€ç®¡ç†ä¸‹ã«ãªã„ä¾å­˜ã«å¯¾ã—ã¦ã¯ãƒ¢ãƒƒã‚¯ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚\n\n_ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰p.270 ã‚ˆã‚Šå¼•ç”¨ã€‚_\n\nã“ã“ã§ã„ã†ã€Œç®¡ç†ä¸‹ã«ã‚ã‚‹ä¾å­˜ã€ã¨ã¯ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ã—ã‹åˆ©ç”¨ã•ã‚Œãªã„ã€Œå¥½ããªã‚ˆã†ã«ã§ãã‚‹ã€ä¾å­˜ã®ã“ã¨ã§ã€å¤šãã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãªã©ãŒè©²å½“ã—ã¾ã™ã€‚ã€Œç®¡ç†ä¸‹ã«ãªã„ä¾å­˜ã€ã¨ã¯ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã€Œå¥½ããªã‚ˆã†ã«ã§ããªã„ã€ä¾å­˜ã®ã“ã¨ã§ã€å¤–éƒ¨ã‹ã‚‰è¦³æ¸¬å¯èƒ½ãªæŒ¯ã‚‹èˆã„ã«ãªã‚Šã¾ã™ã€‚\n\nè‘—è€…ã¯ã€ç®¡ç†ä¸‹ã«ãªã„ä¾å­˜ã‚’ãƒ¢ãƒƒã‚¯ã®ç½®ãæ›ãˆã‚‹ã“ã¨ã§ã€Œã©ã®ã‚ˆã†ãªãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œã£ãŸã¨ã—ã¦ã‚‚ã€ç®¡ç†ä¸‹ã«ãªã„ä¾å­˜ã¨ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†éš›ã®ä»•æ§˜ãŒå£Šã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã§ãã‚‹ã€ãŸã‚ã€éå¸¸ã«åŠ¹æœçš„ã¨è¨€ã£ã¦ã„ã¾ã™ã€‚é€†ã«ã€ç®¡ç†ä¸‹ã«ã‚ã‚‹ä¾å­˜ã«å¯¾ã—ã¦ã¯ã€ãã®ã¾ã¾ä½¿ã†ã“ã¨ã§ã€Œå¯¾è±¡ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæœ€çµ‚çš„ã«ã©ã®ã‚ˆã†ãªçŠ¶æ…‹ã«ãªã‚‹ã®ã‹ã‚’å¤–éƒ¨ã®è¦–ç‚¹ã‹ã‚‰æ¤œè¨¼ã—ã‚„ã™ãã€ãªã‚Šã€åŠ ãˆã¦ã€ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼ˆãŸã¨ãˆã°ã€ã‚«ãƒ©ãƒ ã®åå‰ã®å¤‰æ›´ã‚„ã»ã‹ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ç§»è¡Œï¼‰ã‚‚ãŠã“ãªã„ã‚„ã™ãã€ãªã‚‹ã¨è¨€ã£ã¦ã„ã¾ã™ï¼ˆp.270ï¼‰ã€‚\n\n## é–‹ç™ºè€…ã—ã‹è¦‹ãªã„ãƒ­ã‚°ã¯ãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ãªã„\n\n\u003e ãƒ­ã‚°å‡ºåŠ›ã‚’ãƒ†ã‚¹ãƒˆã™ã¹ãã‹ã€ã¨ã„ã†å•ã„ã®ç­”ãˆã¯ã€**ãƒ†ã‚¹ãƒˆå¯¾è±¡ã¨ã™ã‚‹ãƒ­ã‚°å‡ºåŠ›ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¦³æ¸¬å¯èƒ½ãªæŒ¯ã‚‹èˆã„ã®ä¸€éƒ¨ãªã®ã‹ã€ãã‚Œã¨ã‚‚ã€å®Ÿè£…ã®è©³ç´°ãªã®ã‹ã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹**ã€ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚\n\n_ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰p.292 ã‚ˆã‚Šå¼•ç”¨ã€‚å¤ªå­—ã¯åŸæ–‡ãƒãƒã€‚_\n\nãªã®ã§ã€ã»ã‹ã®ã™ã¹ã¦ã®å¤–éƒ¨ä¾å­˜ã¨åŒã˜ã‚ˆã†ã«ã€Œå¤–éƒ¨ã‹ã‚‰è¦³æ¸¬å¯èƒ½ãªæŒ¯ã‚‹èˆã„ã€ãªã®ã‹ã€Œå®Ÿè£…ã®è©³ç´°ã€ãªã®ã‹ã§è€ƒãˆã‚Œã°ã‚ˆãã€ã¤ã¾ã‚Šã€ã€Œãƒ“ã‚¸ãƒã‚¹è¦æ±‚ã«å¿œã˜ãŸãƒ­ã‚°ã€ãªã®ã‹ã€Œé–‹ç™ºè€…ã—ã‹è¦‹ãªã„ãƒ­ã‚°ã€ãªã®ã‹ã€ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚\n\n## æœ¬ç•ªã¨åŒã˜ç¨®é¡ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ãƒ†ã‚¹ãƒˆã‚’è¡ŒãŠã†\n\nå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒ†ã‚¹ãƒˆã§ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã¯ãã‚Œãªã‚Šã®å·¥å¤«ãŒå¿…è¦ã§ã—ã‚‡ã†ã€‚ã¾ãŸã€ãã®ã‚³ã‚¹ãƒˆã‚’è€ƒãˆã¦ãƒ¢ãƒƒã‚¯ã«ã—ã¦ã„ã‚‹ã¨ã„ã†äººã‚‚å¤šã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚ã¨ã¯ã„ãˆã€å‰ã€…é …ã§è‘—è€…ãŒæŒ™ã’ã¦ã„ã‚‹åˆ©ç‚¹ã¯ã€ãã®ã‚³ã‚¹ãƒˆã‚’ä¸Šå›ã‚‹ã‚‚ã®ã ã¨æ€ã„ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç”¨æ„ã™ã‚‹éš›ã®æŒ‡é‡ã‚’ã¾ã¨ã‚ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\n\n\u003e * çµ±åˆãƒ†ã‚¹ãƒˆã§ã®ãƒ‡ãƒ¼ã‚¿ã®å¾Œå§‹æœ«\n\u003e   * å„ãƒ†ã‚¹ãƒˆãƒ»ã‚±ãƒ¼ã‚¹ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å¾©å…ƒã•ã›ã‚‹\n\u003e     * ãƒ†ã‚¹ãƒˆã«è²»ã‚„ã•ã‚Œã‚‹æ™‚é–“ã¯ä»–ã®æ–¹æ³•ã‚ˆã‚Šã‚‚é•·ããªã‚‹\n\u003e   * ãƒ†ã‚¹ãƒˆãƒ»ã‚±ãƒ¼ã‚¹ã®å®Ÿè¡Œå¾Œã«ãƒ‡ãƒ¼ã‚¿ã®å¾Œå§‹æœ«ã‚’ã™ã‚‹\n\u003e     * ãƒ‡ãƒ¼ã‚¿ã®å¾Œå§‹æœ«ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œãªã‹ã£ãŸã¨ãã«å•é¡Œã¨ãªã£ã¦ã—ã¾ã†\n\u003e   * å„ãƒ†ã‚¹ãƒˆãƒ»ã‚±ãƒ¼ã‚¹ã‚’1ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§è¡Œã„ã€ã‚³ãƒŸãƒƒãƒˆã›ãšã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹\n\u003e     * æœ¬ç•ªç’°å¢ƒã§ã¯è¡Œã‚ãªã„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®åˆ©ç”¨ã‚’ãƒ†ã‚¹ãƒˆã§ã¯è¡Œã†ã“ã¨ã«ãªã£ã¦ã—ã¾ã†\n\u003e   * **ãƒ†ã‚¹ãƒˆãƒ»ã‚±ãƒ¼ã‚¹ã®å®Ÿè¡Œå‰ã«ãƒ‡ãƒ¼ã‚¿ã®å¾Œå§‹æœ«ã‚’è¡Œã†**\n\u003e     * ã“ã‚Œã‚‰ã®ä¸­ã§ã¯ã€ã“ã®æ–¹æ³•ãŒã‚‚ã£ã¨ã‚‚å„ªã‚Œã¦ã„ã‚‹\n\u003e     * ã‚ã¾ã‚Šæ™‚é–“ãŒã‹ã‹ã‚‰ãšã€æœ¬ç•ªç’°å¢ƒã§ã®æŒ¯ã‚‹èˆã„ã¨ãƒ†ã‚¹ãƒˆæ™‚ã®æŒ¯ã‚‹èˆã„ãŒç•°ãªã‚‹ã“ã¨ã‚‚ãªãã€ãƒ‡ãƒ¼ã‚¿ã®å¾Œå§‹æœ«ãŒãã¡ã‚“ã¨å®Ÿè¡Œã•ã‚Œã‚‹ã®ã‹ã‚’å¿ƒé…ã™ã‚‹å¿…è¦ã‚‚ãªããªã‚‹ã‹ã‚‰\n\u003e * ãƒ¡ãƒ¢ãƒªå†…ï¼ˆin-memoryï¼‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½¿ç”¨ã«é–¢ã™ã‚‹å•é¡Œ\n\u003e   * SQLite\n\u003e   * æœ¬æ›¸ã§ã¯ã€ãƒ†ã‚¹ãƒˆã®éš›ã«ã€**ãƒ¡ãƒ¢ãƒªå†…ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ã†ã“ã¨ã‚’æ¨å¥¨ã—ã¦ã„ã¾ã›ã‚“**\n\u003e   * æ©Ÿèƒ½é¢ã«ãŠã„ã¦ä¸€èˆ¬çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ç•°ãªã‚‹éƒ¨åˆ†ãŒã‚ã‚‹ã‹ã‚‰\n\n_ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰pp.349-352 ã‚ˆã‚Šå¼•ç”¨ã—ç®‡æ¡æ›¸ãã«ã¾ã¨ã‚ãŸã€‚å¤ªå­—ã¯ç­†è€…ã«ã‚ˆã‚‹ã‚‚ã®ã€‚_\n\nãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯å¤§æŠµã®å ´åˆãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ã‹ã™ç”¨ã® DB ã‚³ãƒ³ãƒ†ãƒŠãŒå»ºã£ã¦ã„ã‚‹ã®ã§ãã‚Œã‚’ãƒ†ã‚¹ãƒˆã§ã‚‚ä½¿ç”¨ã™ã‚Œã°å•é¡Œãªã•ãã†ã§ã™ã—ã€CI ç’°å¢ƒã§ã‚‚å®Ÿè¡Œç’°å¢ƒã«åˆ¥ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¦ã‚‹æ‰‹æ®µãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ï¼ˆãŸã¨ãˆã°ã€[Gitllab ã§ã¯ services ã‚’ä½¿ã†æ–¹æ³•ãŒã‚ã‚‹](https://docs.gitlab.com/ee/ci/services/mysql.html)ï¼‰ã®ã§ã€ä½•ã¨ã‹ãªã‚‹æ°—ãŒã—ã¾ã™ã€‚\n\n## ãƒ¢ãƒƒã‚¯ã®å¯¾è±¡ã«ãªã‚‹å‹ã¯è‡ªèº«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæ‰€æœ‰ã™ã‚‹å‹ã®ã¿ã«ã™ã‚‹\n\nãƒ¢ãƒƒã‚¯ã‚’ä½¿ã†ã‚ˆã†ãªã€ç®¡ç†ä¸‹ã«ãªã„ä¾å­˜ã‚’æ‰±ã†ã¨ãã€ã‚µãƒ¼ãƒ‰ãƒ»ãƒ‘ãƒ¼ãƒ†ã‚£è£½ã® SDK ãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã“ã¨ãŒå¤šã„ã§ã—ã‚‡ã†ã€‚è‘—è€…ã¯ãƒ¢ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹éš›ã®ãƒ™ã‚¹ãƒˆãƒ»ãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®1ã¤ã¨ã—ã¦ã€Œãã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«å¯¾ã™ã‚‹ã‚¢ãƒ€ãƒ—ã‚¿ã‚’ç‹¬è‡ªã«ä½œæˆã—ã€ãã®ã‚¢ãƒ€ãƒ—ã‚¿ã«å¯¾ã—ã¦ãƒ¢ãƒƒã‚¯ã‚’ä½œæˆã™ã‚‹ã€ã¨ã„ã†ã“ã¨ã‚’å‹§ã‚ã¦ã„ã¾ã™ã€‚ç†ç”±ã¯ä¸‹è¨˜ã§ã™ã€‚\n\n\u003e * ã‚µãƒ¼ãƒ‰ãƒ»ãƒ‘ãƒ¼ãƒ†ã‚£è£½ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå®Ÿéš›ã«æ©Ÿèƒ½ã—ã¦ã„ã‚‹ã®ã‹ã‚’æ·±ãçŸ¥ã‚‹ã“ã¨ã¯æ»…å¤šã«ã§ããªã„ã‹ã‚‰ã€‚\n\u003e * ã‚µãƒ¼ãƒ‰ãƒ»ãƒ‘ãƒ¼ãƒ†ã‚£è£½ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªè‡ªä½“ãŒåˆ©ç”¨å¯èƒ½ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’æ—¢ã«æä¾›ã—ã¦ã„ãŸå ´åˆã€ãã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’ãƒ¢ãƒƒã‚¯ã«ç½®ãæ›ãˆã‚‹å¯¾è±¡ã«ã™ã‚‹ã¨ã€ãƒ¢ãƒƒã‚¯ã®æŒ¯ã‚‹èˆã„ã¨ã‚µãƒ¼ãƒ‰ãƒ»ãƒ‘ãƒ¼ãƒ†ã‚£è£½ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å®Ÿéš›ã®æŒ¯ã‚‹èˆã„ã¨ãŒä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ãªãã¦ã¯ãªã‚‰ãªããªã‚Šã€ãƒªã‚¹ã‚¯ã‚’ä¼´ã†ã“ã¨ã«ãªã‚‹ã‹ã‚‰ã€‚\n\u003e * ã‚¢ãƒ€ãƒ—ã‚¿ã‚’æŒŸã‚€ã“ã¨ã§ã€ã‚µãƒ¼ãƒ‰ãƒ»ãƒ‘ãƒ¼ãƒ†ã‚£è£½ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«å«ã¾ã‚Œã‚‹ãƒ“ã‚¸ãƒã‚¹çš„ã«æœ¬è³ªã§ã¯ãªã„æŠ€è¡“çš„ãªè©³ç´°ã‚’éš è”½ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€ã•ã‚‰ã«ã€è‡ªèº«ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç”¨èªã‚’ç”¨ã„ã¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã®é–¢ä¿‚ã‚’å®šç¾©ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‹ã‚‰ã€‚\n\n_ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰p.323 ã‚ˆã‚Šå¼•ç”¨ã€‚_\n\nã“ã‚Œã«ã‚ˆã£ã¦ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ›´æ–°ã«ã‚ˆã£ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãŒå¤‰ã‚ã£ãŸå ´åˆã§ã‚‚ã€ã€Œå¤‰æ›´ã«ã‚ˆã‚‹å½±éŸ¿ã‚’ãã®ã‚¢ãƒ€ãƒ—ã‚¿ã ã‘ã«æŠ‘ãˆã‚‰ã‚Œã‚‹ã€ã“ã¨ã‚‚åˆ©ç‚¹ã¨ã—ã¦æŒ™ã’ã‚‰ã‚Œã¦ã„ã¾ã™ï¼ˆp.323ï¼‰ã€‚\n\n## ãƒªãƒã‚¸ãƒˆãƒªï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã‚¯ãƒ©ã‚¹ï¼‰ã¯ãƒ†ã‚¹ãƒˆã™ã¹ãã‹ï¼Ÿ\n\nãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ãƒªãƒã‚¸ãƒˆãƒªã«å¯¾ã™ã‚‹å˜ä½ãƒ†ã‚¹ãƒˆã‚’è¡Œã‚ãªãã¦ã‚ˆã„ã®ã‹ã€ã¨ã„ã†ã“ã¨ãŒã“ã®æœ¬ã‚’èª­ã‚“ã§ã„ãä¸­ã§æ°—ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚\n\nãƒªãƒã‚¸ãƒˆãƒªã‚’[å‰å›å‡ºã¦ããŸãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ»ã‚³ãƒ¼ãƒ‰ã®4ç¨®é¡](/posts/2023/02/unit-testing-principles-practices-and-patterns-part2-2)ã«å½“ã¦ã¯ã‚ã‚‹ã¨ã€Œã‚ã¾ã‚Šè¤‡é›‘ã«ã¯ãªã‚‰ãªã„ãŒã€ãƒ—ãƒ­ã‚»ã‚¹å¤–ä¾å­˜ã‚’æ‰±ã†ãŸã‚â€¦â€¦ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã€ã«å±ã™ã‚‹ã“ã¨ã«ãªã‚‹ã€ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ—ãƒ­ã‚»ã‚¹å¤–ä¾å­˜ã‚’æ‰±ã£ã¦ã„ã¦ä¿å®ˆã‚³ã‚¹ãƒˆãŒé«˜ã„ä¸€æ–¹ã§ã€è¤‡é›‘ã•ã‚’ä¼´ã£ã¦ã„ãªã„ã®ã§é€€è¡Œã«å¯¾ã™ã‚‹ä¿è­·ãŒã‚ã¾ã‚Šå‚™ã‚ã£ã¦ã„ãªã„ã¨ã„ã†ã“ã¨ã‹ã‚‰ã€è‘—è€…ã¯ã€Œ**ãƒªãƒã‚¸ãƒˆãƒªã‚’ç›´æ¥æ¤œè¨¼ã™ã‚‹ã®ã§ã¯ãªãã€çµ±åˆãƒ†ã‚¹ãƒˆã®ã‚·ãƒŠãƒªã‚ªã®ä¸€éƒ¨ã«å«ã‚ã¦æ¤œè¨¼ã™ã‚‹**ã€ã¨ã„ã†çµè«–ã‚’å‡ºã—ã¦ã„ã¾ã™ï¼ˆpp.363-365ï¼‰ã€‚\n\nãŸã¨ãˆã°ã€assert ãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿéš›ã®ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦å–å¾—ã™ã‚‹ã“ã¨ã§ã€å–å¾—ãƒ¡ã‚½ãƒƒãƒ‰ã®å‹•ä½œç¢ºèªãŒè¡Œãˆã¾ã™ã€‚\n\n## ã¾ã¨ã‚\n\nä»¥ä¸Šã€ç¬¬3éƒ¨ã€Œçµ±åˆï¼ˆintegrationï¼‰ãƒ†ã‚¹ãƒˆã€ã«ã¤ã„ã¦ã®ã¾ã¨ã‚ã¨æ‰€æ„Ÿã§ã—ãŸã€‚\n\nã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ã§ã¯æœ¬å½“ã«å¤šãã®å­¦ã³ãŒã‚ã£ãŸã®ã§ã€ã„ã¾ç§ãŒæ‹…å½“ã—ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ãƒ»ãƒ™ãƒ¼ã‚¹ã«ã‚‚ãã®å­¦ã³ã‚’åæ˜ ã•ã›ãŸã„ã¨æ€ã„ã€è¨ˆç”»ã‚’ç«‹ã¦ã¦ã¿ã¾ã—ãŸã€‚ã¾ãšã€ã‚³ãƒ¼ãƒ‰ãƒ»ãƒ™ãƒ¼ã‚¹ã‚’ã‚ã‚‹ã¹ãå§¿ã®3ç¨®é¡ã«åˆ†é¡ã—ã¾ã—ãŸã€‚\n\n* ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ«ï¼ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ \n* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©\n* å–ã‚‹ã«è¶³ã‚‰ãªã„ã‚³ãƒ¼ãƒ‰\n\nç¾çŠ¶ã§ã¯ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ«ï¼ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€ã®å¤šãã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã«é–¢ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒæ··åœ¨ã—ã¦ã—ã¾ã£ã¦ã„ã‚‹ï¼ˆå¤–éƒ¨ä¾å­˜ã‚’ãã®ã¾ã¾æ‰±ã£ã¦ã„ã‚‹ï¼‰ã®ã§ã€è©²å½“ç®‡æ‰€ã«å°ã‚’ã¤ã‘ã¦ã„ãã€ãã‚Œãã‚Œã«ã¤ã„ã¦ã©ã®ã‚ˆã†ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®åˆ†é›¢ãŒè¡Œãˆã‚‹ã‹ã‚’æ¤œè¨ã—ã¾ã—ãŸã€‚\n\næ¬¡ã«ã€ä»Šã‚ã‚‹ãƒ†ã‚¹ãƒˆãƒ»ã‚±ãƒ¼ã‚¹ã‚’ã©ã®ã‚ˆã†ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã„ãã‹ã‚’æ¤œè¨ã—ã¾ã—ãŸã€‚ã“ã‚Œã‚‰ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã¯ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®ãŸã‚ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã¨è¨€ãˆãã†ã§ã™ï¼ˆã“ã‚ŒãŒå®Œäº†ã™ã‚‹ã“ã¨ã§ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã¸ã®è€æ€§ãŒã¤ãã®ã§ï¼‰ã€‚\n\nã“ã‚Œã‚‰ã¯ã¾ã ç´ æ¡ˆã®æ®µéšã§ã™ãŒã€ã“ã‚Œã‹ã‚‰ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã¨è­°è«–ã—ã¦ã•ã‚‰ã«ç…®è©°ã‚ã¦ã„ãã€ã“ã‚Œã‚’å®Ÿè¡Œã«ç§»ã—ã¦ã„ãã®ãŒã¨ã¦ã‚‚æ¥½ã—ã¿ã§ã™ã€‚\n\næœ€å¾Œã«ã€ç´ æ™´ã‚‰ã—ã„æœ¬ã‚’åŸ·ç­†ãƒ»ç¿»è¨³ãã ã•ã£ãŸæ–¹ã€…ã¸ã€ãã®åŠªåŠ›ã«æ•¬æ„ã‚’è¡¨ã™ã‚‹ã¨ã¨ã‚‚ã«æ„Ÿè¬ç”³ã—ä¸Šã’ã¾ã™ã€‚\n","tags":[{"name":"å˜ä½“ãƒ†ã‚¹ãƒˆ","ref":"/tags/å˜ä½“ãƒ†ã‚¹ãƒˆ"},{"name":"èª­æ›¸","ref":"/tags/èª­æ›¸"}],"showTerminalAside":false},{"title":"ãƒ“ã‚¸ãƒã‚¹ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ã¨é€£æºã®æŒ‡æ®ã‚’åˆ†é›¢ã™ã‚Œã°è‰¯ã„ãƒ†ã‚¹ãƒˆãŒæ›¸ã‘ã‚‹ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬2éƒ¨å¾ŒåŠ","date":"2023-02-19T00:00:00.000Z","ref":"/posts/2023/02/unit-testing-principles-practices-and-patterns-part2-2","desc":" ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰ã‚’èª­ã‚“ã§ã„ã‚‹ã®ã§ã€ãã®ã¾ã¨ã‚ã‚’éƒ¨ã”ã¨ã«æ›¸ã„ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚\n\n1. [å˜ä½“ãƒ†ã‚¹ãƒˆã®ç›®çš„ãƒ»å®šç¾©ãƒ»å­¦æ´¾ãƒ»","draft":false,"content":"\n[ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰](https://book.mynavi.jp/ec/products/detail/id=134252)ã‚’èª­ã‚“ã§ã„ã‚‹ã®ã§ã€ãã®ã¾ã¨ã‚ã‚’éƒ¨ã”ã¨ã«æ›¸ã„ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚\n\n1. [å˜ä½“ãƒ†ã‚¹ãƒˆã®ç›®çš„ãƒ»å®šç¾©ãƒ»å­¦æ´¾ãƒ»å‘½åã«ã¤ã„ã¦ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬1éƒ¨](/posts/2023/01/unit-testing-principles-practices-and-patterns-part1)\n1. [ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã‚„ã™ã„ãƒ†ã‚¹ãƒˆã‚’æ›¸ã“ã†ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬2éƒ¨å‰åŠ](/posts/2023/02/unit-testing-principles-practices-and-patterns-part2-1)\n1. ãƒ“ã‚¸ãƒã‚¹ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ã¨é€£æºã®æŒ‡æ®ã‚’åˆ†é›¢ã™ã‚Œã°è‰¯ã„ãƒ†ã‚¹ãƒˆãŒæ›¸ã‘ã‚‹ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬2éƒ¨å¾ŒåŠï¼ˆã“ã®è¨˜äº‹ï¼‰\n1. [ãƒ—ãƒ­ã‚»ã‚¹å¤–ä¾å­˜ã¯çµ±åˆãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ã‚ˆã†ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬3éƒ¨](/posts/2023/02/unit-testing-principles-practices-and-patterns-part3)\n\nä»Šå›ã¯ç¬¬2éƒ¨ã€Œå˜ä½“ãƒ†ã‚¹ãƒˆã¨ãã®ä¾¡å€¤ã€ã®å¾ŒåŠã«ã¤ã„ã¦ã®æ„Ÿæƒ³ã¨è€ƒå¯Ÿã«ãªã‚Šã¾ã™ã€‚ç¬¬2éƒ¨ã¯ä»¥ä¸‹ã®4ç« ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ãŒã€ä»Šå›ã¯å¾ŒåŠã®ç¬¬6ç« ã¨ç¬¬7ç« ã«ã¤ã„ã¦æ‰±ã„ã¾ã™ã€‚\n\n* ç¬¬6ç« ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®3ã¤ã®æ‰‹æ³•\n* ç¬¬7ç« ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®ä¾¡å€¤ã‚’é«˜ã‚ã‚‹ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°\n\n## é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°\n\nå˜ä½“ãƒ†ã‚¹ãƒˆã®æ‰‹æ³•ã«ã¯ä»¥ä¸‹ã®3ã¤ãŒå­˜åœ¨ã—ã¾ã™ã€‚\n\n\u003e * å‡ºåŠ›å€¤ãƒ™ãƒ¼ã‚¹ãƒ»ãƒ†ã‚¹ãƒˆï¼ˆæˆ»ã‚Šå€¤ã‚’ç¢ºèªã™ã‚‹ãƒ†ã‚¹ãƒˆï¼‰\n\u003e * çŠ¶æ…‹ãƒ™ãƒ¼ã‚¹ãƒ»ãƒ†ã‚¹ãƒˆï¼ˆçŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ãƒ†ã‚¹ãƒˆï¼‰\n\u003e * ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ™ãƒ¼ã‚¹ãƒ»ãƒ†ã‚¹ãƒˆï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé–“ã®ã‚„ã‚Šå–ã‚Šã‚’ç¢ºèªã™ã‚‹ãƒ†ã‚¹ãƒˆï¼‰\n\n_ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰p.167 ã‚ˆã‚Šå¼•ç”¨ã—ç®‡æ¡æ›¸ãã«ã¾ã¨ã‚ãŸã€‚_\n\nè‘—è€…ã¯ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã¸ã®è€æ€§ã¨ä¿å®ˆã®ã—ã‚„ã™ã•ã‚’ç¶­æŒã™ã‚‹ã®ã«å¿…è¦ãªã‚³ã‚¹ãƒˆã®è¦³ç‚¹ã‹ã‚‰ã€Œå‡ºåŠ›å€¤ãƒ™ãƒ¼ã‚¹ãƒ»ãƒ†ã‚¹ãƒˆãŒã‚‚ã£ã¨ã‚‚è²»ç”¨å¯¾åŠ¹æœã®é«˜ã„ãƒ†ã‚¹ãƒˆãƒ»ã‚±ãƒ¼ã‚¹ã‚’ä½œæˆã§ãã‚‹ã€ã¨ã—ã¦ã„ã¾ã™ã€‚ãã—ã¦ã€å‡ºåŠ›å€¤ãƒ™ãƒ¼ã‚¹ãƒ»ãƒ†ã‚¹ãƒˆã¯ã€ã€Œé–¢æ•°å‹ã«ã‚ˆã‚‹å˜ä½“ãƒ†ã‚¹ãƒˆã®æ‰‹æ³•ã€ã§ã‚ã‚‹ã“ã¨ã‹ã‚‰ã€ç¬¬6ç« ã§ã¯ä¸»ã«é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ»é–¢æ•°å‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã¤ã„ã¦è§£èª¬ã•ã‚Œã¦ã„ã¾ã™ã€‚\n\n\u003e * é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã¨ã¯ã€æ•°å­¦çš„é–¢æ•°ã‚’ç”¨ã„ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ã“ã¨ã§ã™ã€‚ãã—ã¦ã€ã“ã®æ•°å­¦çš„é–¢æ•°ï¼ˆmathematical functionï¼‰ã¯ç´”ç²‹é–¢æ•°ï¼ˆpure functionï¼‰ã¨ã‚‚å‘¼ã°ã‚Œã€**éš ã‚ŒãŸå…¥åŠ›ã‚„å‡ºåŠ›ãŒãªã„**é–¢æ•°ï¼ˆã‚‚ã—ãã¯ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰ã®ã“ã¨ã«ãªã‚Šã¾ã™\n\u003e * é–¢æ•°å‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ã¯ä½•ã‹ï¼Ÿ\n\u003e   * é–¢æ•°å‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ã€ç´”ç²‹é–¢æ•°ï¼ˆä¸å¤‰ï¼‰ã‚’ç”¨ã„ã¦æ›¸ã‹ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’æœ€å¤§é™ã«å¢—ã‚„ã™ä¸€æ–¹ã€å‰¯ä½œç”¨ã‚’æ‰±ã†ã‚³ãƒ¼ãƒ‰ã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™\n\u003e   * é–¢æ•°å‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ã€**å‰¯ä½œç”¨ã‚’ãƒ“ã‚¸ãƒã‚¹ãƒ»ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æœ€åˆã‚„æœ€å¾Œã«æŒã£ã¦ã„ã**ã“ã¨ã§ã€**ãƒ“ã‚¸ãƒã‚¹ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ã¨å‰¯ä½œç”¨ã¨ã‚’åˆ†é›¢**ã—ã‚„ã™ãã—ã¦ã„ã¾ã™\n\u003e   * æ±ºå®šã‚’ä¸‹ã™ã‚³ãƒ¼ãƒ‰ã¯é–¢æ•°çš„æ ¸ï¼ˆfunctional coreï¼‰ã‚‚ã—ãã¯ä¸å¤‰æ ¸ï¼ˆimmutable coreï¼‰ã¨å‘¼ã°ã‚Œã‚‹ã®ã«å¯¾ã—ã€æ±ºå®šã«åŸºã¥ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯å¯å¤‰æ®»ï¼ˆmutable shellï¼‰ã¨å‘¼ã°ã‚Œã¾ã™\n\n_ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰pp.181-185 ã‚ˆã‚Šå¼•ç”¨ã—ç®‡æ¡æ›¸ãã«ã¾ã¨ã‚ãŸã€‚å¤ªå­—ã¯ç­†è€…ã«ã‚ˆã‚‹ã‚‚ã®ã€‚_\n\nç§ã¯é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ»é–¢æ•°å‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã¤ã„ã¦ä½•ã‚‚çŸ¥è­˜ãŒãªã‹ã£ãŸã®ã§ã™ãŒã€æœ¬æ›¸ã®è§£èª¬ã«ã‚ˆã£ã¦ãã®ã‚ã‚‰ã¾ã—ã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ãã—ã¦ã€é–¢æ•°å‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è©±ã‚’å‰æã«ç¬¬7ç« ã¸ã¨ç¶šã„ã¦ã„ãã¾ã™ã€‚\n\n## ãƒ“ã‚¸ãƒã‚¹ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ã¨é€£æºã®æŒ‡æ®ã‚’åˆ†é›¢ã•ã›ã‚ˆ\n\nMVCï¼ˆModel-View-Controllerï¼‰ã®è€ƒãˆæ–¹ã§ã‚‚é‡è¦ãªã€ãƒ“ã‚¸ãƒã‚¹ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®åˆ†é›¢ã§ã™ãŒã€ã“ã‚Œã‚’é©åˆ‡ã«è¡Œã†ã“ã¨ã§ã€ã€Œç‰¹ã«é‡è¦ãªéƒ¨åˆ†ã ã‘ãŒãƒ†ã‚¹ãƒˆå¯¾è±¡ã€ã¨ãªã£ã¦ã„ã¦ã€ã€Œæœ€å°é™ã®ä¿å®ˆã‚³ã‚¹ãƒˆã§æœ€å¤§é™ã®ä¾¡å€¤ã‚’ç”Ÿã¿å‡ºã™ã€å„ªã‚ŒãŸãƒ†ã‚¹ãƒˆãƒ»ã‚¹ã‚¤ãƒ¼ãƒˆãŒæ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\n\nè‘—è€…ã¯ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ»ã‚³ãƒ¼ãƒ‰ã‚’æ¬¡ã®4ç¨®é¡ã«åˆ†é¡ã—ã¾ã—ãŸã€‚\n\n\u003e * **ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ«ï¼ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **ï¼šã‚³ãƒ¼ãƒ‰ã®è¤‡é›‘ã•ï¼ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ãŠã‘ã‚‹é‡è¦æ€§ãŒé«˜ã„ãŒã€å”åŠ›è€…ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ•°ã¯å°‘ãªã„\n\u003e * å–ã‚‹ã«è¶³ã‚‰ãªã„ã‚³ãƒ¼ãƒ‰ï¼šã‚³ãƒ¼ãƒ‰ã®è¤‡é›‘ã•ï¼ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ãŠã‘ã‚‹é‡è¦æ€§ãŒä½ãã€å”åŠ›è€…ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ•°ã‚‚å°‘ãªã„\n\u003e * **ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©**ï¼šå”åŠ›è€…ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ•°ã¯å¤šã„ãŒã€ã‚³ãƒ¼ãƒ‰ã®è¤‡é›‘ã•ï¼ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ãŠã‘ã‚‹é‡è¦æ€§ã¯ä½ã„\n\u003e * **éåº¦ã«è¤‡é›‘ãªã‚³ãƒ¼ãƒ‰**ï¼šå”åŠ›è€…ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ•°ãŒå¤šãã€ã‚³ãƒ¼ãƒ‰ã®è¤‡é›‘ã•ï¼ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ãŠã‘ã‚‹é‡è¦æ€§ã‚‚é«˜ã„\n\n_ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰p.217 ã‚ˆã‚Šå¼•ç”¨ã—ç®‡æ¡æ›¸ãã«ã¾ã¨ã‚ãŸã€‚å¤ªå­—ã¯ç­†è€…ã«ã‚ˆã‚‹ã‚‚ã®ã€‚_\n\nã“ã®ã€Œéåº¦ã«è¤‡é›‘ãªã‚³ãƒ¼ãƒ‰ã€ãŒã©ã’ã‚“ã¨ã›ã‚“ã¨ã„ã‹ã‚“ãƒ¤ãƒ„ã§ã€ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ«ï¼ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€ã¨ã€Œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã€ã«åˆ†å‰²ã—ã¦ã„ãã¾ã™ã€‚ãã®ãŸã‚ã«å°å…¥ã•ã‚Œã‚‹ã®ãŒã€Œ**è³ªç´ ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆHumble Objectï¼‰**ã€ã¨ã„ã†è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚\n\n\u003e * è³ªç´ ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ã«ã¯ãƒ­ã‚¸ãƒƒã‚¯ã‚’ï¼ˆã»ã¼ï¼‰å«ã¾ã›ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€è³ªç´ ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹å¿…è¦ãŒãªã„ã‚ˆã†ã«ã™ã‚‹\n\u003e * ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯å„ã‚¯ãƒ©ã‚¹ãŒæŒã¦ã‚‹è²¬ä»»ã‚’1ã¤ã ã‘ã«ã™ã‚‹å˜ä¸€è²¬ä»»ã®åŸå‰‡ï¼ˆSingle Responsibility Principle: SRPï¼‰ã‚’éµå®ˆã™ã‚‹ãŸã‚ã®æ‰‹æ®µã¨ã—ã¦ã‚‚è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™\n\u003e * MVPï¼ˆModel-View-Presenterï¼‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚„MVCï¼ˆModel-View-Controllerï¼‰ãƒ‘ã‚¿ãƒ¼ãƒ³â€¦â€¦ã§ã¯ã€Presenterã‚‚ã—ãã¯ControllerãŒè³ªç´ ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ãªã‚Šã€ãƒ“ãƒ¥ãƒ¼ã¨ãƒ¢ãƒ‡ãƒ«ã‚’çµã³ã¤ã‘ã‚‹å½¹å‰²ã‚’æ‹…ã„ã¾ã™\n\n_ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰pp.220-222 ã‚ˆã‚Šå¼•ç”¨ã—ç®‡æ¡æ›¸ãã«ã¾ã¨ã‚ãŸã€‚_\n\næœ¬æ›¸ã§ã¯ä¸Šè¨˜ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ»ã‚³ãƒ¼ãƒ‰ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãŒåˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ã•ã‚Œã¦ãŠã‚Šã€ã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚å€‹äººçš„ã«ã¯ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¨ã„ã†è¨€è‘‰ã®æ„å‘³ã‚’ã¡ã‚ƒã‚“ã¨ç†è§£ã›ãšã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ›¸ã„ã¦ã—ã¾ã£ã¦ã„ãŸï¼ˆã»ã‹ã®äººã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®çŒ¿çœŸä¼¼ã‚’ã—ã¦ã„ãŸï¼‰ã¨ã“ã‚ãŒã‚ã£ãŸã®ã§åçœã—ã¾ã—ãŸâ€¦â€¦ã€‚\n\nãã®ãŸã‚ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¨èªè­˜ã—ã¤ã¤ã€æ™®é€šã«åˆ†å²ãŒå…¥ã£ã¦ã—ã¾ã£ã¦ã„ã¦éåº¦ã«è¤‡é›‘ãªã‚³ãƒ¼ãƒ‰ã«ãªã£ã¦ã—ã¾ã£ã¦ãŸã®ã§ã™ãŒã€æœ¬æ›¸ã§ã¯ã€Œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã«ãŠã‘ã‚‹æ¡ä»¶ä»˜ããƒ­ã‚¸ãƒƒã‚¯ã®æ‰±ã„ã€ã«ã¤ã„ã¦ã‚‚è¨€åŠã•ã‚Œã¦ã„ã¾ã™ã€‚\n\n\u003e ãƒ“ã‚¸ãƒã‚¹ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ã®ã‚³ãƒ¼ãƒ‰ã¨é€£æºã‚’æŒ‡æ®ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®åˆ†é›¢ã‚’ã‚‚ã£ã¨ã‚‚è¡Œã„ã‚„ã™ã„ã®ã¯ã€1ã¤ã®ãƒ“ã‚¸ãƒã‚¹ãƒ»ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ¬¡ã®3æ®µéšã®æµã‚Œã«ãªã£ã¦ã„ã‚‹å ´åˆã§ã™ï¼š\n\u003e\n\u003e 1. ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã®å–å¾—\n\u003e 2. ãƒ“ã‚¸ãƒã‚¹ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ\n\u003e 3. å¤‰æ›´ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜\n\u003e\n\u003e ã—ã‹ã—ãªãŒã‚‰ã€ã“ã‚Œã‚‰ã®æ‰‹é †ã‚’å®Œç’§ã«é †å®ˆã§ããªã„å ´åˆã‚‚ã‚ˆãã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°â€¦â€¦æ±ºå®šã‚’ä¸‹ã™éç¨‹ã®ä¸­ã§ã€é€”ä¸­ã§å¾—ãŸçµæœã‚’ä½¿ã£ã¦ãƒ—ãƒ­ã‚»ã‚¹å¤–ä¾å­˜ã‹ã‚‰æ–°ãŸã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã‚ˆã†ãªå ´åˆã§ã™ã€‚\n\n_ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰p.240 ã‚ˆã‚Šå¼•ç”¨ã€‚ä¸€éƒ¨çœç•¥ã€‚_\n\nãã—ã¦ã€ã“ã®èª²é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã®é¸æŠè‚¢ã¨ã—ã¦ã¯ä»¥ä¸‹ã®3ã¤ãŒã‚ã‚Šã¾ã™ã€‚\n\n\u003e * å¤–éƒ¨ã®ä¾å­˜ã«å¯¾ã™ã‚‹ã™ã¹ã¦ã®èª­ã¿è¾¼ã¿ã¨æ›¸ãè¾¼ã¿ã‚’ãƒ“ã‚¸ãƒã‚¹ãƒ»ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å§‹ã‚ã‚„çµ‚ã‚ã‚Šã«æŒã£ã¦ã„ã\n\u003e   * ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¯åŠ£åŒ–ã™ã‚‹\n\u003e   * ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®é«˜ã•ã¯é‡è¦ãªæ€§è³ªã§ã‚ã‚‹ â†’ **é¸ã¹ãªã„**\n\u003e * ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ«ã«ãƒ—ãƒ­ã‚»ã‚¹å¤–ä¾å­˜ã‚’æ³¨å…¥ã™ã‚‹\n\u003e   * ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ«ã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆã®ã—ã‚„ã™ã•ã¯å¤±ã‚ã‚Œã‚‹\n\u003e   * ã»ã¨ã‚“ã©ã®ã‚³ãƒ¼ãƒ‰ã‚’éåº¦ã«è¤‡é›‘ãªã‚³ãƒ¼ãƒ‰ã«å±ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã—ã¾ã„ã¾ã™ â†’ **é¸ã¹ãªã„**\n\u003e * æ±ºå®šã‚’ä¸‹ã™éç¨‹ã‚’ã•ã‚‰ã«ç´°ã‹ãåˆ†å‰²ã™ã‚‹\n\u003e   * ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®ç°¡æ½”ã•ã‚’ä¿ã¦ãªããªã‚‹\n\u003e   * ã‚ã‚‹ç¨‹åº¦ã§ã‚ã‚Œã°å¯¾å‡¦ã™ã‚‹ã“ã¨ãŒå¯èƒ½ â†’ **é¸ã¹ã‚‹**\n\n_ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰p.241 ã‚ˆã‚Šå¼•ç”¨ã—ç®‡æ¡æ›¸ãã«ã¾ã¨ã‚ãŸã€‚å¤ªå­—ã¯ç­†è€…ã«ã‚ˆã‚‹ã‚‚ã®ã€‚_\n\nå‰ã®2ã¤ã®é¸æŠè‚¢ã«ã¤ã„ã¦ã¯å®¹èªã§ããªã„æ¬ ç‚¹ãŒã‚ã‚‹ã®ã§é¸ã¶ã“ã¨ã¯ã§ããªã„ã®ã§ã™ãŒã€3ã¤ç›®ã®é¸æŠè‚¢ã«ã¤ã„ã¦ã¯è¨±å®¹ã§ãã‚‹ã®ã§ã€æœ¬æ›¸ã§ã¯ã€Œæ±ºå®šã‚’ä¸‹ã™éç¨‹ã‚’ã•ã‚‰ã«ç´°ã‹ãåˆ†å‰²ã™ã‚‹ã€ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚\n\nã€Œæ±ºå®šã‚’ä¸‹ã™éç¨‹ã‚’ã•ã‚‰ã«ç´°ã‹ãåˆ†å‰²ã™ã‚‹ã€ãŸã‚ã®æ–¹æ³•ã¨ã—ã¦ã€Œ**ç¢ºèªå¾Œå®Ÿè¡Œï¼ˆCanExecute/Executeï¼‰ãƒ‘ã‚¿ãƒ¼ãƒ³**ã€ãŒã‚ã‚Šã¾ã™ã€‚\n\nãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ«ã« `CanChangeEmail` ã®ã‚ˆã†ãªç¢ºèªã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã€ã“ã‚Œã‚’ `ChangeEmail` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãŸãŸããŸã‚ã®**äº‹å‰æ¡ä»¶**ã¨ã™ã‚‹ã“ã¨ã§ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¯äº‹å‰æ¡ä»¶ã®ä¸­èº«ã«ã¤ã„ã¦ã¯çŸ¥ã‚‰ãšã«æ¸ˆã‚€ã®ã§ã€**ãƒ“ã‚¸ãƒã‚¹ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã«æµå‡ºã™ã‚‹ã®ã‚’é˜²ã**ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼ˆp.243ï¼‰ã€‚\n\nã“ã‚Œã¯éå¸¸ã«æœ‰ç”¨ãªãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã ã¨æ€ã„ã¾ã—ãŸã€‚  \nã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ï¼ˆç§ã®å‚åŠ ã™ã‚‹ãƒãƒ¼ãƒ ã§ã¯ MVC ã‚’ä½¿ã£ã¦ã„ãªã„ã®ã§ãã‚Œã£ã½ã„ã‚‚ã®ï¼‰ã«ã€ãƒ“ã‚¸ãƒã‚¹çš„ãªæ¡ä»¶åˆ†å²ã‚’æ›¸ã„ã¦ã„ã¦ã€ã©ã“ã¾ã§ãŒãƒ‰ãƒ¡ã‚¤ãƒ³çŸ¥è­˜ã§ã©ã“ã‹ã‚‰ãŒãã†ã§ãªã„ã®ã‹ãŒæ›–æ˜§ã§ãƒ¢ãƒ¤ãƒ¢ãƒ¤ã™ã‚‹ã“ã¨ã‚‚ã‚ã£ãŸã®ã§ã€ä»Šå¾Œã¯ã“ã®ã‚ˆã†ãªãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’æ´»ç”¨ã—ã¦ã€ãƒ“ã‚¸ãƒã‚¹ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¨ã®åˆ†é›¢ã‚’æ˜ç¢ºã«ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚\n\n## è¦³æ¸¬å¯èƒ½ãªãµã‚‹ã¾ã„ã®ç¯„å›²\n\n[å‰å›ã®è¨˜äº‹](/posts/2023/02/unit-testing-principles-practices-and-patterns-part2-1)ã§æ°—ã«ãªã£ã¦ã„ãŸã€Œå¤–éƒ¨ã‹ã‚‰è¦³æ¸¬ã§ããªã„ãƒ—ãƒ­ã‚»ã‚¹å¤–ä¾å­˜ã¨ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã®è©³ç´°ã«ã—ã¡ã‚ƒã£ãŸã‚‰ã€ãã‚Œã»ã¼ E2E ãƒ†ã‚¹ãƒˆã ã‹ã‚‰è¿…é€Ÿãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¾—ã‚‰ã‚Œãªããªã„ï¼Ÿã€ã«å¯¾ã™ã‚‹è‘—è€…ã®ç­”ãˆã¯ã€Œç‰ã­ãã®å±¤ã®ã‚ˆã†ã«è€ƒãˆã‚‹ã€ã“ã¨ã§ã—ãŸã€‚\n\nå¤–éƒ¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¨ã£ã¦ã®è¦³æ¸¬å¯èƒ½ãªæŒ¯ã‚‹èˆã„ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã«ã¨ã£ã¦ã®è¦³æ¸¬å¯èƒ½ãªæŒ¯ã‚‹èˆã„ã€ãã—ã¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¨ã£ã¦ã®è¦³æ¸¬å¯èƒ½ãªæŒ¯ã‚‹èˆã„ã¯ãã‚Œãã‚Œç•°ãªã£ã¦ã„ã¦ã€ãã‚Œãã‚Œã«ã¨ã£ã¦ç›´æ¥é–¢ä¿‚ãªã„ã“ã¨ã«ã¤ã„ã¦ã¯æ„è­˜ã—ãªã„ã€ã¨ã„ã†ã“ã¨ã®ã‚ˆã†ã§ã™ã€‚å‰ç« ã§ã¯ç©¶æ¥µã‚’è¨€ãˆã°å¤–éƒ¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ãƒ†ã‚¹ãƒˆã ã‘ã§è‰¯ã„ã®ã§ã¯ã¨ã„ã†è©±ã«ãªã£ã¦ã„ã¾ã—ãŸãŒã€ãã‚Œã¯é•ã†ã€ã¨ã„ã†ã“ã¨ã§ã™ã­ã€‚\n\nãã‚Œã¯ãã†ã€ã¨ã„ã†æ„Ÿã˜ã¯ã‚ã‚Šã¾ã™ãŒã€å®Ÿéš›ã«ãã®ã‚ˆã†ã«ãƒ†ã‚¹ãƒˆã‚’ä½œã‚‹ã«ã¯ã€ä»Šå›ã®ç¯„å›²ã§å–ã‚Šä¸Šã’ãŸãƒ“ã‚¸ãƒã‚¹ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®åˆ†é›¢ãŒé©åˆ‡ã«è¡Œã‚ã‚Œã¦ã„ãªã„ã¨ã€å¦ãŒå¿œã§ã‚‚ç›´æ¥é–¢ä¿‚ã—ãªã„å‘¼ã³å‡ºã—ã«ã¤ã„ã¦ã‚‚æ„è­˜ã›ã–ã‚‹ã‚’å¾—ãªããªã‚‹æ°—ãŒã—ã¾ã™ã€‚ä¾‹ãˆã°ã€å‘¼ã³å‡ºã—å…ˆã§ã•ã‚‰ã« DB ã«ä¾å­˜ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹å ´åˆã«ã¯ DB ã®ãƒ¢ãƒƒã‚¯ã‚’ä½œã‚‹å¿…è¦ãŒå‡ºã¦ãã¾ã™ã€‚\n\nãƒ“ã‚¸ãƒã‚¹ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆé–¢æ•°çš„æ ¸ï¼‰ã®ã‚¯ãƒ©ã‚¹ã‹ã‚‰ã€ãƒ¢ãƒƒã‚¯ã‚’å¿…è¦ã¨ã—ã¦ã—ã¾ã†ãƒ—ãƒ­ã‚»ã‚¹å¤–ä¾å­˜ã‚’å¾¹åº•çš„ã«æ’é™¤ã™ã‚‹ã“ã¨ã§ï¼ˆã“ã‚ŒãŒé–¢æ•°å‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ€æƒ³ï¼‰ã€ãã‚Œã„ã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚å›ã‚Šã¾ã‚ã£ã¦é–¢æ•°å‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è§£èª¬ãŒã•ã‚Œã¦ã„ãŸã“ã¨ã«è…‘ã«è½ã¡ã¾ã—ãŸã€‚\n\n## ã¾ã¨ã‚\n\nä»¥ä¸Šã€ç¬¬2éƒ¨ã€Œå˜ä½“ãƒ†ã‚¹ãƒˆã¨ãã®ä¾¡å€¤ã€ã®å¾ŒåŠã«ã¤ã„ã¦ã®ã¾ã¨ã‚ã¨æ‰€æ„Ÿã§ã—ãŸã€‚ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã¤ã„ã¦ã¯ç†è§£ã—ã¦ã„ãªã„éƒ¨åˆ†ãŒå¤šãã€å‚è€ƒã«ã—ã¦ã„ã‚‹ã»ã‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªãƒã‚¸ãƒˆãƒªã‚’è¦‹ãªãŒã‚‰å”¸ã£ã¦ã„ãŸã‚Šã™ã‚‹ã®ã§ã€ä»Šå›ã®ç¯„å›²ã§ã¯ãã†ã—ãŸã¨ã“ã‚ãŒæ¬¡ã€…ã¨åˆ†ã‹ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚è‰¯ã„å˜ä½“ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã“ã¨ã‚’ç›®æŒ‡ã™ã¨ã€ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ»ã‚³ãƒ¼ãƒ‰ã‚‚æ”¹å–„ã•ã‚Œã¦ã„ãã®ã ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚\n","tags":[{"name":"å˜ä½“ãƒ†ã‚¹ãƒˆ","ref":"/tags/å˜ä½“ãƒ†ã‚¹ãƒˆ"},{"name":"èª­æ›¸","ref":"/tags/èª­æ›¸"}],"showTerminalAside":false},{"title":"FastAPIã¨SQLAlchemy2.0ãªã‚‰ã‚‚ã†å‹ãƒ’ãƒ³ãƒˆã‚’è«¦ã‚ãªãã¦ã„ã„","date":"2023-02-08T00:00:00.000Z","ref":"/posts/2023/02/fastapi-orm-sqlalchemy","desc":" ã‚µãƒã‚³ï¼ˆGoogle Search Consoleï¼‰ã‚’çœºã‚ã¦ã„ãŸã‚‰ `FastAPI MySQL` ãŒãã‚Œãªã‚Šã«éœ€è¦ã‚ã‚Šãã†ã¨æ€ã£ãŸã®ã§ã€FastAPI ã¨ SQLAlchemy ã‚’çµ„ã¿åˆã‚ã›ã¦ ORM ã‚’ä½¿ã†æ–¹æ³•ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚æœ€è¿‘ã® SQLAlchemyï¼ˆ1.4ä»¥é™ï¼‰ã§ã¯ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œ","draft":false,"content":"\nã‚µãƒã‚³ï¼ˆGoogle Search Consoleï¼‰ã‚’çœºã‚ã¦ã„ãŸã‚‰ `FastAPI MySQL` ãŒãã‚Œãªã‚Šã«éœ€è¦ã‚ã‚Šãã†ã¨æ€ã£ãŸã®ã§ã€FastAPI ã¨ SQLAlchemy ã‚’çµ„ã¿åˆã‚ã›ã¦ ORM ã‚’ä½¿ã†æ–¹æ³•ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚æœ€è¿‘ã® SQLAlchemyï¼ˆ1.4ä»¥é™ï¼‰ã§ã¯ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å‹ã‚’é©ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã®ã§ã€å‹ãƒ’ãƒ³ãƒˆã‚’æ´»ã‹ã—ã¦å‹å®‰å…¨ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ã‚‚é›£ã—ããªããªã£ã¦ã„ã¾ã™ã€‚\n\n## ç’°å¢ƒ\n\n* Python 3.10.6\n* FastAPI 0.89.1\n* SQLAlchemy 2.0.1\n* Docker 20.10.13\n* Docker Compose v2.3.3\n\n## å‰æ\n\nFastAPI å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® [SQL (Relational) Databases](https://fastapi.tiangolo.com/ja/tutorial/sql-databases/) ã®ãƒšãƒ¼ã‚¸ã‚’ç†Ÿèª­ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚\n\n2023å¹´1æœˆã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸ SQLAlchemy 2.0ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚1ç³»ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ [SQLAlchemy 2.0 - Major Migration Guide](https://docs.sqlalchemy.org/en/20/changelog/migration_20.html) ã‚’å‚è€ƒã«2.0ã¸ç§»è¡Œã—ã¦ãã ã•ã„ã€‚1.4ã‹ã‚‰2.0ã®ç§»è¡Œã¯ã‚¹ãƒ ãƒ¼ã‚ºã ã¨æ€ã„ã¾ã™ã€‚\n\nSQLAlchemy ã§åˆ©ç”¨ã§ãã‚‹ ORM ã®ãƒ¢ãƒ‡ãƒ«ã®æ›¸ãæ–¹ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚å€‹äººçš„ã«ã¯ [dataclass ã¨çµ±åˆã—ãŸæ›¸ãæ–¹](https://docs.sqlalchemy.org/en/20/orm/dataclasses.html)ã‚‚å¥½ãã§ã™ãŒã€ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ãªå®Ÿè£…ã‚’è¡Œã„ã¾ã™ã€‚\n\n## æˆæœç‰©\n\nhttps://github.com/SogoKato/fastapi-sqlalchemy2\n\n```py\nfrom fastapi import Depends, FastAPI, HTTPException\nfrom pydantic import BaseModel\nfrom sqlalchemy import ForeignKey, String, create_engine, select\nfrom sqlalchemy.orm import (\n    DeclarativeBase,\n    Mapped,\n    Session,\n    mapped_column,\n    relationship,\n    sessionmaker,\n)\n\n\"\"\"\nSQLAlchemyã®ãƒ¢ãƒ‡ãƒ«.\n\nBased on:\n* https://docs.sqlalchemy.org/en/20/orm/quickstart.html#declare-models\n* https://fastapi.tiangolo.com/ja/tutorial/sql-databases/#create-the-database-models\n\"\"\"\n\n\nclass Base(DeclarativeBase):\n    \"\"\"å„DBãƒ¢ãƒ‡ãƒ«ã®åŸºåº•ã‚¯ãƒ©ã‚¹.\"\"\"\n\n    pass\n\n\nclass User(Base):\n    \"\"\"usersãƒ†ãƒ¼ãƒ–ãƒ«ã®DBãƒ¢ãƒ‡ãƒ«.\"\"\"\n\n    __tablename__ = \"users\"\n\n    id: Mapped[int] = mapped_column(primary_key=True, index=True)\n    email: Mapped[str] = mapped_column(String(100), unique=True, index=True)\n    hashed_password: Mapped[str] = mapped_column(String(100))\n    is_active: Mapped[bool]\n\n    items: Mapped[list[\"Item\"]] = relationship(back_populates=\"owner\")\n\n\nclass Item(Base):\n    \"\"\"itemsãƒ†ãƒ¼ãƒ–ãƒ«ã®DBãƒ¢ãƒ‡ãƒ«.\"\"\"\n\n    __tablename__ = \"items\"\n\n    id: Mapped[int] = mapped_column(primary_key=True, index=True)\n    title: Mapped[str] = mapped_column(String(30), index=True)\n    description: Mapped[str] = mapped_column(String(30), index=True)\n    owner_id: Mapped[int] = mapped_column(ForeignKey(\"users.id\"))\n\n    owner: Mapped[\"User\"] = relationship(back_populates=\"items\")\n\n\n\"\"\"\nPydanticã®ãƒ¢ãƒ‡ãƒ«.\n\nBased on:\n* https://fastapi.tiangolo.com/ja/tutorial/sql-databases/#create-the-pydantic-models\n\"\"\"\n\n\nclass ItemBase(BaseModel):\n    \"\"\"Itemã®åŸºåº•ã‚¯ãƒ©ã‚¹.\"\"\"\n\n    title: str\n    description: str | None = None\n\n\nclass ItemCreateRequest(ItemBase):\n    \"\"\"Itemä½œæˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡¨ç¾ã™ã‚‹ã‚¯ãƒ©ã‚¹.\"\"\"\n\n    pass\n\n\nclass ItemResponse(ItemBase):\n    \"\"\"Itemã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¡¨ç¾ã™ã‚‹ã‚¯ãƒ©ã‚¹.\"\"\"\n\n    id: int\n    owner_id: int\n\n    class Config:\n        orm_mode = True\n\n\nclass UserBase(BaseModel):\n    \"\"\"Userã®åŸºåº•ã‚¯ãƒ©ã‚¹.\"\"\"\n\n    email: str\n\n\nclass UserCreateRequest(UserBase):\n    \"\"\"Userä½œæˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡¨ç¾ã™ã‚‹ã‚¯ãƒ©ã‚¹.\"\"\"\n\n    password: str\n\n\nclass UserResponse(UserBase):\n    \"\"\"Userã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¡¨ç¾ã™ã‚‹ã‚¯ãƒ©ã‚¹.\"\"\"\n\n    id: int\n    is_active: bool\n    items: list[ItemResponse] = []\n\n    class Config:\n        orm_mode = True\n\n\n\"\"\"\nDBã®CRUDæ“ä½œã‚’è¡Œã†é–¢æ•°.\n\nBased on:\n* https://docs.sqlalchemy.org/en/20/changelog/migration_20.html#migration-orm-usage\n* https://fastapi.tiangolo.com/ja/tutorial/sql-databases/#crud-utils\n\"\"\"\n\n\ndef get_db_user(db: Session, user_id: int):\n    \"\"\"usersãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰user_idã«ä¸€è‡´ã™ã‚‹Userã‚’å–å¾—ã—ã¾ã™.\"\"\"\n    return db.execute(select(User).where(User.id == user_id)).scalars().first()\n\n\ndef get_db_user_by_email(db: Session, email: str):\n    \"\"\"usersãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰emailã«ä¸€è‡´ã™ã‚‹Userã‚’å–å¾—ã—ã¾ã™.\"\"\"\n    return db.execute(select(User).where(User.email == email)).scalars().first()\n\n\ndef get_db_users(db: Session, skip: int = 0, limit: int = 100):\n    \"\"\"usersãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰Userã‚’ã™ã¹ã¦å–å¾—ã—ã¾ã™.\"\"\"\n    return db.execute(select(User).offset(skip).limit(limit)).scalars().all()\n\n\ndef create_db_user(db: Session, user: UserCreateRequest):\n    \"\"\"usersãƒ†ãƒ¼ãƒ–ãƒ«ã«Userã‚’è¿½åŠ ã—ã¾ã™.\"\"\"\n    fake_hashed_password = user.password + \"notreallyhashed\"\n    db_user = User(\n        email=user.email, hashed_password=fake_hashed_password, is_active=True\n    )\n    db.add(db_user)\n    db.commit()\n    db.refresh(db_user)\n    return db_user\n\n\ndef get_db_items(db: Session, skip: int = 0, limit: int = 100):\n    \"\"\"itemsãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰Itemã‚’ã™ã¹ã¦å–å¾—ã—ã¾ã™.\"\"\"\n    return db.execute(select(Item).offset(skip).limit(limit)).scalars().all()\n\n\ndef create_db_user_item(db: Session, item: ItemCreateRequest, user_id: int):\n    \"\"\"itemsãƒ†ãƒ¼ãƒ–ãƒ«ã«Itemã‚’è¿½åŠ ã—ã¾ã™.\"\"\"\n    db_item = Item(**item.dict(), owner_id=user_id)\n    db.add(db_item)\n    db.commit()\n    db.refresh(db_item)\n    return db_item\n\n\n\"\"\"\nFastAPIã§SQLAlchemyã‚’ä½¿ã†ãŸã‚ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—.\n\"\"\"\n# DBã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚‹.\nSQLALCHEMY_DATABASE_URL = \"mysql+mysqldb://user:password@db/test\"\n\n# ãƒ‡ãƒãƒƒã‚°ç”¨ã«echo=Trueã«è¨­å®š.\nengine = create_engine(SQLALCHEMY_DATABASE_URL, echo=True)\nSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)\n\n# DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†.\nBase.metadata.create_all(bind=engine)\n\n# FastAPIã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–.\napp = FastAPI()\n\n\ndef get_db():\n    \"\"\"ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãŸã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€å‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰é–‰ã˜ã‚‹ãŸã‚ã®Dependency.\"\"\"\n    db = SessionLocal()\n    try:\n        yield db\n    finally:\n        db.close()\n\n\n\"\"\"\nFastAPIã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°.\n\"\"\"\n\n\n@app.post(\"/users/\", response_model=UserResponse)\ndef create_user(user: UserCreateRequest, db: Session = Depends(get_db)):\n    \"\"\"ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™.\"\"\"\n    db_user = get_db_user_by_email(db, email=user.email)\n    if db_user:\n        raise HTTPException(status_code=400, detail=\"Email already registered\")\n    return create_db_user(db=db, user=user)\n\n\n@app.get(\"/users/\", response_model=list[UserResponse])\ndef read_users(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):\n    \"\"\"ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¸€è¦§ã—ã¾ã™.\"\"\"\n    users = get_db_users(db, skip=skip, limit=limit)\n    return users\n\n\n@app.get(\"/users/{user_id}\", response_model=UserResponse)\ndef read_user(user_id: int, db: Session = Depends(get_db)):\n    \"\"\"ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã—ã¾ã™.\"\"\"\n    db_user = get_db_user(db, user_id=user_id)\n    if db_user is None:\n        raise HTTPException(status_code=404, detail=\"User not found\")\n    return db_user\n\n\n@app.post(\"/users/{user_id}/items/\", response_model=ItemResponse)\ndef create_item_for_user(\n    user_id: int, item: ItemCreateRequest, db: Session = Depends(get_db)\n):\n    \"\"\"ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆã—ã¾ã™.\"\"\"\n    return create_db_user_item(db=db, item=item, user_id=user_id)\n\n\n@app.get(\"/items/\", response_model=list[ItemResponse])\ndef read_items(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):\n    \"\"\"ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä¸€è¦§ã—ã¾ã™.\"\"\"\n    items = get_db_items(db, skip=skip, limit=limit)\n    return items\n```\n\nä»¥ä¸Šã‚’ `main.py` ã¨ã—ã¦ä¿å­˜ã—ã¦ã€ä¸‹è¨˜ã® `Dockerfile` `docker-compose.yml` ã§ `docker compose up --build` ã™ã‚Œã°å‹•ãã¾ã™ã€‚\n\n```dockerfile\nFROM python:3.10\n\nWORKDIR /app\n\nENV PATH=$PATH:/root/.local/bin\nCOPY pyproject.toml poetry.lock ./\n\nRUN curl -sSL https://install.python-poetry.org | python3 - \\\n    \u0026\u0026 poetry install\n\nCMD [\"poetry\", \"run\", \"uvicorn\", \"main:app\", \"--host\", \"0.0.0.0\", \"--reload\"]\n```\n\n```yaml\nversion: '3'\nservices:\n  app:\n    build:\n      context: ./\n      dockerfile: Dockerfile\n    ports:\n      - '8000:8000'\n    volumes:\n      - type: bind\n        source: ./\n        target: /app\n  db:\n    image: mysql:8.0\n    environment:\n      MYSQL_ROOT_PASSWORD: password\n      MYSQL_DATABASE: test\n      MYSQL_USER: user\n      MYSQL_PASSWORD: password\n```\n\n## ã¡ã‚‡ã“ã£ã¨è§£èª¬\n\n### SQL Alchemy 2.0 ã«å¯¾å¿œã•ã›ã‚‹\n\nã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚Œã°ãã‚ŒãŒã™ã¹ã¦ãªã®ã§ã‚ã¾ã‚Šè§£èª¬ã™ã‚‹ã“ã¨ã¯ãªã„ã®ã§ã™ãŒã€FastAPI å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® [SQL (Relational) Databases](https://fastapi.tiangolo.com/ja/tutorial/sql-databases/) ã®ãƒšãƒ¼ã‚¸ã¨ã®å¤§ããªé•ã„ã¯ã€SQLAlchemy 2.0é¢¨ãªæ›¸ãæ–¹ã«ãªã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã§ã™ã€‚\n\nSQLAlchemy ã‚’ä½¿ã£ãŸã“ã¨ã®ã‚ã‚‹æ–¹ãªã‚‰ `session.query(User).filter(User.id == user_id).first()` ã®ã‚ˆã†ãªæ›¸ãæ–¹ã«æ…£ã‚Œã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ãŒã€SQLAlchemy 2.0 ã§ã¯ã“ã®æ›¸ãæ–¹ã¯[ãƒ¬ã‚¬ã‚·ãƒ¼ã¨ã•ã‚Œã¦ã„ã¾ã™](https://docs.sqlalchemy.org/en/20/orm/queryguide/query.html#legacy-query-api)ã€‚\n\nSQLAlchemy Core ã«çµ±ä¸€ã•ã‚ŒãŸæ›¸ãæ–¹ãŒæ¨å¥¨ã•ã‚Œã¦ãŠã‚Šã€ä¸Šè¨˜ã®ä¾‹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚\n\n```py\nsession.execute(select(User).where(User.id == user_id)).scalars().first()\n```\n\nç‰¹å¾´ã¯\n\n* ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆï¼ˆSELECT ... WHERE ...ï¼‰ã¨ãã®å®Ÿè¡ŒãŒæ˜ç¢ºã«åˆ†é›¢ã•ã‚ŒãŸ\n* `Query` ã‚¯ãƒ©ã‚¹ã§ã¯ãªã `Result` ã‚¯ãƒ©ã‚¹ã‚„ `ScalarResult` ã§ `.all()` ã‚„ `.first()` ã‚’ä½¿ã†\n\nã“ã¨ã§ã™ã€‚ä»Šã¾ã§ã® API ã‚ˆã‚Šã‚‚åˆ†ã‹ã‚Šã‚„ã™ããªã£ã¦ã„ã¾ã™ã—ã€å‹æ¨è«–ã‚‚åŠ¹ã„ã¦ã„ã‚‹ã®ã§ä½¿ã„ã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚\n\nãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹ã®æ›¸ãæ–¹ã‚‚å¤‰ã‚ã£ã¦ã„ã¾ã™ã€‚\n\nä»Šã¾ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã—ã¦ã„ãŸéƒ¨åˆ†ãŒ\n\n```py\nid = Column(Integer, primary_key=True, index=True)\n```\n\nã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\n\n```py\nid: Mapped[int] = mapped_column(primary_key=True, index=True)\n```\n\nãã‚Œã£ã½ãç§»æ¤ã—ã¦ã„ã‘ã°è¿·ã†ã“ã¨ã¯å°‘ãªã„ã¨æ€ã„ã¾ã™ã€‚\n\n### DB ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å–å¾—ã«ã¯ dependency ã‚’ä½¿ã†\n\nFastAPI ã®ä¸»è¦ãªæ©Ÿèƒ½ã®ä¸€ã¤ã¨ã‚‚ã„ãˆã‚‹ dependency ã‚’ä½¿ã£ã¦ã€DB ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç”Ÿæˆã‚’è¡Œã†ã®ãŒå®šç•ªã¨ãªã£ã¦ã„ã¾ã™ã€‚ã¡ãªã¿ã«ã€`SessionLocal` ã®å‘½åã¯ã€`sqlalchemy.orm.Session` ã¨åŒºåˆ¥ã™ã‚‹ãŸã‚ã ãã†ã§ã™ã€‚\n\n```py\ndef get_db():\n    db = SessionLocal()\n    try:\n        yield db\n    finally:\n        db.close()\n```\n\nã“ã® `get_db` dependency ã‚’ä½¿ã†ã“ã¨ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é–‹å§‹æ™‚ã« DB ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ï¼ˆ`yield` ã®æ®µéšã§æ¸¡ã•ã‚Œã‚‹ï¼‰ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰ï¼ˆfinally ç¯€ã§ï¼‰DB ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‰ã˜ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚Dependency ã§ã® `yield` ã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ã¯ [Dependencies with yield](https://fastapi.tiangolo.com/ja/tutorial/dependencies/dependencies-with-yield/) ã‚’ã”å‚ç…§ãã ã•ã„ã€‚\n\nDependency ã¯ã€åˆ¥ã® dependency ã®ä¸­ã§ã‚‚ä½¿ã†ã“ã¨ãŒã§ãã‚‹ã®ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‰å‡¦ç†ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ï¼‰ã§å¼•æ•°ã« `db = Depends(get_db)` ã¨æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ãã®ä¸­ã§ã‚‚ DB ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾¿åˆ©ã§ã™ã­ã€‚\n\n### Pydantic ã® ORM mode\n\nç§ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯æ™®æ®µä½¿ã£ã¦ã„ãªã„ã®ã§ã™ãŒã€ãƒãƒƒãƒã™ã‚Œã°ä¾¿åˆ©ã ãªã¨æ€ã†ã®ãŒ Pydantic ã® `orm_mode = True` ã§ã™ã€‚\n\nã“ã‚ŒãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã¨ã€Pydantic ãŒå€¤ã‚’å–å¾—ã™ã‚‹ã¨ãã« `data[\"id\"]` ã®ã‚ˆã†ã«è¾æ›¸ã®ã‚­ãƒ¼ã ã‘ã§ãªãã€`data.id` ã®ã‚ˆã†ã«å±æ€§ã§ã‚‚å€¤ã‚’å–å¾—ã—ã‚ˆã†ã¨è©¦ã¿ã‚‹ã‚ˆã†ã«ãªã‚‹ãã†ã§ã™ã€‚ã“ã‚Œã ã‘èã„ã¦ã‚‚ã‚ã¾ã‚Šãƒ”ãƒ³ã¨ãã¾ã›ã‚“ãŒã€ã“ã®é•ã„ãŒã‚ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ ORM ãŒå¼µã£ã¦ã„ã‚‹ relationshipï¼ˆé€šå¸¸ã¯ lazy loading ãªã®ã§æ±‚ã‚ã‚‰ã‚Œã‚‹ã¾ã§ã¯å­˜åœ¨ã—ã¦ã„ãªã„ï¼‰ã®å€¤ã‚’ã¨ã£ã¦ãã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚‹ã‚ˆã†ã§ã™ï¼ˆ`@property` ã§å‘¼ã³å‡ºã—ã¦å€¤ã‚’ã¨ã£ã¦ã“ã‚‰ã‚Œã‚‹ã¨ã„ã†ã‚ˆã†ãªã“ã¨ã‹ãªã¨äºˆæƒ³ã—ã¦ã„ã¾ã™ï¼‰ã€‚\n\n## ã¾ã¨ã‚\n\n[Prisma Client Python](https://prisma-client-py.readthedocs.io/en/stable/) ã®å‹ä»˜ã‘ã®é–‹ç™ºè€…ä½“é¨“ã‚‚çµæ§‹å¥½ãã§ã—ãŸãŒã€SQLAlchemy ã‚‚ã¾ã ã¾ã å‹¢ã„ãŒã‚ã‚Šã¾ã™ã­ã€‚ãœã²æ´»ç”¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚\n\né–¢é€£è¨˜äº‹ã‚‚ã©ã†ãã€‚  \n[SQLAlchemyã§'MySQL server has gone away'ãŒç™ºç”Ÿã—ãŸæ™‚ã®å¯¾å‡¦æ³•2ã¤](/posts/2023/01/sqlalchemy-dealing-with-disconnects)\n\n## ãŠã¾ã‘ï¼šAPI ã‚’ãŸãŸã„ã¦ã¿ã‚‹\n\n```\n$ curl -s localhost:8000/users/ -XPOST \\\n  -H 'content-type: application/json' \\\n  -d '{\"email\": \"me@example.com\", \"password\": \"mystrongpassword\"}' \\\n  | jq\n```\n\n```json\n{\n  \"email\": \"me@example.com\",\n  \"id\": 1,\n  \"is_active\": true,\n  \"items\": []\n}\n```\n\n```\n$ curl -s localhost:8000/users/ | jq\n```\n\n```json\n[\n  {\n    \"email\": \"me@example.com\",\n    \"id\": 1,\n    \"is_active\": true,\n    \"items\": []\n  }\n]\n```\n\n```\n$ curl -s localhost:8000/users/?limit=0 | jq\n```\n\n```json\n[]\n```\n\n```\n$ curl -s localhost:8000/users/1 | jq\n```\n\n```json\n{\n  \"email\": \"me@example.com\",\n  \"id\": 1,\n  \"is_active\": true,\n  \"items\": []\n}\n```\n\n```\n$ curl -s localhost:8000/users/1/items/ -XPOST \\\n  -H 'content-type: application/json' \\\n  -d '{\"title\": \"LEVEL3\", \"description\": \"My favourite album\"}' \\\n  | jq\n```\n\n```json\n{\n  \"title\": \"LEVEL3\",\n  \"description\": \"My favourite album\",\n  \"id\": 1,\n  \"owner_id\": 1\n}\n```\n\n```\n$ curl -s localhost:8000/users/1 | jq\n```\n\n```json\n{\n  \"email\": \"me@example.com\",\n  \"id\": 1,\n  \"is_active\": true,\n  \"items\": [\n    {\n      \"title\": \"LEVEL3\",\n      \"description\": \"My favourite album\",\n      \"id\": 1,\n      \"owner_id\": 1\n    }\n  ]\n}\n```\n\n```\n$ curl -s localhost:8000/items/ | jq\n```\n\n```json\n[\n  {\n    \"title\": \"LEVEL3\",\n    \"description\": \"My favourite album\",\n    \"id\": 1,\n    \"owner_id\": 1\n  }\n]\n```\n\n## å‚è€ƒæ–‡çŒ®\n\n* [SQL (Relational) Databases](https://fastapi.tiangolo.com/ja/tutorial/sql-databases/)\n* [ORM Quick Start](https://docs.sqlalchemy.org/en/20/orm/quickstart.html)\n","tags":[{"name":"Python","ref":"/tags/python"},{"name":"FastAPI","ref":"/tags/fastapi"},{"name":"SQLAlchemy","ref":"/tags/sqlalchemy"},{"name":"ORM","ref":"/tags/orm"}],"showTerminalAside":false},{"title":"TypedDictã¯dictã®subtypeã§ã¯ãªã„ã®ã§é–¢æ•°ã®å¼•æ•°ã«ã¯Mappingã‚’ä½¿ã†","date":"2023-02-06T00:00:00.000Z","ref":"/posts/2023/02/typeddict-is-not-subtype-of-dict","desc":" Python ã® dictï¼ˆè¾æ›¸ï¼‰ã‚’ TypeScript ã® interface ã®ã‚ˆã†ã«æ‰±ãˆã¦ä¾¿åˆ©ãª TypedDict ã§ã™ãŒã€**dict ã®ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã§ã¯ãªã„**ã¨ã„ã†ã®ãŒå°‘ã—è½ã¨ã—ç©´ã ãªã¨æ€ã£ãŸã®ã§ãƒ¡ãƒ¢ã€‚\n\n##","draft":false,"content":"\nPython ã® dictï¼ˆè¾æ›¸ï¼‰ã‚’ TypeScript ã® interface ã®ã‚ˆã†ã«æ‰±ãˆã¦ä¾¿åˆ©ãª [TypedDict](https://peps.python.org/pep-0589/) ã§ã™ãŒã€**dict ã®ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã§ã¯ãªã„**ã¨ã„ã†ã®ãŒå°‘ã—è½ã¨ã—ç©´ã ãªã¨æ€ã£ãŸã®ã§ãƒ¡ãƒ¢ã€‚\n\n## ã¾ãšã¯ PEP ã‚’è¦‹ã‚ˆã†\n\nå¤§æŠµã®ã“ã¨ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚Œã°æ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚ä»Šå›ã‚‚ä¾‹å¤–ãªããã†ã§ã—ãŸã€‚\n\n\u003e First, any TypedDict type is consistent with `Mapping[str, object]`.\n\nhttps://peps.python.org/pep-0589/#type-consistency\n\nè¨€ã„ãŸã„ã“ã¨ã¯ä»¥ä¸Šã§ã™ã€‚é–¢æ•°ã®å¼•æ•°ã¨ã—ã¦ã€ãã® TypedDict ä»¥å¤–ã®è¾æ›¸ã‚‚å—ã‘å–ã‚ŠãŸã„ã¨ãã¯ Mapping ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚\n\n```py\nfrom typing import Mapping, TypedDict\n\nclass Movie(TypedDict):\n    name: str\n    year: int\n\ndef from_mapping(map: Mapping[str, object]):\n    \"\"\"TypedDictã‚’å«ã‚€ä»»æ„ã®ãƒãƒƒãƒ—ã‚’å—ã‘å–ã‚‹é–¢æ•°.\"\"\"\n\ndef from_dict(dict: dict[str, object]):\n    \"\"\"ä»»æ„ã®dictã‚’å—ã‘å–ã‚‹é–¢æ•°.\"\"\"\n\nmovie: Movie = {\n  \"name\": \"Harry Potter and the Philosopher's Stone\",\n  \"year\": 1999,\n}\n\n# OK\nfrom_mapping(movie)\n\n# NG\nfrom_dict(movie)\n```\n\n## ã©ã‚“ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ï¼Ÿ\n\nå‹ãƒ’ãƒ³ãƒˆãªã®ã§å®Ÿè¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€é™çš„å‹æ¤œæŸ»ã§æ€’ã‚‰ã‚Œã¾ã™ã€‚\n\n```\n$ poetry run pyright main.py\n...\npyright 1.1.292\n/path/to/main.py\n  /path/to/main.py:22:11 - error: Argument of type \"Movie\" cannot be assigned to parameter \"dict\" of type \"dict[str, object]\" in function \"from_dict\"\n  Â Â \"Movie\" is incompatible with \"dict[str, object]\" (reportGeneralTypeIssues)\n1 error, 0 warnings, 0 informations\nCompleted in 0.512sec\n```\n\nã¡ãªã¿ã«ä¸Šè¨˜ã®ä¾‹ã§ã¯ `Mapping[str, object]` ã‚’ä½¿ã£ã¦ã„ã¾ã™ãŒ `Mapping[str, Any]` ã§ã‚‚å•é¡Œãªã„ã§ã™ã€‚\n\n## ã¾ã¨ã‚\n\nã¨ã‚Šã‚ãˆãš `dict[str, Any]` ã§ã„ã‘ã‚‹ã‹ãªï½ã¨æ€ã£ã¦ã„ãŸã‚‰å¼•ã£ã‹ã‹ã£ãŸã®ã§å‹‰å¼·ã«ãªã‚Šã¾ã—ãŸã€‚\n\nå°‘ã—è©±ã¯ãã‚Œã¾ã™ãŒ[ãƒ­ãƒã‚¹ãƒˆãƒã‚¹åŸå‰‡](https://ja.wikipedia.org/wiki/%E3%83%AD%E3%83%90%E3%82%B9%E3%83%88%E3%83%8D%E3%82%B9%E5%8E%9F%E5%89%87)ã¨ã„ã†ã®ã‚’æœ€è¿‘çŸ¥ã‚Šã¾ã—ãŸã€‚\n\n\u003e è²´æ–¹ãŒè‡ªåˆ†ã§ã™ã‚‹ã“ã¨ã«é–¢ã—ã¦ã¯å³å¯†ã«ã€è²´æ–¹ãŒä»–äººã‹ã‚‰å—ã‘ã‚‹ã“ã¨ã«é–¢ã—ã¦ã¯å¯›å®¹ã«  \n\u003e (be conservative in what you do, be liberal in what you accept from others)\n\nä»Šå›ã®ä¾‹ã§ã¯ `dict[str, Any]` ã‚’å¼•æ•°ã¨ã—ã¦æŒ‡å®šã™ã‚‹ã‚ˆã‚Šã‚‚ `Mapping[str, Any]` ã¨æ›¸ãã»ã†ãŒã€ã‚ˆã‚Šã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’å …ç‰¢ãªä½œã‚Šã«ã§ãã‚‹ã®ã‹ã‚‚ã¨æ€ã„ã¾ã—ãŸã€‚ã¡ã‚‡ã£ã¨å½±ãŒè–„ã„ï¼ˆï¼Ÿï¼‰Mapping ãã‚“ã€æœ‰åŠ¹ã«æ´»ç”¨ã—ã¦ã„ããŸã„æ‰€å­˜ã§ã™ã€‚\n\n## å‚è€ƒæ–‡çŒ®\n\n* https://peps.python.org/pep-0589/\n* https://stackoverflow.com/questions/73242556/typeddict-class-is-an-incompatible-type-for-function-expecting-dict\n\nRobustness Principle çš„ã«ã‚‚ Mapping ã‚’ä½¿ã†ã‚ˆã†ã«ã—ãŸæ–¹ãŒã„ã„ã‹ã‚‚\n","tags":[{"name":"Python","ref":"/tags/python"}],"showTerminalAside":false},{"title":"ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã‚„ã™ã„ãƒ†ã‚¹ãƒˆã‚’æ›¸ã“ã†ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬2éƒ¨å‰åŠ","date":"2023-02-04T00:00:00.000Z","ref":"/posts/2023/02/unit-testing-principles-practices-and-patterns-part2-1","desc":" ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰ã‚’èª­ã‚“ã§ã„ã‚‹ã®ã§ã€ãã®ã¾ã¨ã‚ã‚’éƒ¨ã”ã¨ã«æ›¸ã„ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚\n\n1. [å˜ä½“ãƒ†ã‚¹ãƒˆã®ç›®çš„ãƒ»å®šç¾©ãƒ»å­¦æ´¾ãƒ»","draft":false,"content":"\n[ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰](https://book.mynavi.jp/ec/products/detail/id=134252)ã‚’èª­ã‚“ã§ã„ã‚‹ã®ã§ã€ãã®ã¾ã¨ã‚ã‚’éƒ¨ã”ã¨ã«æ›¸ã„ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚\n\n1. [å˜ä½“ãƒ†ã‚¹ãƒˆã®ç›®çš„ãƒ»å®šç¾©ãƒ»å­¦æ´¾ãƒ»å‘½åã«ã¤ã„ã¦ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬1éƒ¨](/posts/2023/01/unit-testing-principles-practices-and-patterns-part1)\n1. ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã‚„ã™ã„ãƒ†ã‚¹ãƒˆã‚’æ›¸ã“ã†ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬2éƒ¨å‰åŠï¼ˆã“ã®è¨˜äº‹ï¼‰\n1. [ãƒ“ã‚¸ãƒã‚¹ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ã¨é€£æºã®æŒ‡æ®ã‚’åˆ†é›¢ã™ã‚Œã°è‰¯ã„ãƒ†ã‚¹ãƒˆãŒæ›¸ã‘ã‚‹ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬2éƒ¨å¾ŒåŠ](/posts/2023/02/unit-testing-principles-practices-and-patterns-part2-2)\n1. [ãƒ—ãƒ­ã‚»ã‚¹å¤–ä¾å­˜ã¯çµ±åˆãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ã‚ˆã†ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬3éƒ¨](/posts/2023/02/unit-testing-principles-practices-and-patterns-part3)\n\nä»Šå›ã¯ç¬¬2éƒ¨ã€Œå˜ä½“ãƒ†ã‚¹ãƒˆã¨ãã®ä¾¡å€¤ã€ã®å‰åŠã«ã¤ã„ã¦ã®æ„Ÿæƒ³ã¨è€ƒå¯Ÿã«ãªã‚Šã¾ã™ã€‚ç¬¬2éƒ¨ã¯ä»¥ä¸‹ã®4ç« ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ãŒã€ä»Šå›ã¯å‰åŠã®ç¬¬4ç« ã¨ç¬¬5ç« ã«ã¤ã„ã¦æ‰±ã„ã¾ã™ã€‚\n\n* ç¬¬4ç« ï¼šè‰¯ã„å˜ä½“ãƒ†ã‚¹ãƒˆã‚’æ§‹æˆã™ã‚‹4æœ¬ã®æŸ±\n* ç¬¬5ç« ï¼šãƒ¢ãƒƒã‚¯ã®åˆ©ç”¨ã¨ãƒ†ã‚¹ãƒˆã®å£Šã‚Œã‚„ã™ã•\n\n**2023-02-18 æ›´æ–°ï¼šè¨˜äº‹ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚**\n\n## ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã¸ã®è€æ€§ã‚’æŒã¤ã“ã¨ãŒå¸¸ã«å¿…è¦\n\n\u003e è‰¯ã„å˜ä½“ãƒ†ã‚¹ãƒˆã‚’æ§‹æˆã™ã‚‹ã‚‚ã®ã¨ã—ã¦ã€æ¬¡ã®4æœ¬ã®æŸ±ãŒã‚ã‚Šã¾ã™ï¼š\n\u003e * é€€è¡Œï¼ˆregressionï¼‰ã«å¯¾ã™ã‚‹ä¿è­·\n\u003e * ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã¸ã®è€æ€§\n\u003e * è¿…é€Ÿãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯\n\u003e * ä¿å®ˆã®ã—ã‚„ã™ã•\n\n_ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰p.96 ã‚ˆã‚Šå¼•ç”¨ã€‚_\n\nä»Šå›èª­ã‚“ã ç¯„å›²ã§ã¯ã€Œè‰¯ã„å˜ä½“ãƒ†ã‚¹ãƒˆã‚’æ§‹æˆã™ã‚‹4æœ¬ã®æŸ±ã€ã«ã¤ã„ã¦èª¬æ˜ã•ã‚Œã¦ã„ã¾ã—ãŸãŒã€ãã®ä¸­ã§ã‚‚ä¸€è²«ã—ã¦é‡è¦è¦–ã•ã‚Œã¦ã„ãŸã®ãŒ2æœ¬ç›®ã®æŸ±**ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã¸ã®è€æ€§**ã§ã™ã€‚ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã¸ã®è€æ€§ã¯å¸¸ã«æœ€å¤§é™ã«ã—ã¤ã¤ã€åŒæ™‚ã«æˆã‚Šç«‹ãŸãªã„**é€€è¡Œã«å¯¾ã™ã‚‹ä¿è­·**ã¨**è¿…é€Ÿãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**ã«ã¤ã„ã¦ã¯ã€ãƒ†ã‚¹ãƒˆã®ç¨®é¡ã”ã¨ã«ã©ã¡ã‚‰ã‚’å„ªå…ˆã™ã‚‹ã‹æ±ºã‚ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ï¼ˆp.125ï¼‰ã€‚\n\n![fig 4.12](//www.plantuml.com/plantuml/png/LP3DIiD058NtUOfPraKsNOjqqwSmBiRajWRh59BfVdvGKbG8Y611aQ9Gg6WL4HMYUPZRr6JLLt2Q22QB6MQutptdS3eXfm4V7Gsi5kevwajKKrGBL6dvVKNrZF83vLCkufMOEMoTHAjhaTtFYacCyW7b1DNfEXbl4HgI07hKvSF0QXL2vDCp0pWiMtnNr3AzoH_V_y1-067e3vdLojFZGjoYd3kizBz3dQ0UeuvHQvEbNEW1UFlKFRG2S3bb_G6GRhkB-WJL9-feWq0RQjEVjvSiZXg0pxYnfTouri3i_6hvTT40Hypdrdz4icsNukOGkw5IUnExMjjSnDwf1wuw8VRkWUzvmFQQ6XrWdkd_5m00)\n\nãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã¸ã®è€æ€§ã‚’æŒãŸã›ã‚‹ãŸã‚ã®ã‚³ãƒ„ã¯ã€Œè¦³æ¸¬å¯èƒ½ãªæŒ¯ã‚‹èˆã„ã€ã®ã¿ã‚’ãƒ†ã‚¹ãƒˆã—ã€ãã‚Œã‚’å¾—ã‚‹ã¾ã§ã®éç¨‹ã¯è¦‹ãªã„ï¼ˆhow ã§ã¯ãªã what ã‚’ã¿ã‚‹ï¼‰ã¨ã„ã†ã“ã¨ã§ã™ï¼ˆpp.127-128ï¼‰ã€‚ãã®ãŸã‚ E2E ãƒ†ã‚¹ãƒˆã¯é€€è¡Œã«å¯¾ã™ã‚‹ä¿è­·ã‚’æœ€å¤§é™ã«å‚™ãˆã¦ã„ã‚‹ã¨è¨€ãˆã¾ã™ã€‚ç§ãŒæ‰€å±ã™ã‚‹ãƒãƒ¼ãƒ ã§ã‚‚ E2E ãƒ†ã‚¹ãƒˆã®ã“ã¨ã‚’æ™®æ®µã€Œãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ†ã‚¹ãƒˆã€ã¨å‘¼ã‚“ã§ãŠã‚Šã€ãã®é€šã‚Šã ãªã¨æ€ã„ã¾ã—ãŸã€‚\n\nä¸€æ–¹ã§ E2E ãƒ†ã‚¹ãƒˆã«ã¯å®Ÿè¡Œæ™‚é–“ãŒé•·ãã‹ã‹ã£ã¦ã—ã¾ã†ã®ã§ã€E2E ãƒ†ã‚¹ãƒˆã ã‘ã§é–‹ç™ºã‚’è¡Œã†ã®ã¯å³ã—ã„ã§ã™ã€‚ã—ã‹ã—ãªãŒã‚‰ã€è‘—è€…ã¯ç¬¬5ç« ã§ã€Œã‚·ã‚¹ãƒ†ãƒ å†…ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯å®Ÿè£…ã®è©³ç´°ã«ãªã‚Šã¾ã™ã€ã¨è¨€ã„ã€è¦³æ¸¬å¯èƒ½ãªæŒ¯ã‚‹èˆã„ã§ã¯ãªã„ï¼ˆãƒ†ã‚¹ãƒˆã§è¦‹ã‚‹ã¹ãæœ€çµ‚çš„ãªçµæœã§ã¯ãªã„ï¼‰ã¨ã—ã¦ã„ã¾ã™ã€‚\n\n\u003e * **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆãƒ»ã‚±ãƒ¼ã‚¹ã¯ãƒ“ã‚¸ãƒã‚¹ã«ãŠã‘ã‚‹å…¨ä½“çš„ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒã„ã‹ã«å®Ÿè¡Œã•ã‚Œã‚‹ã®ã‹ã‚’æ¤œè¨¼ã™ã‚‹**ã®ã«å¯¾ã—ã€**ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ã‚¯ãƒ©ã‚¹ã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆãƒ»ã‚±ãƒ¼ã‚¹ã¯åŒã˜ãƒ¦ãƒ¼ã‚¹ãƒ»ã‚±ãƒ¼ã‚¹ãŒå®Œäº†ã«è‡³ã‚‹ã¾ã§ã®ä¸€éƒ¨ã‚’æ¤œè¨¼ã™ã‚‹**ã“ã¨ã«ãªã‚‹\n\u003e   * ![fig 5.10](//www.plantuml.com/plantuml/png/SoWkIImgAStDuIfAJIv9p4lFILLGUhfasilc5O-RrZzkNlcuQSdZfaMFcpS_RkvGKaWiLaZEoKpDAq5M3fQV_hXvrUEcZO-RzpnkslwuUJbOn-x7JLj18isJ7pVj1EikJYqgoqnEHT7UtFcuUI7G7eWMcBKx3S4QKl9p4pFp38dHO8IamOWBuau5tPJyyZnTEvZ52bOAIizdhtksOkRxFHsFcvU1tRiJRCf62FlzdaubBfXgtT82e5weKJ1Hc9amjo7CVDouxicE1c3OAN51vQ0cG7NYCC48Zmb6Q2OufEQb0ACB0000)\n\u003e * ã‚·ã‚¹ãƒ†ãƒ å†…ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚·ã‚¹ãƒ†ãƒ é–“ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³\n\u003e   * **ã‚·ã‚¹ãƒ†ãƒ å†…ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯å®Ÿè£…ã®è©³ç´°ã«ãªã‚Šã¾ã™**ã€‚ãã®ç†ç”±ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹éš›ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ã‚¯ãƒ©ã‚¹é–“ã§è¡Œã‚ã‚Œã‚‹ã‚„ã‚Šå–ã‚Šã¯è¦³æ¸¬å¯èƒ½ãªæŒ¯ã‚‹èˆã„ã®ä¸€éƒ¨ã«ã¯ãªã‚‰ãªã„ã‹ã‚‰ã§ã™\n\u003e   * ã‚·ã‚¹ãƒ†ãƒ é–“ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å ´åˆã¯é•ã„ã¾ã™ã€‚ãªãœãªã‚‰ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã©ã®ã‚ˆã†ã«å¤–éƒ¨ã¨ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–ã‚‹ã®ã‹ã€ã¨ã„ã†ã“ã¨ã¯ãã®ã‚·ã‚¹ãƒ†ãƒ ã®è¦³æ¸¬å¯èƒ½ãªæŒ¯ã‚‹èˆã„å…¨ä½“ã‚’å½¢æˆã™ã‚‹ã‚‚ã®ã ã‹ã‚‰ã§ã™\n\u003e * **å¤–éƒ¨ã‹ã‚‰è¦³å¯Ÿã§ããªã„ãƒ—ãƒ­ã‚»ã‚¹å¤–ä¾å­˜ã¨ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯å®Ÿè£…ã®è©³ç´°ã«ãªã‚‹**\n\u003e   * ã‚‚ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é™¤ãã™ã¹ã¦ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ã“ã¨ãŒæ±ºã—ã¦ãªã„ã®ã§ã‚ã‚Œã°ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹ä»•æ§˜ã‚’ï¼ˆæ—¢å­˜ã®æ©Ÿèƒ½ã‚’ç ´ç¶»ã•ã›ãªã„é™ã‚Šï¼‰å¥½ããªã‚ˆã†ã«å¤‰ãˆã‚‰ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™\n\n_ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰pp.153-164ã‚ˆã‚Šå¼•ç”¨ã—ç®‡æ¡æ›¸ãã«ã¾ã¨ã‚ãŸã€‚å¤ªå­—ã¯ç­†è€…ã«ã‚ˆã‚‹ã‚‚ã®ã€‚å›³ã¯ç­†è€…ä½œæˆã€‚_\n\nãã†ãªã‚‹ã¨ã»ã¨ã‚“ã©ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯ E2E ãƒ†ã‚¹ãƒˆã¨åŒã˜ãªã®ã§å˜ä½“ãƒ†ã‚¹ãƒˆã®ç¯„ç–‡ã§ã¯ãªã„æ°—ãŒã—ã¾ã™ã€‚ã“ã‚Œã¯æ˜ã‚‰ã‹ãªçŸ›ç›¾ã§ã™ãŒã€ã“ã“ã«ã¤ã„ã¦ã¯ç¬¬6ãƒ»7ç« ã§èª¬æ˜ã—ã¦ãã‚Œã‚‹ã‚ˆã†ãªã®ã§ç¶šãã‚’æ¥½ã—ã¿ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚\n\nã¾ãŸã€å˜ä½“ãƒ†ã‚¹ãƒˆãŒã‚«ãƒãƒ¼ã™ã‚‹ç¯„å›²ã‚’åºƒãã—ã™ãã‚‹ã¨ p-r ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹æ™‚ã«ã€å¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰ãŒå•é¡Œãªã„ã‹ã®åˆ¤æ–­ã‚’ã™ã‚‹ã®ãŒé›£ã—ããªã‚‹ã®ã§ã¯ãªã„ã‹ãªï¼Ÿã¨ã„ã†ç–‘å•ç‚¹ãŒæµ®ã‹ã‚“ã§ãã¾ã—ãŸã€‚ãƒ†ã‚¹ãƒˆç²’åº¦ã®ãƒãƒ©ãƒ³ã‚¹ã«ã¤ã„ã¦ã‚‚ä»¥é™ã®ç« ã§èª¬æ˜ãŒã‚ã‚‹ã®ã‚’æœŸå¾…ã—ã¦ã„ã¾ã™ã€‚\n\n## ãƒ¢ãƒƒã‚¯ã¨ã‚¹ã‚¿ãƒ–\n\n\u003e * **ãƒ¢ãƒƒã‚¯**ï¼šãƒ¢ãƒƒã‚¯ã€ã‚¹ãƒ‘ã‚¤\n\u003e   * ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ãã®ä¾å­˜ã«å‘ã‹ã£ã¦è¡Œã‚ã‚Œã‚‹**å¤–éƒ¨ã«å‘ã‹ã†ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå‡ºåŠ›ï¼‰ã‚’æ¨¡å€£**ã—ã€ãã—ã¦ã€**æ¤œè¨¼ã™ã‚‹**\n\u003e   * ã‚¹ãƒ‘ã‚¤ã¯ãƒ¢ãƒƒã‚¯ã¨åŒã˜å½¹å‰²ã‚’æ‹…ã†\n\u003e     * ãƒ¢ãƒƒã‚¯ã¯ãƒ¢ãƒƒã‚¯ãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®åŠ©ã‘ã‚’å€Ÿã‚Šã¦ç”Ÿæˆã•ã‚Œã‚‹\n\u003e     * ã‚¹ãƒ‘ã‚¤ã¯é–‹ç™ºè€…è‡ªèº«ã®æ‰‹ã§å®Ÿè£…ã•ã‚Œã‚‹\n\u003e * **ã‚¹ã‚¿ãƒ–**ï¼šã‚¹ã‚¿ãƒ–ã€ãƒ€ãƒŸãƒ¼ã€ãƒ•ã‚§ã‚¤ã‚¯\n\u003e   * ä¾å­˜ã‹ã‚‰ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ã«å‘ã‹ã£ã¦è¡Œã‚ã‚Œã‚‹**å†…éƒ¨ã«å‘ã‹ã†ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå…¥åŠ›ï¼‰ã‚’æ¨¡å€£**\n\u003e   * ãƒ€ãƒŸãƒ¼ã¨ã¯ã€nullå€¤ã‚„ä¸€æ™‚ã—ã®ãã§ä½¿ã‚ã‚Œã‚‹æ–‡å­—åˆ—ãªã©ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒ¼ãƒ‰ãƒ»ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸå€¤ã®ã“ã¨\n\u003e   * ã‚¹ã‚¿ãƒ–ã¯ã‚‚ã£ã¨æ´—ç·´ã•ã‚Œã¦ãŠã‚Šã€è¨­å®šã«ã‚ˆã£ã¦è¿”ã™çµæœã‚’ç•°ãªã‚‹ã‚·ãƒŠãƒªã‚ªã”ã¨ã«å¤‰ãˆã‚‰ã‚Œã‚‹å®Œå…¨ã«è‡ªç«‹ã—ãŸä¾å­˜ã¨ã—ã¦æŒ¯ã‚‹èˆã†ã‚‚ã®\n\u003e   * ãƒ•ã‚§ã‚¤ã‚¯ã¨ä½¿ã†ç›®çš„ã¯ã‚¹ã‚¿ãƒ–ã®å ´åˆã¨ã»ã¼åŒã˜ã§ã‚ã‚‹ä¸€æ–¹ã€é€šå¸¸ã€ãƒ•ã‚§ã‚¤ã‚¯ã¯ã¾ã å­˜åœ¨ã—ãªã„ä¾å­˜ã‚’ç½®ãæ›ãˆã‚‹ãŸã‚ã«ä½œæˆã•ã‚Œã‚‹\n\n_ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰pp.132-134 ã‚ˆã‚Šå¼•ç”¨ã—ç®‡æ¡æ›¸ãã«ã¾ã¨ã‚ãŸã€‚å¤ªå­—ã¯ç­†è€…ã«ã‚ˆã‚‹ã‚‚ã®ã€‚_\n\nãƒ¢ãƒƒã‚¯ã«é–¢é€£ã—ã¦5ã¤ã®ç”¨èªãŒå‡ºã¦ãã¾ã—ãŸã€‚ãƒ¢ãƒƒã‚¯ãƒ»ã‚¹ãƒ‘ã‚¤ãƒ»ã‚¹ã‚¿ãƒ–ãƒ»ãƒ€ãƒŸãƒ¼ãƒ»ãƒ•ã‚§ã‚¤ã‚¯ã§ã™ã€‚æ­£ç›´ã€ã“ã‚Œã‚‰ã®å½¹å‰²ã®ã‚‚ã®ã¯å…¨éƒ¨ãƒ¢ãƒƒã‚¯ã ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚è¨€è‘‰ã®æ„å‘³ã‚’çŸ¥ã£ãŸã‹ã‚‰ã«ã¯æ„è­˜ã—ã¦ä½¿ã„åˆ†ã‘ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚\n\nã“ã“ã§é‡è¦ã ã¨æ€ã£ãŸã®ã¯ã€Œã‚¹ã‚¿ãƒ–ã¨ã®ã‚„ã‚Šã¨ã‚Šã‚’æ±ºã—ã¦æ¤œè¨¼ã—ã¦ã¯ãªã‚‰ãªã„ã€ã¨ã„ã†ç‚¹ã§ã™ã€‚\n\nãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã¸ã®è€æ€§ã®è©±ã§ã‚‚å‡ºã¦ããŸã‚ˆã†ã«ã€è¦³æ¸¬å¯èƒ½ãªæŒ¯ã‚‹èˆã„ã®ã¿ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã¹ãã¨ã„ã†ã“ã¨ã¨ä¸€è²«ã—ã¦ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ãŒæŒã£ã¦ãã‚‹å€¤ã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ã¯ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…ã®è©³ç´°ï¼ˆhowï¼‰ã‚’èª¿ã¹ã‚‹ã“ã¨ã«ãªã‚Šã€éå‰°æ¤œè¨¼ã¨ãªã‚Šã¾ã™ã€‚\n\nä»Šã¾ã§å®Ÿè£…ã—ã¦ããŸå˜ä½“ãƒ†ã‚¹ãƒˆã‚’æ€ã„è¿”ã—ã¦ã¿ã¦ã€ã“ã‚Œã‚’ã‚„ã£ã¦ã—ã¾ã£ã¦ã„ã‚‹ã“ã¨ã¯ã‚ã¾ã‚Šãªã„ã¨ã¯æ€ã„ã¾ã™ãŒã€ã†ã£ã‹ã‚Šã™ã‚‹ã¨ã‚„ã£ã¦ã—ã¾ã„ãã†ãªã®ã§æ„è­˜ã—ã¦ã„ããŸã„ã§ã™ã€‚\n\n## ã¾ã¨ã‚\n\nä»¥ä¸Šã€ç¬¬2éƒ¨ã€Œå˜ä½“ãƒ†ã‚¹ãƒˆã¨ãã®ä¾¡å€¤ã€ã®å‰åŠã«ã¤ã„ã¦ã®ã¾ã¨ã‚ã¨æ‰€æ„Ÿã‚’æ‹™æ–‡ãªãŒã‚‰æ›¸ãã¾ã—ãŸã€‚æ°—ã¥ããŒå¤šã„ã®ã§ã€è‡ªåˆ†ãŒæºã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã‚‚ã“ã®æœ¬ã§å¾—ãŸçŸ¥è­˜ã‚’å°å…¥ã—ã‚ˆã†ã¨è©¦ã¿ã¦ã„ã¾ã™ã€‚æ—©ãå…¨éƒ¨èª­ã¿åˆ‡ã‚‰ãªãã‚ƒã€‚ã§ã¯ã§ã¯ã€‚\n","tags":[{"name":"å˜ä½“ãƒ†ã‚¹ãƒˆ","ref":"/tags/å˜ä½“ãƒ†ã‚¹ãƒˆ"},{"name":"èª­æ›¸","ref":"/tags/èª­æ›¸"}],"showTerminalAside":false},{"title":"å˜ä½“ãƒ†ã‚¹ãƒˆã®ç›®çš„ãƒ»å®šç¾©ãƒ»å­¦æ´¾ãƒ»å‘½åã«ã¤ã„ã¦ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬1éƒ¨","date":"2023-01-17T00:00:00.000Z","ref":"/posts/2023/01/unit-testing-principles-practices-and-patterns-part1","desc":" ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰ã‚’èª­ã‚“ã§ã„ã‚‹ã®ã§ã€ãã®ã¾ã¨ã‚ã‚’éƒ¨ã”ã¨ã«æ›¸ã„ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚\n\n1. å˜ä½“ãƒ†ã‚¹ãƒˆã®ç›®çš„ãƒ»å®šç¾©ãƒ»å­¦æ´¾ãƒ»å‘½","draft":false,"content":"\n[ã€å˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ã€ï¼ˆVladimir Khorikov è‘—ã€é ˆç”°æ™ºä¹‹è¨³ï¼‰](https://book.mynavi.jp/ec/products/detail/id=134252)ã‚’èª­ã‚“ã§ã„ã‚‹ã®ã§ã€ãã®ã¾ã¨ã‚ã‚’éƒ¨ã”ã¨ã«æ›¸ã„ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚\n\n1. å˜ä½“ãƒ†ã‚¹ãƒˆã®ç›®çš„ãƒ»å®šç¾©ãƒ»å­¦æ´¾ãƒ»å‘½åã«ã¤ã„ã¦ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬1éƒ¨ï¼ˆã“ã®è¨˜äº‹ï¼‰\n1. [ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã‚„ã™ã„ãƒ†ã‚¹ãƒˆã‚’æ›¸ã“ã†ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬2éƒ¨å‰åŠ](/posts/2023/02/unit-testing-principles-practices-and-patterns-part2-1)\n1. [ãƒ“ã‚¸ãƒã‚¹ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ã¨é€£æºã®æŒ‡æ®ã‚’åˆ†é›¢ã™ã‚Œã°è‰¯ã„ãƒ†ã‚¹ãƒˆãŒæ›¸ã‘ã‚‹ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬2éƒ¨å¾ŒåŠ](/posts/2023/02/unit-testing-principles-practices-and-patterns-part2-2)\n1. [ãƒ—ãƒ­ã‚»ã‚¹å¤–ä¾å­˜ã¯çµ±åˆãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ã‚ˆã†ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹ï¼ä½¿ã„æ–¹ ç¬¬3éƒ¨](/posts/2023/02/unit-testing-principles-practices-and-patterns-part3)\n\nä»Šå›ã¯ç¬¬1éƒ¨ã€Œå˜ä½“ï¼ˆunitï¼‰ãƒ†ã‚¹ãƒˆã¨ã¯ã€ã«ã¤ã„ã¦ã®æ„Ÿæƒ³ã¨è€ƒå¯Ÿã«ãªã‚Šã¾ã™ã€‚ç¬¬1éƒ¨ã¯ä»¥ä¸‹ã®3ç« ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚\n\n* ç¬¬1ç« ï¼šãªãœã€å˜ä½“ï¼ˆunitï¼‰ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã®ã‹ï¼Ÿ\n* ç¬¬2ç« ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã¨ã¯ä½•ã‹ï¼Ÿ\n* ç¬¬3ç« ï¼šå˜ä½“ãƒ†ã‚¹ãƒˆã®æ§‹é€ çš„è§£æ\n\n**2023-02-18 æ›´æ–°ï¼šè¨˜äº‹ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚**\n\n## æœ¬ã‚’èª­ã‚€å‰ã®ãƒ†ã‚¹ãƒˆã«å¯¾ã™ã‚‹èªè­˜\n\nã¾ãšå‰æã¨ã—ã¦ã€æœ¬ã‚’èª­ã‚€å‰ã®ç§ã®ãƒ†ã‚¹ãƒˆã«å¯¾ã™ã‚‹èªè­˜ã‚’ã¾ã¨ã‚ã¾ã™ã€‚\n\n* å˜ä½“ãƒ†ã‚¹ãƒˆã¯æ™®æ®µã‹ã‚‰æ›¸ã„ã¦ã„ã‚‹\n  * Python ã¨ [pytest](https://docs.pytest.org/en/7.2.x/) ã‚’ä½¿ç”¨\n  * ã‚«ãƒãƒ¬ãƒƒã‚¸ã¯100%ã«ã—ã‚ˆã†ã¨ã„ã†ãƒãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚‹\n  * CI ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹\n* ãƒ¢ãƒƒã‚¯ã®ä½¿ã„æ–¹ã«ã„ã¾ã„ã¡è‡ªä¿¡ãŒãªã„\n  * è‡ªä½œè‡ªæ¼”ã«ãªã£ã¦ã„ã‚‹æ°—ãŒã™ã‚‹æ™‚ãŒã‚ã‚‹\n* ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆã¯ã‚„ã‚‹ã¹ãã‹è¿·ã†\n* ãƒ©ãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆãƒ»ã‚¹ãƒ¢ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆã€çµ±åˆãƒ†ã‚¹ãƒˆã€é€€è¡Œãƒ†ã‚¹ãƒˆãªã©ã®ç”¨èªã®æ­£ç¢ºãªæ„å‘³ã‚„ä½¿ã„åˆ†ã‘ã‚’çŸ¥ã‚‰ãªã„\n* TDD ã«ã¤ã„ã¦å‹‰å¼·ã—ãŸã“ã¨ã¯ãªã„\n\nä¸Šè¨˜ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã€ã‚ã‚‰ãŸã‚ã¦æŒ¯ã‚Šè¿”ã‚‹ã¨ãƒ†ã‚¹ãƒˆã«é–¢ã—ã¦è‡ªåˆ†ãŒãªã‚“ã¨ãªãã‚„ã£ã¦ããŸã“ã¨ãŒã•ã‚‰ã‘å‡ºã•ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸã€‚ä»Šå›ã®æœ¬ã§ã¯ã€ç§ã®ã‚ˆã†ãªãƒ¬ãƒ™ãƒ«ã®èª­è€…ã§ã‚‚å¼•ã£ã‹ã‹ã‚‹ã“ã¨ãªãè¦ªåˆ‡ã«è§£èª¬ã•ã‚Œã¦ã„ã¾ã™ã€‚\n\n## å¤å…¸å­¦æ´¾ vs ãƒ­ãƒ³ãƒ‰ãƒ³å­¦æ´¾\n\nå­¦ã³ã¯è‰²ã€…ã¨ã‚ã‚‹ã®ã§ã™ãŒã€ã¾ãšçŸ¥ã£ãŸã®ã¯ã€Œå¤å…¸å­¦æ´¾ã€ã¨ã€Œãƒ­ãƒ³ãƒ‰ãƒ³å­¦æ´¾ã€ãŒã‚ã‚‹ã€ã¨ã„ã†ã“ã¨ã§ã™ã€‚å¤å…¸å­¦æ´¾ã¯[ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€ï¼ˆKent Beck è‘—ã€å’Œç”°å“äººè¨³ï¼‰](https://www.ohmsha.co.jp/book/9784274217883/)ã‚’åŸç‚¹ã¨ã—ã¦ã„ã¾ã™ã€‚ãƒ­ãƒ³ãƒ‰ãƒ³å­¦æ´¾ã¯ãƒ­ãƒ³ãƒ‰ãƒ³ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§ç”Ÿã¾ã‚ŒãŸã“ã¨ã«ç”±æ¥ã—ã¦ã„ã¾ã™ï¼ˆp.28ï¼‰ã€‚ãƒ­ãƒ³ãƒ‰ãƒ³å­¦æ´¾ã¯1å˜ä½ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ä»¥å¤–ã®ä¾å­˜ã¯ãƒ¢ãƒƒã‚¯ã‚’ä½¿ã†ã‚ˆã†ã«ã™ã‚‹ã¹ãã¨è€ƒãˆã¦ã„ã¦ã€å¤å…¸å­¦æ´¾ã¯1å˜ä½ã®æŒ¯ã‚‹èˆã„ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ã€å˜ä½“ãƒ†ã‚¹ãƒˆåŒå£«ãŒçŠ¶æ…‹ã‚’å…±æœ‰ã™ã‚‹ä¾å­˜ã«å¯¾ã—ã¦ã®ã¿ãƒ¢ãƒƒã‚¯ã‚’ä½¿ã†ã¹ãã¨è€ƒãˆã¦ã„ã¾ã™ï¼ˆp.52ï¼‰ã€‚\n\nç§ã®æ‰€å±ã™ã‚‹ãƒãƒ¼ãƒ ã§ã¯æ˜ç¢ºã«ã©ã¡ã‚‰ã®å­¦æ´¾ã®ä¸»å¼µã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã©ã¡ã‚‰ã‹ã¨ã„ã†ã¨ãƒ­ãƒ³ãƒ‰ãƒ³å­¦æ´¾ã«è¿‘ã„ã‚ˆã†ã«æ„Ÿã˜ã¾ã—ãŸã€‚å„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã€Œ1å˜ä½ã®ã‚³ãƒ¼ãƒ‰ã€ã¨è¦‹ã¦ã€å˜ä½“ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã„ã¾ã™ã€‚ãƒ¢ãƒƒã‚¯ã«é–¢ã—ã¦ã¯ãƒ­ãƒ³ãƒ‰ãƒ³å­¦æ´¾ã»ã©å³æ ¼ã§ã¯ãªã„ã§ã™ãŒã€ä¾‹ãˆã° lib ã¯ lib ã§å˜ä½“ãƒ†ã‚¹ãƒˆã‚’è¡Œã£ã¦ã„ã‚‹ã¨ã„ã†ç†ç”±ã§ã€lib ã®å‘¼ã³å‡ºã—å´ã«å¯¾ã™ã‚‹å˜ä½“ãƒ†ã‚¹ãƒˆã§ã¯ lib ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ã¨ã„ã†ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã¯ã—ã°ã—ã°ã‚ã‚Šã¾ã™ã€‚\n\nè‘—è€…ãŒæŒ‡æ‘˜ã™ã‚‹é€šã‚Šã€ç§ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ã¯1ã¤ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã™ã‚‹ã¨ãã®ãƒ†ã‚¹ãƒˆã‚„å‘¨è¾ºã®ãƒ†ã‚¹ãƒˆã‚‚ç›´ã•ãªã„ã¨ã„ã‘ãªã„ã®ã§ã€ã“ã‚Œã¯ç¶­æŒã‚³ã‚¹ãƒˆã®ã‹ã‹ã‚‹è‰¯ããªã„ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãªã®ã‹ã‚‚ã€ã¨ã„ã†ã“ã¨ã«æ°—ã¥ãã¾ã—ãŸã€‚\n\n## ãƒ†ã‚¹ãƒˆãƒ»ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£\n\nç¬¬3ç« ã®ã€Œãƒ†ã‚¹ãƒˆãƒ»ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®æº–å‚™ã€ã«ã¤ã„ã¦ã®è­°è«–ã‚‚èˆˆå‘³æ·±ã‹ã£ãŸã§ã™ã€‚æœ¬ã®ä¸­ã§ã¯ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’ä½¿ã£ã¦ç¹°ã‚Šè¿”ã—åŒã˜è¨˜è¿°ã‚’æ›¸ãã“ã¨ã‚’é¿ã‘ã‚‹ã“ã¨ã«é–¢ã—ã¦ã€ã€Œãƒ†ã‚¹ãƒˆãƒ»ã‚±ãƒ¼ã‚¹ãŒèª­ã¿ã¥ã‚‰ããªã£ã¦ã—ã¾ã†ã€ã“ã¨ã«è¨€åŠã—ã¦ã„ã¾ã™ï¼ˆp.73ï¼‰ã€‚\n\nç§ã¯ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã§ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’ä½¿ã†ã“ã¨ã¯ã‚ã¾ã‚Šå¤šããªã„ã§ã™ãŒã€[pytest.fixture ã‚’ autouse=True ã«ã™ã‚‹](https://docs.pytest.org/en/7.2.x/how-to/fixtures.html#autouse-fixtures-fixtures-you-don-t-have-to-request)ã“ã¨ã¯å¤šã„ã§ã™ã€‚ã‚³ãƒ¼ãƒ‰ã®é‡ã‚’å‰Šæ¸›ã§ãã‚‹ä¸€æ–¹ã§ã€ã“ã‚Œã‚‚å¤šç”¨ã—ã™ãã‚‹ã¨ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒèª­ã¿ã«ãããªã£ã¦ã—ã¾ã†ã®ã§æ°—ã‚’ä»˜ã‘ãŸã„ã¨æ€ã„ã¾ã—ãŸã€‚\n\n## å‘½åè¦å‰‡\n\nå‘½åè¦å‰‡ã«é–¢ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ«ãƒ¼ãƒ«ã‚’è¨­ã‘ã¦ã„ã¾ã™ã€‚å‰æã¨ã—ã¦ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«å¯¾ã—ã¦ã€ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚’1ã¤ä½œã‚‹ãƒ«ãƒ¼ãƒ«ã«ãªã£ã¦ã„ã¾ã™ã€‚ä¸‹è¨˜ã®å‘½åã¯ãã®ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã®ãƒ¡ã‚½ãƒƒãƒ‰åã«å¯¾ã™ã‚‹ã‚‚ã®ã§ã™ã€‚\n\n* æ­£å¸¸ç³»\n  * `test_success` ã‚‚ã—ãã¯ `test_success_{äº‹å‰æ¡ä»¶}`\n    * e.g. `test_success_when_hoge_is_fuga`\n* ç•°å¸¸ç³»\n  * `test_failure_{äº‹å‰æ¡ä»¶}`\n    * e.g. `test_failure_when_hoge_is_invalid`\n\næœ¬ã§ã¯ã‚ˆãã‚ã‚‹ï¼ˆãã—ã¦å½¹ã«ç«‹ãŸãªã„ï¼‰å‘½åè¦å‰‡ã®ä¾‹ã¨ã—ã¦ `{ãƒ†ã‚¹ãƒˆå¯¾è±¡ãƒ¡ã‚½ãƒƒãƒ‰}_{äº‹å‰æ¡ä»¶}_{æƒ³å®šã™ã‚‹çµæœ}` ã¨ã„ã†ã‚‚ã®ãŒæŒ™ã’ã‚‰ã‚Œã¦ã„ã¾ã™ãŒï¼ˆp.77ï¼‰ã€ç§ã®ãƒãƒ¼ãƒ ã§ã‚‚ãƒ†ã‚¹ãƒˆå¯¾è±¡ãƒ¡ã‚½ãƒƒãƒ‰ã”ã¨ã«ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚’ä½œã£ã¦ã„ã‚‹æ™‚ç‚¹ã§ã€æƒ³å®šã™ã‚‹çµæœï¼ˆsuccess/failureï¼‰ã‚„äº‹å‰æ¡ä»¶ï¼ˆwhenï½ï¼‰ã‚‚ã‚ã‚‹ã®ã§ã€ã“ã‚Œã«è©²å½“ã—ã¦ã—ã¾ã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã—ãŸã€‚\n\nãŸã ã€ã“ã‚Œã«é–¢ã—ã¦ã¯ç§è‡ªèº«ãã“ã¾ã§æ‚ªã„ã¨ã¯æ€ã£ã¦ã„ã¾ã›ã‚“ã€‚ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚‹ã¨ã„ã£ã¦ã‚‚ã€é ­ã« `test_success` `test_failure` ã‚’ã¤ã‘ã¦ã„ã‚‹ã ã‘ã§ã™ã—ã€ã“ã®ç¨‹åº¦ãªã‚‰ã‚€ã—ã‚è¦‹ã‚„ã™ãã¦è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚ã—ã‹ã—ãªãŒã‚‰ã€ãã‚‚ãã‚‚ã“ã®ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã®ä½œã‚Šæ–¹ã®æ çµ„ã¿è‡ªä½“ãŒã€æŒ¯ã‚‹èˆã„ã‚ˆã‚Šã‚‚ã‚³ãƒ¼ãƒ‰ã®å®Ÿè£…ã«ç›®ãŒè¡Œãã‚‚ã®ãªã®ã¯ç¢ºã‹ãªã®ã§ã€ã“ã®ç‚¹ã«é–¢ã—ã¦ã¯æœ¬ã®ç¶šãã‚’èª­ã¿ãªãŒã‚‰ã‚ˆã‚Šè‰¯ãã—ã¦ã„ããŸã‚ã«ã©ã†ã™ã‚‹ã¹ãã‹ã‚’è€ƒãˆã¦ã„ããŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚\n\n## ã¾ã¨ã‚\n\nä»¥ä¸Šã€ç¬¬1éƒ¨ã€Œå˜ä½“ï¼ˆunitï¼‰ãƒ†ã‚¹ãƒˆã¨ã¯ã€ã«ã¤ã„ã¦ã®ã¾ã¨ã‚ã¨æ‰€æ„Ÿã‚’æ‹™æ–‡ãªãŒã‚‰æ›¸ãã¾ã—ãŸã€‚\n\nã¾ã é€”ä¸­ã§ã™ãŒã€èª­ã¿ã‚„ã™ãé¢ç™½ã„äºˆæ„Ÿãªã®ã§ã€æ°—ã«ãªã£ãŸæ–¹ã¯æ˜¯éæœ¬ã‚’æ‰‹ã«å–ã£ã¦èª­ã‚“ã§ã¿ã¦ãã ã•ã„ï¼\n","tags":[{"name":"å˜ä½“ãƒ†ã‚¹ãƒˆ","ref":"/tags/å˜ä½“ãƒ†ã‚¹ãƒˆ"},{"name":"èª­æ›¸","ref":"/tags/èª­æ›¸"}],"showTerminalAside":false},{"title":"SQLAlchemyã§'MySQL server has gone away'ãŒç™ºç”Ÿã—ãŸæ™‚ã®å¯¾å‡¦æ³•2ã¤","date":"2023-01-12T00:00:00.000Z","ref":"/posts/2023/01/sqlalchemy-dealing-with-disconnects","desc":" FastAPI ã§ SQLAlchemy ã‚’ä½¿ã£ã¦ã„ã‚‹æ™‚ã«ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¦ãŸç›´å¾Œã¯å•é¡Œãªã„ã‘ã©ä¸€å®šæ™‚é–“çµŒéå¾Œã« DB æ¥ç¶šãŒåˆ‡ã‚Œã¦ã—ã¾ã†å•é¡Œã«é­é‡ã—ãŸã®ã§ãã®æ™‚ã«èª¿ã¹ãŸã“ã¨ã®ãƒ¡ãƒ¢ã€‚\n\n## ç’°å¢ƒ\n\n* mysql 5.7.15\n* SQLAlchemy 1.4.45\n* mysqlclient 2","draft":false,"content":"\nFastAPI ã§ SQLAlchemy ã‚’ä½¿ã£ã¦ã„ã‚‹æ™‚ã«ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¦ãŸç›´å¾Œã¯å•é¡Œãªã„ã‘ã©ä¸€å®šæ™‚é–“çµŒéå¾Œã« DB æ¥ç¶šãŒåˆ‡ã‚Œã¦ã—ã¾ã†å•é¡Œã«é­é‡ã—ãŸã®ã§ãã®æ™‚ã«èª¿ã¹ãŸã“ã¨ã®ãƒ¡ãƒ¢ã€‚\n\n## ç’°å¢ƒ\n\n* mysql 5.7.15\n* SQLAlchemy 1.4.45\n* mysqlclient 2.1.1\n\n## å•é¡Œ\n\n```\nMySQLdb.OperationalError: (2006, 'MySQL server has gone away')\n```\n\næœ€å¾Œã« MySQL ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¦ã‹ã‚‰ä¸€å®šæ™‚é–“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§8æ™‚é–“ï¼‰ãŒçµŒéã™ã‚‹ã¨ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Š DB ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã™ã€‚\n\n## åŸå› \n\nSQLAlchemy ã«ã¯ Connection Pooling ã¨ã„ã†ã€DB ã‚µãƒ¼ãƒãƒ¼ã¨ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’å†…éƒ¨çš„ã«ä¿æŒã™ã‚‹æ©Ÿèƒ½ãŒå­˜åœ¨ã—ã¾ã™ã€‚ã¾ãŸã€MySQL ã«ã¯ä¸€å®šæ™‚é–“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§8æ™‚é–“ï¼‰ãŒçµŒéã™ã‚‹ã¨ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ç ´æ£„ã™ã‚‹æ©Ÿèƒ½ãŒå­˜åœ¨ã—ã¾ã™ã€‚\n\nãã®çµæœã€SQLAlchemy å´ã§ä¿æŒã—ã¦ã„ã‚‹ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã‚¯ã‚¨ãƒªã‚’æŠ•ã’ãŸã‚Šã—ã¦ã‚‚ã€MySQL å´ã§ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãŒç ´æ£„ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã¯ `MySQL server has gone away` ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã—ã¾ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚\n\n`show global variables like 'wait_timeout';` ã«ã‚ˆã£ã¦ã€ç¾åœ¨è¨­å®šã•ã‚Œã¦ã„ã‚‹ `wait_timeout` ã®ç§’æ•°ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\n\n```\nmysql\u003e show global variables like 'wait_timeout';\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| wait_timeout  | 28800 |\n+---------------+-------+\n1 row in set (0.00 sec)\n```\n\nç”Ÿãã¦ã„ã‚‹ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã¯ `show processlist` ã§çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚`Time` ãŒçµŒéæ™‚é–“ï¼ˆç§’ï¼‰ã§ã™ã€‚\n\n```\nmysql\u003e show processlist;\n+---------+-------+-----------------+------+---------+-------+----------+------------------+\n| Id      | User  | Host            | db   | Command | Time  | State    | Info             |\n+---------+-------+-----------------+------+---------+-------+----------+------------------+\n| 1200000 | scott | localhost:47000 | test | Query   |     0 | starting | show processlist |\n| 1200001 | scott | localhost:47001 | test | Sleep   |  3600 |          | NULL             |\n+---------+-------+-----------------+------+---------+-------+----------+------------------+\n2 rows in set (0.00 sec)\n```\n\n## è§£æ±ºæ–¹æ³•\n\n[SQLAlchemy ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.sqlalchemy.org/en/20/core/pooling.html#dealing-with-disconnects)ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€å¤§ããã€Œæ‚²è¦³çš„ã€ã€Œæ¥½è¦³çš„ã€2ã¤ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒã‚ã‚Šã¾ã™ã€‚\n\nã©ã¡ã‚‰ã‚’æ¡ç”¨ã™ã‚‹ã‹ã¯è¦ä»¶ã‚„å¥½ã¿ã«ã‚ˆã‚‹ã¨æ€ã„ã¾ã™ã€‚ã©ã¡ã‚‰ã®æ–¹æ³•ã«ã—ã¦ã‚‚ã€ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ã‹ã‚‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ãŸå¾Œã« MySQL å´ã§ç ´æ£„ã•ã‚Œã¦ã—ã¾ã†ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã¯ç„¡åŠ¹ãªã®ã§ã”æ³¨æ„ãã ã•ã„ï¼ˆä¸€åº¦ã®å‡¦ç†ã§ãã‚“ãªã«é•·ãæ‰±ã†ã“ã¨ã¯å°‘ãªã„ã¨ã¯æ€ã„ã¾ã™ãŒï¼‰ã€‚\n\n### æ‚²è¦³çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ\n\nã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ã‹ã‚‰å–ã‚Šå‡ºã™ã¨ãã«ã€ãã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãŒã¾ã ç”Ÿãã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹æ–¹æ³•ã§ã™ã€‚ç§ã¯ä»Šå›ã“ã¡ã‚‰ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚\n\nã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ™‚ã«è‹¥å¹²ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒã§ãã¦ã—ã¾ã„ã¾ã™ãŒã€æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã§ä¿¡é ¼ã§ãã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚\n\n```py\nfrom sqlalchemy import create_engine\n\nengine = create_engine(\"mysql+mysqldb://scott:tiger@localhost/test\", pool_pre_ping=True)\n```\n\n### æ¥½è¦³çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ\n\nä¸€å®šæ™‚é–“ã”ã¨ã«ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼µã‚Šç›´ã™æ–¹æ³•ã§ã™ã€‚ä¾‹ãˆã°ã€DB ã‚µãƒ¼ãƒãƒ¼å´ã§28800ç§’ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ãªã‚‰ã°ã€ãã‚Œã‚ˆã‚Šã‚‚çŸ­ãè¨­å®šã™ã‚Œã°ã‚ˆã„ã§ã™ã€‚\n\nä½¿ã£ã¦ã„ã¦ã‚‚ä½¿ã£ã¦ã„ãªãã¦ã‚‚ä¸€å®šæ™‚é–“ãŠãã« DB ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã‚“ã§ã—ã¾ã„ã¾ã™ãŒã€ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ™‚ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒç™ºç”Ÿã—ãªã„ã®ãŒåˆ©ç‚¹ã§ã™ã€‚\n\n```py\nfrom sqlalchemy import create_engine\n\nengine = create_engine(\"mysql+mysqldb://scott:tiger@localhost/test\", pool_recycle=3600)\n```\n\n## å‚è€ƒæ–‡çŒ®\n\n* [Connection Pooling](https://docs.sqlalchemy.org/en/20/core/pooling.html)\n* [Python: SQLAlchemy ã§ 'MySQL server has gone away' ã«ãªã‚‹å•é¡Œã‚’è§£æ±ºã™ã‚‹](https://blog.amedama.jp/entry/2015/08/15/133322)\n* [full-stack-fastapi-postgresql/session.py at master Â· tiangolo/full-stack-fastapi-postgresql](https://github.com/tiangolo/full-stack-fastapi-postgresql/blob/master/%7B%7Bcookiecutter.project_slug%7D%7D/backend/app/app/db/session.py)\n","tags":[{"name":"Python","ref":"/tags/python"},{"name":"SQLAlchemy","ref":"/tags/sqlalchemy"}],"showTerminalAside":false},{"title":"2023å¹´ç‰ˆ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°ã®å€‹äººçš„ãƒ¡ãƒ¢","date":"2023-01-08T00:00:00.000Z","ref":"/posts/2023/01/keyboard-remap","desc":" ä¸å®šæœŸçš„ã«ã€Œã‚ãƒ¼ã§ã‚‚ãªã„ã€ã“ãƒ¼ã§ã‚‚ãªã„ã€ã¨è¨€ã£ã¦ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ã„ã˜ã‚Šã ã—ã¦ã—ã¾ã†ã“ã¨ã£ã¦ã‚ã‚Šã¾ã™ã‚ˆã­ã€‚ç§ã¯ã‚ã‚Šã¾ã™ã€‚é™ã‚Šã‚ã‚‹ã‚­ãƒ¼ã®ä¸­ã‹ã‚‰è‡ªåˆ†ã«ã¨ã£ã¦ã®æœ€é©è§£ã‚’è¦‹ã¤ã‘ã‚‹ä½œæ¥­ã¯ãªã‚“ã ã‹ã‚“ã æ¥½ã—ã„ã§ã™ã€‚\n\nä»Šå›ã¯ 2023 å¹´ç‰ˆã€ç§ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æ›¸ãã¨ã‚ã¦ãŠã“ã†ã¨æ€ã„ã¾ã™ã€‚\n\néå»","draft":false,"content":"\nä¸å®šæœŸçš„ã«ã€Œã‚ãƒ¼ã§ã‚‚ãªã„ã€ã“ãƒ¼ã§ã‚‚ãªã„ã€ã¨è¨€ã£ã¦ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ã„ã˜ã‚Šã ã—ã¦ã—ã¾ã†ã“ã¨ã£ã¦ã‚ã‚Šã¾ã™ã‚ˆã­ã€‚ç§ã¯ã‚ã‚Šã¾ã™ã€‚é™ã‚Šã‚ã‚‹ã‚­ãƒ¼ã®ä¸­ã‹ã‚‰è‡ªåˆ†ã«ã¨ã£ã¦ã®æœ€é©è§£ã‚’è¦‹ã¤ã‘ã‚‹ä½œæ¥­ã¯ãªã‚“ã ã‹ã‚“ã æ¥½ã—ã„ã§ã™ã€‚\n\nä»Šå›ã¯ 2023 å¹´ç‰ˆã€ç§ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æ›¸ãã¨ã‚ã¦ãŠã“ã†ã¨æ€ã„ã¾ã™ã€‚\n\néå»ã®è¨˜äº‹: [Windows10 ã¨ PowerToys ã§ US ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã‚‚ç„¡å¤‰æ›ãƒ»å¤‰æ›ã‚­ãƒ¼ã‚’ä½¿ã£ã¦ IME ã‚’ä¸€ç™ºã§åˆ‡ã‚Šæ›¿ãˆã‚‹](https://qiita.com/SogoK/items/7e0ea37c3e958c39608c)\n\n## ç’°å¢ƒ\n\n* ä½¿ã†ãƒ‘ã‚½ã‚³ãƒ³\n  * Windows ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—\n  * Windows ãƒ©ãƒƒãƒ—ãƒˆãƒƒãƒ—\n  * MacBook Air (2022)\n* ä½¿ã†ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰\n  * HHKBï¼ˆUS é…åˆ—ï¼‰\n  * MacBook Air å†…è”µã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼ˆUS é…åˆ—ï¼‰\n\nä»•äº‹ã¯ Windows ãƒ©ãƒƒãƒ—ãƒˆãƒƒãƒ— + HHKB ãªã®ã§ã€ã“ã®çµ„ã¿åˆã‚ã›ã§ä½œæ¥­ã™ã‚‹æ™‚é–“ãŒä¸€ç•ªé•·ã„ã§ã™ã€‚MacBook Air ã§ä½œæ¥­ã™ã‚‹æ™‚ã¯åŸºæœ¬çš„ã«ã¯å†…è”µã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’ä½¿ã„ã¾ã™ãŒã€HHKB ã‚’æ¥ç¶šã™ã‚‹ã“ã¨ã‚‚ã—ã°ã—ã°ã‚ã‚Šã¾ã™ã€‚\n\n## çµè«–\n\nçµå±€ä»•äº‹ã§ãƒ‘ã‚½ã‚³ãƒ³ã‚’è§¦ã‚‹æ™‚é–“ã®æ–¹ãŒé•·ã„ã®ã§ã€Windows + HHKB ã®çµ„ã¿åˆã‚ã›ã§ä½¿ã†çŠ¶æ³ã‚’å„ªå…ˆã—ã¾ã—ãŸã€‚\n\n- HHKB ãªã®ã§ã€`Control` ã¯ `Caps Lock` ã®ä½ç½®\n- ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã®å·¦å³ã¯ãã‚Œãã‚Œ Mac ã® `è‹±æ•°` `ã‹ãª` ã‚­ãƒ¼ã«ã™ã‚‹\n  - Windows ã§ã‚‚ Mac ã® `è‹±æ•°` `ã‹ãª` ã‚­ãƒ¼ã‚’ã¡ã‚ƒã‚“ã¨èªè­˜ã—ã¦ IME ã®åˆ‡ã‚Šæ›¿ãˆã‚’ã‚„ã£ã¦ãã‚Œã‚‹\n  - ãªã®ã§éå»è¨˜äº‹ã§ç´¹ä»‹ã—ãŸ PowerToys ã‚’ä½¿ç”¨ã—ãŸãƒãƒƒã‚¯ã¯ä¸è¦\n- ä¸Šè¨˜ã«ã‚ˆã£ã¦ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼å·¦å³ã® `Windows/Command` ã‚­ãƒ¼ãŒæ¶ˆãˆã¦ã—ã¾ã†ã®ã§ã€`å·¦ Alt/Option` ã‚’ `Windows/Command` ã«ã™ã‚‹\n- Mac ã§ã¯ Karabiner Elements ã‚’ä½¿ç”¨ã—ã¦ Windows ã§ã®æ“ä½œæ„Ÿã«å¯„ã›ã¦ã„ã\n  - Mac ã® `Command` ã¨ Windows ã® `Control` ãŒåŒã˜ä½ç½®ã«æ¥ã‚‹ã‚ˆã†ã«ã™ã‚‹\n\n## å®Ÿç¾æ–¹æ³•\n\nä½¿ã†ãƒ„ãƒ¼ãƒ«ã¯ä»¥ä¸‹ã® 2 ã¤ã§ã™ã€‚\n\n- [Happy Hacking Keyboard ã‚­ãƒ¼ãƒãƒƒãƒ—å¤‰æ›´ãƒ„ãƒ¼ãƒ«](https://happyhackingkb.com/jp/download/)\n- [Karabiner Elements](https://karabiner-elements.pqrs.org/)\n\n### Happy Hacking Keyboard ã‚­ãƒ¼ãƒãƒƒãƒ—å¤‰æ›´ãƒ„ãƒ¼ãƒ«\n\n![HHKB](/images/posts/2023/01/keyboard_hhkb_remap.png)\n\nå¤‰æ›´ç‚¹ã¨ã—ã¦ã¯\n\n- `å·¦â™¢` ã‚’ `è‹±æ•°` ã«\n- `å³â™¢` ã‚’ `ã‹ãª` ã«\n- `å·¦ Alt/Option` ã‚’ `Control` ã«\n\nã“ã‚Œã«ã‚ˆã£ã¦ Windows ã§ã‚‚ Mac ã§ã‚‚ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã®å·¦ã‚’æŠ¼ã›ã°è‹±å­—å…¥åŠ›ã€ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã®å³ã‚’æŠ¼ã›ã°ã‹ãªå…¥åŠ›ã«ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚ä»Šã¨ãªã£ã¦ã¯ã“ã‚Œä»¥å¤–ã® IME åˆ‡ã‚Šæ›¿ãˆæ–¹æ³•ã¯é¢å€’ã™ãã¦è€ãˆã‚‰ã‚Œã¾ã›ã‚“ã€‚\n\nãã—ã¦ã€ã“ã®å¤‰æ›´ã«ã‚ˆã£ã¦ `â™¢` ãŒæ¶ˆæ»…ã—ãŸã®ã§ `Windows/Command` ã‚­ãƒ¼ãŒä½¿ãˆãªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚ãã®ãŸã‚ `å·¦ Alt/Option` ã‚’ `â™¢` ã«å¤‰æ›´ã—ã¾ã™ã€‚`Alt/Option` ã¯å·¦å³ã«ã‚ã‚‹ã®ã§ã©ã¡ã‚‰ã‚’å¤‰æ›´ã—ã¦ã‚‚ã„ã„ã®ã§ã™ãŒã€å€‹äººçš„ã«ã¯ `Windows + Shift + S`ï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼‰ã‚„ã€ï¼ˆMac ã§ã¯ `Command` ã¨ `Control` ã‚’å…¥ã‚Œæ›¿ãˆã‚‹ãŸã‚ï¼‰`Control + C` ã®çµ„ã¿åˆã‚ã›ãªã©ãŒå·¦æ‰‹ã ã‘ã§æŠ¼ã›ãŸæ–¹ãŒä¾¿åˆ©ãªã®ã§ã€å·¦å´ã‚’ `â™¢` ã«ã—ã¾ã—ãŸã€‚  \næœ¬å½“ã¯å·¦å´ã® `Alt/Option` ã‚‚ã‚ã‚‹ã®ãŒç†æƒ³ãªã®ã§ã™ãŒã€`Alt/Option` ã‚’ä½¿ã†ã®ã¯ VS Code ã§è¤‡æ•°è¡Œé¸æŠã™ã‚‹ã¨ããŒã»ã¨ã‚“ã©ãªã®ã§ã€ãƒã‚¦ã‚¹ã¨ã®çµ„ã¿åˆã‚ã›ã§ã™ã—ã¾ã ãªã‚“ã¨ã‹ãªã‚‹ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚\n\nWindows ã§ã‚‚ Mac ã§ã‚‚ DIP ã‚¹ã‚¤ãƒƒãƒã¯å¤‰æ›´ã›ãšã«ã€å¸¸ã«åŒã˜ãƒ¢ãƒ¼ãƒ‰ã§ä½¿ã„ã¾ã™ã€‚DIP ã‚¹ã‚¤ãƒƒãƒã«ã¤ã„ã¦ã¯[å…¬å¼ãƒšãƒ¼ã‚¸](https://happyhackingkb.com/jp/products/discontinued/hhkb_backview.html)ã‚’å‚ç…§ãã ã•ã„ã€‚\n\n| ã‚­ãƒ¼ | ON/OFF |\n| ---- | ------ |\n| SW1  | OFF    |\n| SW2  | OFF    |\n| SW3  | ON     |\n| SW4  | OFF    |\n| SW5  | OFF    |\n\nå‚è€ƒ: HHKB ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚­ãƒ¼é…åˆ—\n\n![HHKB ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚­ãƒ¼é…åˆ—](https://happyhackingkb.com/jp/products/image/leaflet/pro_keytop_a_l.jpg)\n\n### Karabiner Elementsï¼ˆåŸºæœ¬çš„ãªè¨­å®šï¼‰\n\nWindows ã§ã¯ OS å´ã§ã®è¨­å®šã¯ç‰¹ã«è¡Œã‚ãšã€HHKB ã«æ›¸ãè¾¼ã‚“ã è¨­å®šã®ã¿ã§ä½¿ç”¨ã—ã¾ã™ã€‚  \nã“ã“ã‹ã‚‰ã€Mac ã§ Windows ã§ã®æ“ä½œæ„Ÿã«å¯„ã›ã¦ã„ããŸã‚ã®èª¿æ•´ã‚’ã‚„ã£ã¦ã„ãã¾ã™ã€‚\n\n#### ä¿®é£¾ã‚­ãƒ¼ã‚’å…¥ã‚Œæ›¿ãˆã‚‹\n\nã¾ãšã€ä¿®é£¾ã‚­ãƒ¼ã‚’å…¥ã‚Œæ›¿ãˆã¦ã„ãã¾ã™ã€‚ä¿®é£¾ã‚­ãƒ¼ã®å…¥ã‚Œæ›¿ãˆã¯ Mac ã®æ¨™æº–æ©Ÿèƒ½ã§å®Ÿç¾ã§ãã‚‹ã®ã§ã™ãŒã€ãƒ„ãƒ¼ãƒ«çµ±ä¸€ã®è¦³ç‚¹ã‹ã‚‰ Karabiner Elements ã§å®Ÿæ–½ã—ã¾ã™ã€‚\n\nMac ã®å†…è”µã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼ˆUS é…åˆ—ï¼‰ã® `Caps Lock` ã‚’ HHKB é¢¨ã« Windows ã§ã® `Control` ç›¸å½“ã§ã‚ã‚‹ `Command` ã«ã—ã¾ã™ã€‚\n\n![å†…è”µã‚­ãƒ¼ãƒœãƒ¼ãƒ‰](/images/posts/2023/01/keyboard_ke_internal.png)\n\nHHKB ã® `å·¦ Command` ã¨ `å·¦ Control` ã‚’å…¥ã‚Œæ›¿ãˆã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ä¸€èˆ¬çš„ã« `Caps Lock` ã®ä½ç½®ã®ã‚­ãƒ¼ãŒ `Command` ã«ãªã‚Šã¾ã™ã€‚ä¸€ç•ªæ‰‹å‰ã®åˆ—ã®å·¦ç«¯ãŒ `Control` ã§ã™ã€‚\n\n![HHKB](/images/posts/2023/01/keyboard_ke_hhkb.png)\n\n#### Mac å†…è”µã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®å·¦å³ `Command` ã‚’ `è‹±æ•°` `ã‹ãª` ã«ã™ã‚‹\n\nKarabiner Elements ã® `Complex Modifications` â†’ `Add rule` â†’ `Import more rules from the Internet (Open a web browser)` ã¨é€²ã¿ã¾ã™ã€‚\n\n[https://ke-complex-modifications.pqrs.org/](https://ke-complex-modifications.pqrs.org/) ãŒé–‹ãã®ã§ã€`RDP for Japanese, US Keyboard ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¨USã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã€æ—¥æœ¬èªç’°å¢ƒã®è¨­å®šï¼‰` ã‚’ import ã—ã¾ã™ã€‚ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚’ä½¿ã‚ãªã‘ã‚Œã° `For Japanese ï¼ˆæ—¥æœ¬èªç’°å¢ƒå‘ã‘ã®è¨­å®šï¼‰ (rev 6)` ã§ã‚‚ OK ã§ã™ã€‚\n\n`[RDP] RDPã‚¢ãƒ—ãƒªä»¥å¤–ã§ã¯ã€ã‚³ãƒãƒ³ãƒ‰ã‚­ãƒ¼ã‚’å˜ä½“ã§æŠ¼ã—ãŸã¨ãã«ã€è‹±æ•°ãƒ»ã‹ãªã‚­ãƒ¼ã‚’é€ä¿¡ã™ã‚‹ã€‚ï¼ˆå·¦ã‚³ãƒãƒ³ãƒ‰ã‚­ãƒ¼ã¯è‹±æ•°ã€å³ã‚³ãƒãƒ³ãƒ‰ã‚­ãƒ¼ã¯ã‹ãªï¼‰ (rev 3)`ï¼ˆ`ã‚³ãƒãƒ³ãƒ‰ã‚­ãƒ¼ã‚’å˜ä½“ã§æŠ¼ã—ãŸã¨ãã«ã€è‹±æ•°ãƒ»ã‹ãªã‚­ãƒ¼ã‚’é€ä¿¡ã™ã‚‹ã€‚ï¼ˆå·¦ã‚³ãƒãƒ³ãƒ‰ã‚­ãƒ¼ã¯è‹±æ•°ã€å³ã‚³ãƒãƒ³ãƒ‰ã‚­ãƒ¼ã¯ã‹ãªï¼‰ (rev 3)`ï¼‰ã®ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚\n\nã“ã‚Œã«ã‚ˆã‚Šã€HHKB ã§ã® `è‹±æ•°` `ã‹ãª` ã¨åŒã˜æ©Ÿèƒ½ãŒå®Ÿç¾ã—ã¾ã™ã€‚æœ¬æ¥ã®ä½ç½®ã®å·¦å³ `Command` ã‚‚å˜æŠ¼ã—ã§ãªã‘ã‚Œã°å¼•ãç¶šãåˆ©ç”¨å¯èƒ½ã§ã™ã€‚\n\n### Karabiner Elementsï¼ˆç´°ã‹ã„è¨­å®šï¼‰\n\nä¸Šè¨˜ã®è¨­å®šã§åŸºæœ¬çš„ã«ã¯ OK ã§ã™ãŒã€ã¾ã ç´°ã‹ã„ã¨ã“ã‚ã§é•ã„ãŒã‚ã‚‹ã®ã§åˆã‚ã›ã¦ã„ãã¾ã™ã€‚\n\n#### `Home` `End` ã‚­ãƒ¼ã§è¡Œç«¯ã«ç§»å‹•ã™ã‚‹\n\nå…ˆã»ã©ã¨åŒã˜ã‚ˆã†ã«ã€ä»Šåº¦ã¯ `PC-Style Shortcuts` ã‚’æ¢ã—ã¦ import ã—ã¾ã™ã€‚\n\n`Home key to the beginning of the line (Control + a)` ãŠã‚ˆã³ `End key to the end of the line (Control + e)` ã®ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚\n\n#### æ—¥æœ¬èªå…¥åŠ›æ™‚ã® `Control + T/U/I/O/P` ã‚’å¾©æ´»ã•ã›ã‚‹\n\nHHKB ã§æ—¥æœ¬èªã‚’å…¥åŠ›ã—ã¦ã„ã‚‹æ–¹ãªã‚‰ä½¿ã£ã¦ã„ã‚‹ã“ã¨ã‚‚å¤šã„ã¨æ€ã‚ã‚Œã‚‹ `Control + T/U/I/O/P` ã¨ã„ã†ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚Windows ã§ä½¿ãˆã‚‹ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã§ã™ãŒã€Mac ã§ã‚‚ `Windows é¢¨ã®ã‚­ãƒ¼æ“ä½œ` ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ã§ä½¿ãˆã¾ã™ã€‚\n\n![Mac IME](/images/posts/2023/01/keyboard_mac_ime.png)\n\n| Windows ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ | Mac ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ         | å¤‰æ›å…ˆ   | F ã‚­ãƒ¼ |\n| ---------------------- | -------------------------- | -------- | ------ |\n| Control + T            | Control + T                | åŠè§’è‹±æ•° | F10    |\n| Control + U            | Control + U                | å…¨è§’ã‹ãª | F6     |\n| Control + I            | Control + I                | å…¨è§’ã‚«ãƒŠ | F7     |\n| Control + O            | ä¸æ˜ (Option + A ã¯ä½¿ãˆãŸ) | åŠè§’ï½¶ï¾…   | F10    |\n| Control + P            | Control + P                | å…¨è§’è‹±æ•° | F9     |\n\nã“ã‚Œã‚‰ã«é–¢ã—ã¦ã¯ã€åŠè§’ï½¶ï¾…ã‚’é™¤ã„ã¦ã€ã©ã¡ã‚‰ã‚‚ `Control` ãªã®ã§ã€`Caps Lock` ä½ç½®ã« Windows ã§ã¯ `Control` ã‚’ã€Mac ã§ã¯ `Command` ã‚’ç½®ãé‹ç”¨ã ã¨ä½ç½®ãŒãšã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚\n\nãªã®ã§ã€`Command + T/U/I/O/P` ã§ã€Windows ã¨åŒã˜ã‚ˆã†ãªå‹•ä½œã‚’ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚ãªãœã‹ `Control + O` ã ã‘ Windows ã¨äº’æ›æ€§ãŒãªã„ï¼ˆåŠè§’è‹±æ•°ã«ãªã£ã¦ã—ã¾ã†ï¼‰ã®ã§ã€`Option + A` ã«ã—ã¾ã™ã€‚\n\nè©¦ã—ã¦ã¿ãŸã„æ–¹ã¯ [japanese_cmd_tuiop.json](https://raw.githubusercontent.com/SogoKato/KE-complex_modifications/feature/cmd-tuiop/public/json/japanese_cmd_tuiop.json) ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ `~/.config/karabiner/assets/complex_modifications` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚\n\nï¼ˆä½¿ã£ã¦ã¿ã¦å®‰å®šã—ã¦ã„ãŸã‚‰ãƒ—ãƒ«ãƒªã‚¯ã‚’å‡ºãã†ã¨æ€ã„ã¾ã™ï¼‰\n\nä¸Šè¨˜ã‚’ã™ã¹ã¦è¨­å®šã™ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚\n\n![complex modifications](/images/posts/2023/01/keyboard_ke_complex.png)\n\n## æœ€å¾Œã«\n\nä»¥ä¸ŠãŒã€2023å¹´ç‰ˆ ç§ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°ã§ã—ãŸã€‚å¤šåˆ†å‘ã“ã†åŠå¹´ãã‚‰ã„ã¯ã“ã®è¨­å®šã§è¡Œãã¨æ€ã„ã¾ã™ã€‚ã§ã¯ã§ã¯ã€‚\n","tags":[{"name":"ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰","ref":"/tags/ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰"}],"showTerminalAside":false},{"title":"ãƒ—ãƒ­ã‚­ã‚·ç’°å¢ƒã§Kubernetesæ§‹ç¯‰ï¼ˆContainerd+Calicoï¼‰","date":"2022-12-27T00:00:00.000Z","ref":"/posts/2022/12/kubernetes-behind-proxy","desc":" åŒæœŸã¨ä¸€ç·’ã«ãƒˆãƒ©ã‚·ãƒ¥ã—ãŸã®ã§ã€ãƒ—ãƒ­ã‚­ã‚·ç’°å¢ƒä¸‹ã§ kubeadm + Containerd + Calico ã® Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è¨˜éŒ²ã‚’æ®‹ã—ã¾ã™ã€‚\n\n## ç’°å¢ƒ\n\n* Ubuntu 22.04\n  * ã‚µãƒ¼ãƒãƒ¼ã¯ãƒ‹ãƒ•ã‚¯ãƒ©ã‚’åˆ©ç”¨ï¼ˆe-medium4 2vCPU/4","draft":false,"content":"\nåŒæœŸã¨ä¸€ç·’ã«ãƒˆãƒ©ã‚·ãƒ¥ã—ãŸã®ã§ã€ãƒ—ãƒ­ã‚­ã‚·ç’°å¢ƒä¸‹ã§ kubeadm + Containerd + Calico ã® Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è¨˜éŒ²ã‚’æ®‹ã—ã¾ã™ã€‚\n\n## ç’°å¢ƒ\n\n* Ubuntu 22.04\n  * ã‚µãƒ¼ãƒãƒ¼ã¯ãƒ‹ãƒ•ã‚¯ãƒ©ã‚’åˆ©ç”¨ï¼ˆe-medium4 2vCPU/4GBï¼‰\n* Kubernetes v1.26.0\n* kubeadm v1.26.0\n* Containerd v1.6.14\n* Calico v3.24.5\n\nã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã€ãƒãƒ¼ãƒ‰1å°ãšã¤ã®æ§‹æˆã¨ã—ã¾ã™ã€‚ãƒ—ãƒ­ã‚­ã‚·ã‚’çµŒç”±ã—ãªã‘ã‚Œã°ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å‡ºã‚‰ã‚Œãªã„ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚\n\n![network](//www.plantuml.com/plantuml/png/SoWkIImgAStDuSehJybCJ5Uevb9Go4ijASylobP8pybFIim12O51KNvfIMgHDP1NYwIee2YpBB4a5QugCIMbABMuMC5MGSdGt4ZFs53FGCz0tz1CoPeBnHo5Q6mg3PLYhQ7AalFpIehoSmfo4lDIOM9v-Icf40VKSZcavgK07Gu0)\n\nãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã® CIDR ã¯ `172.31.0.0/16`ã€ãƒ—ãƒ­ã‚­ã‚·ã¯ `http://172.31.0.1:3128` ã¨ã—ã¦é€²ã‚ã¾ã™ã€‚\n\nService CIDR ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® `10.96.0.0/12` ã‚’ã€Pod Network CIDR ã¯ Calico ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚ã‚‹ `192.168.0.0/16` ã‚’ä½¿ã„ã¾ã™ã€‚\n\nğŸ’¡ ç­†è€…ã®ç’°å¢ƒã§ã¯ã“ã®è¨˜äº‹ã§ç´¹ä»‹ã™ã‚‹å†…å®¹ã§æ§‹ç¯‰ã§ãã¾ã—ãŸãŒã€ç’°å¢ƒã«ã‚ˆã£ã¦çŠ¶æ³ãŒç•°ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãƒ—ãƒ­ã‚­ã‚·é…ä¸‹ã§ã®æ§‹ç¯‰ã«æŒ‘æˆ¦ã™ã‚‹å‰ã«ã€**ã¾ãšã¯ä¼¼ãŸç’°å¢ƒã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒã‚ã‚‹ã‚µãƒ¼ãƒãƒ¼ã§è©¦ã™ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™**ã€‚\n\n## ãƒ—ãƒ­ã‚­ã‚·ã®è¨­å®šãŒå¿…è¦ãªç®‡æ‰€\n\n### ç’°å¢ƒå¤‰æ•°ï¼ˆ`~/.bashrc`ï¼‰\n\n#### ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³\n\n```sh\nexport HTTP_PROXY=http://172.31.0.1:3128\nexport HTTPS_PROXY=http://172.31.0.1:3128\nexport NO_PROXY=localhost,127.0.0.1,172.31.0.0/16,10.96.0.0/12,192.168.0.0/16\n```\n\nã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã§ã¯ `NO_PROXY` ã« Sercice CIDR ã® IP ãƒ¬ãƒ³ã‚¸ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ `10.96.0.0/12`ï¼‰ã¨ Pod Network CIDR ã® IP ãƒ¬ãƒ³ã‚¸ã‚’è¨­å®šã—ã¦ãŠãã“ã¨ã§ `kubeadm init` æ™‚ã® preflight check ã® WARNING ã‚’æŠ‘ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™[^1]ã€‚\n\nåæ˜ ã™ã‚‹ã«ã¯ `source ~/.bashrc` ã—ã¾ã™ã€‚\n\n[^1]: ä»¥å‰ã¯ IP ãƒ¬ãƒ³ã‚¸ã‚’æŒ‡å®šã§ããªã‹ã£ãŸã‚ˆã†ã§ã™ãŒã€ä»Šã¯å•é¡Œãªãä½¿ãˆã¾ã™ã€‚https://github.com/kubernetes/kubeadm/issues/324#issuecomment-331483277\n\n#### ãƒãƒ¼ãƒ‰\n\n```sh\nexport HTTP_PROXY=http://172.31.0.1:3128\nexport HTTPS_PROXY=http://172.31.0.1:3128\nexport NO_PROXY=localhost,127.0.0.1,172.31.0.0/16\n```\n\nãƒãƒ¼ãƒ‰ã§ã¯ `kubeadm init` ã‚’å®Ÿè¡Œã—ãªã„ã®ã§ã“ã‚Œã ã‘ã§ OKã€‚\n\n### `/etc/apt/apt.conf`\n\nå„ç¨®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®ãŸã‚ã«å¿…è¦ã§ã™ã€‚\n\n```\nAcquire::http::proxy \"http://172.31.0.1:3128\";\nAcquire::https::proxy \"http://172.31.0.1:3128\";\n```\n\n### `/etc/systemd/system/containerd.service.d/http-proxy.conf`\n\n```\n[Service]\nEnvironment=\"HTTP_PROXY=http://172.31.0.1:3128\"\nEnvironment=\"HTTPS_PROXY=http://172.31.0.1:3128\"\nEnvironment=\"NO_PROXY=localhost,127.0.0.1,172.31.0.0/16,10.96.0.0/12\"\n```\n\n`NO_PROXY` ã« Pod Network CIDR ã® IP ãƒ¬ãƒ³ã‚¸ã‚‚è¿½åŠ ã—ã‚ˆã†ã‹ã¨æ€ã£ãŸã®ã§ã™ãŒã€ãƒãƒ¼ãƒ‰ã‚’è·¨ã„ã  Pod é–“ã®é€šä¿¡ãªã©è©¦ã—ãŸç¯„å›²ã§ã¯è¿½åŠ ã—ãªãã¦ã‚‚ç•°å¸¸ãŒãªã‹ã£ãŸã®ã§è¿½åŠ ã—ã¦ã„ã¾ã›ã‚“ã€‚  \nç­†è€…ã® Kubernetes ã®çŸ¥è­˜ãŒæµ…ã„ã ã‘ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã€æ¤œè¨¼ä¸è¶³ã§ã—ãŸã‚‰æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨ã‚ã‚ŠãŒãŸã„ã§ã™ã€‚ğŸ™‡\n\nã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ãŸã‚‰ Containerd ã®å†èµ·å‹•ãŒå¿…è¦ã§ã™ã€‚\n\n```sh\nsystemctl daemon-reload\nsystemctl restart containerd\n```\n\n## æ§‹ç¯‰æ‰‹é †\n\nä¸Šè¨˜ã®ãƒ—ãƒ­ã‚­ã‚·è¨­å®šä»¥å¤–ã¯é€šå¸¸ã®æ‰‹é †ã¨åŒã˜ã§ã™ã€‚\n\n* [kubeadmã‚’ä½¿ç”¨ã—ãŸã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ä½œæˆ](https://kubernetes.io/ja/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/)\n* [kubeadmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](https://kubernetes.io/ja/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)\n* [CRIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](https://kubernetes.io/ja/docs/setup/production-environment/container-runtimes/)\n\nUbuntu 22.04 ã§æ§‹ç¯‰ã™ã‚‹éš›ã®æ³¨æ„ç‚¹ã«ã¤ã„ã¦ã¯ [Ubuntu 22.04ã§ã®Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹ç¯‰ï¼ˆContainerdã¨SystemdCgroupï¼‰](/posts/2022/12/kubernetes-ubuntu22.04-cgroup-systemd) ã‚’ã”å‚ç…§ãã ã•ã„ã€‚\n\n```sh\nkubeadm init --pod-network-cidr 192.168.0.0/16\n```\n\n### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®é©ç”¨\n\næ§‹ç¯‰ãŒå®Œäº†ã—ãŸã‚‰ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’é©ç”¨ã—ã¾ã™ã€‚ä»¥ä¸‹ã¯ Calico ã‚’ä½¿ã†å ´åˆã®ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚\n\n```sh\ncurl https://raw.githubusercontent.com/projectcalico/calico/v3.24.5/manifests/calico.yaml -O\nkubectl apply -f calico.yaml\n```\n\n`kubectl -n kube-system get po -w` ã—ã¦ã€1ã¤ã® `calico-kube-controllers` ã¨ãƒãƒ¼ãƒ‰æ•°åˆ†ã® `calico-node` Pod ãŒ Running ãªã‚‰å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚CoreDNS ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹ãƒã‚°ã‚’è¸ã‚“ã ã‚‰ [Kubernetesã§CoreDNSãŒãƒ«ãƒ¼ãƒ—ã—ã¦ã—ã¾ã†å•é¡Œã¸ã®å¯¾å‡¦](/posts/2022/12/kubernetes-coredns-loop) ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚\n\n## å‹•ä½œç¢ºèª\n\nç°¡å˜ãªå‹•ä½œç¢ºèªã‚’ã—ã¦ã¿ã¾ã™ã€‚\n\n```sh\nkubectl create deployment nginx --image=nginx\n```\n\n```sh\nPOD_NAME=$(kubectl get pods -l app=nginx -o jsonpath=\"{.items[0].metadata.name}\")\n```\n\nåˆ¥ã®ã‚·ã‚§ãƒ«ã‚’é–‹ãã€`curl localhost:8080` ã‚’è©¦ã—ã¦ã¿ã¾ã™ã€‚\n\n```sh\nkubectl port-forward $POD_NAME 8080:80\n```\n\nãƒ­ã‚°ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚\n\n```sh\nkubectl logs $POD_NAME\n```\n\nexec ã‚’è©¦ã—ã¾ã™ã€‚\n\n```sh\nkubectl exec -ti $POD_NAME -- nginx -v\n```\n\nNodePort Service ã‚’è©¦ã—ã¾ã™ã€‚\n\n```sh\nkubectl expose deployment nginx --port 80 --type NodePort\n```\n\n```sh\nNODE_PORT=$(kubectl get svc nginx \\\n  --output=jsonpath='{range .spec.ports[0]}{.nodePort}')\n```\n\n```sh\ncurl 127.0.0.1:$NODE_PORT\n```\n\n```sh\nkubectl delete svc nginx\n```\n\næ¬¡ã« Cluster IP Service ã‚’è©¦ã—ã¾ã™ã€‚\n\n```sh\nkubectl expose deployment nginx --port 80 --type ClusterIP\n```\n\nã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æƒ³å®šã—ãŸ Pod ã‚’å»ºã¦ã¾ã™ï¼ˆnginx ã§ã™ãŒï¼‰ã€‚\n\n```sh\nkubectl create deployment client --image=nginx\n```\n\n```sh\nPOD_NAME_CLIENT=$(kubectl get pods -l app=client -o jsonpath=\"{.items[0].metadata.name}\")\n```\n\nPod å†…ã§ `curl nginx` ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚\n\n```sh\nkubectl exec -ti $POD_NAME_CLIENT -- curl nginx\n```\n\n`\u003eWelcome to nginx!` ã® HTML ãŒè¿”ã£ã¦ã“ã‚Œã° OKï¼\n\n## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é›†\n\n### `FailedCreatePodSandBox` - ãƒ›ã‚¹ãƒˆã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ IP ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯\n\n`calico-kube-controllers` ãŒ ContainerCreating ã§æ­¢ã¾ã£ã¦ã—ã¾ã†å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n```\nEvents:\n  Type     Reason                  Age                 From               Message\n  ----     ------                  ----                ----               -------\n  Warning  FailedScheduling        115s                default-scheduler  0/1 nodes are available: 1 node(s) had untolerated taint {node.kubernetes.io/not-ready: }. preemption: 0/1 nodes are available: 1 Preemption is not helpful for scheduling..\n  Normal   Scheduled               104s                default-scheduler  Successfully assigned kube-system/calico-kube-controllers-7bdbfc669-97wdp to controlplane\n  Warning  FailedCreatePodSandBox  103s                kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network for sandbox \"6a029253befac6840d358f8f78b865510bb3874b971fc7241d4ded6b1e92ce2d\": plugin type=\"calico\" failed (add): stat /var/lib/calico/nodename: no such file or directory: check that the calico/node container is running and has mounted /var/lib/calico/\n  Normal   SandboxChanged          16s (x3 over 103s)  kubelet            Pod sandbox changed, it will be killed and re-created.\n```\n\n`stat /var/lib/calico/nodename: no such file or directory: check that the calico/node container is running and has mounted /var/lib/calico/` ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã«ã¯ãƒã‚¦ãƒ³ãƒˆã¯ã§ãã¦ã„ã¾ã—ãŸã€‚\n\nã€Œãƒã‚¦ãƒ³ãƒˆã¯ã§ãã¦ nodenameï¼ˆãƒ›ã‚¹ãƒˆåï¼‰ã¯å–å¾—ã§ãã¦ã„ã‚‹ãŒã€ãƒ—ãƒ­ã‚­ã‚·ã«é˜»ã¾ã‚Œã¦é€šä¿¡ã§ãã¦ã„ãªã„ã®ã§ã¯ï¼Ÿã€ã¨è€ƒãˆã€Containerd ã® NO_PROXY ã®è¨­å®šã«ãƒ›ã‚¹ãƒˆã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã® CIDR ã‚’è¿½è¨˜ã—ãŸã‚‰ `172.31.0.0/16` ãŸã‚‰ã“ã®å•é¡Œã¯è§£æ±ºã—ã¾ã—ãŸã€‚\n\n```\n# vim /etc/systemd/system/containerd.service.d/http-proxy.conf\n```\n\n`172.31.0.0/16` ã‚’è¿½è¨˜ã€‚\n\n```\n[Service]\nEnvironment=\"HTTP_PROXY=http://172.31.0.1:3128\"\nEnvironment=\"HTTPS_PROXY=http://172.31.0.1:3128\"\nEnvironment=\"NO_PROXY=localhost,127.0.0.1,172.31.0.0/16\"\n```\n\n```\n# systemctl daemon-reload\n# systemctl restart containerd\n# kubectl -n kube-system delete po calico-kube-controllers-7bdbfc669-97wdp --force\nWarning: Immediate deletion does not wait for confirmation that the running resource has been terminated. The resource may continue to run on the cluster indefinitely.\npod \"calico-kube-controllers-7bdbfc669-97wdp\" force deleted\n```\n\n### `FailedCreatePodSandBox` - Service ã® IP ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯\n\nçŠ¶æ³ã¯å¤‰ã‚ã£ãŸã‚‚ã®ã®ã€ã“ã¡ã‚‰ã‚‚ `calico-kube-controllers` ãŒ ContainerCreating ã§æ­¢ã¾ã£ã¦ã—ã¾ã†å•é¡Œã§ã™ã€‚\n\n```\nEvents:\n  Type     Reason                  Age                From               Message\n  ----     ------                  ----               ----               -------\n  Normal   Scheduled               3m12s              default-scheduler  Successfully assigned kube-system/calico-kube-controllers-7bdbfc669-9gltp to controlplane\n  Warning  FailedCreatePodSandBox  72s                kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network for sandbox \"68070146a6bd3c3a3044cbe84495c39ef3abafd069f171db2a185c8925aee2d1\": plugin type=\"calico\" failed (add): error getting ClusterInformation: Get \"https://10.96.0.1:443/apis/crd.projectcalico.org/v1/clusterinformations/default\": Service Unavailable\n  Normal   SandboxChanged          12s (x2 over 72s)  kubelet            Pod sandbox changed, it will be killed and re-created.\n```\n\nã“ã¡ã‚‰ã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€šã‚Šãªã®ã§ã€Service CIDR ã‚’ Containerd ã® NO_PROXY ã«è¿½åŠ ã—ã¾ã™ã€‚\n\n```\n# vim /etc/systemd/system/containerd.service.d/http-proxy.conf\n```\n\n`10.96.0.0/12` ã‚’è¿½è¨˜ã€‚\n\n```\n[Service]\nEnvironment=\"HTTP_PROXY=http://172.31.0.1:3128\"\nEnvironment=\"HTTPS_PROXY=http://172.31.0.1:3128\"\nEnvironment=\"NO_PROXY=localhost,127.0.0.1,172.31.0.0/16,10.96.0.0/12\"\n```\n\nå…ˆã»ã©ã¨åŒã˜ã‚ˆã†ã« daemon-reload, restart containerd, Pod ã®å¼·åˆ¶å‰Šé™¤ã‚’ã—ã¾ã™ã€‚\n\n## ã¾ã¨ã‚\n\næœ€å¾Œã¾ã§ãŠèª­ã¿ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\n\nãƒ—ãƒ­ã‚­ã‚·ç’°å¢ƒã§ã® Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹ç¯‰ã¯ã€é€šå¸¸ã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹ç¯‰ã‚ˆã‚Šã‚‚ Kubernetes ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å‘¨ã‚Šã®çŸ¥è­˜ãŒè¦æ±‚ã•ã‚Œã‚‹ã®ã§å°‘ã—ãƒãƒ¼ãƒ‰ãƒ«ãŒä¸ŠãŒã‚Šã¾ã™ã€‚\n\nå†’é ­ã«ã‚‚æ›¸ãã¾ã—ãŸãŒã€ã¾ãšã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«ç›´æ¥ç¹‹ãŒã‚‹ç’°å¢ƒã§æ§‹ç¯‰ã‚’è©¦ã—ã¦ã¿ã¦ã€ãã®å¾Œã«ãƒ—ãƒ­ã‚­ã‚·ç’°å¢ƒã§ã®æ§‹ç¯‰ã‚’å®Ÿæ–½ã™ã‚‹ã¨åŸå› ã®åˆ‡ã‚Šåˆ†ã‘ãŒã‚¹ãƒ ãƒ¼ã‚ºã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚\n\n## å‚è€ƒæ–‡çŒ®\n\n* [Installing kubernetes behind a corporate proxy](https://medium.com/@vivekanand.poojari/installing-kubernetes-behind-a-corporate-proxy-bc5582e43fb8)\n* [kubeadmã‚’ä½¿ç”¨ã—ãŸã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ä½œæˆ](https://kubernetes.io/ja/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/)\n* [kubeadmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](https://kubernetes.io/ja/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)\n* [CRIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](https://kubernetes.io/ja/docs/setup/production-environment/container-runtimes/)\n* [Install Calico networking and network policy for on-premises deployments](https://projectcalico.docs.tigera.io/getting-started/kubernetes/self-managed-onprem/onpremises)\n","tags":[{"name":"Kubernetes","ref":"/tags/kubernetes"}],"showTerminalAside":false},{"title":"Ubuntu 22.04ã§ã®Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹ç¯‰ï¼ˆContainerdã¨SystemdCgroupï¼‰","date":"2022-12-26T00:00:00.000Z","ref":"/posts/2022/12/kubernetes-ubuntu22.04-cgroup-systemd","desc":" å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰‹é †é€šã‚Šæµã—è¾¼ã‚ã°å‰²ã¨ç°¡å˜ã«æ§‹ç¯‰ã§ãã‚‹ Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§ã™ãŒã€Ubuntu 22.04 ã«ãªã£ã¦ã‹ã‚‰å°‘ã—æ‰‹ã‚’å…¥ã‚Œã‚‹å¿…è¦ãŒå‡ºã¦ããŸã®ã§å·®åˆ†ã‚’ç´¹ä»‹ã—ã¦ãŠãã¾ã™ã€‚\n\n**2022-02-16 æ›´æ–°ï¼šKubernetes ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ—¥æœ¬èªç‰ˆãŒæ›´æ–°ã•ã‚Œã¦ã„ãŸ","draft":false,"content":"\nå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰‹é †é€šã‚Šæµã—è¾¼ã‚ã°å‰²ã¨ç°¡å˜ã«æ§‹ç¯‰ã§ãã‚‹ Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§ã™ãŒã€Ubuntu 22.04 ã«ãªã£ã¦ã‹ã‚‰å°‘ã—æ‰‹ã‚’å…¥ã‚Œã‚‹å¿…è¦ãŒå‡ºã¦ããŸã®ã§å·®åˆ†ã‚’ç´¹ä»‹ã—ã¦ãŠãã¾ã™ã€‚\n\n**2022-02-16 æ›´æ–°ï¼šKubernetes ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ—¥æœ¬èªç‰ˆãŒæ›´æ–°ã•ã‚Œã¦ã„ãŸã®ã§ãƒªãƒ©ã‚¤ãƒˆã—ã¾ã—ãŸã€‚**\n\n## ç’°å¢ƒ\n\n* Ubuntu 22.04\n* Kubernetes v1.26.0\n* kubeadm v1.26.0\n* Containerd v1.6.16\n\n## ä½•ãŒå¤‰ã‚ã£ãŸï¼Ÿ\n\nUbuntu 21.10 ä»¥é™ã€Cgroup v2 ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãªã‚Šã¾ã—ãŸ[^1]ã€‚  \nCgroup ã«ã¤ã„ã¦è©³ã—ãçŸ¥ã‚ŠãŸã„æ–¹ã¯ [ç¬¬37å› Linuxã‚«ãƒ¼ãƒãƒ«ã®ã‚³ãƒ³ãƒ†ãƒŠæ©Ÿèƒ½ â€• cgroupã®æ”¹è‰¯ç‰ˆcgroup v2ï¼»1ï¼½](https://gihyo.jp/admin/serial/01/linux_containers/0037)ã®è¨˜äº‹ãŒã‚ã‹ã‚Šã‚„ã™ã„ã®ã§èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚\n\nKubernetes ã«ãŠã„ã¦ã¯ã€Œcgroupãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã€ã‚’ kubelet ã®è¨­å®šã§é¸æŠã—ã¾ã™ã€‚`cgroupfs` ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ãŒ v1 ã«ã€`systemd` ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ãŒ v2 ã«å¯¾å¿œã—ã¦ã„ã‚‹ã¨è€ƒãˆã‚Œã°å•é¡Œãªã„ã¨æ€ã„ã¾ã™ã€‚\n\n[^1]: https://wiki.ubuntu.com/UbuntuWeeklyNewsletter/Issue697\n\n## ä½•ã‚‚ã—ãªã„ã¨ã©ã†ãªã‚‹ï¼Ÿ\n\nã‚³ãƒ³ãƒ†ãƒŠã¯èµ·å‹•ã—ã¾ã™ãŒã€ä½¿ã„ç‰©ã«ãªã‚‰ãªã„ãã‚‰ã„ä¸å®‰å®šã«ãªã‚Šå†ä½œæˆã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆkube-apiserverï¼‰ã‚‚ä¾‹å¤–ã§ãªã„ã®ã§ã€kubectl ã‚’å©ã„ã¦ã‚‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ã“ãªã‹ã£ãŸã‚Šã€‚ã€‚\n\n## è§£æ±ºæ–¹æ³•\n\nCgroup v1 ã«æˆ»ã™ã€ã¨ã„ã†ã‚„ã‚Šæ–¹ã‚‚ã‚ã‚‹ã¨ã¯æ€ã†ã®ã§ã™ãŒã€systemd ã‚’ Cgroup ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¨ã—ã¦è¨­å®šã™ã‚Œã° Cgroup v2 ã®ã¾ã¾ã§ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ã€æ–°ã—ãã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹ã®ã§ã‚ã‚Œã°ãã†ã™ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚\n\nkubelet ã«é–¢ã—ã¦ã¯ kubeadm v1.22 ä»¥é™ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ `systemd` ã‚’é¸æŠã™ã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§[^2]ã€ç‰¹ã«æ°—ã«ã™ã‚‹å¿…è¦ã¯ãªã„ã§ã™ã€‚\n\n[^2]: å‚™è€ƒ: v1.22 ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ KubeletConfiguration ã® cgroupDriver ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®šã—ã¦ã„ãªã„å ´åˆã€kubeadm ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ systemd ã‚’è¨­å®šã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚  \nhttps://kubernetes.io/ja/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/#kubelet-cgroup%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%83%BC%E3%81%AE%E8%A8%AD%E5%AE%9A\n\n**Containerd ã‚’ CRI ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹å ´åˆã€Containerd å´ã§ã‚‚ Cgroup ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚’é¸æŠã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆä»Šå›ã®è¨˜äº‹ã®ãƒŸã‚½ï¼‰ã€‚**\n\nLinux ã®å ´åˆã€Containerd ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ `/etc/containerd/config.toml` ã«ã‚ã‚Šã¾ã™ã€‚å­˜åœ¨ã—ãªã„å ´åˆã¯ã€ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã§ä½œæˆã—ã¾ã™ã€‚\n\n```sh\nmkdir -p /etc/containerd\ncontainerd config default | sudo tee /etc/containerd/config.toml\n```\n\n[Kubernetesãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://kubernetes.io/ja/docs/setup/production-environment/container-runtimes/#systemd-cgroup%E3%83%89%E3%83%A9%E3%82%A4%E3%83%90%E3%83%BC%E3%82%92%E6%A7%8B%E6%88%90%E3%81%99%E3%82%8B)ã«è¨˜è¼‰ã®ã‚ˆã†ã« `runc` ãŒ `systemd` Cgroup ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚’ä½¿ã†ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚\n\n```toml\n[plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc]\n  ...\n  [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc.options]\n    SystemdCgroup = true\n```\n\nä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä¿®æ­£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\n\n```sh\nsed -i 's/SystemdCgroup \\= false/SystemdCgroup \\= true/g' /etc/containerd/config.toml\n```\n\nContainerd ã‚’å†èµ·å‹•ã—ã¾ã™ã€‚\n\n```sh\nsystemctl restart containerd\n```\n\nä»–ã®æ‰‹é †ã¯å‚è€ƒæ–‡çŒ®ã®ä¸Š3ã¤ã®ãƒªãƒ³ã‚¯å…ˆã«è¨˜è¼‰ã®æ‰‹é †ã‚’å®Ÿæ–½ã™ã‚Œã° OK ã§ã™ã€‚\n\nãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³è¨­å®šå¾Œã€CoreDNS ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹ãƒã‚°ã‚’è¸ã‚“ã ã‚‰ [Kubernetesã§CoreDNSãŒãƒ«ãƒ¼ãƒ—ã—ã¦ã—ã¾ã†å•é¡Œã¸ã®å¯¾å‡¦](/posts/2022/12/kubernetes-coredns-loop) ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚\n\n## å‚è€ƒæ–‡çŒ®\n\n* [kubeadmã‚’ä½¿ç”¨ã—ãŸã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ä½œæˆ](https://kubernetes.io/ja/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/)\n* [kubeadmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](https://kubernetes.io/ja/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)\n* [ã‚³ãƒ³ãƒ†ãƒŠãƒ©ãƒ³ã‚¿ã‚¤ãƒ ](https://kubernetes.io/ja/docs/setup/production-environment/container-runtimes/)\n* [cgroupãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®è¨­å®š](https://kubernetes.io/ja/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/)\n* [Ubuntu 22.04ã§kubeadmã§Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒå‹•ã‹ãªã„ï¼Ÿ](https://tech.virtualtech.jp/entry/2022/06/08/115030)\n","tags":[{"name":"Kubernetes","ref":"/tags/kubernetes"}],"showTerminalAside":false},{"title":"Kubernetesã§CoreDNSãŒãƒ«ãƒ¼ãƒ—ã—ã¦ã—ã¾ã†å•é¡Œã¸ã®å¯¾å‡¦","date":"2022-12-24T00:00:00.000Z","ref":"/posts/2022/12/kubernetes-coredns-loop","desc":" 1å¹´å‰ã«ã‚‚ Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’è‡ªåŠ›ã§çµ„ã‚“ã§ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ã¦ã¿ã‚‹ã€The Hard Wayã€‘ã®è¨˜äº‹ã®ä¸­ã§è»½ãè§£èª¬ã—ãŸãƒã‚¿ã§ã™ã€‚\n\n## ç’°å¢ƒ\n\n* Ubuntu 22","draft":false,"content":"\n1å¹´å‰ã«ã‚‚ [Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’è‡ªåŠ›ã§çµ„ã‚“ã§ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ã¦ã¿ã‚‹ã€The Hard Wayã€‘](https://qiita.com/SogoK/items/192d475c20e07dd38984)ã®è¨˜äº‹ã®ä¸­ã§è»½ãè§£èª¬ã—ãŸãƒã‚¿ã§ã™ã€‚\n\n## ç’°å¢ƒ\n\n* Ubuntu 22.04\n* Kubernetes v1.26.0\n* kubeadm v1.26.0\n\n## å•é¡Œ\n\nKubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã§åå‰è§£æ±ºã«ä½¿ã‚ã‚Œã‚‹ CoreDNS ã® Pod ãŒ `CrashLoopBackOff` ã«ãªã£ã¦ã—ã¾ã„å†èµ·å‹•ã‚’ç¹°ã‚Šè¿”ã™å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚\n\n```\n# kubectl -n kube-system logs coredns-787d4945fb-6kb5t\n.:53\n[INFO] plugin/reload: Running configuration SHA512 = 591cf328cccc12bc490481273e738df59329c62c0b729d94e8b61db9961c2fa5f046dd37f1cf888b953814040d180f52594972691cd6ff41be96639138a43908\nCoreDNS-1.9.3\nlinux/amd64, go1.18.2, 45b0a11\n[FATAL] plugin/loop: Loop (127.0.0.1:34129 -\u003e :53) detected for zone \".\", see https://coredns.io/plugins/loop#troubleshooting. Query: \"HINFO 1033981844954998931.6641498229839068582.\"\n```\n\n## åŸå› \n\nhttps://coredns.io/plugins/loop/#troubleshooting\n\nUbuntu 18.04 ä»¥é™ãªã©ã®æœ€è¿‘ã®ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ã® DNS ã‚¹ã‚¿ãƒ–ãƒªã‚¾ãƒ«ãƒ (systemd-resolved) ãŒä½¿ã‚ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã“ã¨ãŒåŸå› ã§ã™ã€‚Kubelet ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« `/var/lib/kubelet/config.yaml` ã‚’è¦‹ã‚‹ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚\n\n```conf\nresolvConf: /run/systemd/resolve/resolv.conf\n```\n\nã“ã“ã§æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ« `/run/systemd/resolve/resolv.conf` ãŒ kubelet ã«ã‚ˆã£ã¦ã€CoreDNS ã‚³ãƒ³ãƒ†ãƒŠã«æ¸¡ã•ã‚Œã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ä¸­èº«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚\n\n```conf\n# This is /run/systemd/resolve/resolv.conf managed by man:systemd-resolved(8).\n# Do not edit.\n#\n# This file might be symlinked as /etc/resolv.conf. If you're looking at\n# /etc/resolv.conf and seeing this text, you have followed the symlink.\n#\n# This is a dynamic resolv.conf file for connecting local clients directly to\n# all known uplink DNS servers. This file lists all configured search domains.\n#\n# Third party programs should typically not access this file directly, but only\n# through the symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a\n# different way, replace this symlink by a static file or a different symlink.\n#\n# See man:systemd-resolved.service(8) for details about the supported modes of\n# operation for /etc/resolv.conf.\n\nnameserver 127.0.0.1\nsearch .\n```\n\nOS ä¸Šã§ã¯ã‚¹ã‚¿ãƒ–ãƒªã‚¾ãƒ«ãƒãŒã„ã‚‹ã®ã§ `127.0.0.1` ã‚’ DNS ã¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ãŒã€CoreDNS ã®ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã¯ãã®ã‚³ãƒ³ãƒ†ãƒŠè‡ªèº«ã‚’æŒ‡ã™ã“ã¨ã«ãªã‚Šã¾ã™ã€‚çµæœçš„ã«ãƒ«ãƒ¼ãƒ—ã—ã¦ã—ã¾ã„ã€ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚\n\n## è§£æ±ºæ–¹æ³•\n\nåŸå› ã¯ä¸Šè¨˜ã®é€šã‚Šãªã®ã§ã€`127.0.0.1` ã§ã¯ãªã„å¤–éƒ¨ã® DNS ã‚µãƒ¼ãƒãƒ¼ã‚’è¨­å®šã™ã‚Œã°è§£æ±ºã§ãã¾ã™ã€‚\n\n`/run/systemd/resolve/resolv.conf` ã¯ systemd-resolved ã®ç®¡ç†ä¸‹ã«ã‚ã‚‹è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã®ã§ã€å¤§å…ƒã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« `/etc/systemd/resolved.conf` ã‚’ä¿®æ­£ã—ã€systemd-resolved ã‚’å†èµ·å‹•ã™ã‚‹ã“ã¨ã§ `/run/systemd/resolve/resolv.conf` ã‚’å†ç”Ÿæˆã•ã›ã¾ã™ã€‚\n\nãã®å¾Œæ–°ã—ã„ `resolv.conf` ã®å†…å®¹ã‚’åæ˜ ã•ã›ã‚‹ãŸã‚ã« kubelet ã¨ Container runtime (containerd) ã‚’å†èµ·å‹•ã—ã¾ã™ã€‚\n\n```\nNAMESERVER_ADDRESSES=8.8.8.8\nsed -i \"s/^DNS=127.0.0.1$/DNS=${NAMESERVER_ADDRESSES}/\" /etc/systemd/resolved.conf\nsystemctl restart systemd-resolved\nsystemctl restart kubelet\nsystemctl restart containerd\n```\n\nCoreDNS ãŒç„¡äº‹ Running ã«ãªã‚Œã° OK ã§ã™ã€‚\n\n```\nroot@controlplane:~# kubectl -n kube-system get po -w\nNAME                                      READY   STATUS             RESTARTS     AGE\ncalico-kube-controllers-7bdbfc669-w4xxt   1/1     Running            0            2m57s\ncalico-node-2f2qc                         1/1     Running            0            15m\ncoredns-787d4945fb-6kb5t                  0/1     CrashLoopBackOff   5 (7s ago)   16m\ncoredns-787d4945fb-q5bhz                  0/1     CrashLoopBackOff   5 (7s ago)   16m\netcd-controlplane                         1/1     Running            0            16m\nkube-apiserver-controlplane               1/1     Running            0            16m\nkube-controller-manager-controlplane      1/1     Running            0            16m\nkube-proxy-692c8                          1/1     Running            0            16m\nkube-scheduler-controlplane               1/1     Running            0            16m\ncoredns-787d4945fb-6kb5t                  0/1     Running            6 (19s ago)   16m\ncoredns-787d4945fb-6kb5t                  1/1     Running            6 (19s ago)   16m\ncoredns-787d4945fb-q5bhz                  0/1     Running            6 (25s ago)   16m\ncoredns-787d4945fb-q5bhz                  1/1     Running            6 (25s ago)   16m\n```\n","tags":[{"name":"Kubernetes","ref":"/tags/kubernetes"}],"showTerminalAside":false},{"title":"VS Code Serverã§ãƒªãƒ¢ãƒ¼ãƒˆãƒ›ã‚¹ãƒˆã®ã‚³ãƒ³ãƒ†ãƒŠä¸Šé–‹ç™ºç’°å¢ƒã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹","date":"2022-12-17T00:00:00.000Z","ref":"/posts/2022/12/vscode-server-devcontainer","desc":" ä»Šå›ã¯ã€Œã¼ãã®ã‹ã‚“ãŒãˆãŸã•ã„ãã‚‡ã†ã®ã‹ã„ã¯ã¤ã‹ã‚“ãã‚‡ã†ã€ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚\n\nVS Code Server ã‚’ä½¿ã„ã€ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼ä¸Šã§ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦å‹•ã‹ã—ã¦ã„ã‚‹é–‹ç™ºç’°å¢ƒã«ç›´","draft":false,"content":"\nä»Šå›ã¯ã€Œã¼ãã®ã‹ã‚“ãŒãˆãŸã•ã„ãã‚‡ã†ã®ã‹ã„ã¯ã¤ã‹ã‚“ãã‚‡ã†ã€ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚\n\n[VS Code Server](https://code.visualstudio.com/docs/remote/vscode-server) ã‚’ä½¿ã„ã€ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼ä¸Šã§ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦å‹•ã‹ã—ã¦ã„ã‚‹é–‹ç™ºç’°å¢ƒã«ç›´æ¥ä¹—ã‚Šè¾¼ã‚“ã§ã¿ã‚ˆã†ã€ã¨ã„ã†ã‚¢ã‚¤ãƒ‡ã‚¢ã§ã™ã€‚\n\nSSH ã‚‚ãƒãƒ¼ãƒˆé–‹æ”¾ã‚‚ä¸è¦ãªã®ã§ã¨ã¦ã‚‚ãŠæ‰‹è»½ã§ã™ã€‚\n\n## ç’°å¢ƒ\n\nã‚µãƒ¼ãƒãƒ¼\n* Raspberry Pi 400 (Ubuntu 22.04.1, arm64)\n  * Docker \u0026 Docker Compose ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨\n\nã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ\n* VS Code 1.74.1\n  * [Remote - Tunnels](https://marketplace.visualstudio.com/items?itemName=ms-vscode.remote-server) æ‹¡å¼µæ©Ÿèƒ½ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨\n\næ‰•ã„å‡ºã•ã‚ŒãŸ URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚Œã°ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã§ã‚‚ä½¿ãˆã‚‹ã®ã§ã€iPad ãªã©ã®ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«ã§ã‚‚ä½¿ãˆã¾ã™ã­ã€‚\n\n## ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰\n\nhttps://github.com/SogoKato/simple-devenv-py\n\n## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£\n\n![architecture](//www.plantuml.com/plantuml/png/dLAnJiCm4Dtz5QSmPu2vieegPb1JmNnoZjJ2EKU-Isc5-k-ene5q849ikPVttZq_UosAISS-64nkxtjKWfiTkJt74BiJLCyDR69B5Q202vvOORNIRqBTqi4xijQOH4wHkq1GRQcFIl3OLF1X06P_Df4LFLFwCfocJBiYbhtGK3eKjkJFGWNu9V1BJ6yoe2DuE2gn-CXPJKUzlOuk9r7gQucl-ew9hFstyTrVZCzcmRo9OtBqKxNaUKcnezHxnW1FAJeI8Sb2BV2IT3ioU-xWVXY2TwZJIN0Op2NdsPXorRKjhPjIVbtRacsEJ4jdM3PR4xUNj_K9)\n\n### ãªãœã‚³ãƒ³ãƒ†ãƒŠã§å‹•ã‹ã™ã‹ï¼Ÿ\n\næœ€è¿‘ã¯ãƒ›ã‚¹ãƒˆä¸Šã«è¨€èªã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã®ã§ã¯ãªãã€ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ã£ã¦é–‹ç™ºç’°å¢ƒã‚’æ•´ãˆã‚‹ã“ã¨ã®æ–¹ãŒå¤šã„ã¨æ€ã„ã¾ã™ã€‚\n\nã‚‚ã¡ã‚ã‚“ä»®æƒ³ç’°å¢ƒã‚’ä½¿ã†ã¨ã„ã†æ‰‹æ®µã‚‚ã‚ã‚Šã¾ã™ãŒã€å¯æ¬æ€§ã§ã¯ã‚³ãƒ³ãƒ†ãƒŠã®æ–¹ãŒä¸Šãªã®ã§ã€ç§ã¯å¤§æŠµã®å ´åˆã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ã£ãŸé–‹ç™ºç’°å¢ƒã‚’ä½œã‚Šã€VS Code ã® dev container ã‚’ä½¿ã£ã¦ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ä½œæ¥­ã‚’ã—ã¾ã™ã€‚\n\nã—ã‹ã—ãªãŒã‚‰ã€ä»Šå›å°å…¥ã™ã‚‹ VS Code Server ã§ã¯2022å¹´12æœˆç¾åœ¨ã¾ã  dev container ã‚’ã¯ã˜ã‚ã¨ã™ã‚‹ãƒªãƒ¢ãƒ¼ãƒˆé–‹ç™ºã®æ‹¡å¼µæ©Ÿèƒ½ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\n\u003e Can I use the Remote Development Extensions or a dev container with the VS Code Server?  \n\u003e Not at this time.\n\nhttps://code.visualstudio.com/docs/remote/vscode-server#_can-i-use-the-remote-development-extensions-or-a-dev-container-with-the-vs-code-server\n\nãªã®ã§ã€ãƒ›ã‚¹ãƒˆä¸Šã« VS Code Server ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã¨ã“ã‚ã§å®Ÿéš›ã®é–‹ç™ºç’°å¢ƒã«å…¥ã‚Šè¾¼ã‚€ã“ã¨ãŒã§ããªã„ã®ã§ã€ã§ã‚ã‚Œã°é–‹ç™ºç’°å¢ƒã®ã‚³ãƒ³ãƒ†ãƒŠä¸Šã« VS Code Server ã‚’å…¥ã‚Œã¦ç›´æ¥ä¹—ã‚Šè¾¼ã‚‚ã†ã€ã¨ã„ã†ã®ãŒä»Šå›ã®è¶£æ—¨ã«ãªã‚Šã¾ã™ã€‚\n\n## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—\n\n```sh\ngit clone https://github.com/SogoKato/simple-devenv-py.git\n```\n\nDockerfile ã®æŠœç²‹ã§ã™ã€‚ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰æ™‚ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰\u0026å®Ÿè¡Œã—ã¦ VS Code Server ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™ã€‚\n\nCMD ã« `code-server` ã‚³ãƒãƒ³ãƒ‰ã‚’æ›¸ã„ã¦ã€ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã« VS Code Server ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚\n\n`--accept-server-license-terms` ã¨ `--random-name` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¸è¦ã«ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã€é †ã«[ãƒ©ã‚¤ã‚»ãƒ³ã‚¹](https://code.visualstudio.com/license/server)ã¸ã®åŒæ„ã¨ãƒ©ãƒ³ãƒ€ãƒ ãªå‘½åã‚’ã—ã¦ã„ã¾ã™ã€‚  \n`--server-data-dir` ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ã®ãŸã‚ VS Code Server ã®ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜é ˜åŸŸã‚’ãƒã‚¤ãƒ³ãƒ‰ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«ã—ã¦ãŠãã¾ã™ã€‚[^1]\n\n[^1]: ãŸã ã—ã€ç­†è€…ãŒä¸€åº¦ã‚³ãƒ³ãƒ†ãƒŠã‚’å†ä½œæˆã—ã¦ã¿ãŸã¨ã“ã‚ GitHub ã®å†èªè¨¼ã¯ä¸è¦ã§ã—ãŸãŒã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸæ‹¡å¼µæ©Ÿèƒ½ãªã©ã¯æ¶ˆãˆã¦ã—ã¾ã£ã¦ã„ã¾ã—ãŸï¼ˆèª¿æŸ»ä¸­ï¼‰ã€‚\n\n```dockerfile\nRUN wget -O- https://aka.ms/install-vscode-server/setup.sh | sh\n\nCMD [\"code-server\", \"serve\", \"--accept-server-license-terms\", \"--random-name\", \"--server-data-dir\", \"/workspace/.vscode-server\"]\n```\n\nã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã—ã‚‡ã†ã€‚\n\n```sh\ndocker compose build\n```\n\ndocker-compose.yml ã§ã™ã€‚ãªã‚“ã®å¤‰å“²ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚\n\n```yml\nversion: '3'\nservices:\n  app:\n    build:\n      context: ./\n      dockerfile: Dockerfile\n    volumes:\n      - type: bind\n        source: ./\n        target: /workspace\n```\n\nèµ·å‹•ã—ã¾ã™ã€‚\n\n```sh\ndocker compose up -d\n```\n\nãƒ­ã‚°ã‚’è¦‹ã‚‹ã¨ GitHub ã¸ã®ãƒ­ã‚°ã‚¤ãƒ³ã‚’æ±‚ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚\n\n```sh\ndocker compose logs -f\n```\n\n```\nsimple-devenv-py-app-1  | To grant access to the server, please log into https://github.com/login/device and use code xxxx-xxxx\n```\n\nè¨€ã‚ã‚ŒãŸé€šã‚Š https://github.com/login/device ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¾ã—ã‚‡ã†ã€‚\n\nãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã™ã‚‹ã¨ãƒˆãƒ³ãƒãƒ«ãŒä½œæˆã•ã‚Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ã‚¯ã‚»ã‚¹ç”¨ã® URL ãŒæ‰•ã„å‡ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚\n\n```\nsimple-devenv-py-app-1  | [2022-12-17 09:06:03] info Creating tunnel with the name: dazzling-antshrike\nsimple-devenv-py-app-1  | \nsimple-devenv-py-app-1  | Open this link in your browser https://insiders.vscode.dev/+ms-vscode.remote-server/dazzling-antshrike/workspace\n```\n\n## æ¥ç¶šï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰\n\nå¥½ããªãƒ–ãƒ©ã‚¦ã‚¶ã§æ‰•ã„å‡ºã•ã‚ŒãŸãƒªãƒ³ã‚¯ã‚’é–‹ãã ã‘ã§ã™ã€‚ç°¡å˜ã€‚\n\n## æ¥ç¶šï¼ˆVS Codeï¼‰\n\n[Remote - Tunnels](https://marketplace.visualstudio.com/items?itemName=ms-vscode.remote-server) æ‹¡å¼µæ©Ÿèƒ½ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€GitHub ã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒˆãƒ³ãƒãƒ«ã®ä¸€è¦§ã‚’ç¢ºèªã§ãã¾ã™ã€‚\n\n![Tunnels](/images/posts/2022/12/vsc_remote_tunnels.png)\n\nãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒªãƒ¢ãƒ¼ãƒˆã«æ¥ç¶šã—ã¾ã™ã€‚\n\n## éŠã‚“ã§ã¿ã‚‹\n\nã‚ã¨ã¯ã„ã¤ã‚‚é€šã‚Š VS Code ã®è¨­å®šã‚’è¡Œãªã£ã¦ã„ã‘ã° OK ã§ã™ã€‚\n\n![editor](/images/posts/2022/12/vsc_remote_editor.png)\n\nã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã¿ã¾ã™ã€‚\n\n![run](/images/posts/2022/12/vsc_remote_run.png)\n\nãƒãƒ¼ãƒˆãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æ¤œçŸ¥ã™ã‚‹ã¨ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œæ™‚ã¨åŒã˜ã‚ˆã†ã«é€šçŸ¥ãŒå‡ºã¦ãã¾ã™ã€‚  \nã€Œãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã§é–‹ãã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒãƒ¼ãƒˆãŒã‚¯ãƒ©ã‚¦ãƒ‰çµŒç”±ã§ãƒãƒ¼ãƒˆãŒè»¢é€ã•ã‚Œã¦ã€èµ·å‹•ã—ãŸã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå±Šãã¾ã™ã€‚\n\n![port forwarding](/images/posts/2022/12/vsc_port_forwarding.png)\n\nã¡ãªã¿ã«ã“ã® URL ã¯ GitHub æœªèªè¨¼ã®çŠ¶æ…‹ã§ã¯è¦‹ã‚‹ã“ã¨ãŒã§ããªã„ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹ï¼‰ã®ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«ã‚‚å®‰å¿ƒã§ã™ã€‚\n\n## ä½¿ã„å¿ƒåœ°ã¯ï¼Ÿ\n\nè‹¥å¹²ãƒ©ã‚°ãŒã‚ã‚‹ã‚ˆã†ã«æ„Ÿã˜ã¾ã™ã€‚\n\nä»Šå›æ¤œè¨¼ã«ä½¿ã£ãŸ Raspberry Pi ã®ã‚¹ãƒšãƒƒã‚¯ã®å•é¡Œãªã®ã‹ï¼ˆMicroSD ã‹ã‚‰ SSD ã«ã—ãŸã‚‰å¤‰ã‚ã‚‹ã‹ã‚‚ï¼Ÿï¼‰ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã®å•é¡Œãªã®ã‹ã€åŸå› ã¯ã¾ã åˆ‡ã‚Šåˆ†ã‘ã§ãã¦ã„ã¾ã›ã‚“ã€‚\n\nã¾ãŸã€ã¡ã‚‡ã„ã¡ã‚‡ã„æ¥ç¶šãŒåˆ‡ã‚Œã¦ `Connecting to hogehoge...` ã¨å‡ºã¦ãã‚‹ã®ã§ã™ãŒã€ã“ã‚Œã¯ãŠãã‚‰ãã†ã¡ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã®ã›ã„ãªæ°—ãŒã—ã¾ã™ã€‚ã€‚\n\n### 2022/12/18 è¿½è¨˜\n\nMicro SD ã‹ã‚‰ SSD ã«å¤‰ãˆã¦ã¿ãŸã‚‰ä½“æ„ŸãŒå¤§ããæ”¹å–„ã•ã‚Œã€ã‚¹ãƒˆãƒ¬ã‚¹ã‚’æ„Ÿã˜ãªã„ç¨‹åº¦ã«å¿«é©ã«ãªã‚Šã¾ã—ãŸã€‚SSD ã—ã‹å‹ãŸã‚“ã€‚\n\n## ã¾ã¨ã‚\n\nä»Šã¾ã§ã“ã‚Œã¨åŒæ§˜ã®ã“ã¨ã‚’å®Ÿç¾ã™ã‚‹é¸æŠè‚¢ã¨ã—ã¦ [code-server](https://coder.com/docs/code-server/latest) ãŒã‚ã‚Šã¾ã—ãŸãŒã€Pylance ãªã©ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã§ã¯åˆ©ç”¨ã§ããªã„æ‹¡å¼µæ©Ÿèƒ½ãŒã‚ã£ãŸã‚Šã—ã¦ã€ãƒ­ãƒ¼ã‚«ãƒ«ã® VSCode ã¨åŒã˜ç’°å¢ƒã‚’æ•´ãˆã‚‹ã“ã¨ã¯å›°é›£ã§ã—ãŸã€‚\n\nMicrosoft è¬¹è£½ã® VS Code Server ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸã“ã¨ã«ã‚ˆã‚Šã€ã‚ˆã‚Šãƒ­ãƒ¼ã‚«ãƒ«ã® VS Code ã«è¿‘ã„ç’°å¢ƒã‚’ä½œã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚  \nã‚µãƒ¼ãƒãƒ¼å´ã®ãƒãƒ¼ãƒˆã‚’é–‹ã‘ã‚‹å¿…è¦ãŒãªã„ã®ã‚‚ãƒ¡ãƒªãƒƒãƒˆã§ã™ã€‚ä¼æ¥­ã®ãƒãƒªã‚·ãƒ¼æ¬¡ç¬¬ã§ã™ãŒã€ä¼šç¤¾ã§ã“ã‚Œã‚’ä½¿ãˆãŸã‚‰å¬‰ã—ã„ã¨ã„ã†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚å¤šã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚\n\nãã‚Œã§ã¯ã€ãƒãƒƒãƒ”ãƒ¼ãªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒ©ã‚¤ãƒ•ã‚’ï¼\n\n## å‚è€ƒæ–‡çŒ®\n\n* [Visual Studio Code Server](https://code.visualstudio.com/docs/remote/vscode-server)\n","tags":[{"name":"VS Code","ref":"/tags/vs-code"},{"name":"é–‹ç™ºç’°å¢ƒ","ref":"/tags/é–‹ç™ºç’°å¢ƒ"}],"showTerminalAside":false},{"title":"ã‚ˆãã‚ã‚‹SPA+APIæ§‹æˆã§ã®OpenID Connectã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…","date":"2022-12-02T00:00:00.000Z","ref":"/posts/2022/12/openid-connect-fastapi","desc":" ã“ã®è¨˜äº‹ã¯ãƒ‹ãƒ•ã‚¯ãƒ©ç­‰ã‚’æä¾›ã—ã¦ã„ã‚‹ã€å¯Œå£«é€šã‚¯ãƒ©ã‚¦ãƒ‰ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º Advent Calendar 2022ã®2æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚\n\næ˜¨æ—¥ã¯ [@nt","draft":false,"content":"\nã“ã®è¨˜äº‹ã¯[ãƒ‹ãƒ•ã‚¯ãƒ©](https://www.nifcloud.com/)ç­‰ã‚’æä¾›ã—ã¦ã„ã‚‹ã€[å¯Œå£«é€šã‚¯ãƒ©ã‚¦ãƒ‰ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º Advent Calendar 2022](https://qiita.com/advent-calendar/2022/fjct)ã®2æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚\n\næ˜¨æ—¥ã¯ [@ntoofu](https://qiita.com/ntoofu) ã•ã‚“ã® [ãƒ‘ã‚±ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ã‹ã‚‰Kubernetes APIã®TLSé€šä¿¡ã‚’è§£æã™ã‚‹](https://ntoofu.github.io/blog/post/sniffing-kube-apiserver-tls/) ã§ã—ãŸã€‚  \nç§ã¯ TLS ãªæ™‚ç‚¹ã§ãƒ‘ã‚±ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’è«¦ã‚ã¦ã—ã¾ã„ãã†ã§ã™ãŒ Linux ã®ä¾¿åˆ©ãªä»•çµ„ã¿ã¨æ°—åˆãŒã‚ã‚Œã° TLS 1.3 ã®ãƒ‘ã‚±ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ã‚‚å¯èƒ½ã ã¨ã‚ã‹ã‚Šã€ã¨ã¦ã‚‚æœ‰ç›Šã§ã—ãŸã€‚ç§ã‚‚ã‚®ãƒ¼ã‚¯ãªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ç›®æŒ‡ã—ã¦é ‘å¼µã‚Šã¾ã™ã€‚\n\nä»Šæ—¥ã¯ OpenID Connect ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã©ã†å®Ÿè£…ã™ã‚‹ã‹ã«ã¤ã„ã¦æ¤œè¨ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚\n\nFastAPI + SPA (Vue.js) ã§ã¡ã‚‡ã£ã¨ã—ãŸç¤¾å†…ãƒ„ãƒ¼ãƒ«ã‚’é–‹ç™ºã—ãŸæ™‚ã«ç¤¾å†…ã®èªå¯åŸºç›¤ã¨ã® OpenID Connect ã‚’ç”¨ã„ãŸãƒ­ã‚°ã‚¤ãƒ³é€£æºæ©Ÿèƒ½ã‚’ä½œã‚ŠãŸã‹ã£ãŸã®ã§ã™ãŒã€å®Ÿè£…ã®ãŸã‚ã®æƒ…å ±ãŒå°‘ãªã‹ã£ãŸã®ã§è¨˜äº‹ã«æ®‹ã—ã¦ãŠããŸã„ã¨æ€ã£ãŸã®ãŒãã£ã‹ã‘ã§ã™ã€‚ã€Œã“ã‚ŒãŒãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã ï¼ã€ã¨ã„ã†ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€1ã¤ã®å®Ÿè·µä¾‹ã¨ã—ã¦ã©ãªãŸã‹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚\n\n## å¯¾è±¡èª­è€…\n\n* OpenID Connect ã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã‚¢ãƒ—ãƒªã‚’ä½œã‚ŠãŸã„ã‘ã©å®Ÿè£…æ–¹æ³•ãŒã‚ã‹ã‚‰ãªã„äºº\n  * è‰²ã‚“ãªãƒ•ãƒ­ãƒ¼ãŒã‚ã‚‹ã£ã½ã„ã‘ã©ã©ã‚Œã‚’ä½¿ã†ã¹ãï¼Ÿ\n  * ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼Ÿ ID ãƒˆãƒ¼ã‚¯ãƒ³ï¼Ÿ\n  * ã‚µãƒ¼ãƒãƒ¼ã§ä½•ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ä½•ã™ã‚‹ã®ï¼Ÿ\n* Python ã® FastAPI ã§ä½œã£ãŸã‚µãƒ¼ãƒãƒ¼ã§ã®ãƒ­ã‚°ã‚¤ãƒ³ã€œãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã€œãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã®å®Ÿè£…ä¾‹ãŒçŸ¥ã‚ŠãŸã„äºº\n\n## OpenID Connect ã¨ã¯\n\n**OpenID Connect ã¯ OAuth 2.0 ã‚’æ‹¡å¼µã™ã‚‹å½¢ã§ç­–å®šã•ã‚ŒãŸã€èªè¨¼ãƒ»èªå¯ã®ãŸã‚ã®ä»•çµ„ã¿**ã§ã™ã€‚OAuth 2.0 ã¯èªå¯ã‚’è¡Œã†ã“ã¨ã‚’ç›®çš„ã¨ã—ãŸä»•æ§˜ã§ã™ã€‚ã™ã§ã«10å¹´ã‚‚å‰ã®è©±ã§ã™ãŒã€OAuth ã‚’èªè¨¼ã«ã‚‚ä½¿ã£ã¦ã—ã¾ã†ã€ŒSNS ãƒ­ã‚°ã‚¤ãƒ³ã€ã®æ‰‹æ³•ã¯ã€Œ[å˜ãªã‚‹ OAuth 2.0 ã‚’èªè¨¼ã«ä½¿ã†ã¨ã€è»ŠãŒé€šã‚Œã‚‹ã»ã©ã®ã©ã§ã‹ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ãƒ»ãƒ›ãƒ¼ãƒ«ãŒã§ãã‚‹](https://www.sakimura.org/2012/02/1487/)ã€ã¨æŒ‡æ‘˜ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚OpenID Connect ã¯ OAuth 2.0 ã‚’æ‹¡å¼µã—ã¦èªè¨¼ã®ç”¨é€”ã«ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ãŸã€ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ã¨ãªã£ã¦ã„ã¾ã™ã€‚\n\nä¸‹å›³ã¯èªè¨¼ãƒ»èªå¯ã®æµã‚Œã®ä¸€ä¾‹ã§ã™ï¼ˆresponse_type=id_token ã®å ´åˆï¼‰ã€‚\n\n![overview](//www.plantuml.com/plantuml/png/NP6zIiDG5CVt-nINJkbGgBg9I0SNfrlo1g7DKD0q9EckzpW4KHfGS6aH9KWeIeMYK1FmOGv9u-GhUEvDH9lbSCBv_J_2xVc1vGMJqnDc3OAnnn6U43AKxpIvvVE9Rtjyx0rfxdIPI-neC78j9-0jb6yAXHkKQswO_NPB2Sn-ZUysSE7Qpl4HmXt22qA4CaOuuuQeTU9NjzTbEhHpgBpskSBbgyPN23EKdsgHIuG50j3222DOABXSN9T9HYS5o8IQ8OILtq67a8RVvZRzcZyYf7bqLLnCgy_o8Td47vMewPlIaa-NJEX8y__fMOVDTRcreVuqHCXqqLMRcN-2xLCHpqXUtrLces8HHldb_NTspdgsCwI7-W40)\n\nOP: OpenID Provider; ID ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡Œè€…  \nRP: Relying Party; OP ã«èªè¨¼æ©Ÿèƒ½ã‚’æ—¢å­˜ã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒª\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µãƒ¼ãƒ“ã‚¹ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ã‚µãƒ¼ãƒ“ã‚¹ã¯ã¾ãš OpenID ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆOPï¼‰ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚OP ã¯æœªèªè¨¼ã§ã‚ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’å‡ºã—ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼ã—ã¦ã‹ã‚‰ã€ã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾ã—ã¦èªå¯ã‚’è¡Œã†ã‹ã©ã†ã‹åŒæ„ã‚’å–ã‚Šã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒæ„ã™ã‚‹ã¨ã€OP ã¯ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å«ã‚ã¦ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ URL ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹ã¯å—ã‘å–ã£ãŸ ID ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£è¦ã® OP ã‹ã‚‰ã®ã‚‚ã®ã§ã‚ã‚‹ã“ã¨ã‚’ OP ã®å…¬é–‹éµã‚’ä½¿ç”¨ã—ã¦æ¤œè¨¼ã—ã¾ã™ï¼ˆãã®ã»ã‹ã«ã‚‚è¤‡æ•°ã®æ¤œè¨¼ã‚’ã™ã‚‹ï¼‰ã€‚æ¤œè¨¼ãŒæ­£å¸¸ã«çµ‚äº†ã™ã‚Œã°ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒ­ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã¯å®Œäº†ã§ã™ã€‚\n\n## ã§ã€ã©ã†ã‚„ã£ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã®ï¼Ÿ\n\n### ã¾ãšã¯çµè«–\n\n![code flow](//www.plantuml.com/plantuml/png/RPBFIW9H5CRtzoakhdGXJNzM4Q7GnfL3FS6aBeHI6KTewTmROQ4e94YWX28XKXdq1t8a7-OuEgvwXRwPKN2apULSlz_vpdUk4oiQccwKBY-ObZBoEYVvH792uWidrugyLCpeFA-dSUugx3n_nKCaFbr4tfFuvk5JDH9Y1NXaKzc2bZFucHfVDUmf0I6k9bR2li8okJI7Mm089GkPNEA4P8la2ya6YJx9CWydCSBDabHN_GSAyt95ZxrfXzpbnPl7lvDiavYwXHYH79AKA1Wuu6w6RTniaVb3vWE31WHJG3Z3cZEOkEqm4GDiIhBY3psA0jaoMJIjPQT7qh8RrVbrtRywtS6YF_QRjdqj57PznF2Zdsf3U_QcTM2B8ko39B0NjDj8C6PGN9RDsRGRC2NHyrQm_1N0uGhh7RppnjMPDktQX--zRWqIytuRwLpY_sUtNwkpyStwdRsbWy2yqh3l7dyd9elXpySNzmS0)\n\n* API ã‚µãƒ¼ãƒãƒ¼ã§èªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„ ID ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã‚’è¡Œã†\n  * ä»Šå›ã¯æ¡ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®éƒ½åˆã§ Authorization Code Flow ã‚’ä½¿ã„ã¾ã™\n* ID ãƒˆãƒ¼ã‚¯ãƒ³ã¯ Cookie ã§ç®¡ç†\n  * localStorage ã§ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šå•é¡ŒãŒã‚ã‚‹\n  * ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã§ã¯åˆ©ä¾¿æ€§ã«æ¬ ã‘ã‚‹\n  * Cookie ã®å±æ€§\n    * HttpOnly: true\n      * JavaScript ã‹ã‚‰ã¯è§¦ã‚‰ã›ãªã„\n    * SameSite: Lax\n      * ä»–ã‚µã‚¤ãƒˆã¸ã® Cookie é€ä¿¡ã‚’æœ€ä½é™ã«ã™ã‚‹\n      * Strict ã«ã™ã‚‹ã¨ OP ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ãŸéš›ã«ç ´æ£„ã•ã‚Œã¦ã—ã¾ã†ãŸã‚ Lax\n    * Secure: true\n      * HTTPS ã§ã®ã¿ Cookie ã‚’é€ä¿¡ã™ã‚‹\n\n### SPA ãªã‚‰å…¨éƒ¨ SPA ã«ã‚„ã‚‰ã›ã‚Œã°ã„ã„ã‚“ã˜ã‚ƒãªã„ã®ï¼Ÿ\n\nã¯ã„ã€Implicit Flow ã‚’ä½¿ã†ã“ã¨ã§å®Ÿç¾ã§ãã¾ã™ã€‚\n\nå†’é ­ã®ã€Œè»ŠãŒé€šã‚Œã‚‹ã»ã©ã®ã©ã§ã‹ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ãƒ»ãƒ›ãƒ¼ãƒ«ã€ã®è©±ã¯ OAuth 2.0 ã‚’ Implicit Flow ã§ä½¿ç”¨ã—ãŸæ™‚ã®è©±ã§ã™ãŒã€OpenID Connect ã¯ãã‚Œã‚’è¸ã¾ãˆã¦ç­–å®šã•ã‚ŒãŸä»•æ§˜ãªã®ã§ã€OpenID Connect ã«ãŠã„ã¦ Implicit Flow ã‚’ä½¿ã†ã“ã¨ã«å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\n\nImplicit Flow ã‚’ä½¿ã†å ´åˆã€ä¸‹å›³ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼ˆresponse_type=id_tokenï¼‰ã€‚\n\n![implicit flow](//www.plantuml.com/plantuml/png/TP9FIm916CRlyoa6JteGjZydYL3euicbFi6c7eHIMLVegFD6I1WA1LsKC2H4AWCfq5tmmxpkkfxw2hqpxWO3THbcz_dDypppxcORZcKxpSiBPXMTciqHNX0y55-qSgl1cusopMjsYTOzWvtNhdW2nQT4u1x5WYTFpLI2rScZKgpKhQh3pynST63Vq8IScO-40uELgoLERXgGADJBrVm9mYF26q8VnHYXnPC5Yf1T2cPq_j1WgbVwMALbkEJ5X-Bd20CKAxaHCuGf0j264KSuMH0TJk_2YKUQ9CI4he7GsJaUfIMY6suUtEtm6S7r-ztWkhTx34UJpNWPrz1zNThulHcZbxyDO-rLfGrLlKLINhQZvarLvwcufPnKXklYjjLUhqQCfF-8O3oW24dyFHZ_lRjUtiGPghaE19s-V_lqxRLPbZuF_HC_)\n\nä¸Šè¨˜ã®ãƒ•ãƒ­ãƒ¼ã§ã¯ã€SPA å´ã§ Client Secret ã‚’ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ClientSecret ãŒå¿…è¦ã«ãªã‚‹ã®ã¯ä¸»ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆèªå¯ã‚³ãƒ¼ãƒ‰ã‚„ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ã¦ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚„ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ã‚„ã¤ï¼‰ã‚’ä½¿ã†æ™‚ãªã®ã§ã€response_type=id_token ã§ OIDC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹å ´åˆã«ã¯å›°ã‚Šã¾ã›ã‚“ã€‚response_type=id_token ã§å•é¡ŒãŒãªã„ã‹ã¨ã„ã†è¦³ç‚¹ã§ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†æ™‚ã«ã ã‘ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒæ‰‹ã«å…¥ã‚Œã°å•é¡Œãªã„å ´åˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒæœ€æ–°ã§ã‚ã‚‹å¿…è¦ãŒãªã„å ´åˆï¼‰ã«ã¯äº‹è¶³ã‚Šã‚‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚\n\nSPA ã§ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦‹ã›ãŸããªã„æ©Ÿå¯†æƒ…å ±ã‚’æ‰±ã†ã®ã¯ã»ã¨ã‚“ã©ä¸å¯èƒ½ã ã¨æ€ã„ã¾ã™ã®ã§ Client Secret ã‚’ SPA ã«æŒãŸã›ã‚‹å¿…è¦ãŒãªã„ã®ã¯å¬‰ã—ã„ä»•æ§˜ã§ã™ã­ã€‚**Implicit Flow ã§ã¯ CSRF å¯¾ç­–ã®ãŸã‚ã« nonce ã®æ¤œè¨¼ãŒå¿…é ˆ**ãªã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚\n\n### ID ãƒˆãƒ¼ã‚¯ãƒ³ã©ã“ç½®ãå•é¡Œ\n\nãŸã ã€Client Secret ã‚’ SPA ã§ç®¡ç†ã™ã‚‹å¿…è¦ãŒãªã„ã‹ã‚‰ã¨ã„ã£ã¦ SPA ä¸Šã§ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨ã€ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã©ã“ã«ä¿ç®¡ã™ã‚‹ã‹ã€ã¨ã„ã†å•é¡ŒãŒå‡ºã¦ãã¾ã™ã€‚ã“ã‚Œã¯ OIDC ã®ã‚¹ã‚³ãƒ¼ãƒ—å¤–ã®è­°è«–ã§ã™ãŒã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…ã«ã‚ãŸã£ã¦å¿…ãšæ¤œè¨ã™ã‚‹ã¹ãç‚¹ã ã¨æ€ã†ã®ã§ã€ä»Šå›ã¯ã“ã‚Œã‚‚è€ƒãˆã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚\n\nID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç½®ãå ´æ‰€ã¨ã—ã¦è€ƒãˆã‚‰ã‚Œã‚‹å€™è£œã‚’æ¯”è¼ƒã—ã¦ã¿ã¾ã™ã€‚\n\n||Cookie (HttpOnly: true, Secure: true, SameSite: Lax)|ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒª|localStorage|\n|---|---|---|---|\n|ä¿æŒæœŸé–“|**è¨­å®šã•ã‚ŒãŸæœ‰åŠ¹æœŸé™ã¾ã§**|ãƒšãƒ¼ã‚¸ãŒãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã¾ã§|**ãªã—**|\n|CSRF å¯¾ç­–|**æ›´æ–°ç³»ã¯é˜²ã’ã‚‹**|**ä»–ã® JS ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯åŸºæœ¬çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„**|ã©ã® JS ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚å–å¾—å¯|\n|JS ã§ã® ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—|ã§ããªã„ [^1]|**ã§ãã‚‹**|**ã§ãã‚‹**|\n\n[^1]: ã‚µãƒ¼ãƒãƒ¼å´ã§ Cookie ã® ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã—ãŸä¸Šã§ã€JSON ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿”å´ã™ã‚‹ API ã‚’ä½œã£ãŸã‚Šã™ã‚Œã°å¯èƒ½ã§ã™ã€‚\n\nã©ã‚Œã‚‚ä¸€é•·ä¸€çŸ­ãªæ„ŸãŒã‚ã‚Šã¾ã™ãŒã€ã“ã®ä¸­ã§ä¸€ç•ªå®‰å…¨æ€§ã¨åˆ©ä¾¿æ€§ã®ãƒãƒ©ãƒ³ã‚¹ãŒã„ã„ã®ã¯ Cookie (HttpOnly: true, Secure: true, SameSite: Lax) ã ã¨æ€ã£ãŸã®ã§ã€ä»Šå›ã¯ Cookie ã« ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç½®ãã‚ˆã†ã«ã—ã¾ã—ãŸã€‚\n\nãªãŠã€Auth0 ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã¯ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã« ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¤ã¤ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é•·ãä¿ãŸã›ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã‚ˆã†ã§ã™ã€‚  \n[SPAèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã¯localStorageã§ã‚‚Cookieã§ã‚‚ãªã„ã€Auth0æ–¹å¼ã¯ã„ã„ã­ã¨ã„ã†ãŠè©±](https://mizumotok.hatenablog.jp/entry/2021/08/04/114431)\n\n## FastAPI ã§ OpenID Connect ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹\n\nä»¥ä¸Šã§ã€ä¸€é€šã‚Šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…æ–¹é‡ã«ã¤ã„ã¦è­°è«–ãŒã§ããŸã¨æ€ã†ã®ã§ã€ã“ã“ã‹ã‚‰ã¯å…·ä½“çš„ãª Python (FastAPI) ã§ã®å®Ÿè£…ã«ç§»ã‚ŠãŸã„ã¨æ€ã„ã¾ã™ã€‚  \nä»Šå›ä½¿ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒª Authlib ã§ã¯ FastAPI ã®ä»–ã« Starlette, Flask ã‚„ Django ã® Oauth Client ã¨ãã®å®Ÿè£…ä¾‹ã‚‚å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚‰ã‚’å‚è€ƒã«ã™ã‚Œã°ä»–ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚‚å‰²ã¨ç°¡å˜ã«å®Ÿè£…ã§ãã‚‹ã®ã§ã¯ãªã„ã‹ãªã¨æ€ã„ã¾ã™ã€‚\n\n### ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰\n\nhttps://github.com/SogoKato/oidc-fastapi-authlib\n\nå‹•ã‹ã—ã¦ã¿ãŸã„æ–¹ã¯ README ã«å¾“ã£ã¦èµ·å‹•ã—ã¦ã¿ã¦ãã ã•ã„ã€‚\n\n### å¿…è¦ãªã‚‚ã®\n\nå‰æº–å‚™ã¨ã—ã¦ OpenID ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ç”¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã©ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ã§ã‚‚å¤§ä¸ˆå¤«ã§ã™ãŒã€ã¾ã æŒã£ã¦ã„ãªã„å ´åˆã¯ [Auth0](https://auth0.com/jp) ã«ç™»éŒ²ã—ã¦ã¿ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚å€‹äººã§ä½¿ã†ã‚ˆã†ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆé‡ã§ã‚ã‚Œã°ç„¡æ–™ã§ä½¿ãˆã¾ã™ï¼ˆ2022å¹´12æœˆç¾åœ¨ï¼‰ã€‚\n\nç™»éŒ²å¾Œã€Application ã‚’ä½œæˆã—ãŸã‚‰ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URI (Allowed Callback URLs) ã« `http://localhost:8080/api/auth` ã‚’å…¥ã‚Œã¦ãŠãã¾ã™ã€‚ã¾ãŸã€ä¸‹è¨˜ã®æƒ…å ±ã‚’æ¢ã—ã¦ãƒ¡ãƒ¢ã£ã¦ãŠãã¾ã—ã‚‡ã†ã€‚\n\n* Client ID\n* Client Secret\n* OpenID Configuration Endpoint\n  * ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ OIDC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å¿…è¦ãªæƒ…å ±ã‚’è¿”ã—ã¦ãã‚Œã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ\n  * é€šå¸¸ `https://example.com/.well-known/openid-configuration`\n\n### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£\n\n![architecture](//www.plantuml.com/plantuml/png/SoWkIImgAStDuKfCBialKdZSlEnnyvx7JTk0f49YiK9fSMeHLs9HSaPcRc99ge9oIMfoHbv-JdvwfK9UUcPUXOAD3L15MMPogfqT3dME0Pv4g5Bo2F7rqNSE3jRt2bO2sGnqM4bcCefEa6CKTEsWDbi17RlgSTFwnqqh7ZVjVDpSmGKHrzMr0za9bDTFBCX4249D18bpEQJcfG0z3G00)\n\nä»Šå›ã¯ Cookie ã® SameSite å±æ€§ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€SPA ã¨ API ã¨ã§åŒã˜ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’ä½¿ã„ã€ãƒ‘ã‚¹ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŒ¯ã‚Šåˆ†ã‘ã¾ã™ã€‚\n\n### è§£èª¬\n\n#### ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®å‡¦ç†\n\n```python\napp = FastAPI()\napp.add_middleware(SessionMiddleware, secret_key=\"MYSTRONGKEY\", https_only=True)\n```\n\nFastAPI ã®åˆæœŸåŒ–ã¨ Cookie ã®ãŸã‚ã® SessionMiddleware ã®è¿½åŠ ã‚’ã—ã¾ã™ã€‚\n\n```python\noauth = OAuth()\noauth.register(\n    name=\"auth0\",\n    server_metadata_url=\"https://example.com/.well-known/openid-configuration\",\n    client_id=\"ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID\",\n    client_secret=\"ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ\",\n    client_kwargs={\"scope\": \"openid profile\"},\n)\n```\n\nAuthlib ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã‚Šã¾ã™ã€‚scope ã« `openid` ã¨å…¥ã‚Œã¦ãŠãã“ã¨ã§ Authorization Code Flow ã®æ™‚ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ ID ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ‰‹ã«å…¥ã‚Šã¾ã™ã€‚\n\n```python\n@app.get(\"/api/login\")\nasync def login(request: Request):\n    redirect_uri = request.url_for(\"auth\")\n    return await oauth.auth0.authorize_redirect(request, redirect_uri)\n```\n\nèªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã“ã“ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ `http://localhost:8080/api/auth` ã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URI ã¨ã—ãŸèªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™ï¼ˆOpenID ãƒ—ãƒ­ãƒã‚¤ãƒ€ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ï¼‰ã€‚\n\nã¡ãªã¿ã«ã“ã‚“ãª URL ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ã€‚state ã¨ nonce ãŒã‚ã‚‹ã“ã¨ã‚‚ç¢ºèªã§ãã¾ã™ã­ã€‚\n\n```\nhttps://example.com/authorize\n  ?response_type=code\n  \u0026client_id=ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID\n  \u0026redirect_uri=http%3A%2F%2Flocalhost%3A8080%2Fapi%2Fauth\n  \u0026scope=openid+profile\n  \u0026state=PGO5TxTujESoXuLlfzYTWZsioK5Up5\n  \u0026nonce=HfyA3eugosoOuieiTGRZ\n```\n\n![OP login](/images/posts/2022/12/oidc_op_login.png)\n\nãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã™ã‚‹ã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URI ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã€æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå‘¼ã°ã‚Œã¾ã™ã€‚\n\n```python\n@app.get(\"/api/auth\")\nasync def auth(request: Request):\n    try:\n        token = await oauth.auth0.authorize_access_token(request)\n    except OAuthError:\n        logger.exception(\"An error occurred while verifying authorization response.\")\n        raise UnauthenticatedError()\n    userinfo = token.get(\"userinfo\")\n    # userinfoã®claims(subã‚„nameãªã©)ã‚’ä½¿ã£ã¦DBã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã™ã‚‹å‡¦ç†ãŒã“ã“ã«ãã¾ã™.\n    request.session[\"id_token\"] = token.get(\"id_token\")\n    return RedirectResponse(url=\"/\")\n```\n\n`authorize_access_token` ã§èªå¯ã‚³ãƒ¼ãƒ‰ã¨ state ã‚’ä½¿ã£ã¦ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€ID ãƒˆãƒ¼ã‚¯ãƒ³ã¨ nonce ã‚’æ¤œè¨¼ã™ã‚‹ã¨ã“ã‚ã¾ã§ã‚„ã£ã¦ãã‚Œã¾ã™ï¼ˆæ¥½ã¡ã‚“ï¼‰ã€‚  \nãã®å¾Œã¯è‡ªåˆ†ã®å¥½ããªã‚ˆã†ã«å‡¦ç†ã‚’ã—ã¦ OK ã§ã™ã€‚sub ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ã¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã¾ã  DB ã«ç™»éŒ²ã•ã‚Œã¦ã„ãªã‘ã‚Œã° insert ã™ã‚‹ã¨ã‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ãŒå¤‰ã‚ã£ã¦ãŸã‚‰æ›´æ–°ã™ã‚‹ã¨ã‹ã€ãã†ã„ã†å‡¦ç†ãŒæ¥ã‚‹ã®ã‹ãªã¨æ€ã„ã¾ã™ã€‚\n\næœ€å¾Œã«ã€Cookie ã« ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚»ãƒƒãƒˆã—ã¦ `/` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã¯å®Œäº†ã§ã™ã€‚\n\n#### ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®å‡¦ç†\n\nãƒ­ã‚°ã‚¤ãƒ³å¾Œã¯ JS å´ã§ fetch ã‚„ axios ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã™ã‚‹ã¨ã€Cookie ã‚‚è‡ªå‹•çš„ã«é€ä¿¡ã•ã‚Œã¾ã™ã€‚ãªã®ã§ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã—ã‹ä½¿ã‚ã›ãŸããªã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã¯ã€Depends ã‚’ä½¿ã£ã¦ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚\n\n```python\n@app.get(\"/api/items\")\nasync def list_items(user: User = Depends(verify_user)):\n    logger.info(f\"Successful log in: user_id={user.id} name={user.name}\")\n    return {\n        \"items\": [\n            {\"name\": \"Teddy bear\", \"icon\": \"ğŸ§¸\", \"price\": 99},\n            {\"name\": \"Apple\", \"icon\": \"ğŸ\", \"price\": 2},\n            {\"name\": \"Sushi\", \"icon\": \"ğŸ£\", \"price\": 200},\n            {\"name\": \"Bento\", \"icon\": \"ğŸ±\", \"price\": 50},\n        ]\n    }\n```\n\n`verify_user` é–¢æ•°ã§ Cookie ã‹ã‚‰ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚\n\n```python\nasync def verify_user(request: Request):\n    id_token = request.session.get(\"id_token\")\n    if id_token is None:\n        raise UnauthenticatedError()\n    decoded_jwt = await verify_token(id_token=id_token)\n    # DBã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹å‡¦ç†ãŒã“ã“ã«ãã¾ã™.\n    # user = user_repo.select_by_user_id(user_id=user_id)\n    return user\n```\n\n`verify_token` ãŒ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã™ã‚‹é–¢æ•°ã§ã™ã€‚\n\n```python\nasync def verify_token(id_token: str):\n    jwks = await oauth.auth0.fetch_jwk_set()\n    try:\n        decoded_jwt = jwt.decode(s=id_token, key=jwks)\n    except Exception:\n        logger.exception(\"An error occurred while decoding jwt.\")\n        raise UnauthenticatedError()\n    metadata = await oauth.auth0.load_server_metadata()\n    if decoded_jwt[\"iss\"] != metadata[\"issuer\"]:\n        raise UnauthenticatedError()\n    if decoded_jwt[\"aud\"] != settings.oidc_client_id:\n        raise UnauthenticatedError()\n    exp = datetime.fromtimestamp(decoded_jwt[\"exp\"])\n    if exp \u003c datetime.now():\n        raise UnauthenticatedError()\n    return decoded_jwt\n```\n\nID ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ã¨ã—ã¦æœ€ä½é™å¿…è¦ãªã®ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼ˆAuthorization Code Flow ã®å ´åˆï¼‰ã€‚\n\n1. JWK Setï¼ˆOP ã®å…¬é–‹éµï¼‰ã‚’ä½¿ç”¨ã—ã¦ JWT ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã™ã‚‹\n2. iss ã‚¯ãƒ¬ãƒ¼ãƒ ï¼ˆIssuer Identifier; ç™ºè¡Œè€…ï¼‰ã‚’æ¤œè¨¼ã™ã‚‹\n3. aud ã‚¯ãƒ¬ãƒ¼ãƒ ï¼ˆAudience(s); èª°ã«å¯¾ã—ã¦ç™ºè¡Œã—ãŸã‹ = Client IDï¼‰ã‚’æ¤œè¨¼ã™ã‚‹\n4. exp ã‚¯ãƒ¬ãƒ¼ãƒ ï¼ˆExpiration time; æœ‰åŠ¹æœŸé™ï¼‰ã‚’æ¤œè¨¼ã™ã‚‹\n\nä»¥ä¸ŠãŒå®Œäº†ã™ã‚Œã°åŸºæœ¬çš„ãª OIDC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…ã¯å®Œäº†ã§ã™ğŸ‰\n\n![log in](/images/posts/2022/12/oidc_log_in.gif)\n\n## æœ€å¾Œã«\n\nã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿï¼Ÿ\n\nä¸€è¦‹è¤‡é›‘ãã†ãª OpenID Connect ã§ã™ãŒã€ä¸€ã¤ãšã¤ç´è§£ã„ã¦ã¿ã‚‹ã¨æ„å¤–ã¨ç°¡å˜ã«å®Ÿè£…ã§ãã‚‹ã‚ˆã†ã«ä»•æ§˜ãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚è‡ªåˆ†ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é ‘å¼µã£ã¦ç®¡ç†ã™ã‚‹ã‚ˆã‚Šã‚‚ã“ã†ã„ã†ã¨ã“ã‚ã¯ä¿¡é ¼ã§ãã‚‹ OpenID ãƒ—ãƒ­ãƒã‚¤ãƒ€ã«ä»»ã›ã¦ã—ã¾ã£ãŸæ–¹ãŒæ¥½ã§ã™ã—ã€ä½•ã‚ˆã‚Šã‚‚å®‰å…¨ã§ã™ã‚ˆã­ã€‚\n\nãœã²çš†ã•ã‚“ã‚‚ Web ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œã‚‹æ™‚ã«ã¯æ´»ç”¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚\n\nã“ã®è¨˜äº‹ã¯[å¯Œå£«é€šã‚¯ãƒ©ã‚¦ãƒ‰ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º Advent Calendar 2022](https://qiita.com/advent-calendar/2022/fjct)ã®2æ—¥ç›®ã®è¨˜äº‹ã§ã—ãŸã€‚\n\næ˜æ—¥ã¯ [@Syuparn](https://qiita.com/Syuparn) ã•ã‚“ãŒ SQL ã®ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦æ›¸ã„ã¦ãã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚  \nSQL ã®ãƒ†ã‚¹ãƒˆã£ã¦ã‚ã¾ã‚Šã‚„ã£ã¦ãªã‹ã£ãŸã‚Šã™ã‚‹ã®ã§ã€ä»–ã®äººãŒã©ã®ã‚ˆã†ã«è€ƒãˆã¦å®Ÿæ–½ã—ã¦ã„ã‚‹ã®ã‹æ°—ã«ãªã‚Šã¾ã™ã€‚ãã‚Œã§ã¯ã€æ˜æ—¥ã®è¨˜äº‹ã‚‚ãŠæ¥½ã—ã¿ã«ï¼\n\nï¼ˆğŸ‘‡ã“ã®è¨˜äº‹ãŒã‚ˆã‹ã£ãŸã‚‰ã„ã„ã­ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼ï¼‰\n\n## å‚è€ƒæ–‡çŒ®\n\n* [OpenID Connect Basic Client Implementer's Guide 1.0 - draft 42](https://openid.net/specs/openid-connect-basic-1_0.html)\n* [OpenID Connect Implicit Client Implementer's Guide 1.0 - draft 25](https://openid.net/specs/openid-connect-implicit-1_0.html)\n* [Google login for FastAPI](https://blog.authlib.org/2020/fastapi-google-login)\n* [ä¸€ç•ªåˆ†ã‹ã‚Šã‚„ã™ã„ OpenID Connect ã®èª¬æ˜](https://qiita.com/TakahikoKawasaki/items/498ca08bbfcc341691fe)\n* [IDãƒˆãƒ¼ã‚¯ãƒ³ãŒåˆ†ã‹ã‚Œã° OpenID Connect ãŒåˆ†ã‹ã‚‹](https://qiita.com/TakahikoKawasaki/items/8f0e422c7edd2d220e06)\n* [OpenID Connect å…¨ãƒ•ãƒ­ãƒ¼è§£èª¬](https://qiita.com/TakahikoKawasaki/items/4ee9b55db9f7ef352b47)\n* [OAuth 2.0/OpenID Connectã®2ã¤ã®ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½¿ã„ã¿ã¡](https://qiita.com/wadahiro/items/ad36c7932c6627149873)\n* [å˜ãªã‚‹ OAuth 2.0 ã‚’èªè¨¼ã«ä½¿ã†ã¨ã€è»ŠãŒé€šã‚Œã‚‹ã»ã©ã®ã©ã§ã‹ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ãƒ»ãƒ›ãƒ¼ãƒ«ãŒã§ãã‚‹](https://www.sakimura.org/2012/02/1487/)\n* [OIDCã®Implicit Flowã§ClientSecretã‚’ä½¿ã‚ãšã«IDé€£æºã™ã‚‹](https://zenn.dev/ritou/articles/a)\n* [SPAèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã¯localStorageã§ã‚‚Cookieã§ã‚‚ãªã„ã€Auth0æ–¹å¼ã¯ã„ã„ã­ã¨ã„ã†ãŠè©±](https://mizumotok.hatenablog.jp/entry/2021/08/04/114431)\n* [Goã§OpenID Connectã®Clientã‚’å®Ÿè£…ã™ã‚‹ï¼ˆå®Ÿè£…ç·¨ï¼‰](https://times.hrbrain.co.jp/entry/go-openid-connect-implement)\n","tags":[{"name":"OpenID Connect","ref":"/tags/openid-connect"},{"name":"èªè¨¼/èªå¯","ref":"/tags/èªè¨¼-èªå¯"},{"name":"SPA","ref":"/tags/spa"},{"name":"Python","ref":"/tags/python"},{"name":"FastAPI","ref":"/tags/fastapi"}],"showTerminalAside":false},{"title":"GitLab CIã®rulesã¨workflowã‚’ç†è§£ã™ã‚‹","date":"2022-11-17T00:00:00.000Z","ref":"/posts/2022/11/gitlab-rules-workflow","desc":" GitLab CI ã® rules ã‚’ä½¿ã£ã¦ Dockerfile ãªã©ã®ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´æ™‚ã®ã¿ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å›ã—ã¦ã€ãã‚Œä»¥å¤–ã®æ™‚ã«ã¯æ—¢å­˜ã® Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ CI ã‚’å®Ÿè¡Œã™ã‚‹ã€ã¨ã„ã†çµ„ã¿æ–¹ã‚’ã—ãŸã‹ã£ãŸã®ã§ã™ãŒã€æ›¸ãæ–¹ã«çµæ§‹æ‰‹é–“å–ã£ãŸã®ã§ãƒ¡ãƒ¢ã€‚","draft":false,"content":"\nGitLab CI ã® rules ã‚’ä½¿ã£ã¦ Dockerfile ãªã©ã®ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´æ™‚ã®ã¿ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å›ã—ã¦ã€ãã‚Œä»¥å¤–ã®æ™‚ã«ã¯æ—¢å­˜ã® Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ CI ã‚’å®Ÿè¡Œã™ã‚‹ã€ã¨ã„ã†çµ„ã¿æ–¹ã‚’ã—ãŸã‹ã£ãŸã®ã§ã™ãŒã€æ›¸ãæ–¹ã«çµæ§‹æ‰‹é–“å–ã£ãŸã®ã§ãƒ¡ãƒ¢ã€‚\n\nç’°å¢ƒ: GitLab.com 15.6.0-pre\n\n## rules ã¨ã¯\n\nhttps://docs.gitlab.com/ee/ci/yaml/#rules\n\nãã‚Œãã‚Œã®ã‚¸ãƒ§ãƒ–ã«ã¤ã„ã¦ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«è¿½åŠ ã™ã‚‹ã‹ã—ãªã„ã‹ã®æ¡ä»¶ã‚’è¨˜è¿°ã™ã‚‹ã‚‚ã®ã§ã™ã€‚\n\nrules ã§ã¯ä¸‹è¨˜ã®æ¡ä»¶ãŒæŒ‡å®šã§ãã¾ã™ã€‚\n\n* `if`\n* `changes`\n* `exists`\n* `allow_failure`\n* `variables`\n* `when`\n\nãã‚Œãã‚Œã®æ¡ä»¶ã®è©³ç´°ã«ã¤ã„ã¦ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚\n\nrules ã¯ [only/except](https://docs.gitlab.com/ee/ci/yaml/#only--except) ã‚’ç½®ãæ›ãˆã‚‹ã‚‚ã®ãªã®ã§ã€rules ã¨ only/except ã‚’åŒã˜ã‚¸ãƒ§ãƒ–ã§åŒæ™‚ã«æŒ‡å®šã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚\n\nrules ã®æŒ‡å®šã®ä¸€ä¾‹ã‚’å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰å¼•ç”¨ã—ã¾ã™ã€‚\n\n```yaml\ndocker build:\n  script: docker build -t my-image:$CI_COMMIT_REF_SLUG .\n  rules:\n    - if: $CI_PIPELINE_SOURCE == \"merge_request_event\"\n      changes:\n        - Dockerfile\n      when: manual\n      allow_failure: true\n```\n\nä¸Šè¨˜ã®ä¾‹ã§ã¯\n\n* ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒãƒãƒ¼ã‚¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ™‚ã« `Dockerfile` ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹\n* `Dockerfile` ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹æ™‚ã«ã€ã‚¸ãƒ§ãƒ–ã‚’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚¸ãƒ§ãƒ–ã¨ã—ã¦è¿½åŠ ã™ã‚‹\n  * `allow_failure: true` ã«ã‚ˆã£ã¦ã€ã‚¸ãƒ§ãƒ–ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œãªã‹ã£ãŸã¨ã—ã¦ã‚‚å¾Œç¶šã®ã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œã‚‹\n* `Dockerfile` ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„æ™‚ã¯ã€ã‚¸ãƒ§ãƒ–ã‚’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«è¿½åŠ ã—ãªã„\n  * `when: never` ã¨åŒã˜\n\nã¨ã„ã†æŒ™å‹•ã«ãªã‚Šã¾ã™ã€‚\n\nrules ã¯ãƒªã‚¹ãƒˆãªã®ã§è¤‡æ•°ã®ãƒ«ãƒ¼ãƒ«ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ãŒã€ **çŸ­çµ¡è©•ä¾¡ã§ã‚ã‚‹** ç‚¹ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚rules ã¯ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒä½œæˆã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è©•ä¾¡ã•ã‚Œã€æœ€åˆã«ãƒãƒƒãƒã™ã‚‹ã¾ã§è©•ä¾¡ãŒè¡Œã‚ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€ä¾‹ãˆã° `- when: manual` ã‚’æœ€åˆã«è¨˜è¿°ã™ã‚‹ã¨ãã“ã§è©•ä¾¡ãŒçµ‚ã‚ã‚Šï¼ˆ`manual` ã¯å¸¸ã«çœŸã¨ãªã‚Šãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«è¿½åŠ ã•ã‚Œã¾ã™ï¼‰ã€ãã®å¾Œã®æ¡ä»¶ã«ã¤ã„ã¦ã¯è©•ä¾¡ã•ã‚Œã¾ã›ã‚“ã€‚è¨€ã‚ã‚Œã¦ã¿ãŸã‚‰ãã‚Œã¯ãã†ãªã®ã§ã™ãŒã€ç­†è€…ã¯ãã“ã§ã—ã°ã‚‰ãè©°ã¾ã£ã¦ã¾ã—ãŸã€‚\n\n## workflow ã¨ã¯\n\nhttps://docs.gitlab.com/ee/ci/yaml/workflow.html\n\nãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãã®ã‚‚ã®ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã©ã†ã‹ã‚’æ±ºå®šã™ã‚‹ã‚‚ã®ã§ã™ã€‚workflow ã§æ¡ä»¶ã«ãƒãƒƒãƒã—ãªã‹ã£ãŸå ´åˆã€ãã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å†…ã®ã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\n\nã‚ˆãã‚ã‚‹ä½¿ã„æ–¹ã¨ã—ã¦ã¯ `$CI_PIPELINE_SOURCE` ã®ç¨®é¡ï¼ˆ`merge_request_event`, `push`, `schedule`, etc.ï¼‰ã«å¿œã˜ã¦ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã—ãªã„ã‹ã‚’æ±ºã‚ã‚‹ã¨è¨€ã£ãŸä½¿ã„æ–¹ãŒã‚ã‚Šã¾ã™ã€‚\n\n```yaml\nworkflow:\n  rules:\n    - if: $CI_PIPELINE_SOURCE == \"schedule\"\n      when: never\n    - if: $CI_PIPELINE_SOURCE == \"push\"\n      when: never\n    - when: always\n```\n\nä¸Šè¨˜ã®ä¾‹ã§ã¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œæ™‚ã¾ãŸã¯ push æ™‚ï¼ˆãƒ–ãƒ©ãƒ³ãƒã¨ã‚¿ã‚°ï¼‰ã«ã¯ `when: never` ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯èµ°ã‚Šã¾ã›ã‚“ã€‚ãã‚Œä»¥å¤–ã®æ™‚ã«ã¯ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚\n\n## é‡è¤‡ã—ãŸãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’é¿ã‘ã‚‹\n\nhttps://docs.gitlab.com/ee/ci/jobs/job_control.html#avoid-duplicate-pipelines\n\nã‚¸ãƒ§ãƒ–ã« rules ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã¨ã€ãƒãƒ¼ã‚¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆå¾Œã«ãƒ–ãƒ©ãƒ³ãƒã«å¯¾ã—ã¦ push ã™ã‚‹ã¨ã„ã£ãŸ1ã¤ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã€push æ™‚ã«ç™ºç”Ÿã—ãŸãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¨ãƒãƒ¼ã‚¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®2ã¤ãŒèµ°ã‚‰ã›ã‚‹ã“ã¨ãŒèµ·ã“ã‚Šãˆã¾ã™ã€‚\n\né‡è¤‡ã—ãŸãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆduplicate pipelinesï¼‰ã‚’é¿ã‘ã‚‹ãŸã‚ã«ã¯\n\n* workflow ã‚’ä½¿ã£ã¦ã©ã®ç¨®é¡ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯èµ°ã£ã¦è‰¯ã„ã®ã‹ã‚’æŒ‡å®šã™ã‚‹\n* ã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œã‚‹æ¡ä»¶ã‚’ã‹ãªã‚Šé™å®šçš„ã«ã—ã¦ã€æœ€å¾Œã®ãƒ«ãƒ¼ãƒ«ã¨ã—ã¦ `when`ï¼ˆ`when: never` ä»¥å¤–ï¼‰ã‚’ä½¿ã†ã®ã‚’é¿ã‘ã‚‹\n\nã“ã¨ãŒå¯¾ç­–ã«ãªã‚Šã¾ã™ã€‚\n\nç­†è€…ã®å ´åˆã¯ã€æ¬¡é …ã§ç¤ºã™ä¾‹ã‚’æ›¸ã„ã¦ã„ã‚‹éš›ã«é‡è¤‡ã—ãŸãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒç™ºç”Ÿã—ã€ç‰‡æ–¹ã®ã‚¸ãƒ§ãƒ–ã¯æ­£ã—ãæ©Ÿèƒ½ã—ãªã„ã¨ã„ã†çŠ¶æ³ãŒèµ·ã“ã‚Šã¾ã—ãŸãŒã€workflow ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§é‡è¤‡ãŒè§£æ¶ˆã•ã‚Œã€æ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚\n\n## ç‰¹å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´æ™‚ã®ã¿ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã—ã€ãã‚Œä»¥å¤–ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å¾Œç¶šã®ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹\n\n`.gitlab-ci.yml` ã¨åŒéšå±¤ã« `Dockerfile` ãŒã‚ã‚‹æƒ³å®šã§ã™ã€‚\n\n```yaml\nstages:\n  - build\n  - test\n\nworkflow:\n  rules:\n    - if: $CI_PIPELINE_SOURCE == \"merge_request_event\"\n    - if: $CI_COMMIT_BRANCH \u0026\u0026 $CI_OPEN_MERGE_REQUESTS\n      when: never\n    - if: $CI_COMMIT_BRANCH\n\nbuild:\n  stage: build\n  image:\n    name: gcr.io/kaniko-project/executor:v1.9.0-debug\n    entrypoint: [\"\"]\n  script:\n    - /kaniko/executor\n      --context \"${CI_PROJECT_DIR}\"\n      --dockerfile \"${CI_PROJECT_DIR}/Dockerfile\"\n      --destination \"${CI_REGISTRY_IMAGE}:latest\"\n  rules:\n    - if: $CI_PIPELINE_SOURCE =~ /merge_request_event|push/\n      changes:\n        - Dockerfile\n    - when: manual\n      allow_failure: true\n\ntest:\n  stage: test\n  image: \"${CI_REGISTRY_IMAGE}:latest\"\n  script:\n    - echo \"DO SOME TESTS\"\n```\n\nä¸Šè¨˜ã®ä¾‹ã¯ä»¥ä¸‹ã®æŒ™å‹•ã‚’ã—ã¾ã™ã€‚\n\n* workflow\n  * ãƒãƒ¼ã‚¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å ´åˆã¯å®Ÿè¡Œã•ã‚Œã‚‹\n  * ãƒãƒ¼ã‚¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã‚‹æ™‚ã€ãƒ–ãƒ©ãƒ³ãƒã¸ã® push ã‚¤ãƒ™ãƒ³ãƒˆã§ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯å®Ÿè¡Œã•ã‚Œãªã„\n  * ãã‚Œä»¥å¤–ã®ãƒ–ãƒ©ãƒ³ãƒã¸ã® push ã‚¤ãƒ™ãƒ³ãƒˆã§ã¯å®Ÿè¡Œã•ã‚Œã‚‹\n* rules\n  * ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒãƒãƒ¼ã‚¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ™‚ã¾ãŸã¯ push ã•ã‚ŒãŸæ™‚ã« `Dockerfile` ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹\n    * changes ã¯ä¸Šè¨˜ä»¥å¤–ã§ã¯å¸¸ã«çœŸã¨ãªã£ã¦ã—ã¾ã†ãŸã‚\n  * `Dockerfile` ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹æ™‚ã«ã€ã‚¸ãƒ§ãƒ–ã‚’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ ã™ã‚‹\n  * ä¸Šè¨˜ã®æ¡ä»¶ã«å½“ã¦ã¯ã¾ã‚‰ãªã„æ™‚ã¯ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚¸ãƒ§ãƒ–ã¨ã—ã¦ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«è¿½åŠ ã™ã‚‹\n    * `allow_failure: true` ã¨ãªã£ã¦ã„ã‚‹ã®ã§ã€å¾Œç¶šã®ã‚¸ãƒ§ãƒ–ã¯ãã®ã¾ã¾å®Ÿè¡Œã•ã‚Œã‚‹\n\nã“ã®ã‚ˆã†ã«æ›¸ãã“ã¨ã§ã€å®Ÿç¾ã—ãŸã‹ã£ãŸã€Œç‰¹å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´æ™‚ã®ã¿ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã—ã€ãã‚Œä»¥å¤–ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å¾Œç¶šã®ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ã€ãŒå®Ÿç¾ã—ã¾ã™ã€‚\n","tags":[{"name":"Gitlab","ref":"/tags/gitlab"},{"name":"CI/CD","ref":"/tags/ci-cd"}],"showTerminalAside":false},{"title":"Next.jsã¨Tailwind CSSã§ãƒ–ãƒ­ã‚°ã‚’ä½œã‚‹ã¨ãã«è€ƒãˆãŸã“ã¨","date":"2022-11-13T00:00:00.000Z","ref":"/posts/2022/11/blog-with-nextjs-and-tailwindcss","desc":" ã“ã®ãƒ–ãƒ­ã‚°ã¯ Next.js ã® SSGï¼ˆStatic Site Generation; é™çš„ã‚µã‚¤ãƒˆç”Ÿæˆï¼‰æ©Ÿèƒ½ã‚’ä½¿ã„ãªãŒã‚‰ã€ãƒ‡ã‚¶ã‚¤ãƒ³ã®å¤§åŠã¯ Tailwind CSS ã‚’ä½¿ç”¨ã—ã¦æ•´ãˆã¦ã„ã¾ã™ã€‚ãã—ã¦ç”Ÿæˆã•ã‚ŒãŸ HTML, CSS, JS ã¯ GitHub Pages ã§ãƒ›ã‚¹ãƒˆã•ã›ã¦ã‚‚ã‚‰ã£ã¦ã„ã¾ã™ã€‚","draft":false,"content":"\nã“ã®ãƒ–ãƒ­ã‚°ã¯ Next.js ã® SSGï¼ˆStatic Site Generation; é™çš„ã‚µã‚¤ãƒˆç”Ÿæˆï¼‰æ©Ÿèƒ½ã‚’ä½¿ã„ãªãŒã‚‰ã€ãƒ‡ã‚¶ã‚¤ãƒ³ã®å¤§åŠã¯ Tailwind CSS ã‚’ä½¿ç”¨ã—ã¦æ•´ãˆã¦ã„ã¾ã™ã€‚ãã—ã¦ç”Ÿæˆã•ã‚ŒãŸ HTML, CSS, JS ã¯ GitHub Pages ã§ãƒ›ã‚¹ãƒˆã•ã›ã¦ã‚‚ã‚‰ã£ã¦ã„ã¾ã™ã€‚\n\nãã“ãã“ã®å‡ºæ¥æ „ãˆã«ãªã£ãŸã®ã§ã€ä»Šå›ã¯ã“ã®ãƒ–ãƒ­ã‚°ãŒã§ãã‚‹ã¾ã§ã®ãŠè©±ã‚’ã—ãŸã„ãªã¨æ€ã£ãŸã®ã§ã™ãŒã€æ­£ç›´ãªã¨ã“ã‚ã€ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯å…ˆã®ãƒšãƒ¼ã‚¸ã‚’~~ã¾ã‚‹ãƒ‘ã‚¯~~å‚è€ƒã«ã•ã›ã¦ã‚‚ã‚‰ã„ãªãŒã‚‰ä½œæˆã—ãŸã®ã§ã€å…·ä½“çš„ãªæ§‹ç¯‰æ–¹æ³•ã«ã¤ã„ã¦ã¯ãã¡ã‚‰ã‚’ã”è¦§ã„ãŸã ã‘ã‚‹ã¨è‰¯ã„ã‹ã¨æ€ã„ã¾ã™ã€‚1ã‚¹ãƒ†ãƒƒãƒ—ãšã¤ä¸å¯§ã«è§£èª¬ã•ã‚Œã¦ãŠã‚Šã¨ã¦ã‚‚æœ‰ç”¨ã§ã—ãŸğŸ™\n\n* [Next.jsã‚’åˆ©ç”¨ã—ãŸåˆã‚ã¦ã®æœ¬æ ¼çš„Markdownãƒ–ãƒ­ã‚°ã‚µã‚¤ãƒˆã®æ§‹ç¯‰](https://reffect.co.jp/react/nextjs-markdown-blog)\n\nãªã®ã§ã€ä»Šå›ã¯æŠ€è¡“çš„ãªè©³ç´°ã¨ã„ã†ã‚ˆã‚Šã‚‚ã€ç­†è€…ãŒå§‹ã‚ã‚‹å‰ã«ç–‘å•ã ã£ãŸç‚¹ã‚„æŠ€è¡“é¸å®šã€è¨­è¨ˆã¾ã‚ã‚Šã«ã¤ã„ã¦æ›¸ã‘ã‚Œã°ãªã¨æ€ã„ã¾ã™ã€‚\n\n## å¯¾è±¡èª­è€…\n\n* è‡ªåˆ†ã®ãƒ–ãƒ­ã‚°ã‚’ä½œã£ã¦ã¿ãŸã„äºº\n* React ã‚„ Next.js ã«èˆˆå‘³ãŒã‚ã‚‹äºº\n\n## ãƒ–ãƒ­ã‚°ã‚’ã©ã“ã§ãƒ›ã‚¹ãƒˆã™ã‚‹ã‹\n\næŠ€è¡“ã«é–¢ã™ã‚‹è¨˜äº‹ã‚’æ›¸ãã®ã§ã‚ã‚Œã° Qiita ã‚„ Zenn ã§ã„ã„ã˜ã‚ƒã‚“ã¨æ€ã„ã¾ã™ã—ã€å®Ÿéš›ãã®æ–¹ãŒã¯ã‚‹ã‹ã«æ¥½ã§ã€å¤šãã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚‚ã‚‰ã„ã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚ãã‚“ãªä¸­ã€è‡ªåˆ†ã®ãƒ–ãƒ­ã‚°ã‚’ä½œã‚‹ç†ç”±ã¨ã—ã¦ã¯ã€Œã‚„ã£ã¦ã¿ãŸã‹ã£ãŸã‹ã‚‰ã€ä»¥ä¸Šã®ç†ç”±ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚ã¤ã¾ã‚Šãƒ­ãƒãƒ³ã§ã™ã€‚\n\nã—ã‹ã—ãªãŒã‚‰ã€ã„ã–è‡ªåˆ†ã®ãƒ–ãƒ­ã‚°ã‚’ä½œã‚ã†ã¨æ€ã£ãŸã¨ãã«\n\n* ç°¡å˜ã«ã€ã‹ã¤é«˜åº¦ãªã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒã§ãã‚‹\n* ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚³ã‚¹ãƒˆãŒå®‰ã„\n\nã¨ã„ã£ãŸç¾å‘³ã—ã„ç’°å¢ƒã¯æ€ã£ãŸã‚ˆã‚Šã‚‚å°‘ãªã„ã§ã™ã€‚\n\nãƒ–ãƒ­ã‚°ã‚’ä½œã‚‹ã¨è¨€ã£ãŸã‚‰ WordPress ãŒè¶…å®šç•ªã§ã™ãŒã€ãƒ†ãƒ¼ãƒã‚’ä½œã‚‹ã¨ãªã‚‹ã¨ php ã‚„ WordPress ã®çŸ¥è­˜ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚WordPress ãƒ†ãƒ¼ãƒã¥ãã‚Šã«æºã‚ã£ãŸã“ã¨ãŒã‚ã‚‹ã®ã§ã€ã‚„ã£ã¦ã¿ã‚‹ã¨æ€ã£ãŸã‚ˆã‚Šç°¡å˜ãªã®ã§ã™ãŒã€ç­†è€…ã®ãŠä»•äº‹ã®åˆ†é‡ã¨ã¯ã‹ã™ã‚‰ãªã„ã®ã§ã‚ã¾ã‚Šãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ¹§ãã¾ã›ã‚“ã€‚  \nã¾ãŸã€æœ€ä½æœˆæ•°ç™¾å††ã®ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚³ã‚¹ãƒˆã‚‚ã‹ã‹ã‚Šã¾ã™ã—ã€å‹•çš„ã«ãƒšãƒ¼ã‚¸ã‚’ç”Ÿæˆã™ã‚‹ã®ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚‚é…ããªã‚ŠãŒã¡ã§ã™ã€‚\n\næ¬¡ã« SSGï¼ˆStatic Site Generation; é™çš„ã‚µã‚¤ãƒˆç”Ÿæˆï¼‰ã‚’æ¤œè¨ã—ã¾ã™ã€‚Markdown ã§åŸç¨¿ã‚’æ›¸ãã€é™çš„ãª HTML ãªã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã™ã‚Œã°ã€GitHub Pages ã§ç„¡æ–™ã§å…¬é–‹ã§ãã‚‹ã®ã§çµæ§‹è‰¯ã•ãã†ã§ã™ã€‚\n\nSSG ã®ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ã¯æœ‰åãªã‚‚ã®ãŒã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚\n\n* Next.js\n* Gatsby\n* Hugo\n* NuxtJS\n* Jekyll\n\nã“ã®ã†ã¡ã€Next.js ã¨ Gatsby ã¯ React ãƒ™ãƒ¼ã‚¹ã®ãŸã‚å½“åˆã¯æ¤œè¨ã‹ã‚‰å¤–ã—ã¦ã„ã¾ã—ãŸã€‚ç­†è€…ã¯ Hugo ã‚’é¸ã³ã€é…å¸ƒãƒ†ãƒ¼ãƒã‚’é©ç”¨ã—ã¦ã¿ãŸã‚Šã€è‡ªä½œãƒ†ãƒ¼ãƒã‚’ä½œã‚Šå§‹ã‚ãŸã‚Šã—ã¾ã—ãŸãŒã€æƒ³åƒã‚ˆã‚Šå­¦ç¿’ã‚³ã‚¹ãƒˆãŒé«˜ã‹ã£ãŸã®ã§æŒ«æŠ˜ã—ã¦ã—ã¾ã„ã¾ã—ãŸã€‚\n\nä»£ã‚ã‚Šã«æœ€è¿‘æ³¢ã«ä¹—ã£ã¦ã„ãã†ãª Next.js ã‚’ä½¿ã£ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚React ã‚’ä½¿ã†ã®ã¯åˆã‚ã¦ã ã£ãŸã®ã§ï¼ˆãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã—ã‹ã‚„ã£ãŸã“ã¨ãŒãªã„ï¼‰èºŠèº‡ã—ã¦ã„ã¾ã—ãŸãŒã€[æœ€åˆã«ç´¹ä»‹ã—ãŸè¨˜äº‹](https://reffect.co.jp/react/nextjs-markdown-blog)ã®ãŠã‹ã’ã‚‚ã‚ã£ã¦ã€ã™ã‚“ãªã‚Šã¨æ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚React ã®åŸºæœ¬çš„ãªçŸ¥è­˜ã•ãˆã‚ã‚Œã°å•é¡Œãªã•ãã†ã§ã™ã€‚\n\n## ã©ã†ã‚„ã£ã¦ãƒ‡ã‚¶ã‚¤ãƒ³ã™ã‚‹ã‹\n\nã¾ãšã¯ Adobe XD ã§ãƒ‡ã‚¶ã‚¤ãƒ³ã‚«ãƒ³ãƒ—ã‚’ä½œæˆã—ã¾ã™ã€‚ã„ããªã‚Šãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ã‚’å§‹ã‚ã¦ã‚‚ã€ä½œã‚ŠãŸã„ã‚‚ã®ãŒå®šã¾ã£ã¦ã„ãªã„ã¨ç„¡é§„ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã—ã¾ã†ã®ã§ã€å¤šå°‘æ‰‹é–“ã§ã‚‚ä½œã‚ŠãŸã„ã‚‚ã®ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å…ˆã«æ±ºã‚ã¦ãŠãã¨è‰¯ã„ã§ã™ã€‚\n\n![XD](/images/posts/2022/11/xd.png)\n\nä¸Šå›³ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã‚„ã‚µã‚¤ãƒ‰ãƒãƒ¼ã€è¨˜äº‹ä¸€è¦§ã€è¨˜äº‹ãƒšãƒ¼ã‚¸ã‚’ã–ã£ãã‚Šã¨ä½œã‚Šã¾ã—ãŸã€‚\n\n## React ã® CSS ã‚ˆãã‚ã‹ã‚‰ã‚“å•é¡Œ\n\nç­†è€…ã®çµŒé¨“ä¸è¶³ã®ã›ã„ãªã®ã§ã™ãŒã€React ã§ CSS ã§ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨ã™ã‚‹ãƒ™ã‚¹ãƒˆãªæ–¹æ³•ãŒã‚ˆãã‚ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸğŸ˜‡\n\nãƒ‡ã‚¶ã‚¤ãƒ³ã‚«ãƒ³ãƒ—ã‚’ä½œã£ã¦ã¿ã¦ã€ãã“ã¾ã§è¤‡é›‘ãª CSS ã‚’è¨˜è¿°ã™ã‚‹å¿…è¦ãŒãªã•ãã†ã ã£ãŸã®ã§ã€Tailwind CSS ã‚’ä½¿ã£ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚\n\n[Tailwind CSS](https://tailwindcss.com/) ã¨ã¯ã€HTML ã®ã‚¯ãƒ©ã‚¹å±æ€§ã« `flex`, `pt-4`, `text-center` ã®ã‚ˆã†ãªã‚¯ãƒ©ã‚¹åã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã§ã€`display: flex` ã‚’ã‹ã‘ãŸã‚Š `padding-top` ã‚„ `text-align: center` ã‚’è¨­å®šã§ãã‚‹ã¨ã„ã†ãƒ¤ãƒ„ã§ã™ã€‚\n\nè»½ãå€‹äººçš„ãªæ„Ÿæƒ³ã‚’ã¾ã¨ã‚ã¦ã¿ã‚‹ã¨\n\nPros\n* ã‚³ãƒ¼ãƒ‰é‡ãŒæ¸›ã‚‹\n* HTML è¦ç´ ã‚’æ¶ˆã—ãŸã‘ã© CSS ã¯æ¶ˆã—å¿˜ã‚ŒãŸã€ã¿ãŸã„ãªã“ã¨ã¯ãªããªã‚‹\n* ã‚«ã‚¹ã‚¿ãƒ ã®è‰²ã‚’è¨­å®šã§ãã‚‹ãªã©ã€ä¸€å®šã®æŸ”è»Ÿæ€§ãŒã‚ã‚‹\n\nCons\n* CSS ã®çŸ¥è­˜ã¯å¿…è¦ï¼ˆãã‚Œã¯ãã†ï¼‰\n* éƒ½åº¦ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’è¦‹ã¦ã‚¯ãƒ©ã‚¹åã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚‹\n* è¤‡é›‘ãªã“ã¨ã¯ã§ããªã„ã®ã§å‰²ã‚Šåˆ‡ã‚‹ã‹ã€åˆ¥ã®æ–¹æ³•ã§æ›¸ã‹ãªãã¦ã¯ã„ã‘ãªã„\n\nãªæ„Ÿã˜ã§ã™ã€‚è‰¯ã„ã¨ã“ã‚ã‚‚æ‚ªã„ã¨ã“ã‚ã‚‚ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ç­†è€…ã¯ã‚¢ãƒªã ã¨åˆ¤æ–­ã—ã¦æ¡ç”¨ã—ã¾ã—ãŸã—ã€å®Ÿéš›è‰¯ã‹ã£ãŸã§ã™ã€‚\n\n## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å®Ÿè¡Œã•ã›ãŸã„å‡¦ç†ã©ã†æ›¸ãã®\n\nSSG ã§é™çš„ãªãƒšãƒ¼ã‚¸ã‚’æ›¸ãå‡ºã™ã¨è¨€ã£ã¦ã‚‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å®Ÿè¡Œã•ã›ãŸã„å‡¦ç†ã¯ã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚µã‚¤ãƒˆã§ã¯ã€ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰â†”ï¸ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã‚„ã€Œã„ã„ã­ã€ãƒœã‚¿ãƒ³ãŒãã‚Œã«è©²å½“ã—ã¾ã™ã€‚ã„ãšã‚Œã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ DOM ã‚’æ›¸ãæ›ãˆã‚‹å¿…è¦æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n\næ™®é€šã« React ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦æ›¸ã„ã¦ã—ã¾ã†ã¨ SSG ã§ã®ãƒ“ãƒ«ãƒ‰æ™‚ã«é™çš„ãªãƒšãƒ¼ã‚¸ã¨ã—ã¦æ›¸ãå‡ºã•ã‚Œã¦ã—ã¾ã†ãŸã‚ã€ãªã‚“ã¨ã‹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æœ€åˆã¯ public ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã« js ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ã„ã¦ Next.js ã® [Script](https://nextjs.org/docs/basic-features/script) ã‚¿ã‚°ã§èª­ã¿è¾¼ã¾ã›ã¦ã„ãŸã®ã§ã™ãŒã€ãã‚Œã‚ˆã‚Šã‚‚ Next.js ã® [Dynamic Import](https://nextjs.org/docs/advanced-features/dynamic-import) æ©Ÿèƒ½ã‚’ä½¿ã£ãŸæ–¹ãŒã‚¹ãƒãƒ¼ãƒˆã«æ›¸ã‘ã¾ã™ã€‚\n\n`{ ssr: false }` å¼•æ•°ã‚’æ¸¡ã—ã¦ã‚ã’ã‚‹ã“ã¨ã§ã€ãã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\n\n## GitHub Pages ã§å…¬é–‹ã™ã‚‹ã¨ãã®ç½ \n\næ™´ã‚Œã¦æº–å‚™å®Œäº†ï¼ã„ã–å…¬é–‹ï¼ã¨æ„æ°—æšã€…ã¨ GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã‚‚ã€ã†ã¾ãã„ã‹ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚\n\nãƒ“ãƒ«ãƒ‰æ™‚ã«ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã—ã‚‡ã†ã€‚\n\n```\nnext build\nnext export -o docs/\ntouch docs/.nojekyll\necho 'sogo.dev' \u003e docs/CNAME\n```\n\nãƒã‚¤ãƒ³ãƒˆã¯å…¬é–‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆä¸Šè¨˜ã®å ´åˆã¯ `docs`ï¼‰ã®ç›´ä¸‹ã« `.nojekyll` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã„ã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚ŒãŒãªã„ã¨ `_next` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ä»¥ä¸‹ãŒå…¬é–‹ã•ã‚Œãšãƒªãƒ³ã‚¯åˆ‡ã‚Œã«ãªã‚Šã¾ã™ã€‚  \nå‚è€ƒ: [Next.js ã® SSG æ©Ÿèƒ½ã§ç”Ÿæˆã—ãŸé™çš„ã‚µã‚¤ãƒˆã‚’ GitHub Actions çµŒç”±ã§ GitHub Pages ã«å…¬é–‹ã™ã‚‹](https://sidearrow.github.io/article/next-js-ssg-on-github-pages)\n\næœ€å¾Œã®ã‚³ãƒãƒ³ãƒ‰ã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’ä½¿ç”¨ã—ãªã„å ´åˆã¯ä¸è¦ã§ã™ãŒã€ä½¿ç”¨ã™ã‚‹å ´åˆã¯éƒ½åº¦ç”Ÿæˆã—ã¦ãŠã‹ãªã„ã¨æ¶ˆãˆã¦ã—ã¾ã†ãŸã‚ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³åã§ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚\n\n## ä»Šå¾Œã‚„ã£ã¦ã„ããŸã„ã“ã¨\n\nä»¥ä¸ŠãŒã“ã®ãƒ–ãƒ­ã‚°ã‚’ä½œã‚‹ã«ã‚ãŸã£ã¦è€ƒãˆãŸã“ã¨ãªã®ã§ã™ãŒã€ã¾ã ã‚„ã‚Šæ®‹ã—ãŸã“ã¨ã¯ã‚ã‚Šã¾ã™ã€‚\n\n* è¨˜äº‹ã‚’ãƒªãƒƒãƒã«ã—ãŸã„\n  * ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆ\n  * ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰\n  * ç›®æ¬¡ï¼ˆToCï¼‰\n* ãŠã™ã™ã‚è¨˜äº‹ã‚’ã„ã„æ„Ÿã˜ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§å‡ºã—ãŸã„\n  * ã¾ãšã¯è¨˜äº‹ã‚’æ›¸ããŸã‚ãªãã‚ƒã€‚ã€‚\n\n## æœ€å¾Œã«\n\nã¤ã‚‰ã¤ã‚‰ã¨é§„æ–‡ã‚’æ›¸ãé€£ã­ã¦ã—ã¾ã„ã¾ã—ãŸã€‚å‹˜ã®è‰¯ã„æ–¹ã¯æ°—ã¥ã„ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ãŒã€ã“ã®ãƒ–ãƒ­ã‚°ã¯ GitHub Pages ã§ãƒ›ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹ï¼[ã‚½ãƒ¼ã‚¹ãŒè¦‹ã‚Œã‚‹](https://github.com/SogoKato/sogokato.github.io)ãªã®ã§ã€ã‚‚ã—èˆˆå‘³ã®ã‚ã‚‹æ–¹ãŒã„ã‚‰ã£ã—ã‚ƒã„ã¾ã—ãŸã‚‰è¦—ã„ã¦ã¿ã¦ãã ã•ã„ã€‚\n","tags":[{"name":"JavaScript","ref":"/tags/javascript"},{"name":"React","ref":"/tags/react"},{"name":"Next.js","ref":"/tags/next.js"},{"name":"Tailwind CSS","ref":"/tags/tailwind-css"}],"showTerminalAside":false},{"title":"Hello World!","date":"2022-10-11T00:00:00.000Z","ref":"/posts/2022/10/hello-world","desc":" ã¯ã˜ã‚ã¾ã—ã¦ã€‚  \nã“ã‚Œã¯åˆã‚ã¦ã®æŠ•ç¨¿ã§ã™ã€‚\n\nä»Šã¾ã§ãƒ–ãƒ­ã‚°ãŒé•·ãç¶šã„ãŸã“ã¨ãŒãªã„ã®ã§ã™ãŒã€nåº¦ç›®ã®æ­£ç›´ã¨ã„ã†ã“ã¨ã§ä»Šå›ã“ãã¯é•·ãç¶šãã‚ˆã†ã«é ‘å¼µã‚ŠãŸã„ã¨æ€ã„ã¾ã™ï¼ˆã¨ã¦ã‚‚å›ºã„æ±ºæ„ï¼‰ã€‚\n\n@SogoKato ã¨ã„ã„ã¾ã™ã€‚ã©ã‚“ãªäººã‹æ°—ã«ãªã£ã¦ãã‚ŒãŸæ–¹ã¯ è‡ªå·±ç´¹ä»‹ãƒšãƒ¼ã‚¸ ã‚’ã”è¦§ã„ãŸ","draft":false,"content":"\nã¯ã˜ã‚ã¾ã—ã¦ã€‚  \nã“ã‚Œã¯åˆã‚ã¦ã®æŠ•ç¨¿ã§ã™ã€‚\n\nä»Šã¾ã§ãƒ–ãƒ­ã‚°ãŒé•·ãç¶šã„ãŸã“ã¨ãŒãªã„ã®ã§ã™ãŒã€nåº¦ç›®ã®æ­£ç›´ã¨ã„ã†ã“ã¨ã§ä»Šå›ã“ãã¯é•·ãç¶šãã‚ˆã†ã«é ‘å¼µã‚ŠãŸã„ã¨æ€ã„ã¾ã™ï¼ˆã¨ã¦ã‚‚å›ºã„æ±ºæ„ï¼‰ã€‚\n\n@SogoKato ã¨ã„ã„ã¾ã™ã€‚ã©ã‚“ãªäººã‹æ°—ã«ãªã£ã¦ãã‚ŒãŸæ–¹ã¯ [è‡ªå·±ç´¹ä»‹ãƒšãƒ¼ã‚¸](/profile) ã‚’ã”è¦§ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚\n\nã“ã®ãƒ–ãƒ­ã‚°ã®åˆ¶ä½œã«ã‚ãŸã£ã¦ã¯ã€åˆã‚ã¦ React + Next.js + Tailwind CSS ã‚’è§¦ã£ã¦ä½œã£ã¦ã¿ã¾ã—ãŸãŒã€çµæ§‹ã„ã„é–‹ç™ºè€…ä½“é¨“ã ã£ãŸã®ã§ã“ã‚Œã«ã¤ã„ã¦ã‚‚ã¾ãŸè¨˜äº‹ã«èµ·ã“ã—ã¦ã„ããŸã„ãªã€œã¨æ€ã£ã¦ã„ã¾ã™ã€‚ã€‚ï¼ˆå°‘ã—ã‚†ã‚‹ã„æ±ºæ„ï¼‰\n\nä»Šã¾ã§æ›¸ã„ã¦ããŸè¨˜äº‹ã«ã¤ã„ã¦ã¯ã€[ç§ã® Qiita](https://qiita.com/SogoK) ã‚’è¦‹ã¦ã¿ã¦ãã ã•ã„ã€‚  \nãŠã™ã™ã‚ã¯â†“ã‚‰ã¸ã‚“ã§ã™ã€‚\n\n* [Vue 3ã‹ã‚‰å§‹ã‚ã‚‹äººã®ãŸã‚ã®å­¦ç¿’ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—](https://qiita.com/SogoK/items/15ed0d9b2be4279b2f47)\n* [æ–°å’ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒCKAå–å¾—ã‚’ç›®æŒ‡ã—ã¦Kubernetesã‚’å‹‰å¼·ã—ãŸã¨ãã®è¨˜éŒ²](https://qiita.com/SogoK/items/4ed2e118d0412c868169)\n* [GitLabã®ã‚¿ãƒ–ã‚’é–‹ãã™ãã¦è¦‹åˆ†ã‘ã¥ã‚‰ã„ã®ã§faviconã‚’å¤‰ãˆã‚‹æ‹¡å¼µæ©Ÿèƒ½ã‚’ä½œã£ãŸ](https://qiita.com/SogoK/items/31f74b517dc3c6884c04)\n\nã•ã¦ã€åˆå›ã‹ã‚‰é ‘å¼µã‚Šã™ãã‚‹ã¨æ¬¡å›ä»¥é™ã®å¿ƒç†çš„ãªãƒãƒ¼ãƒ‰ãƒ«ãŒã‚ãŒã£ã¡ã‚ƒã†ã®ã§ã“ã‚Œãã‚‰ã„ã«ã—ã¦ãŠã“ã†ã¨æ€ã„ã¾ã™ã€‚ã§ã¯ã€ã“ã‚Œã‹ã‚‰ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ğŸ™\n","tags":[{"name":"Personal","ref":"/tags/personal"}],"showTerminalAside":false}],"slicedPosts":[{"title":"FastAPIã¨SQLAlchemy2.0ãªã‚‰ã‚‚ã†å‹ãƒ’ãƒ³ãƒˆã‚’è«¦ã‚ãªãã¦ã„ã„","date":"2023-02-08T00:00:00.000Z","ref":"/posts/2023/02/fastapi-orm-sqlalchemy","desc":" ã‚µãƒã‚³ï¼ˆGoogle Search Consoleï¼‰ã‚’çœºã‚ã¦ã„ãŸã‚‰ `FastAPI MySQL` ãŒãã‚Œãªã‚Šã«éœ€è¦ã‚ã‚Šãã†ã¨æ€ã£ãŸã®ã§ã€FastAPI ã¨ SQLAlchemy ã‚’çµ„ã¿åˆã‚ã›ã¦ ORM ã‚’ä½¿ã†æ–¹æ³•ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚æœ€è¿‘ã® SQLAlchemyï¼ˆ1.4ä»¥é™ï¼‰ã§ã¯ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œ","draft":false,"content":"\nã‚µãƒã‚³ï¼ˆGoogle Search Consoleï¼‰ã‚’çœºã‚ã¦ã„ãŸã‚‰ `FastAPI MySQL` ãŒãã‚Œãªã‚Šã«éœ€è¦ã‚ã‚Šãã†ã¨æ€ã£ãŸã®ã§ã€FastAPI ã¨ SQLAlchemy ã‚’çµ„ã¿åˆã‚ã›ã¦ ORM ã‚’ä½¿ã†æ–¹æ³•ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚æœ€è¿‘ã® SQLAlchemyï¼ˆ1.4ä»¥é™ï¼‰ã§ã¯ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å‹ã‚’é©ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã®ã§ã€å‹ãƒ’ãƒ³ãƒˆã‚’æ´»ã‹ã—ã¦å‹å®‰å…¨ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ã‚‚é›£ã—ããªããªã£ã¦ã„ã¾ã™ã€‚\n\n## ç’°å¢ƒ\n\n* Python 3.10.6\n* FastAPI 0.89.1\n* SQLAlchemy 2.0.1\n* Docker 20.10.13\n* Docker Compose v2.3.3\n\n## å‰æ\n\nFastAPI å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® [SQL (Relational) Databases](https://fastapi.tiangolo.com/ja/tutorial/sql-databases/) ã®ãƒšãƒ¼ã‚¸ã‚’ç†Ÿèª­ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚\n\n2023å¹´1æœˆã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸ SQLAlchemy 2.0ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚1ç³»ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ [SQLAlchemy 2.0 - Major Migration Guide](https://docs.sqlalchemy.org/en/20/changelog/migration_20.html) ã‚’å‚è€ƒã«2.0ã¸ç§»è¡Œã—ã¦ãã ã•ã„ã€‚1.4ã‹ã‚‰2.0ã®ç§»è¡Œã¯ã‚¹ãƒ ãƒ¼ã‚ºã ã¨æ€ã„ã¾ã™ã€‚\n\nSQLAlchemy ã§åˆ©ç”¨ã§ãã‚‹ ORM ã®ãƒ¢ãƒ‡ãƒ«ã®æ›¸ãæ–¹ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚å€‹äººçš„ã«ã¯ [dataclass ã¨çµ±åˆã—ãŸæ›¸ãæ–¹](https://docs.sqlalchemy.org/en/20/orm/dataclasses.html)ã‚‚å¥½ãã§ã™ãŒã€ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ãªå®Ÿè£…ã‚’è¡Œã„ã¾ã™ã€‚\n\n## æˆæœç‰©\n\nhttps://github.com/SogoKato/fastapi-sqlalchemy2\n\n```py\nfrom fastapi import Depends, FastAPI, HTTPException\nfrom pydantic import BaseModel\nfrom sqlalchemy import ForeignKey, String, create_engine, select\nfrom sqlalchemy.orm import (\n    DeclarativeBase,\n    Mapped,\n    Session,\n    mapped_column,\n    relationship,\n    sessionmaker,\n)\n\n\"\"\"\nSQLAlchemyã®ãƒ¢ãƒ‡ãƒ«.\n\nBased on:\n* https://docs.sqlalchemy.org/en/20/orm/quickstart.html#declare-models\n* https://fastapi.tiangolo.com/ja/tutorial/sql-databases/#create-the-database-models\n\"\"\"\n\n\nclass Base(DeclarativeBase):\n    \"\"\"å„DBãƒ¢ãƒ‡ãƒ«ã®åŸºåº•ã‚¯ãƒ©ã‚¹.\"\"\"\n\n    pass\n\n\nclass User(Base):\n    \"\"\"usersãƒ†ãƒ¼ãƒ–ãƒ«ã®DBãƒ¢ãƒ‡ãƒ«.\"\"\"\n\n    __tablename__ = \"users\"\n\n    id: Mapped[int] = mapped_column(primary_key=True, index=True)\n    email: Mapped[str] = mapped_column(String(100), unique=True, index=True)\n    hashed_password: Mapped[str] = mapped_column(String(100))\n    is_active: Mapped[bool]\n\n    items: Mapped[list[\"Item\"]] = relationship(back_populates=\"owner\")\n\n\nclass Item(Base):\n    \"\"\"itemsãƒ†ãƒ¼ãƒ–ãƒ«ã®DBãƒ¢ãƒ‡ãƒ«.\"\"\"\n\n    __tablename__ = \"items\"\n\n    id: Mapped[int] = mapped_column(primary_key=True, index=True)\n    title: Mapped[str] = mapped_column(String(30), index=True)\n    description: Mapped[str] = mapped_column(String(30), index=True)\n    owner_id: Mapped[int] = mapped_column(ForeignKey(\"users.id\"))\n\n    owner: Mapped[\"User\"] = relationship(back_populates=\"items\")\n\n\n\"\"\"\nPydanticã®ãƒ¢ãƒ‡ãƒ«.\n\nBased on:\n* https://fastapi.tiangolo.com/ja/tutorial/sql-databases/#create-the-pydantic-models\n\"\"\"\n\n\nclass ItemBase(BaseModel):\n    \"\"\"Itemã®åŸºåº•ã‚¯ãƒ©ã‚¹.\"\"\"\n\n    title: str\n    description: str | None = None\n\n\nclass ItemCreateRequest(ItemBase):\n    \"\"\"Itemä½œæˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡¨ç¾ã™ã‚‹ã‚¯ãƒ©ã‚¹.\"\"\"\n\n    pass\n\n\nclass ItemResponse(ItemBase):\n    \"\"\"Itemã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¡¨ç¾ã™ã‚‹ã‚¯ãƒ©ã‚¹.\"\"\"\n\n    id: int\n    owner_id: int\n\n    class Config:\n        orm_mode = True\n\n\nclass UserBase(BaseModel):\n    \"\"\"Userã®åŸºåº•ã‚¯ãƒ©ã‚¹.\"\"\"\n\n    email: str\n\n\nclass UserCreateRequest(UserBase):\n    \"\"\"Userä½œæˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡¨ç¾ã™ã‚‹ã‚¯ãƒ©ã‚¹.\"\"\"\n\n    password: str\n\n\nclass UserResponse(UserBase):\n    \"\"\"Userã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¡¨ç¾ã™ã‚‹ã‚¯ãƒ©ã‚¹.\"\"\"\n\n    id: int\n    is_active: bool\n    items: list[ItemResponse] = []\n\n    class Config:\n        orm_mode = True\n\n\n\"\"\"\nDBã®CRUDæ“ä½œã‚’è¡Œã†é–¢æ•°.\n\nBased on:\n* https://docs.sqlalchemy.org/en/20/changelog/migration_20.html#migration-orm-usage\n* https://fastapi.tiangolo.com/ja/tutorial/sql-databases/#crud-utils\n\"\"\"\n\n\ndef get_db_user(db: Session, user_id: int):\n    \"\"\"usersãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰user_idã«ä¸€è‡´ã™ã‚‹Userã‚’å–å¾—ã—ã¾ã™.\"\"\"\n    return db.execute(select(User).where(User.id == user_id)).scalars().first()\n\n\ndef get_db_user_by_email(db: Session, email: str):\n    \"\"\"usersãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰emailã«ä¸€è‡´ã™ã‚‹Userã‚’å–å¾—ã—ã¾ã™.\"\"\"\n    return db.execute(select(User).where(User.email == email)).scalars().first()\n\n\ndef get_db_users(db: Session, skip: int = 0, limit: int = 100):\n    \"\"\"usersãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰Userã‚’ã™ã¹ã¦å–å¾—ã—ã¾ã™.\"\"\"\n    return db.execute(select(User).offset(skip).limit(limit)).scalars().all()\n\n\ndef create_db_user(db: Session, user: UserCreateRequest):\n    \"\"\"usersãƒ†ãƒ¼ãƒ–ãƒ«ã«Userã‚’è¿½åŠ ã—ã¾ã™.\"\"\"\n    fake_hashed_password = user.password + \"notreallyhashed\"\n    db_user = User(\n        email=user.email, hashed_password=fake_hashed_password, is_active=True\n    )\n    db.add(db_user)\n    db.commit()\n    db.refresh(db_user)\n    return db_user\n\n\ndef get_db_items(db: Session, skip: int = 0, limit: int = 100):\n    \"\"\"itemsãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰Itemã‚’ã™ã¹ã¦å–å¾—ã—ã¾ã™.\"\"\"\n    return db.execute(select(Item).offset(skip).limit(limit)).scalars().all()\n\n\ndef create_db_user_item(db: Session, item: ItemCreateRequest, user_id: int):\n    \"\"\"itemsãƒ†ãƒ¼ãƒ–ãƒ«ã«Itemã‚’è¿½åŠ ã—ã¾ã™.\"\"\"\n    db_item = Item(**item.dict(), owner_id=user_id)\n    db.add(db_item)\n    db.commit()\n    db.refresh(db_item)\n    return db_item\n\n\n\"\"\"\nFastAPIã§SQLAlchemyã‚’ä½¿ã†ãŸã‚ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—.\n\"\"\"\n# DBã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚‹.\nSQLALCHEMY_DATABASE_URL = \"mysql+mysqldb://user:password@db/test\"\n\n# ãƒ‡ãƒãƒƒã‚°ç”¨ã«echo=Trueã«è¨­å®š.\nengine = create_engine(SQLALCHEMY_DATABASE_URL, echo=True)\nSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)\n\n# DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†.\nBase.metadata.create_all(bind=engine)\n\n# FastAPIã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–.\napp = FastAPI()\n\n\ndef get_db():\n    \"\"\"ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãŸã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€å‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰é–‰ã˜ã‚‹ãŸã‚ã®Dependency.\"\"\"\n    db = SessionLocal()\n    try:\n        yield db\n    finally:\n        db.close()\n\n\n\"\"\"\nFastAPIã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°.\n\"\"\"\n\n\n@app.post(\"/users/\", response_model=UserResponse)\ndef create_user(user: UserCreateRequest, db: Session = Depends(get_db)):\n    \"\"\"ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™.\"\"\"\n    db_user = get_db_user_by_email(db, email=user.email)\n    if db_user:\n        raise HTTPException(status_code=400, detail=\"Email already registered\")\n    return create_db_user(db=db, user=user)\n\n\n@app.get(\"/users/\", response_model=list[UserResponse])\ndef read_users(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):\n    \"\"\"ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¸€è¦§ã—ã¾ã™.\"\"\"\n    users = get_db_users(db, skip=skip, limit=limit)\n    return users\n\n\n@app.get(\"/users/{user_id}\", response_model=UserResponse)\ndef read_user(user_id: int, db: Session = Depends(get_db)):\n    \"\"\"ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã—ã¾ã™.\"\"\"\n    db_user = get_db_user(db, user_id=user_id)\n    if db_user is None:\n        raise HTTPException(status_code=404, detail=\"User not found\")\n    return db_user\n\n\n@app.post(\"/users/{user_id}/items/\", response_model=ItemResponse)\ndef create_item_for_user(\n    user_id: int, item: ItemCreateRequest, db: Session = Depends(get_db)\n):\n    \"\"\"ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆã—ã¾ã™.\"\"\"\n    return create_db_user_item(db=db, item=item, user_id=user_id)\n\n\n@app.get(\"/items/\", response_model=list[ItemResponse])\ndef read_items(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):\n    \"\"\"ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä¸€è¦§ã—ã¾ã™.\"\"\"\n    items = get_db_items(db, skip=skip, limit=limit)\n    return items\n```\n\nä»¥ä¸Šã‚’ `main.py` ã¨ã—ã¦ä¿å­˜ã—ã¦ã€ä¸‹è¨˜ã® `Dockerfile` `docker-compose.yml` ã§ `docker compose up --build` ã™ã‚Œã°å‹•ãã¾ã™ã€‚\n\n```dockerfile\nFROM python:3.10\n\nWORKDIR /app\n\nENV PATH=$PATH:/root/.local/bin\nCOPY pyproject.toml poetry.lock ./\n\nRUN curl -sSL https://install.python-poetry.org | python3 - \\\n    \u0026\u0026 poetry install\n\nCMD [\"poetry\", \"run\", \"uvicorn\", \"main:app\", \"--host\", \"0.0.0.0\", \"--reload\"]\n```\n\n```yaml\nversion: '3'\nservices:\n  app:\n    build:\n      context: ./\n      dockerfile: Dockerfile\n    ports:\n      - '8000:8000'\n    volumes:\n      - type: bind\n        source: ./\n        target: /app\n  db:\n    image: mysql:8.0\n    environment:\n      MYSQL_ROOT_PASSWORD: password\n      MYSQL_DATABASE: test\n      MYSQL_USER: user\n      MYSQL_PASSWORD: password\n```\n\n## ã¡ã‚‡ã“ã£ã¨è§£èª¬\n\n### SQL Alchemy 2.0 ã«å¯¾å¿œã•ã›ã‚‹\n\nã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚Œã°ãã‚ŒãŒã™ã¹ã¦ãªã®ã§ã‚ã¾ã‚Šè§£èª¬ã™ã‚‹ã“ã¨ã¯ãªã„ã®ã§ã™ãŒã€FastAPI å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® [SQL (Relational) Databases](https://fastapi.tiangolo.com/ja/tutorial/sql-databases/) ã®ãƒšãƒ¼ã‚¸ã¨ã®å¤§ããªé•ã„ã¯ã€SQLAlchemy 2.0é¢¨ãªæ›¸ãæ–¹ã«ãªã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã§ã™ã€‚\n\nSQLAlchemy ã‚’ä½¿ã£ãŸã“ã¨ã®ã‚ã‚‹æ–¹ãªã‚‰ `session.query(User).filter(User.id == user_id).first()` ã®ã‚ˆã†ãªæ›¸ãæ–¹ã«æ…£ã‚Œã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ãŒã€SQLAlchemy 2.0 ã§ã¯ã“ã®æ›¸ãæ–¹ã¯[ãƒ¬ã‚¬ã‚·ãƒ¼ã¨ã•ã‚Œã¦ã„ã¾ã™](https://docs.sqlalchemy.org/en/20/orm/queryguide/query.html#legacy-query-api)ã€‚\n\nSQLAlchemy Core ã«çµ±ä¸€ã•ã‚ŒãŸæ›¸ãæ–¹ãŒæ¨å¥¨ã•ã‚Œã¦ãŠã‚Šã€ä¸Šè¨˜ã®ä¾‹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚\n\n```py\nsession.execute(select(User).where(User.id == user_id)).scalars().first()\n```\n\nç‰¹å¾´ã¯\n\n* ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆï¼ˆSELECT ... WHERE ...ï¼‰ã¨ãã®å®Ÿè¡ŒãŒæ˜ç¢ºã«åˆ†é›¢ã•ã‚ŒãŸ\n* `Query` ã‚¯ãƒ©ã‚¹ã§ã¯ãªã `Result` ã‚¯ãƒ©ã‚¹ã‚„ `ScalarResult` ã§ `.all()` ã‚„ `.first()` ã‚’ä½¿ã†\n\nã“ã¨ã§ã™ã€‚ä»Šã¾ã§ã® API ã‚ˆã‚Šã‚‚åˆ†ã‹ã‚Šã‚„ã™ããªã£ã¦ã„ã¾ã™ã—ã€å‹æ¨è«–ã‚‚åŠ¹ã„ã¦ã„ã‚‹ã®ã§ä½¿ã„ã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚\n\nãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹ã®æ›¸ãæ–¹ã‚‚å¤‰ã‚ã£ã¦ã„ã¾ã™ã€‚\n\nä»Šã¾ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã—ã¦ã„ãŸéƒ¨åˆ†ãŒ\n\n```py\nid = Column(Integer, primary_key=True, index=True)\n```\n\nã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\n\n```py\nid: Mapped[int] = mapped_column(primary_key=True, index=True)\n```\n\nãã‚Œã£ã½ãç§»æ¤ã—ã¦ã„ã‘ã°è¿·ã†ã“ã¨ã¯å°‘ãªã„ã¨æ€ã„ã¾ã™ã€‚\n\n### DB ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å–å¾—ã«ã¯ dependency ã‚’ä½¿ã†\n\nFastAPI ã®ä¸»è¦ãªæ©Ÿèƒ½ã®ä¸€ã¤ã¨ã‚‚ã„ãˆã‚‹ dependency ã‚’ä½¿ã£ã¦ã€DB ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç”Ÿæˆã‚’è¡Œã†ã®ãŒå®šç•ªã¨ãªã£ã¦ã„ã¾ã™ã€‚ã¡ãªã¿ã«ã€`SessionLocal` ã®å‘½åã¯ã€`sqlalchemy.orm.Session` ã¨åŒºåˆ¥ã™ã‚‹ãŸã‚ã ãã†ã§ã™ã€‚\n\n```py\ndef get_db():\n    db = SessionLocal()\n    try:\n        yield db\n    finally:\n        db.close()\n```\n\nã“ã® `get_db` dependency ã‚’ä½¿ã†ã“ã¨ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é–‹å§‹æ™‚ã« DB ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ï¼ˆ`yield` ã®æ®µéšã§æ¸¡ã•ã‚Œã‚‹ï¼‰ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰ï¼ˆfinally ç¯€ã§ï¼‰DB ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‰ã˜ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚Dependency ã§ã® `yield` ã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ã¯ [Dependencies with yield](https://fastapi.tiangolo.com/ja/tutorial/dependencies/dependencies-with-yield/) ã‚’ã”å‚ç…§ãã ã•ã„ã€‚\n\nDependency ã¯ã€åˆ¥ã® dependency ã®ä¸­ã§ã‚‚ä½¿ã†ã“ã¨ãŒã§ãã‚‹ã®ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‰å‡¦ç†ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ï¼‰ã§å¼•æ•°ã« `db = Depends(get_db)` ã¨æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ãã®ä¸­ã§ã‚‚ DB ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾¿åˆ©ã§ã™ã­ã€‚\n\n### Pydantic ã® ORM mode\n\nç§ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯æ™®æ®µä½¿ã£ã¦ã„ãªã„ã®ã§ã™ãŒã€ãƒãƒƒãƒã™ã‚Œã°ä¾¿åˆ©ã ãªã¨æ€ã†ã®ãŒ Pydantic ã® `orm_mode = True` ã§ã™ã€‚\n\nã“ã‚ŒãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã¨ã€Pydantic ãŒå€¤ã‚’å–å¾—ã™ã‚‹ã¨ãã« `data[\"id\"]` ã®ã‚ˆã†ã«è¾æ›¸ã®ã‚­ãƒ¼ã ã‘ã§ãªãã€`data.id` ã®ã‚ˆã†ã«å±æ€§ã§ã‚‚å€¤ã‚’å–å¾—ã—ã‚ˆã†ã¨è©¦ã¿ã‚‹ã‚ˆã†ã«ãªã‚‹ãã†ã§ã™ã€‚ã“ã‚Œã ã‘èã„ã¦ã‚‚ã‚ã¾ã‚Šãƒ”ãƒ³ã¨ãã¾ã›ã‚“ãŒã€ã“ã®é•ã„ãŒã‚ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ ORM ãŒå¼µã£ã¦ã„ã‚‹ relationshipï¼ˆé€šå¸¸ã¯ lazy loading ãªã®ã§æ±‚ã‚ã‚‰ã‚Œã‚‹ã¾ã§ã¯å­˜åœ¨ã—ã¦ã„ãªã„ï¼‰ã®å€¤ã‚’ã¨ã£ã¦ãã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚‹ã‚ˆã†ã§ã™ï¼ˆ`@property` ã§å‘¼ã³å‡ºã—ã¦å€¤ã‚’ã¨ã£ã¦ã“ã‚‰ã‚Œã‚‹ã¨ã„ã†ã‚ˆã†ãªã“ã¨ã‹ãªã¨äºˆæƒ³ã—ã¦ã„ã¾ã™ï¼‰ã€‚\n\n## ã¾ã¨ã‚\n\n[Prisma Client Python](https://prisma-client-py.readthedocs.io/en/stable/) ã®å‹ä»˜ã‘ã®é–‹ç™ºè€…ä½“é¨“ã‚‚çµæ§‹å¥½ãã§ã—ãŸãŒã€SQLAlchemy ã‚‚ã¾ã ã¾ã å‹¢ã„ãŒã‚ã‚Šã¾ã™ã­ã€‚ãœã²æ´»ç”¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚\n\né–¢é€£è¨˜äº‹ã‚‚ã©ã†ãã€‚  \n[SQLAlchemyã§'MySQL server has gone away'ãŒç™ºç”Ÿã—ãŸæ™‚ã®å¯¾å‡¦æ³•2ã¤](/posts/2023/01/sqlalchemy-dealing-with-disconnects)\n\n## ãŠã¾ã‘ï¼šAPI ã‚’ãŸãŸã„ã¦ã¿ã‚‹\n\n```\n$ curl -s localhost:8000/users/ -XPOST \\\n  -H 'content-type: application/json' \\\n  -d '{\"email\": \"me@example.com\", \"password\": \"mystrongpassword\"}' \\\n  | jq\n```\n\n```json\n{\n  \"email\": \"me@example.com\",\n  \"id\": 1,\n  \"is_active\": true,\n  \"items\": []\n}\n```\n\n```\n$ curl -s localhost:8000/users/ | jq\n```\n\n```json\n[\n  {\n    \"email\": \"me@example.com\",\n    \"id\": 1,\n    \"is_active\": true,\n    \"items\": []\n  }\n]\n```\n\n```\n$ curl -s localhost:8000/users/?limit=0 | jq\n```\n\n```json\n[]\n```\n\n```\n$ curl -s localhost:8000/users/1 | jq\n```\n\n```json\n{\n  \"email\": \"me@example.com\",\n  \"id\": 1,\n  \"is_active\": true,\n  \"items\": []\n}\n```\n\n```\n$ curl -s localhost:8000/users/1/items/ -XPOST \\\n  -H 'content-type: application/json' \\\n  -d '{\"title\": \"LEVEL3\", \"description\": \"My favourite album\"}' \\\n  | jq\n```\n\n```json\n{\n  \"title\": \"LEVEL3\",\n  \"description\": \"My favourite album\",\n  \"id\": 1,\n  \"owner_id\": 1\n}\n```\n\n```\n$ curl -s localhost:8000/users/1 | jq\n```\n\n```json\n{\n  \"email\": \"me@example.com\",\n  \"id\": 1,\n  \"is_active\": true,\n  \"items\": [\n    {\n      \"title\": \"LEVEL3\",\n      \"description\": \"My favourite album\",\n      \"id\": 1,\n      \"owner_id\": 1\n    }\n  ]\n}\n```\n\n```\n$ curl -s localhost:8000/items/ | jq\n```\n\n```json\n[\n  {\n    \"title\": \"LEVEL3\",\n    \"description\": \"My favourite album\",\n    \"id\": 1,\n    \"owner_id\": 1\n  }\n]\n```\n\n## å‚è€ƒæ–‡çŒ®\n\n* [SQL (Relational) Databases](https://fastapi.tiangolo.com/ja/tutorial/sql-databases/)\n* [ORM Quick Start](https://docs.sqlalchemy.org/en/20/orm/quickstart.html)\n","tags":[{"name":"Python","ref":"/tags/python"},{"name":"FastAPI","ref":"/tags/fastapi"},{"name":"SQLAlchemy","ref":"/tags/sqlalchemy"},{"name":"ORM","ref":"/tags/orm"}],"showTerminalAside":false},{"title":"ã‚ˆãã‚ã‚‹SPA+APIæ§‹æˆã§ã®OpenID Connectã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…","date":"2022-12-02T00:00:00.000Z","ref":"/posts/2022/12/openid-connect-fastapi","desc":" ã“ã®è¨˜äº‹ã¯ãƒ‹ãƒ•ã‚¯ãƒ©ç­‰ã‚’æä¾›ã—ã¦ã„ã‚‹ã€å¯Œå£«é€šã‚¯ãƒ©ã‚¦ãƒ‰ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º Advent Calendar 2022ã®2æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚\n\næ˜¨æ—¥ã¯ [@nt","draft":false,"content":"\nã“ã®è¨˜äº‹ã¯[ãƒ‹ãƒ•ã‚¯ãƒ©](https://www.nifcloud.com/)ç­‰ã‚’æä¾›ã—ã¦ã„ã‚‹ã€[å¯Œå£«é€šã‚¯ãƒ©ã‚¦ãƒ‰ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º Advent Calendar 2022](https://qiita.com/advent-calendar/2022/fjct)ã®2æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚\n\næ˜¨æ—¥ã¯ [@ntoofu](https://qiita.com/ntoofu) ã•ã‚“ã® [ãƒ‘ã‚±ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ã‹ã‚‰Kubernetes APIã®TLSé€šä¿¡ã‚’è§£æã™ã‚‹](https://ntoofu.github.io/blog/post/sniffing-kube-apiserver-tls/) ã§ã—ãŸã€‚  \nç§ã¯ TLS ãªæ™‚ç‚¹ã§ãƒ‘ã‚±ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’è«¦ã‚ã¦ã—ã¾ã„ãã†ã§ã™ãŒ Linux ã®ä¾¿åˆ©ãªä»•çµ„ã¿ã¨æ°—åˆãŒã‚ã‚Œã° TLS 1.3 ã®ãƒ‘ã‚±ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ã‚‚å¯èƒ½ã ã¨ã‚ã‹ã‚Šã€ã¨ã¦ã‚‚æœ‰ç›Šã§ã—ãŸã€‚ç§ã‚‚ã‚®ãƒ¼ã‚¯ãªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ç›®æŒ‡ã—ã¦é ‘å¼µã‚Šã¾ã™ã€‚\n\nä»Šæ—¥ã¯ OpenID Connect ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã©ã†å®Ÿè£…ã™ã‚‹ã‹ã«ã¤ã„ã¦æ¤œè¨ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚\n\nFastAPI + SPA (Vue.js) ã§ã¡ã‚‡ã£ã¨ã—ãŸç¤¾å†…ãƒ„ãƒ¼ãƒ«ã‚’é–‹ç™ºã—ãŸæ™‚ã«ç¤¾å†…ã®èªå¯åŸºç›¤ã¨ã® OpenID Connect ã‚’ç”¨ã„ãŸãƒ­ã‚°ã‚¤ãƒ³é€£æºæ©Ÿèƒ½ã‚’ä½œã‚ŠãŸã‹ã£ãŸã®ã§ã™ãŒã€å®Ÿè£…ã®ãŸã‚ã®æƒ…å ±ãŒå°‘ãªã‹ã£ãŸã®ã§è¨˜äº‹ã«æ®‹ã—ã¦ãŠããŸã„ã¨æ€ã£ãŸã®ãŒãã£ã‹ã‘ã§ã™ã€‚ã€Œã“ã‚ŒãŒãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã ï¼ã€ã¨ã„ã†ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€1ã¤ã®å®Ÿè·µä¾‹ã¨ã—ã¦ã©ãªãŸã‹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚\n\n## å¯¾è±¡èª­è€…\n\n* OpenID Connect ã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã‚¢ãƒ—ãƒªã‚’ä½œã‚ŠãŸã„ã‘ã©å®Ÿè£…æ–¹æ³•ãŒã‚ã‹ã‚‰ãªã„äºº\n  * è‰²ã‚“ãªãƒ•ãƒ­ãƒ¼ãŒã‚ã‚‹ã£ã½ã„ã‘ã©ã©ã‚Œã‚’ä½¿ã†ã¹ãï¼Ÿ\n  * ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼Ÿ ID ãƒˆãƒ¼ã‚¯ãƒ³ï¼Ÿ\n  * ã‚µãƒ¼ãƒãƒ¼ã§ä½•ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ä½•ã™ã‚‹ã®ï¼Ÿ\n* Python ã® FastAPI ã§ä½œã£ãŸã‚µãƒ¼ãƒãƒ¼ã§ã®ãƒ­ã‚°ã‚¤ãƒ³ã€œãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã€œãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã®å®Ÿè£…ä¾‹ãŒçŸ¥ã‚ŠãŸã„äºº\n\n## OpenID Connect ã¨ã¯\n\n**OpenID Connect ã¯ OAuth 2.0 ã‚’æ‹¡å¼µã™ã‚‹å½¢ã§ç­–å®šã•ã‚ŒãŸã€èªè¨¼ãƒ»èªå¯ã®ãŸã‚ã®ä»•çµ„ã¿**ã§ã™ã€‚OAuth 2.0 ã¯èªå¯ã‚’è¡Œã†ã“ã¨ã‚’ç›®çš„ã¨ã—ãŸä»•æ§˜ã§ã™ã€‚ã™ã§ã«10å¹´ã‚‚å‰ã®è©±ã§ã™ãŒã€OAuth ã‚’èªè¨¼ã«ã‚‚ä½¿ã£ã¦ã—ã¾ã†ã€ŒSNS ãƒ­ã‚°ã‚¤ãƒ³ã€ã®æ‰‹æ³•ã¯ã€Œ[å˜ãªã‚‹ OAuth 2.0 ã‚’èªè¨¼ã«ä½¿ã†ã¨ã€è»ŠãŒé€šã‚Œã‚‹ã»ã©ã®ã©ã§ã‹ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ãƒ»ãƒ›ãƒ¼ãƒ«ãŒã§ãã‚‹](https://www.sakimura.org/2012/02/1487/)ã€ã¨æŒ‡æ‘˜ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚OpenID Connect ã¯ OAuth 2.0 ã‚’æ‹¡å¼µã—ã¦èªè¨¼ã®ç”¨é€”ã«ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ãŸã€ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ã¨ãªã£ã¦ã„ã¾ã™ã€‚\n\nä¸‹å›³ã¯èªè¨¼ãƒ»èªå¯ã®æµã‚Œã®ä¸€ä¾‹ã§ã™ï¼ˆresponse_type=id_token ã®å ´åˆï¼‰ã€‚\n\n![overview](//www.plantuml.com/plantuml/png/NP6zIiDG5CVt-nINJkbGgBg9I0SNfrlo1g7DKD0q9EckzpW4KHfGS6aH9KWeIeMYK1FmOGv9u-GhUEvDH9lbSCBv_J_2xVc1vGMJqnDc3OAnnn6U43AKxpIvvVE9Rtjyx0rfxdIPI-neC78j9-0jb6yAXHkKQswO_NPB2Sn-ZUysSE7Qpl4HmXt22qA4CaOuuuQeTU9NjzTbEhHpgBpskSBbgyPN23EKdsgHIuG50j3222DOABXSN9T9HYS5o8IQ8OILtq67a8RVvZRzcZyYf7bqLLnCgy_o8Td47vMewPlIaa-NJEX8y__fMOVDTRcreVuqHCXqqLMRcN-2xLCHpqXUtrLces8HHldb_NTspdgsCwI7-W40)\n\nOP: OpenID Provider; ID ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡Œè€…  \nRP: Relying Party; OP ã«èªè¨¼æ©Ÿèƒ½ã‚’æ—¢å­˜ã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒª\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µãƒ¼ãƒ“ã‚¹ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ã‚µãƒ¼ãƒ“ã‚¹ã¯ã¾ãš OpenID ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆOPï¼‰ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚OP ã¯æœªèªè¨¼ã§ã‚ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’å‡ºã—ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼ã—ã¦ã‹ã‚‰ã€ã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾ã—ã¦èªå¯ã‚’è¡Œã†ã‹ã©ã†ã‹åŒæ„ã‚’å–ã‚Šã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒæ„ã™ã‚‹ã¨ã€OP ã¯ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å«ã‚ã¦ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ URL ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹ã¯å—ã‘å–ã£ãŸ ID ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£è¦ã® OP ã‹ã‚‰ã®ã‚‚ã®ã§ã‚ã‚‹ã“ã¨ã‚’ OP ã®å…¬é–‹éµã‚’ä½¿ç”¨ã—ã¦æ¤œè¨¼ã—ã¾ã™ï¼ˆãã®ã»ã‹ã«ã‚‚è¤‡æ•°ã®æ¤œè¨¼ã‚’ã™ã‚‹ï¼‰ã€‚æ¤œè¨¼ãŒæ­£å¸¸ã«çµ‚äº†ã™ã‚Œã°ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒ­ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã¯å®Œäº†ã§ã™ã€‚\n\n## ã§ã€ã©ã†ã‚„ã£ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã®ï¼Ÿ\n\n### ã¾ãšã¯çµè«–\n\n![code flow](//www.plantuml.com/plantuml/png/RPBFIW9H5CRtzoakhdGXJNzM4Q7GnfL3FS6aBeHI6KTewTmROQ4e94YWX28XKXdq1t8a7-OuEgvwXRwPKN2apULSlz_vpdUk4oiQccwKBY-ObZBoEYVvH792uWidrugyLCpeFA-dSUugx3n_nKCaFbr4tfFuvk5JDH9Y1NXaKzc2bZFucHfVDUmf0I6k9bR2li8okJI7Mm089GkPNEA4P8la2ya6YJx9CWydCSBDabHN_GSAyt95ZxrfXzpbnPl7lvDiavYwXHYH79AKA1Wuu6w6RTniaVb3vWE31WHJG3Z3cZEOkEqm4GDiIhBY3psA0jaoMJIjPQT7qh8RrVbrtRywtS6YF_QRjdqj57PznF2Zdsf3U_QcTM2B8ko39B0NjDj8C6PGN9RDsRGRC2NHyrQm_1N0uGhh7RppnjMPDktQX--zRWqIytuRwLpY_sUtNwkpyStwdRsbWy2yqh3l7dyd9elXpySNzmS0)\n\n* API ã‚µãƒ¼ãƒãƒ¼ã§èªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„ ID ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã‚’è¡Œã†\n  * ä»Šå›ã¯æ¡ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®éƒ½åˆã§ Authorization Code Flow ã‚’ä½¿ã„ã¾ã™\n* ID ãƒˆãƒ¼ã‚¯ãƒ³ã¯ Cookie ã§ç®¡ç†\n  * localStorage ã§ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šå•é¡ŒãŒã‚ã‚‹\n  * ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã§ã¯åˆ©ä¾¿æ€§ã«æ¬ ã‘ã‚‹\n  * Cookie ã®å±æ€§\n    * HttpOnly: true\n      * JavaScript ã‹ã‚‰ã¯è§¦ã‚‰ã›ãªã„\n    * SameSite: Lax\n      * ä»–ã‚µã‚¤ãƒˆã¸ã® Cookie é€ä¿¡ã‚’æœ€ä½é™ã«ã™ã‚‹\n      * Strict ã«ã™ã‚‹ã¨ OP ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ãŸéš›ã«ç ´æ£„ã•ã‚Œã¦ã—ã¾ã†ãŸã‚ Lax\n    * Secure: true\n      * HTTPS ã§ã®ã¿ Cookie ã‚’é€ä¿¡ã™ã‚‹\n\n### SPA ãªã‚‰å…¨éƒ¨ SPA ã«ã‚„ã‚‰ã›ã‚Œã°ã„ã„ã‚“ã˜ã‚ƒãªã„ã®ï¼Ÿ\n\nã¯ã„ã€Implicit Flow ã‚’ä½¿ã†ã“ã¨ã§å®Ÿç¾ã§ãã¾ã™ã€‚\n\nå†’é ­ã®ã€Œè»ŠãŒé€šã‚Œã‚‹ã»ã©ã®ã©ã§ã‹ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ãƒ»ãƒ›ãƒ¼ãƒ«ã€ã®è©±ã¯ OAuth 2.0 ã‚’ Implicit Flow ã§ä½¿ç”¨ã—ãŸæ™‚ã®è©±ã§ã™ãŒã€OpenID Connect ã¯ãã‚Œã‚’è¸ã¾ãˆã¦ç­–å®šã•ã‚ŒãŸä»•æ§˜ãªã®ã§ã€OpenID Connect ã«ãŠã„ã¦ Implicit Flow ã‚’ä½¿ã†ã“ã¨ã«å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\n\nImplicit Flow ã‚’ä½¿ã†å ´åˆã€ä¸‹å›³ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼ˆresponse_type=id_tokenï¼‰ã€‚\n\n![implicit flow](//www.plantuml.com/plantuml/png/TP9FIm916CRlyoa6JteGjZydYL3euicbFi6c7eHIMLVegFD6I1WA1LsKC2H4AWCfq5tmmxpkkfxw2hqpxWO3THbcz_dDypppxcORZcKxpSiBPXMTciqHNX0y55-qSgl1cusopMjsYTOzWvtNhdW2nQT4u1x5WYTFpLI2rScZKgpKhQh3pynST63Vq8IScO-40uELgoLERXgGADJBrVm9mYF26q8VnHYXnPC5Yf1T2cPq_j1WgbVwMALbkEJ5X-Bd20CKAxaHCuGf0j264KSuMH0TJk_2YKUQ9CI4he7GsJaUfIMY6suUtEtm6S7r-ztWkhTx34UJpNWPrz1zNThulHcZbxyDO-rLfGrLlKLINhQZvarLvwcufPnKXklYjjLUhqQCfF-8O3oW24dyFHZ_lRjUtiGPghaE19s-V_lqxRLPbZuF_HC_)\n\nä¸Šè¨˜ã®ãƒ•ãƒ­ãƒ¼ã§ã¯ã€SPA å´ã§ Client Secret ã‚’ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ClientSecret ãŒå¿…è¦ã«ãªã‚‹ã®ã¯ä¸»ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆèªå¯ã‚³ãƒ¼ãƒ‰ã‚„ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ã¦ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚„ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ã‚„ã¤ï¼‰ã‚’ä½¿ã†æ™‚ãªã®ã§ã€response_type=id_token ã§ OIDC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹å ´åˆã«ã¯å›°ã‚Šã¾ã›ã‚“ã€‚response_type=id_token ã§å•é¡ŒãŒãªã„ã‹ã¨ã„ã†è¦³ç‚¹ã§ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†æ™‚ã«ã ã‘ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒæ‰‹ã«å…¥ã‚Œã°å•é¡Œãªã„å ´åˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒæœ€æ–°ã§ã‚ã‚‹å¿…è¦ãŒãªã„å ´åˆï¼‰ã«ã¯äº‹è¶³ã‚Šã‚‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚\n\nSPA ã§ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦‹ã›ãŸããªã„æ©Ÿå¯†æƒ…å ±ã‚’æ‰±ã†ã®ã¯ã»ã¨ã‚“ã©ä¸å¯èƒ½ã ã¨æ€ã„ã¾ã™ã®ã§ Client Secret ã‚’ SPA ã«æŒãŸã›ã‚‹å¿…è¦ãŒãªã„ã®ã¯å¬‰ã—ã„ä»•æ§˜ã§ã™ã­ã€‚**Implicit Flow ã§ã¯ CSRF å¯¾ç­–ã®ãŸã‚ã« nonce ã®æ¤œè¨¼ãŒå¿…é ˆ**ãªã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚\n\n### ID ãƒˆãƒ¼ã‚¯ãƒ³ã©ã“ç½®ãå•é¡Œ\n\nãŸã ã€Client Secret ã‚’ SPA ã§ç®¡ç†ã™ã‚‹å¿…è¦ãŒãªã„ã‹ã‚‰ã¨ã„ã£ã¦ SPA ä¸Šã§ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨ã€ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã©ã“ã«ä¿ç®¡ã™ã‚‹ã‹ã€ã¨ã„ã†å•é¡ŒãŒå‡ºã¦ãã¾ã™ã€‚ã“ã‚Œã¯ OIDC ã®ã‚¹ã‚³ãƒ¼ãƒ—å¤–ã®è­°è«–ã§ã™ãŒã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…ã«ã‚ãŸã£ã¦å¿…ãšæ¤œè¨ã™ã‚‹ã¹ãç‚¹ã ã¨æ€ã†ã®ã§ã€ä»Šå›ã¯ã“ã‚Œã‚‚è€ƒãˆã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚\n\nID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç½®ãå ´æ‰€ã¨ã—ã¦è€ƒãˆã‚‰ã‚Œã‚‹å€™è£œã‚’æ¯”è¼ƒã—ã¦ã¿ã¾ã™ã€‚\n\n||Cookie (HttpOnly: true, Secure: true, SameSite: Lax)|ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒª|localStorage|\n|---|---|---|---|\n|ä¿æŒæœŸé–“|**è¨­å®šã•ã‚ŒãŸæœ‰åŠ¹æœŸé™ã¾ã§**|ãƒšãƒ¼ã‚¸ãŒãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã¾ã§|**ãªã—**|\n|CSRF å¯¾ç­–|**æ›´æ–°ç³»ã¯é˜²ã’ã‚‹**|**ä»–ã® JS ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯åŸºæœ¬çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„**|ã©ã® JS ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚å–å¾—å¯|\n|JS ã§ã® ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—|ã§ããªã„ [^1]|**ã§ãã‚‹**|**ã§ãã‚‹**|\n\n[^1]: ã‚µãƒ¼ãƒãƒ¼å´ã§ Cookie ã® ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã—ãŸä¸Šã§ã€JSON ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿”å´ã™ã‚‹ API ã‚’ä½œã£ãŸã‚Šã™ã‚Œã°å¯èƒ½ã§ã™ã€‚\n\nã©ã‚Œã‚‚ä¸€é•·ä¸€çŸ­ãªæ„ŸãŒã‚ã‚Šã¾ã™ãŒã€ã“ã®ä¸­ã§ä¸€ç•ªå®‰å…¨æ€§ã¨åˆ©ä¾¿æ€§ã®ãƒãƒ©ãƒ³ã‚¹ãŒã„ã„ã®ã¯ Cookie (HttpOnly: true, Secure: true, SameSite: Lax) ã ã¨æ€ã£ãŸã®ã§ã€ä»Šå›ã¯ Cookie ã« ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç½®ãã‚ˆã†ã«ã—ã¾ã—ãŸã€‚\n\nãªãŠã€Auth0 ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã¯ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã« ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¤ã¤ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é•·ãä¿ãŸã›ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã‚ˆã†ã§ã™ã€‚  \n[SPAèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã¯localStorageã§ã‚‚Cookieã§ã‚‚ãªã„ã€Auth0æ–¹å¼ã¯ã„ã„ã­ã¨ã„ã†ãŠè©±](https://mizumotok.hatenablog.jp/entry/2021/08/04/114431)\n\n## FastAPI ã§ OpenID Connect ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹\n\nä»¥ä¸Šã§ã€ä¸€é€šã‚Šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…æ–¹é‡ã«ã¤ã„ã¦è­°è«–ãŒã§ããŸã¨æ€ã†ã®ã§ã€ã“ã“ã‹ã‚‰ã¯å…·ä½“çš„ãª Python (FastAPI) ã§ã®å®Ÿè£…ã«ç§»ã‚ŠãŸã„ã¨æ€ã„ã¾ã™ã€‚  \nä»Šå›ä½¿ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒª Authlib ã§ã¯ FastAPI ã®ä»–ã« Starlette, Flask ã‚„ Django ã® Oauth Client ã¨ãã®å®Ÿè£…ä¾‹ã‚‚å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚‰ã‚’å‚è€ƒã«ã™ã‚Œã°ä»–ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚‚å‰²ã¨ç°¡å˜ã«å®Ÿè£…ã§ãã‚‹ã®ã§ã¯ãªã„ã‹ãªã¨æ€ã„ã¾ã™ã€‚\n\n### ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰\n\nhttps://github.com/SogoKato/oidc-fastapi-authlib\n\nå‹•ã‹ã—ã¦ã¿ãŸã„æ–¹ã¯ README ã«å¾“ã£ã¦èµ·å‹•ã—ã¦ã¿ã¦ãã ã•ã„ã€‚\n\n### å¿…è¦ãªã‚‚ã®\n\nå‰æº–å‚™ã¨ã—ã¦ OpenID ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ç”¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã©ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ã§ã‚‚å¤§ä¸ˆå¤«ã§ã™ãŒã€ã¾ã æŒã£ã¦ã„ãªã„å ´åˆã¯ [Auth0](https://auth0.com/jp) ã«ç™»éŒ²ã—ã¦ã¿ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚å€‹äººã§ä½¿ã†ã‚ˆã†ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆé‡ã§ã‚ã‚Œã°ç„¡æ–™ã§ä½¿ãˆã¾ã™ï¼ˆ2022å¹´12æœˆç¾åœ¨ï¼‰ã€‚\n\nç™»éŒ²å¾Œã€Application ã‚’ä½œæˆã—ãŸã‚‰ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URI (Allowed Callback URLs) ã« `http://localhost:8080/api/auth` ã‚’å…¥ã‚Œã¦ãŠãã¾ã™ã€‚ã¾ãŸã€ä¸‹è¨˜ã®æƒ…å ±ã‚’æ¢ã—ã¦ãƒ¡ãƒ¢ã£ã¦ãŠãã¾ã—ã‚‡ã†ã€‚\n\n* Client ID\n* Client Secret\n* OpenID Configuration Endpoint\n  * ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ OIDC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å¿…è¦ãªæƒ…å ±ã‚’è¿”ã—ã¦ãã‚Œã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ\n  * é€šå¸¸ `https://example.com/.well-known/openid-configuration`\n\n### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£\n\n![architecture](//www.plantuml.com/plantuml/png/SoWkIImgAStDuKfCBialKdZSlEnnyvx7JTk0f49YiK9fSMeHLs9HSaPcRc99ge9oIMfoHbv-JdvwfK9UUcPUXOAD3L15MMPogfqT3dME0Pv4g5Bo2F7rqNSE3jRt2bO2sGnqM4bcCefEa6CKTEsWDbi17RlgSTFwnqqh7ZVjVDpSmGKHrzMr0za9bDTFBCX4249D18bpEQJcfG0z3G00)\n\nä»Šå›ã¯ Cookie ã® SameSite å±æ€§ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€SPA ã¨ API ã¨ã§åŒã˜ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’ä½¿ã„ã€ãƒ‘ã‚¹ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŒ¯ã‚Šåˆ†ã‘ã¾ã™ã€‚\n\n### è§£èª¬\n\n#### ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®å‡¦ç†\n\n```python\napp = FastAPI()\napp.add_middleware(SessionMiddleware, secret_key=\"MYSTRONGKEY\", https_only=True)\n```\n\nFastAPI ã®åˆæœŸåŒ–ã¨ Cookie ã®ãŸã‚ã® SessionMiddleware ã®è¿½åŠ ã‚’ã—ã¾ã™ã€‚\n\n```python\noauth = OAuth()\noauth.register(\n    name=\"auth0\",\n    server_metadata_url=\"https://example.com/.well-known/openid-configuration\",\n    client_id=\"ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID\",\n    client_secret=\"ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ\",\n    client_kwargs={\"scope\": \"openid profile\"},\n)\n```\n\nAuthlib ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã‚Šã¾ã™ã€‚scope ã« `openid` ã¨å…¥ã‚Œã¦ãŠãã“ã¨ã§ Authorization Code Flow ã®æ™‚ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ ID ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ‰‹ã«å…¥ã‚Šã¾ã™ã€‚\n\n```python\n@app.get(\"/api/login\")\nasync def login(request: Request):\n    redirect_uri = request.url_for(\"auth\")\n    return await oauth.auth0.authorize_redirect(request, redirect_uri)\n```\n\nèªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã“ã“ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ `http://localhost:8080/api/auth` ã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URI ã¨ã—ãŸèªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™ï¼ˆOpenID ãƒ—ãƒ­ãƒã‚¤ãƒ€ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ï¼‰ã€‚\n\nã¡ãªã¿ã«ã“ã‚“ãª URL ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ã€‚state ã¨ nonce ãŒã‚ã‚‹ã“ã¨ã‚‚ç¢ºèªã§ãã¾ã™ã­ã€‚\n\n```\nhttps://example.com/authorize\n  ?response_type=code\n  \u0026client_id=ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID\n  \u0026redirect_uri=http%3A%2F%2Flocalhost%3A8080%2Fapi%2Fauth\n  \u0026scope=openid+profile\n  \u0026state=PGO5TxTujESoXuLlfzYTWZsioK5Up5\n  \u0026nonce=HfyA3eugosoOuieiTGRZ\n```\n\n![OP login](/images/posts/2022/12/oidc_op_login.png)\n\nãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã™ã‚‹ã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URI ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã€æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå‘¼ã°ã‚Œã¾ã™ã€‚\n\n```python\n@app.get(\"/api/auth\")\nasync def auth(request: Request):\n    try:\n        token = await oauth.auth0.authorize_access_token(request)\n    except OAuthError:\n        logger.exception(\"An error occurred while verifying authorization response.\")\n        raise UnauthenticatedError()\n    userinfo = token.get(\"userinfo\")\n    # userinfoã®claims(subã‚„nameãªã©)ã‚’ä½¿ã£ã¦DBã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã™ã‚‹å‡¦ç†ãŒã“ã“ã«ãã¾ã™.\n    request.session[\"id_token\"] = token.get(\"id_token\")\n    return RedirectResponse(url=\"/\")\n```\n\n`authorize_access_token` ã§èªå¯ã‚³ãƒ¼ãƒ‰ã¨ state ã‚’ä½¿ã£ã¦ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€ID ãƒˆãƒ¼ã‚¯ãƒ³ã¨ nonce ã‚’æ¤œè¨¼ã™ã‚‹ã¨ã“ã‚ã¾ã§ã‚„ã£ã¦ãã‚Œã¾ã™ï¼ˆæ¥½ã¡ã‚“ï¼‰ã€‚  \nãã®å¾Œã¯è‡ªåˆ†ã®å¥½ããªã‚ˆã†ã«å‡¦ç†ã‚’ã—ã¦ OK ã§ã™ã€‚sub ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ã¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã¾ã  DB ã«ç™»éŒ²ã•ã‚Œã¦ã„ãªã‘ã‚Œã° insert ã™ã‚‹ã¨ã‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ãŒå¤‰ã‚ã£ã¦ãŸã‚‰æ›´æ–°ã™ã‚‹ã¨ã‹ã€ãã†ã„ã†å‡¦ç†ãŒæ¥ã‚‹ã®ã‹ãªã¨æ€ã„ã¾ã™ã€‚\n\næœ€å¾Œã«ã€Cookie ã« ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚»ãƒƒãƒˆã—ã¦ `/` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã¯å®Œäº†ã§ã™ã€‚\n\n#### ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®å‡¦ç†\n\nãƒ­ã‚°ã‚¤ãƒ³å¾Œã¯ JS å´ã§ fetch ã‚„ axios ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã™ã‚‹ã¨ã€Cookie ã‚‚è‡ªå‹•çš„ã«é€ä¿¡ã•ã‚Œã¾ã™ã€‚ãªã®ã§ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã—ã‹ä½¿ã‚ã›ãŸããªã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã¯ã€Depends ã‚’ä½¿ã£ã¦ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚\n\n```python\n@app.get(\"/api/items\")\nasync def list_items(user: User = Depends(verify_user)):\n    logger.info(f\"Successful log in: user_id={user.id} name={user.name}\")\n    return {\n        \"items\": [\n            {\"name\": \"Teddy bear\", \"icon\": \"ğŸ§¸\", \"price\": 99},\n            {\"name\": \"Apple\", \"icon\": \"ğŸ\", \"price\": 2},\n            {\"name\": \"Sushi\", \"icon\": \"ğŸ£\", \"price\": 200},\n            {\"name\": \"Bento\", \"icon\": \"ğŸ±\", \"price\": 50},\n        ]\n    }\n```\n\n`verify_user` é–¢æ•°ã§ Cookie ã‹ã‚‰ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚\n\n```python\nasync def verify_user(request: Request):\n    id_token = request.session.get(\"id_token\")\n    if id_token is None:\n        raise UnauthenticatedError()\n    decoded_jwt = await verify_token(id_token=id_token)\n    # DBã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹å‡¦ç†ãŒã“ã“ã«ãã¾ã™.\n    # user = user_repo.select_by_user_id(user_id=user_id)\n    return user\n```\n\n`verify_token` ãŒ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã™ã‚‹é–¢æ•°ã§ã™ã€‚\n\n```python\nasync def verify_token(id_token: str):\n    jwks = await oauth.auth0.fetch_jwk_set()\n    try:\n        decoded_jwt = jwt.decode(s=id_token, key=jwks)\n    except Exception:\n        logger.exception(\"An error occurred while decoding jwt.\")\n        raise UnauthenticatedError()\n    metadata = await oauth.auth0.load_server_metadata()\n    if decoded_jwt[\"iss\"] != metadata[\"issuer\"]:\n        raise UnauthenticatedError()\n    if decoded_jwt[\"aud\"] != settings.oidc_client_id:\n        raise UnauthenticatedError()\n    exp = datetime.fromtimestamp(decoded_jwt[\"exp\"])\n    if exp \u003c datetime.now():\n        raise UnauthenticatedError()\n    return decoded_jwt\n```\n\nID ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ã¨ã—ã¦æœ€ä½é™å¿…è¦ãªã®ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼ˆAuthorization Code Flow ã®å ´åˆï¼‰ã€‚\n\n1. JWK Setï¼ˆOP ã®å…¬é–‹éµï¼‰ã‚’ä½¿ç”¨ã—ã¦ JWT ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã™ã‚‹\n2. iss ã‚¯ãƒ¬ãƒ¼ãƒ ï¼ˆIssuer Identifier; ç™ºè¡Œè€…ï¼‰ã‚’æ¤œè¨¼ã™ã‚‹\n3. aud ã‚¯ãƒ¬ãƒ¼ãƒ ï¼ˆAudience(s); èª°ã«å¯¾ã—ã¦ç™ºè¡Œã—ãŸã‹ = Client IDï¼‰ã‚’æ¤œè¨¼ã™ã‚‹\n4. exp ã‚¯ãƒ¬ãƒ¼ãƒ ï¼ˆExpiration time; æœ‰åŠ¹æœŸé™ï¼‰ã‚’æ¤œè¨¼ã™ã‚‹\n\nä»¥ä¸ŠãŒå®Œäº†ã™ã‚Œã°åŸºæœ¬çš„ãª OIDC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…ã¯å®Œäº†ã§ã™ğŸ‰\n\n![log in](/images/posts/2022/12/oidc_log_in.gif)\n\n## æœ€å¾Œã«\n\nã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿï¼Ÿ\n\nä¸€è¦‹è¤‡é›‘ãã†ãª OpenID Connect ã§ã™ãŒã€ä¸€ã¤ãšã¤ç´è§£ã„ã¦ã¿ã‚‹ã¨æ„å¤–ã¨ç°¡å˜ã«å®Ÿè£…ã§ãã‚‹ã‚ˆã†ã«ä»•æ§˜ãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚è‡ªåˆ†ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é ‘å¼µã£ã¦ç®¡ç†ã™ã‚‹ã‚ˆã‚Šã‚‚ã“ã†ã„ã†ã¨ã“ã‚ã¯ä¿¡é ¼ã§ãã‚‹ OpenID ãƒ—ãƒ­ãƒã‚¤ãƒ€ã«ä»»ã›ã¦ã—ã¾ã£ãŸæ–¹ãŒæ¥½ã§ã™ã—ã€ä½•ã‚ˆã‚Šã‚‚å®‰å…¨ã§ã™ã‚ˆã­ã€‚\n\nãœã²çš†ã•ã‚“ã‚‚ Web ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œã‚‹æ™‚ã«ã¯æ´»ç”¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚\n\nã“ã®è¨˜äº‹ã¯[å¯Œå£«é€šã‚¯ãƒ©ã‚¦ãƒ‰ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º Advent Calendar 2022](https://qiita.com/advent-calendar/2022/fjct)ã®2æ—¥ç›®ã®è¨˜äº‹ã§ã—ãŸã€‚\n\næ˜æ—¥ã¯ [@Syuparn](https://qiita.com/Syuparn) ã•ã‚“ãŒ SQL ã®ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦æ›¸ã„ã¦ãã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚  \nSQL ã®ãƒ†ã‚¹ãƒˆã£ã¦ã‚ã¾ã‚Šã‚„ã£ã¦ãªã‹ã£ãŸã‚Šã™ã‚‹ã®ã§ã€ä»–ã®äººãŒã©ã®ã‚ˆã†ã«è€ƒãˆã¦å®Ÿæ–½ã—ã¦ã„ã‚‹ã®ã‹æ°—ã«ãªã‚Šã¾ã™ã€‚ãã‚Œã§ã¯ã€æ˜æ—¥ã®è¨˜äº‹ã‚‚ãŠæ¥½ã—ã¿ã«ï¼\n\nï¼ˆğŸ‘‡ã“ã®è¨˜äº‹ãŒã‚ˆã‹ã£ãŸã‚‰ã„ã„ã­ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼ï¼‰\n\n## å‚è€ƒæ–‡çŒ®\n\n* [OpenID Connect Basic Client Implementer's Guide 1.0 - draft 42](https://openid.net/specs/openid-connect-basic-1_0.html)\n* [OpenID Connect Implicit Client Implementer's Guide 1.0 - draft 25](https://openid.net/specs/openid-connect-implicit-1_0.html)\n* [Google login for FastAPI](https://blog.authlib.org/2020/fastapi-google-login)\n* [ä¸€ç•ªåˆ†ã‹ã‚Šã‚„ã™ã„ OpenID Connect ã®èª¬æ˜](https://qiita.com/TakahikoKawasaki/items/498ca08bbfcc341691fe)\n* [IDãƒˆãƒ¼ã‚¯ãƒ³ãŒåˆ†ã‹ã‚Œã° OpenID Connect ãŒåˆ†ã‹ã‚‹](https://qiita.com/TakahikoKawasaki/items/8f0e422c7edd2d220e06)\n* [OpenID Connect å…¨ãƒ•ãƒ­ãƒ¼è§£èª¬](https://qiita.com/TakahikoKawasaki/items/4ee9b55db9f7ef352b47)\n* [OAuth 2.0/OpenID Connectã®2ã¤ã®ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½¿ã„ã¿ã¡](https://qiita.com/wadahiro/items/ad36c7932c6627149873)\n* [å˜ãªã‚‹ OAuth 2.0 ã‚’èªè¨¼ã«ä½¿ã†ã¨ã€è»ŠãŒé€šã‚Œã‚‹ã»ã©ã®ã©ã§ã‹ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ãƒ»ãƒ›ãƒ¼ãƒ«ãŒã§ãã‚‹](https://www.sakimura.org/2012/02/1487/)\n* [OIDCã®Implicit Flowã§ClientSecretã‚’ä½¿ã‚ãšã«IDé€£æºã™ã‚‹](https://zenn.dev/ritou/articles/a)\n* [SPAèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã¯localStorageã§ã‚‚Cookieã§ã‚‚ãªã„ã€Auth0æ–¹å¼ã¯ã„ã„ã­ã¨ã„ã†ãŠè©±](https://mizumotok.hatenablog.jp/entry/2021/08/04/114431)\n* [Goã§OpenID Connectã®Clientã‚’å®Ÿè£…ã™ã‚‹ï¼ˆå®Ÿè£…ç·¨ï¼‰](https://times.hrbrain.co.jp/entry/go-openid-connect-implement)\n","tags":[{"name":"OpenID Connect","ref":"/tags/openid-connect"},{"name":"èªè¨¼/èªå¯","ref":"/tags/èªè¨¼-èªå¯"},{"name":"SPA","ref":"/tags/spa"},{"name":"Python","ref":"/tags/python"},{"name":"FastAPI","ref":"/tags/fastapi"}],"showTerminalAside":false}],"pages":[1],"tag":{"name":"FastAPI","ref":"/tags/fastapi"}},"__N_SSG":true},"page":"/tags/[tag]","query":{"tag":"fastapi"},"buildId":"myGytjg_O6H0FTkSaqhtQ","isFallback":false,"gsp":true,"scriptLoader":[{"async":true,"src":"https://www.googletagmanager.com/gtag/js?id=G-RE7Q7WBFDJ","strategy":"afterInteractive"},{"id":"_gtag","defer":true,"dangerouslySetInnerHTML":{"__html":"\n              if (window.location.hostname === \"sogo.dev\") {\n                window.dataLayer = window.dataLayer || [];\n                function gtag(){dataLayer.push(arguments);}\n                gtag(\"js\", new Date());\n                gtag(\"config\", \"G-RE7Q7WBFDJ\");\n              }"},"strategy":"afterInteractive"}]}</script></body></html>